unit uFiscal;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs, Variants,
  OleCtrls, FiscalPrinterLib_TLB, uTools, StdCtrls, ExtCtrls, udmGestion, DB, If_Epson, MDOQuery;

type
  TfrmFiscal = class(TForm)
    Hasar: THASAR;
    mImpFiscal: TMemo;
    procedure HasarFaltaPapel(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure HasarImpresoraOK(Sender: TObject);
    //------------------------------------------------
    procedure EpsonFaltaPapel(Sender: TObject);
    procedure EpsonImpresoraOK(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
  private
    { Private declarations }
    HuboFaltaPapel, InverCant: Boolean;
    procedure SetHeaderTrailer;
  public
    { Public declarations }
    Epson: TEpson;
    procedure CancelarTodo;
    function InicializarControlador: Boolean;
    function UltimaFactura: Integer;
    function UltimoTicket: Integer;
    procedure Finalizar;
    procedure UltimosNroComprobantes(var Punto: St04; Mostrar: Boolean; TC: SmallInt; Var NC: St13);
    procedure SetDatos(Linea: Byte; S: String);
    procedure ImprimirEncabezado(Factura: TFactura);
    procedure Cerrar_Comprobante(DatosPago: TDatosPagos; Var Factura: TFactura; Cartel: St40);
    procedure CancelarFactura(NotaDeCredito: Boolean);
    procedure ImprimirLineaBorrada(Producto: TItemFiscal);
    procedure ImprimirLineaControlador(Producto: TItemFiscal; NotaCredito: Boolean);
    function ImprimirRemitoF(Var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
    procedure ImprimirRemitoNF(Factura: TFactura; ItemsFactura: TBody_Fiscal);
    function ImprimirReciboF(Var DatosPago: TDatosPagos; Items: TBody_Fiscal; Detalles1, Detalles2: String): Boolean;
    function ImprimirCotizacionF(Var Factura: TFactura; Items: TBody_Fiscal): Boolean;
    procedure AbrirCajon;
    procedure Imprimir_CajaCF(CajaD, CajaH: TDate; Montos: TDataSet);
    procedure ImprimirCobroCheque(IdFactura: Integer);
    procedure ImprimirCobroTarjeta(DatosPago: TDatosPagos);
    function ImprimirFactura_Servidor(Var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
    procedure ImprimirVoucher(NombreCliente, NombreTarjeta: String; Tipo: Integer; NumeroDeTarjeta: String;
              FechaDeVencimiento: TDate; TipoTarjeta: Integer; Cuotas: Integer; CodigoDeComercio: String;
              NumeroDeTerminal: Integer; NumeroDeLote: Integer; Numero: String; TipoIngreso, TipoOperacion: Integer;
              NumeroAutorizacion: LongInt; Monto, MontoCta: Currency; NumeroComprobanteAsociado: Integer; Copias: SmallInt);
    function Imprimir_Comprobante(Var Factura: TFactura; ItemsFactura: TBody_Fiscal; Var DatosPago: TDatosPagos): Boolean;
    //---------------------
    procedure ReporteZ;
    procedure ReporteX;
  end;

var
  frmFiscal: TfrmFiscal;
  Modelo_CF, TIvaH, TDocH: Integer;
  TIvaE, TDocE: String; 
  NroComp: St13;

implementation

{$R *.DFM}

uses uDemora, udmSaveFile;

Const
  FS = $1c;
  HasarAllCancel = #152;
  MaxLineaTipoFactura = 50;
  MaxLineaTipoTicket  = 20;

//---------------------------------------------------------------------------
// -------------------  Metodos del controlador  --------------------------
//---------------------------------------------------------------------------

procedure TfrmFiscal.CancelarTodo;
begin
  case IF_Modelo of
    1,2,3,8,9: Hasar.Enviar(HasarAllCancel);
        4,5,6: if CualTipoControlador = ControladorSoloTicket then
                 Epson.TratarDeCancelarTodoTkt
               else
                 Epson.TratarDeCancelarTodoTktFac;
  end;
  Finalizar;
end;

procedure TfrmFiscal.SetDatos(Linea: Byte; S: String);
begin
  case IF_Modelo of
    2,3,8,9: Hasar.Enviar(Chr($5d) + Chr(FS) + IntToStr(Linea) + Chr(FS) + S);
      4,5,6: Epson.SetHeader(Linea, S);
  end;
end;

procedure TfrmFiscal.SetHeaderTrailer;
const
  Del = $7f;
var
  Blanco: WideString;
begin
  try
    SetDatos( 1,String(Chr(Del)));
    SetDatos( 2,String(Chr(Del)));
    SetDatos( 3,String(Chr(Del)));
    SetDatos( 4,String(Chr(Del)));
    SetDatos( 5,String(Chr(Del)));
    SetDatos( 6,String(Chr(Del)));
    SetDatos( 7,String(Chr(Del)));
    SetDatos( 8,String(Chr(Del)));
    SetDatos( 9,String(Chr(Del)));
    SetDatos(10,String(Chr(Del)));
    SetDatos(11,String(Chr(Del)));
    SetDatos(12,String(Chr(Del)));
    SetDatos(13,String(Chr(Del)));
    SetDatos(14,String(Chr(Del)));
    SetDatos(15,String(Chr(Del)));
    SetDatos(16,String(Chr(Del)));
    SetDatos(17,String(Chr(Del)));
    SetDatos(18,String(Chr(Del)));
    SetDatos(19,String(Chr(Del)));
    SetDatos(20,String(Chr(Del)));
  except
  end;
  try
    with dmGestion do
    begin
      case IF_Modelo of
        1,2,3: begin
                 Hasar.ConfigurarControlador(IMPRESION_CAMBIO,'Su Vuelto');
                 SetDatos(3,qTerminalesDireccion.AsString + ' ' + qTerminalesLocalidad.AsString);
                 SetDatos(4,qTerminalesProvincia.AsString + ' ' + qTerminalesCodPostal.AsString);
                 Blanco := #0;
               end;
            4:begin
//                 SetDatos(3,qTerminalesDireccion.AsString);
//                 SetDatos(4,qTerminalesLocalidad.AsString + ' ' + qTerminalesProvincia.AsString + ' ' + qTerminalesCodPostal.AsString);
                 Blanco := '';
               end;
          5,6: begin
                 SetDatos(3,qTerminalesDireccion.AsString);
                 SetDatos(4,qTerminalesLocalidad.AsString + ' ' + qTerminalesProvincia.AsString + ' ' + qTerminalesCodPostal.AsString);
                 Blanco := '';
               end;
          8,9: begin
//                 SetDatos(3, qTerminalesDireccion.AsString + ' ' + qTerminalesLocalidad.AsString);
//                 SetDatos(4, qTerminalesProvincia.AsString + ' ' + qTerminalesCodPostal.AsString);
                 Blanco := #0;
               end;
      end;
      if Trim(qTerminalesTelefono.AsString) > Vacio then
        SetDatos(5,'Tel: ' + qTerminalesTelefono.AsString);
      if Trim(qTerminalesMailWeb.AsString) > Vacio then
        SetDatos(6,'Mail: ' + qTerminalesMailWeb.AsString);
    end;
  except
    raise EUsuario.Create('ERROR. Seteo de Encabezamiento');
  end
end;

function TfrmFiscal.InicializarControlador: Boolean;
var
  FantasyHasar1, FantasyHasar2: St20;
  FantasyEpson1, FantasyEpson2: St40;
  Largo, i: Integer;
begin
  Result := True;
  PtoVta := '0000';
  try
    ShowDemora('Inicializando...');
    with dmGestion do
    begin
      qTerminales.Close;
      qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
      qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
      qTerminales.Open;

      InverCant := qTerminalesInvertirCantidad.AsInteger = Verdadero;          //Invertir Cantidad x Precios
      IF_Modelo := qTerminalesModeloControlador.AsInteger;                     //Marca y modelo
      CualTipoControlador := qTerminalesTipoControlador.AsInteger;             //tipo solo Tkt, TF o Fact
      PtoVta := qTerminalesNroPtoVtaControlador.AsString;

      if IF_Modelo = 9 then
        IF_Modelo := 8;
      case IF_Modelo of
        2,3,7,8: begin //HASAR
          try
            Hasar.Puerto := qTerminalesPuertoControlador.AsInteger;
            Hasar.Modelo := IF_Modelo;
            FantasyHasar1 := '';
            FantasyHasar2 := '';
            try
              try
                Hasar.ReComenzar;
              except
                Hasar.Comenzar;
              end;
              Hasar.TratarDeCancelarTodo;
              ControladorOK := True;
              if (CualTipoControlador >= ControladorTipoFactura) then
                Hasar.DescripcionesLargas := True;
              if ControladorOK then
              begin
                UltimosNroComprobantes(PtoVta, False, 0, NroComp);
                SetHeaderTrailer;
                if qTerminalesFantasy1.AsString > Cero then
                begin
                  FantasyHasar1 := qTerminalesFantasy1.AsString;
                  FantasyHasar2 := qTerminalesFantasy2.Value;
                  if CualTipoControlador < ControladorTipoFactura then // Centrado para Tickets
                  begin
                    Largo := Length(FantasyHasar1);
                    Largo := (20 - Largo) div 2;
                    for i := 1 to Largo do
                      Insert(' ', FantasyHasar1, 1);
                    Largo := Length(FantasyHasar2);
                    Largo := (20 - Largo) div 2;
                    for i := 1 to Largo do
                      Insert(' ', FantasyHasar2, 1);
                  end;
                  if (FantasyHasar1 > Cero) and (FantasyHasar2 > Cero) then
                    Hasar.EspecificarNombreDeFantasia(#244 + FantasyHasar1, #244 + FantasyHasar2)
                  else begin
                    if (FantasyHasar1 > Cero) and (FantasyHasar2 = Cero) then
                      Hasar.EspecificarNombreDeFantasia(#244 + FantasyHasar1, ' ')
                    else
                      if (FantasyHasar1 = Cero) and (FantasyHasar2 > Cero) then
                        Hasar.EspecificarNombreDeFantasia(' ', #244 + FantasyHasar2)
                      else
                        Hasar.EspecificarNombreDeFantasia(' ', ' ');
                  end;
                end;
              end;
            except
              Result := False;
              raise;
            end;
          finally
            CloseDemora;
          end
        end;
        4,5,6: begin // EPSON
          try
            FantasyEpson1 := '';
            FantasyEpson2 := '';
            try
              Epson.Baudios := 9600;
              Epson.Puerto := qTerminalesPuertoControlador.AsInteger;
              Epson.Comenzar(CualTipoControlador);
              if CualTipoControlador = ControladorSoloTicket then
                Epson.TratarDeCancelarTodoTkt
              else
                Epson.TratarDeCancelarTodoTktFac;
              ControladorOK := True;
              UltimosNroComprobantes(PtoVta, False, 0, NroComp);
              SetHeaderTrailer;
              if Tipo_Factura then
                Epson.DescripcionesLargas := True;
              PtoVta := qTerminalesNroPtoVtaControlador.Value;
              if ControladorOK then
              begin
                if (CualTipoControlador >= ControladorTipoFactura) and (qTerminalesControladorConLogo.AsInteger = Verdadero) then
                  Epson.EspecificarNombreDeFantasia(' ', ' ')
                else
                begin
                  if qTerminalesFantasy1.AsString > Cero then
                  begin
                    FantasyEpson1 := qTerminalesFantasy1.AsString;
                    FantasyEpson2 := qTerminalesFantasy2.AsString;
                    if CualTipoControlador < ControladorTipoFactura then // Centrado para Tickets
                    begin
                      Largo := Length(FantasyEpson1);
                      Largo := (20 - Largo) div 2;
                      for i := 1 to Largo do
                        Insert(' ', FantasyEpson1, 1);

                      Largo := Length(FantasyEpson2);
                      Largo := (20 - Largo) div 2;
                      for i := 1 to Largo do
                        Insert(' ', FantasyEpson2, 1);
                    end;
                    Epson.EspecificarNombreDeFantasia('ö'+FantasyEpson1, 'ö'+FantasyEpson2);
                  end;
                end;
              end;
            except
              Result := False;
              raise;
            end;
          finally
            CloseDemora;
          end;
        end;
      end;
      IF_Modelo := qTerminalesModeloControlador.AsInteger;         //Marca y modelo
    end;
  finally
    CloseDemora;
  end;
end;

procedure TfrmFiscal.Finalizar;
begin
  case IF_Modelo of
  2,3,7,8,9: Hasar.Finalizar;
      4,5,6: Epson.Finalizar;
  end;
  ControladorOK := False;
  if ExisteDemora then
    CloseDemora;
end;

function TfrmFiscal.UltimaFactura: Integer;
begin
  Result := 0;
  case IF_Modelo of
  2,3,7,8,9: Result := Hasar.UltimaFactura;
      4,5,6: if CualTipoControlador > ControladorSoloTicket then
               Result := Epson.UltimaFactura;
  end;
end;

function TfrmFiscal.UltimoTicket: Integer;
begin
  Result := 0;
  case IF_Modelo of
  2,3,7,8,9: Result := Hasar.UltimoTicket;
      4,5,6: Result := Epson.UltimoTicket;
  end;
end;

procedure TfrmFiscal.UltimosNroComprobantes(var Punto: St04; Mostrar: Boolean; TC: SmallInt; Var NC: St13);
Const
  Leer_Contadores = $67;
var
  PuntoCF: St04;
  Comprobantes_A, Comprobantes_B, RemitosNFH_X, Comprobantes_T,
  NotaCredito_A, NotaCredito_B, RecibosNFH_X, NoFiscales: St13;
  (*
  Tipos de Controladores Fiscales
  ===============================
  ControladorSoloTicket = 1;
  ControladorTktFactura = 2;
  ControladorTipoFactura = 3;
  ControladorTipoEstacion = 4;
  5
  *)
begin
  if not ControladorOk then
    InicializarControlador;

  case IF_Modelo of
    1,2,3,7,8,9: begin //HASAR
      try
        Hasar.ObtenerDatosDeInicializacion;
        PuntoCF := Hasar.Respuesta[7];
      except
        PuntoCF := '9999';
      end;

      Hasar.Enviar(Chr(Leer_Contadores));
      try
        NoFiscales := Hasar.Respuesta[4];
      except
        NoFiscales := '00000000';
      end;

      Comprobantes_B := '00000000';
      Comprobantes_A := '00000000';
      NotaCredito_B  := '00000000';
      NotaCredito_A  := '00000000';
      RemitosNFH_X   := '00000000';
      RecibosNFH_X   := '00000000';
      Case CualTipoControlador of
        ControladorSoloTicket: begin
          Comprobantes_T := Hasar.Respuesta[6];
        end;
        ControladorTktFactura: begin
          Comprobantes_B := Hasar.Respuesta[6];
          Comprobantes_T := Hasar.Respuesta[6];
          Comprobantes_A := Hasar.Respuesta[7]
        end;
        ControladorTipoFactura: begin
          Comprobantes_B := Hasar.Respuesta[6];
          Comprobantes_T := Hasar.Respuesta[6];
          Comprobantes_A := Hasar.Respuesta[7];
          NotaCredito_B  := Hasar.Respuesta[13];
          NotaCredito_A  := Hasar.Respuesta[14];
          RemitosNFH_X   := Hasar.Respuesta[20];
          RecibosNFH_X   := '';
        end;
        ControladorTipoEstacion: begin
          Comprobantes_T := Hasar.Respuesta[6];
          Comprobantes_B := Hasar.Respuesta[6];
          Comprobantes_A := Hasar.Respuesta[7];
          NotaCredito_B  := Hasar.Respuesta[13];
          NotaCredito_A  := Hasar.Respuesta[14];
          RemitosNFH_X   := Hasar.Respuesta[20];
          RecibosNFH_X   := '';
        end;
        ControladorTktFact_NC: begin
          Comprobantes_T := Hasar.Respuesta[6];
          Comprobantes_B := Hasar.Respuesta[6];
          Comprobantes_A := Hasar.Respuesta[7];
          NotaCredito_B  := Hasar.Respuesta[13];
          NotaCredito_A  := Hasar.Respuesta[14];
          RemitosNFH_X   := Hasar.Respuesta[20];
        end;
      end;
    end;
    4: begin //NCR 3140
      try
        Epson.ObtenerDatosDeInicializacion;
        PuntoCF := Epson.Respuesta[2];
      except
        PuntoCF := '9999';
      end;
      Epson.EstadoContadores;
      if CualTipoControlador = ControladorTktFact_NC then
      begin
        Comprobantes_T := Epson.Respuesta[3];
        Comprobantes_B := Epson.Respuesta[3];
        Comprobantes_A := Epson.Respuesta[4];
        NotaCredito_B  := Epson.Respuesta[10];
        NotaCredito_A  := Epson.Respuesta[9];
        try
          NoFiscales := Epson.Respuesta[6];
        except
          NoFiscales := '00000000';
        end;
      end;
    end;
    5,
    6: begin
      try
        Epson.ObtenerDatosDeInicializacion;
        PuntoCF := Epson.Respuesta[2];
      except
        PuntoCF := '9999';
      end;
      Epson.EstadoContadores;
      Case CualTipoControlador of
        ControladorSoloTicket: begin
          Comprobantes_T := Epson.Respuesta[1];
        end;

        ControladorTktFactura: begin
          Comprobantes_B := Epson.Respuesta[3];
          Comprobantes_A := Epson.Respuesta[5];
          try
            NoFiscales := Epson.Respuesta[6];
          except
            NoFiscales := '00000000';
          end;
        end;
        ControladorTipoFactura: begin
          Comprobantes_T := Epson.Respuesta[3];
          Comprobantes_B := Epson.Respuesta[3];
          Comprobantes_A := Epson.Respuesta[5];
          NotaCredito_B  := Epson.Respuesta[10];
          NotaCredito_A  := Epson.Respuesta[9];
          try
            NoFiscales := Epson.Respuesta[6];
          except
            NoFiscales := '00000000';
          end;
        end;
      end;
    end;
  end;

  with dmGestion do
  begin
    try
      qTerminales.Close;
      qTerminales.Transaction := trProc;
      qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
      qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
      if not trProc.InTransaction then
        trProc.StartTransaction;
      qTerminales.Open;
      if not qTerminales.IsEmpty then
      begin
        try
          qTerminales.Edit;
          qTerminalesNroPtoVtaControlador.AsString := Format('%.4s', [PuntoCF]);
          Case CualTipoControlador of
            ControladorSoloTicket: begin
              qTerminalesCompB.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
              qTerminalesCompT.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
            end;
            ControladorTktFactura: begin
              qTerminalesCompA.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_A]);
              qTerminalesCompB.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
              qTerminalesCompT.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
              qTerminalesDNoFs.AsString := Format('%.4s-%.8s', [PuntoCF, NoFiscales]);
            end;
            ControladorTipoFactura: begin
              qTerminalesCompA.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_A]);
              qTerminalesNotCredA.AsString := Format('%.4s-%.8s', [PuntoCF, NotaCredito_A]);
              qTerminalesCompB.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
              qTerminalesNotCredB.AsString := Format('%.4s-%.8s', [PuntoCF, NotaCredito_B]);
              qTerminalesCompT.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
              qTerminalesDNoFs.AsString := Format('%.4s-%.8s', [PuntoCF, NoFiscales]);
              qTerminalesRemX.AsString  := Format('%.4s-%.8s', [PuntoCF, RemitosNFH_X]);
            end;
            ControladorTipoEstacion: begin
              qTerminalesCompA.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_A]);
              qTerminalesNotCredA.AsString := Format('%.4s-%.8s', [PuntoCF, NotaCredito_A]);
              qTerminalesCompB.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
              qTerminalesNotCredB.AsString := Format('%.4s-%.8s', [PuntoCF, NotaCredito_B]);
              qTerminalesCompT.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
              qTerminalesDNoFs.AsString := Format('%.4s-%.8s', [PuntoCF, NoFiscales]);
              qTerminalesRemX.AsString := Format('%.4s-%.8s', [PuntoCF, RemitosNFH_X]);
            end;
            ControladorTktFact_NC: begin
              qTerminalesCompA.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_A]);
              qTerminalesNotCredA.AsString := Format('%.4s-%.8s', [PuntoCF, NotaCredito_A]);
              qTerminalesCompB.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
              qTerminalesNotCredB.AsString := Format('%.4s-%.8s', [PuntoCF, NotaCredito_B]);
              qTerminalesCompT.AsString := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
              qTerminalesDNoFs.AsString := Format('%.4s-%.8s', [PuntoCF, NoFiscales]);
            end;
          end;
          qTerminales.Post;
          trProc.Commit;
        except
          trProc.Rollback;
          raise;
        end;
      end;
    finally
      qTerminales.Close;
      qTerminales.Transaction := trGestion;
      qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
      qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
      qTerminales.Open;
    end;
  end;

  Case TC of
    FacA, DebA, RecA: NC := Format('%.4s-%.8s', [PuntoCF, Comprobantes_A]);
    CreA: NC := Format('%.4s-%.8s', [PuntoCF, NotaCredito_A]);
    Tkt, FacB, DebB, RecB: NC := Format('%.4s-%.8s', [PuntoCF, Comprobantes_B]);
    CreB: NC := Format('%.4s-%.8s', [PuntoCF, NotaCredito_B]);
    ReciboX, Presupuesto: NC := Format('%.4s-%.8s', [PuntoCF, NoFiscales]);
    RemitoX, RemitoTraspaso: NC := Format('%.4s-%.8s', [PuntoCF, RemitosNFH_X]);
    else  NC := Format('%.4s-%.8s', [PuntoCF, '00000000']);
  end;

  if Mostrar then
  begin
    ShowMessage(' Punto de Venta = ' + PuntoCF + #13 + ' Nº Fiscales =    ' + NoFiscales + #13 +
                ' Comprobantes B = ' + Comprobantes_B + #13 + ' Comprobantes A = ' + Comprobantes_A + #13 +
                ' Notas de Cr. B = ' + NotaCredito_B + #13 + ' Notas de Cr. A = ' + NotaCredito_A + #13 +
                ' Remitos X      = ' + RemitosNFH_X + #13 + ' Recibos X      = ' + RecibosNFH_X + #13);
  end;
end;

procedure TfrmFiscal.ImprimirEncabezado(Factura: TFactura);
var
  CodNotaDeCredito: Integer;
  Cadena: String;
  q: TMDOQuery;
begin
  ComprobanteOk := False;
  CodNotaDeCredito := 0;
  Factura.NombreEnt := Up_CaseCF(Factura.NombreEnt);
  if Length(Trim(Factura.NombreEnt)) > 40 then
     Factura.NombreEnt := Copy(Factura.NombreEnt, 1, 40);
  if Factura.TipoDoc = CUIT then
    Factura.NroDocumento := StringReplace(Factura.NroDocumento, '-', '', [rfReplaceAll])
  else
    Factura.NroDocumento := StringReplace(Factura.NroDocumento, '.', '', [rfReplaceAll]);

  if Length(Trim(Factura.Direccion)) > 40 then
     Factura.Direccion := Copy(Factura.Direccion, 1, 40);
  Factura.Direccion := StringReplace(Factura.Direccion, 'º', '', [rfReplaceAll]);
  Factura.Direccion := StringReplace(Factura.Direccion, '-', '', [rfReplaceAll]);
  Factura.Direccion := StringReplace(Factura.Direccion, '/', '', [rfReplaceAll]);
  Factura.Direccion := Up_CaseCF(Factura.Direccion);

  if (Factura.TipoIva = RMT) and
     (IF_Modelo in [1, 3]) then //PR4 o 615
    Factura.TipoIva := NR;
  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := dmGestion.trProc;
    q.SQL.Add('Select NROHASAR, NROEPSON ');
    q.SQL.Add('From TIPODOC Where TIPODOC =:T');
    q.ParamByName('T').AsInteger := Factura.TipoDoc;
    q.Open;
    TDocH := q.Fields[0].AsInteger;
    TDocE := q.Fields[1].AsString;
  finally
    q.Free;
  end;

  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := dmGestion.trProc;
    q.SQL.Add('Select NROHASAR, NROEPSON ');
    q.SQL.Add('From TIPOIVA Where TIPOIVA =:T');
    q.ParamByName('T').AsInteger := Factura.TipoIva;
    q.Open;
    TIvaH := q.Fields[0].AsInteger;
    TIvaE := q.Fields[1].AsString;
  finally
    q.Free;
  end;

  case IF_Modelo of
    1,
    3:begin
        Hasar.kIVA := True;
        Hasar.PrecioBase := False;
        Hasar.ImpuestoInternoFijo := True;
        Hasar.ImpuestoInternoPorMonto := False;
        try
          ShowDemora('Abriendo Tkt de Ventas [3]');
          if (Factura.TipoFactura = Tkt) and (Factura.Entidad = Impersonal) then
          begin
            if Factura.NombreEnt > Cero then
              SetDatos(7, 'Cliente: '+Factura.NombreEnt)
            else
              SetDatos(7,'');
          end
          else begin
            SetDatos(10,' ');
            try
              SetDatos(10,Factura.Localidad + ' ' + Factura.Provincia);
              if Trim(Factura.NroDocumento) = Cero then
                Factura.NroDocumento := '00000000';
              Hasar.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH, Factura.Direccion);
            except
              SetDatos(10, Factura.Direccion);
              if Trim(Factura.NroDocumento) = Cero then
                Factura.NroDocumento := '00000000';
              Hasar.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH);
            end;
          end;
          SetDatos(12,' ');
          Hasar.AbrirComprobanteFiscal(DocumentoValido(IF_Modelo, Factura.TipoFactura));
        finally
          CloseDemora;
        end;
      end;
      2,
      7:begin  //715 / PR5
          Hasar.kIVA := True;
          Hasar.PrecioBase := False;
          Hasar.ImpuestoInternoFijo := True;
          Hasar.ImpuestoInternoPorMonto := False;
          if Trim(Factura.NroDocumento) = Vacio then
            Factura.NroDocumento := '00000000';
          if Trim(Factura.Direccion) = Vacio then
            Factura.Direccion := 'Argentina';
          SetDatos(4, '');
          SetDatos(10, ' ');
          SetDatos(13,' ');
          // notas de credito como DNF
          if Factura.TipoFactura in [CreA, CreB] then
          begin
            try
              ShowDemora('Abriendo Nota de Crédito ');
              CodNotaDeCredito := DocumentoValido(IF_Modelo, Factura.TipoFactura);
              if CodNotaDeCredito > NoEncontrado then
              begin
                Hasar.Modelo := 3; //Setea a PR4
                try
                  // Datos Cliente
                  Cadena := Chr(98) +Chr(FS)+ Factura.NombreEnt +Chr(FS)+ Factura.NroDocumento +Chr(FS)+
                            Chr(TIvaH) +Chr(FS)+
                            Chr(TDocH) +Chr(FS)+ Copy(Factura.Direccion, 1, 40);
                  Hasar.Enviar(Cadena);
                except
                  raise EUsuario.Create('Error en Datos del Cliente.');
                end;
                try
                  Cadena := '';
                  // Comprobante al cual hace ref. la N.de C.
                  Cadena := Chr(147) +Chr(28)+ '1' +Chr(28)+ '00000001'; //Factura.CompRef;
                  Hasar.Enviar(Cadena);
                except
                  raise EUsuario.Create('Error en Comprobante de referencia.');
                end;
                try
                  Cadena := '';
                  //Abrir DFNH
                  Cadena := Chr(128) +Chr(28)+ Chr(CodNotaDeCredito) +Chr(28)+ 'S';
                  Hasar.Enviar(Cadena);
                  Cadena := '';
                except
                  raise EUsuario.Create('Error al abrir NC ');
                end;
              end;
            finally
              CloseDemora;
            end;
          end
          else begin
            if Factura.TipoFactura in [DebA, DebB] then
            begin
              ShowDemora('Abriendo Nota de Débitos ');
              Hasar.DatosCliente(IntToStr(Factura.Entidad)+' '+
                                 Factura.NombreEnt,
                                 Factura.NroDocumento,
                                 TDocH, TIvaH,
                                 Factura.Direccion);
              Hasar.AbrirComprobanteFiscal(DocumentoValido(IF_Modelo, Factura.TipoFactura));
            end
            else begin // comprobante de Ventas
              try
                Hasar.Modelo := 3;
                ShowDemora('Abriendo Tkt de Ventas');
                if (Factura.TipoFactura = Tkt) and
                   (Factura.Entidad = Impersonal) then
                begin
                  if Factura.NombreEnt > Vacio then
                    SetDatos(7, 'Cliente: '+Factura.NombreEnt)
                  else
                    SetDatos(7, ' ');
                  SetDatos(12,' ');
                  Hasar.AbrirComprobanteFiscal(DocumentoValido(IF_Modelo, Factura.TipoFactura));
                end
                else begin
                  SetDatos( 7,' ');
                  SetDatos(10,' ');
                  try
                     SetDatos(10,Factura.Localidad + ' ' + Factura.Provincia);
                    if Trim(Factura.NroDocumento) = Cero then
                      Factura.NroDocumento := '00000000';
                    Cadena := Chr(98) +Chr(FS)+
                              Factura.NombreEnt +Chr(FS)+
                              Factura.NroDocumento +Chr(FS)+
                              Chr(TIvaH) +Chr(FS)+
                              Chr(TDocH) +Chr(FS)+
                              Copy(Factura.Direccion, 1, 40);
                    Hasar.Enviar(Cadena);
                  except
                    on E:Exception do
                      Raise EUsuario.Create(E.Message);
                  end;
                  SetDatos(12,' ');
                  Hasar.AbrirComprobanteFiscal(DocumentoValido(IF_Modelo,
                                               Factura.TipoFactura));
                end;
              finally
                Hasar.Modelo := 2;
                CloseDemora;
              end;
            end;
          end;
        end;
    8:begin
        Hasar.kIVA := True;
        Hasar.PrecioBase := False;
        Hasar.ImpuestoInternoFijo := True;
        Hasar.ImpuestoInternoPorMonto := False;
        if Trim(Factura.NroDocumento) = Vacio then
          Factura.NroDocumento := '00000000';
        if Trim(Factura.Direccion) = Vacio then
          Factura.Direccion := 'Argentina';
        try
          SetDatos(4, '');
          SetDatos(10, ' ');
          SetDatos(13,' ');
          if Factura.TipoFactura in [CreA, CreB] then   // notas de credito, si es Tipo_Factura como DNFH, si no com DNF
          begin
            ShowDemora('Abriendo Nota de Crédito [8]');
            CodNotaDeCredito := DocumentoValido(IF_Modelo, Factura.TipoFactura);
            if CodNotaDeCredito > NoEncontrado then
            begin
              Hasar.DatosCliente(IntToStr(Factura.Entidad)+' '+Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH, Factura.Direccion);
              Hasar.Enviar(Chr(147)+Chr(28)+'1'+Chr(28)+Factura.CompRef); // Comprobante al cual hace ref. la N.de C.
              try
                Hasar.AbrirComprobanteNoFiscalHomologado(CodNotaDeCredito);
              except
                on E:Exception do
                begin
                  EUSuario.Create('Error: '+E.Message);
                end;
              end;
            end
            else begin
              raise EUsuario.Create('Error: Documento NC no definido para el modelo ('+IntToStr(IF_Modelo)+') de controlador');
            end;
          end
          else begin
            if Factura.TipoFactura in [DebA, DebB] then
            begin
              ShowDemora('Abriendo Nota de Débitos [8]');
              Hasar.DatosCliente(IntToStr(Factura.Entidad)+' '+Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH, Factura.Direccion);
              Hasar.AbrirComprobanteFiscal(DocumentoValido(IF_Modelo, Factura.TipoFactura));
            end
            else begin // comprobante de Ventas
              ShowDemora('Abriendo Factura de Venta [8]');
              if Factura.DomicilioE <> VACIO then
                SetDatos(4, 'ENTREGAR EN: '+ Factura.DomicilioE)
              else
                SetDatos(4, 'RETIRA EN LOCAL.- ');
              Hasar.DatosCliente(IntToStr(Factura.Entidad)+' '+Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH, Factura.Direccion);
              Hasar.AbrirComprobanteFiscal(DocumentoValido(IF_Modelo, Factura.TipoFactura));
            end;
          end;
        finally
          CloseDemora;
        end;
      end;
    9:begin
        Hasar.Modelo := 8;
        Hasar.kIVA := True;
        Hasar.PrecioBase := False;
        Hasar.ImpuestoInternoFijo := True;
        Hasar.ImpuestoInternoPorMonto := False;
        try
          SetDatos(10, ' ');
          if Factura.TipoFactura in [CreA, CreB] then   // notas de credito, si es Tipo_Factura como DNFH, si no com DNF
          begin
            ShowDemora('Abriendo Nota de Creditos en Slip.[9]');
            CodNotaDeCredito := DocumentoValido(IF_Modelo, Factura.TipoFactura);
            if CodNotaDeCredito > NoEncontrado then
            begin
              try
                if Trim(Factura.NroDocumento) = '' then
                  Factura.NroDocumento := '00000000';
                Hasar.DatosCliente(IntToStr(Factura.Entidad)+' '+Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH, Factura.Direccion);
                Hasar.Enviar(Chr(147)+Chr(28)+'1'+Chr(28)+Factura.CompRef); // Comprobante al cual hace ref. la N.de C.
                Hasar.AbrirComprobanteNoFiscalHomologado(CodNotaDeCredito);
              except
                Hasar.TratarDeCancelarTodo;
                Hasar.DatosCliente(IntToStr(Factura.Entidad)+' '+Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH, Factura.Direccion);
                Hasar.Enviar(Chr(147)+Chr(28)+'1'+Chr(28)+Factura.CompRef); // Comprobante al cual hace ref. la N.de C.
                Hasar.AbrirComprobanteNoFiscalHomologado(CodNotaDeCredito);
              end;
            end;
          end
          else begin
            // comprobante de Ventas
            Case Factura.TipoCompCli of
              En_Ticket: begin
                           ShowDemora('Abriendo Comprobante en Ticket [9]');
                           Modelo_CF := 3;
                         end;
              En_Slip:   begin
                           ShowDemora('Abriendo Comprobante en Slip [9]');
                           Modelo_CF := 8;
                         end;
            end;
            SetDatos( 7, ' ');
            if (Factura.TipoFactura = Tkt) and (Factura.Entidad = Impersonal) then
            begin
              if Factura.NombreEnt > Cero then
                SetDatos( 7, 'Cliente: '+Factura.NombreEnt)
              else
                SetDatos( 7, ' ');
            end
            else begin
              try
                SetDatos(10,' ');
                try
                  if Trim(Factura.NroDocumento) = Cero then
                    Factura.NroDocumento := '00000000';
                  Hasar.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH, Factura.Direccion);
                except
                  if Trim(Factura.NroDocumento) = Cero then
                    Factura.NroDocumento := '00000000';
                  SetDatos(10, Factura.Direccion);
                  Hasar.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH);
                end;
              except
                Hasar.TratarDeCancelarTodo;
                SetDatos(10,' ');
                try
                  Hasar.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH, Factura.Direccion);
                except
                  SetDatos(10, Factura.Direccion);
                  Hasar.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH);
                end;
              end;
            end;

            Case Modelo_CF of
              3:case Factura.TipoFactura of
                  FacA: Cadena := Chr($40) + Chr(FS) + 'A' + Chr(FS) + 'T';
                  FacB: Cadena := Chr($40) + Chr(FS) + 'B' + Chr(FS) + 'T';
                  DebA: Cadena := Chr($40) + Chr(FS) + 'D' + Chr(FS) + 'T';
                  DebB: Cadena := Chr($40) + Chr(FS) + 'C' + Chr(FS) + 'T';
                  Tkt : Cadena := Chr($40) + Chr(FS) + 'T' + Chr(FS) + 'T';
                end;
              8:case Factura.TipoFactura of
                  FacA: Cadena := Chr($40) + Chr(FS) + 'A' + Chr(FS) + 'S';
                  FacB: Cadena := Chr($40) + Chr(FS) + 'B' + Chr(FS) + 'S';
                  DebA: Cadena := Chr($40) + Chr(FS) + 'D' + Chr(FS) + 'S';
                  DebB: Cadena := Chr($40) + Chr(FS) + 'C' + Chr(FS) + 'S';
                  Tkt : Cadena := Chr($40) + Chr(FS) + 'T' + Chr(FS) + 'S';
                end;
            end;
            Hasar.Enviar(Cadena);
          end;
        finally
          CloseDemora;
        end;
      end;
    4:begin // NCR 3140
        if Factura.TipoFactura in [CreA, CreB] then   // notas de credito como DNFH
        begin
          try
            ShowDemora('Abriendo Nota de Creditos.');
            Epson.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, Factura.TipoDoc, Factura.TipoIva, Factura.Direccion);
            // Comprobante al cual hace ref. la N.de C.
            Epson.InformacionRemito[1] := Factura.CompRef;
            Case Factura.TipoFactura of
              CreA: Epson.InformacionRemito[2]:= 'A';
              CreB: Epson.InformacionRemito[2]:= 'B';
            end;
            Epson.AbrirComprobanteNoFiscalHomologado;
          finally
            CloseDemora;
          end;
        end
        else begin  // comprobante de Ventas
          try
            ShowDemora('Abriendo Comprobante.');
            SetDatos(10,'');
            if (Factura.TipoFactura = Tkt) and
               (Factura.Entidad = Impersonal) then
            begin
              if Factura.NombreEnt > Cero then
                SetDatos(10, 'ó'+'Cliente: '+Factura.NombreEnt)
              else
                SetDatos(10, ' ');
            end
            else begin
              SetDatos(10, Factura.Localidad +' '+ Factura.Provincia);
              Epson.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, Factura.TipoDoc, Factura.TipoIva, Factura.Direccion);
            end;
            Epson.AbrirComprobanteFiscal(DocumentoValido(IF_Modelo, Factura.TipoFactura));
          finally
            CloseDemora;
          end;
        end;
      end;
    5:begin
        try
          ShowDemora('Abriendo Ticket.');
          SetDatos(10,'');
          if (Factura.TipoFactura = Tkt) and (Factura.Entidad = Impersonal) then
          begin
            if Factura.NombreEnt > Cero then
              SetDatos(10, 'ó'+'Cliente: '+Factura.NombreEnt)
            else
              SetDatos(10, ' ');
          end
          else begin
            SetDatos(10, Factura.Localidad +' '+ Factura.Provincia);
            Epson.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, Factura.TipoDoc, Factura.TipoIva, Factura.Direccion);
          end;
          Epson.AbrirComprobanteFiscal(DocumentoValido(IF_Modelo, Factura.TipoFactura));
        finally
          CloseDemora;
        end;
      end;
    6:begin
        try
          if Factura.TipoFactura in [CreA, CreB] then   // notas de credito como DNFH
          begin
            ShowDemora('Abriendo Nota de Creditos.');
            CodNotaDeCredito := DocumentoValido(IF_Modelo, Factura.TipoFactura);
            Epson.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, Factura.TipoDoc, Factura.TipoIva, Factura.Direccion);
            Epson.InformacionRemito[1]:= Factura.CompRef; // Comprobante al cual hace ref. la N.de C.
            Epson.AbrirComprobanteNoFiscalHomologado;
          end
          else begin  // comprobante de Ventas
            ShowDemora('Abriendo Comprobante.');
            if Factura.TipoFactura = Tkt then
            begin
              if Factura.NombreEnt > Cero then
                SetDatos(10, 'ó'+'Cliente: '+Factura.NombreEnt);
            end
            else begin
              Epson.DatosCliente(Factura.NombreEnt, Factura.NroDocumento, Factura.TipoDoc, Factura.TipoIva, Factura.Direccion);
            end;
            Epson.AbrirComprobanteFiscal(DocumentoValido(IF_Modelo, Factura.TipoFactura));
          end;
        finally
          CloseDemora;
        end;
      end;
  end;
end;

procedure TfrmFiscal.ImprimirLineaControlador(Producto: TItemFiscal; NotaCredito: Boolean);
var
  KIva, TAV: Double;
  D1, R1, R2, R3, R0, PrecioCero: Currency;
  Cadena, DetalleProducto, Part1, Part2: String;
  i, j, Entero, Decimal: Integer;
begin
  if IF_Modelo = 9 then
  begin
    Case Factura.TipoCompCli of
      En_Ticket: begin
        if NotaCredito then
          Modelo_CF := 8
        else
          Modelo_CF := 3;
      end;
      En_Slip  : Modelo_CF := 8;
    end;
    PrecioCero := PrcItmCero425;
  end
  else begin
    Modelo_CF := IF_Modelo;
    PrecioCero := PrcItmCero;
  end;

  with Producto do
  begin
    Marca   := Trim(Up_CaseCF(Marca));
    Detalle := Trim(Up_CaseCF(Detalle));
    Color := Trim(Up_CaseCF(Color));
    if not ControladorOK then
      Abort;
    if ComprobanteOk then
      Abort;
    try
      if ExisteDemora then
        ShowDemora('Imprimiendo Items.');

      case Modelo_CF of
        // HASAR/OLIVETI
        1,
        3:begin  // 3= HASAR u OLIVETI PR4F
            Hasar.Modelo := Modelo_CF;
            try
              kIva := 1/(1 + (NoComputable/PrecioNetoT));
            except
              kIva := 1/(1 + NoComputable);
            end;

            if Combustible = True then
            begin // --------Combustibles ------------------------------
              DetalleProducto := Trim(Marca + ' ' + Detalle);
              Hasar.ImprimirTextoFiscal(Format('%m %8.2f %10s', [PrecioFinal+(Descuento/Cantidad), Cantidad, Color]));
              Hasar.ImprimirItem (Marca, Redondeo(PrecioFinal + (Descuento/Cantidad), 4), Redondeo(Cantidad, 2), AlicuotaIva, kIva);
              if Bonificacion > 0 then
                Hasar.DescuentoUltimoItem(Format('%7.2f', [Bonificacion])+'%', Redondeo(Descuento,2), True);
            end
            else begin
              if Length(Marca+' '+Detalle) > MaxLineaTipoTicket then
              begin
                Hasar.ImprimirTextoFiscal(Detalle);
                DetalleProducto := Marca+' '+Color;
              end
              else
                DetalleProducto := Marca+' '+Detalle;

              if InverCant then
              begin
                Hasar.ImprimirItem(DetalleProducto, Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), Redondeo(Cantidad, 2), AlicuotaIva, KIva)
              end
              else begin
                (*
                if PrecioFinal <= PrcItmCero then
                begin
                  try
                    Hasar.ImprimirItem(Marca + ' Promoción', Cantidad, PrecioCero, AlicuotaIva, KIva)
                  except
                    Hasar.ImprimirItem(Marca + 'Promoción', Redondeo(PrecioCero, 2), Redondeo(Cantidad, 2), AlicuotaIva, KIva)
                  end;
                end
                else
                *)
                Hasar.ImprimirItem(DetalleProducto, Redondeo(Cantidad, 2), Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), AlicuotaIva, KIva);
              end;
              if Bonificacion <> 0 then
                Hasar.DescuentoUltimoItem(Format('Bonificacion %7.2f', [Bonificacion])+'%', Redondeo(Descuento,2), True);
            end;
          end;
        2,       // HASAR 715
        7:begin  // HASAR SPR5F
            Hasar.Modelo := 3;
            try
              kIva := 1/(1 + (NoComputable/PrecioNetoT));
            except
              kIva := 1/(1 + NoComputable);
            end;

            if Length(Marca+' '+Detalle) > MaxLineaTipoTicket then
            begin
              Hasar.ImprimirTextoFiscal(Detalle);
              DetalleProducto := Marca+' '+Color;
            end
            else
              DetalleProducto := Marca+' '+Detalle;

            if NotaCredito then
            begin
              if InverCant then
                Hasar.ImprimirItem(DetalleProducto, Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), Redondeo(Cantidad, 2), AlicuotaIva, KIva)
              else
                Hasar.ImprimirItem(DetalleProducto, Redondeo(Cantidad, 2), Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), AlicuotaIva, KIva);
              if Bonificacion <> 0 then
                Hasar.DescuentoUltimoItem(Format('Bonificacion %7.2f', [Bonificacion])+'%', Descuento, True);
            end
            else begin //Comprobante de Ventas
              if InverCant then
                Hasar.ImprimirItem(DetalleProducto, Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), Redondeo(Cantidad, 2), AlicuotaIva, KIva)
              else
                Hasar.ImprimirItem(DetalleProducto, Redondeo(Cantidad, 2), Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), AlicuotaIva, KIva);
              if Bonificacion <> 0 then
              begin
                Entero := Trunc(Int(Redondeo(Descuento,2)));
                Decimal := Trunc(Frac(Redondeo(Descuento,2)) * 100);
                Cadena := Chr(85)+Chr(FS)+Format('Bonif %7.2f', [Bonificacion])+'%'+Chr(FS)+IntToStr(Entero)+'.'+IntTostr(Decimal)+Chr(FS)+'m'+Chr(FS)+'0'+Chr(FS)+'T';
                Hasar.Enviar(Cadena);
              end;
              (*
              Hasar.DescuentoUltimoItem(Format('Bonificacion %7.2f', [Bonificacion])+'%', Descuento, True);
              *)
            end;
          end;
        8:begin // HASAR u OLIVETTI PL8F ó M320 ó PJ20F
            Hasar.Modelo := Modelo_CF;
            try
              kIva := 1/(1 + (NoComputable/PrecioNetoT));
            except
              kIva := 1/(1 + NoComputable);
            end;

            if NotaCredito then
            begin
              if Combustible = True then
              begin
                DetalleProducto := Trim(CodySal+' '+Marca + ' ' + Detalle);
                Hasar.ImprimirTextoFiscal(Marca + ' '+ Detalle + ' ' + FloatToStrF(Cantidad, ffCurrency, 6, 2) + ' ' + FloatToStrF(PrecioTotal, ffFixed, 10, CentavosP));
                Hasar.ImprimirItem(DetalleProducto, Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), Cantidad, AlicuotaIva, KIva);
              end
              else begin
                if DetalleExtendido then  // Cuatro Lineas de Detalle
                begin
                  for i := 1 to 4 do
                    if Trim(DetalleExt[i]) > Cero then
                      Hasar.ImprimirTextoFiscal(DetalleExt[i]);
                end;

                if Trim(SubDet) > Vacio then
                try
                  Hasar.ImprimirTextoFiscal(SubDet);
                except
                end;

                if Length(CodySal+' '+Marca+' '+Detalle+' '+Color) > MaxLineaTipoFactura then
                begin
                  DetalleProducto := CodySal+' '+Marca+' '+Color;
                  try
                    Hasar.ImprimirTextoFiscal(Detalle);
                  except
                  end;
                end
                else
                  DetalleProducto := CodySal+' '+Marca+' '+Detalle+' '+Color;
                if InverCant then
                  Hasar.ImprimirItem(DetalleProducto, Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), Redondeo(Cantidad, 2), AlicuotaIva, KIva)
                else begin

                  (*
                  if PrecioFinal <= PrcItmCero then
                  begin
                    try
                      Hasar.ImprimirItem(DetalleProducto + ' Promoción', Producto.Cantidad, PrecioCero, Producto.AlicuotaIva, KIva)
                    except
                      Hasar.ImprimirItem(DetalleProducto + ' Promoción', PrecioCero, Producto.Cantidad, Producto.AlicuotaIva, KIva)
                    end;
                  end
                  else
                  *)

                  Hasar.ImprimirItem(DetalleProducto, Redondeo(Abs(Cantidad), 2),
                                     Redondeo(Abs(PrecioFinal)+(Abs(Descuento/Cantidad)),
                                     CentavosP), AlicuotaIva, KIva);
                end;
                if Bonificacion <> 0 then
                  Hasar.DescuentoUltimoItem(Format('%7.2f', [Bonificacion])+'%',
                                            Redondeo(Descuento,2), True);
              end;
            end
            else begin //Comprobante de Ventas
              if Combustible = True then // --------Combustibles ------------------------------
              begin
                DetalleProducto := Trim(Marca + ' ' + Detalle);
                Hasar.ImprimirTextoFiscal(Format('%m %8.2f %10s', [PrecioFinal+(Descuento/Cantidad), Cantidad, Color]));
                Hasar.ImprimirItem(DetalleProducto, Redondeo(PrecioFinal+(Descuento/Cantidad), 2), Cantidad, AlicuotaIva, kIva);
                if Bonificacion > 0 then
                  Hasar.DescuentoUltimoItem(Format('Bonificacion %7.2f', [Bonificacion])+'%', Redondeo(Descuento,2), True);
              end
              else begin
                if DetalleExtendido then  // Cuatro Lineas de Detalle
                begin
                  for i := 1 to 4 do
                    if Trim(DetalleExt[i]) > Cero then
                      Hasar.ImprimirTextoFiscal(DetalleExt[i]);
                end;

                if Trim(SubDet) > Vacio then
                try
                  Hasar.ImprimirTextoFiscal(SubDet);
                except
                end;

                if Length(CodySal+' '+Marca+' '+Detalle+' '+Color) > MaxLineaTipoFactura then
                begin
                  DetalleProducto := CodySal+' '+Marca+' '+Color;
                  try
                    Hasar.ImprimirTextoFiscal(Detalle);
                  except
                  end;
                end
                else
                  DetalleProducto := CodySal+' '+Marca+' '+Detalle+' '+Color;

                // Items
                if InverCant then
                  Hasar.ImprimirItem(DetalleProducto, Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), Redondeo(Cantidad, 2), AlicuotaIva, KIva)
                else
                  Hasar.ImprimirItem(DetalleProducto, Redondeo(Cantidad, 2), Redondeo(PrecioFinal+(Descuento/Cantidad), CentavosP), AlicuotaIva, KIva);

                if Bonificacion > 0 then
                  Hasar.DescuentoUltimoItem(Format('Bonificacion %7.2f', [Bonificacion])+'%', Redondeo(Descuento,2), True);

                  (*
                  begin
                  if PrecioFinal <= PrcItmCero then
                  begin
                    try
                      Hasar.ImprimirItem(DetalleProducto + ' Promoción', Producto.Cantidad, PrcItmCero, Producto.AlicuotaIva, KIva)
                    except
                      Hasar.ImprimirItem(DetalleProducto + ' Promoción', PrcItmCero, Producto.Cantidad, Producto.AlicuotaIva, KIva)
                    end;
                  end
                  else begin
                  end;
                  *)

              end;
            end;
          end;
          // EPSON
        4:begin // Controlador Epson AF2002+  NCR 3140
            if Length(Marca+' '+Detalle+' '+Color) > MaxLineaTipoTicket then
            begin
              if Length(Detalle) > MaxLineaTipoTicket then
              begin
                i := 20;  j := 0;
                while i > 1 do
                begin
                  if Detalle[i] > ' ' then
                    Dec(i)
                  else begin
                    j := i;
                    Break
                  end;
                end;
                Part1 := Copy(Detalle, 1, j);
                Part2 := Copy(Detalle, j+1, Length(Detalle));
              end
              else begin
                Part1 := Detalle;
                Part2 := '';
              end;
               DetalleProducto := Marca+' '+Color;
            end
            else
              DetalleProducto := Marca+' '+Detalle+' '+Color;

            if Bonificacion > 0 then
            begin
              if NoComputable = 0 then
                R0 := 0
              else
                R0 := 1/(1+(NoComputable/PrecioNetoT));
              case TIvaEnt of
                RI, RNI, NC: begin
                  D1 := Redondeo((Descuento/((1+(AlicuotaIva/100))))/Cantidad, 2);
                  R1 := Redondeo((PrecioNetoU + D1), 2);
                  if NoComputable <> 0 then
                    R2 := (1/1+(NoComputable/(PrecioNetoU - ((R0 * Bonificacion) / 100))))
                  else
                    R2 := 0;
                  R3 := Redondeo((Descuento/(1+(AlicuotaIva/100))), 2);
                  Epson.ImprimirItem(DetalleProducto, Cantidad, R1, AlicuotaIva, NoComputable, Part1, Part2);
                  Epson.DescuentoUltimoItem(Format(' %7.2f', [Bonificacion])+'%', R3, True);
                end;
                CFi, EX, RMT, BU, NR: begin
                  D1 := Redondeo((Descuento/Cantidad), 2);
                  //R1 := Redondeo(PrecioFinal + D1, 2);
                  R1 := Redondeo(PrecioFinal, 2);
                  if NoComputable <> 0 then
                    R2 := (1/1+(NoComputable / (PrecioNetoU - ((R0 * Bonificacion) / 100))))
                  else
                    R2 := 0;
                  R3 := Redondeo(Descuento, 2);
                  Epson.ImprimirItem(DetalleProducto, Cantidad, R1, AlicuotaIva, NoComputable, Part1, Part2);
                  //Epson.DescuentoUltimoItem(Format('%7.2f', [Bonificacion])+'%', R3, True);
                end;
              end;
            end
            else begin
              D1 := 0;
              if NoComputable = 0 then
                R0 := 0
              else
                R0 := 1/(1+(NoComputable / PrecioNetoT));
              case TIvaEnt of
                RI, RNI, NC: begin
                  Epson.ImprimirItem(DetalleProducto, Cantidad, Redondeo(PrecioNetoU, 2), AlicuotaIva, NoComputable{R0}, Part1, Part2);
                end;
                CFi, EX, RMT, BU, NR: begin
                  Epson.ImprimirItem(DetalleProducto, Cantidad, Redondeo(PrecioFinal, 2), AlicuotaIva, NoComputable{R0}, Part1, Part2);
                end;
              end;
            end;
          end;
        //-------------------------------------------------------------------
        5:begin  //EPSON AF2000/+
            if Length(Marca+' '+Detalle+' '+Color) > MaxLineaTipoTicket then
            begin
              if Length(Detalle) > MaxLineaTipoTicket then
              begin
                i := 20;  j := 0;
                while i > 1 do
                begin
                  if Detalle[i] > ' ' then
                    Dec(i)
                  else begin
                    j := i;
                    Break
                  end;
                end;
                Part1 := Copy(Detalle, 1, j);
                Part2 := Copy(Detalle, j+1, Length(Detalle));
              end
              else begin
                Part1 := Detalle;
                Part2 := '';
              end;
               DetalleProducto := Marca+' '+Color;
            end
            else
              DetalleProducto := Marca+' '+Detalle+' '+Color;

            if Bonificacion > 0 then
            begin
              if NoComputable = 0 then
                R0 := 0
              else
                R0 := 1/(1+(NoComputable/PrecioNetoT));
              case TIvaEnt of
                RI, RNI, NC: begin
                  D1 := Redondeo((Descuento/((1+(AlicuotaIva/100))))/Cantidad, 2);
                  R1 := Redondeo((PrecioNetoU + D1), 2);
                  if NoComputable <> 0 then
                    R2 := (1/1+(NoComputable/(PrecioNetoU - ((R0 * Bonificacion) / 100))))
                  else
                    R2 := 0;
                  R3 := Redondeo((Descuento/(1+(AlicuotaIva/100))), 2);
                  Epson.ImprimirItem(DetalleProducto, Cantidad, R1, AlicuotaIva, NoComputable, Part1, Part2);
                  Epson.DescuentoUltimoItem(Format(' %7.2f', [Bonificacion])+'%', R3, True);
                end;
                CFi, EX, RMT, BU, NR: begin
                  D1 := Redondeo((Descuento/Cantidad), 2);
                  //R1 := Redondeo(PrecioFinal + D1, 2);
                  R1 := Redondeo(PrecioFinal, 2);
                  if NoComputable <> 0 then
                    R2 := (1/1+(NoComputable / (PrecioNetoU - ((R0 * Bonificacion) / 100))))
                  else
                    R2 := 0;
                  R3 := Redondeo(Descuento, 2);
                  Epson.ImprimirItem(DetalleProducto, Cantidad, R1, AlicuotaIva, NoComputable, Part1, Part2);
                  //Epson.DescuentoUltimoItem(Format('%7.2f', [Bonificacion])+'%', R3, True);
                end;
              end;
            end
            (*
            if Bonificacion > 0 then
            begin
              if NoComputable = 0 then
                R0 := 0
              else
                R0 := 1/(1+(NoComputable/PrecioNeto));
              case TIvaEnt of
                RI, RNI, NC: begin
                  D1 := Redondeo((Descuento/((1+(AlicuotaIva/100))))/Cantidad, 2);
                  R1 := Redondeo((PrecioNetoU + D1), 2);
                  if NoComputable <> 0 then
                    R2 := (1/1+(NoComputable/(PrecioNetoU - ((R0 * Bonificacion) / 100))))
                  else
                    R2 := 0;
                  R3 := Redondeo((Descuento/(1+(AlicuotaIva/100))), 2);
                  Epson.ImprimirItem(DetalleProducto, Cantidad, R1, AlicuotaIva, NoComputable{R2}, Part1, Part2);
                  Epson.DescuentoUltimoItem(Format(' %7.2f', [Bonificacion])+'%', R3, True);
                end;
                CFi, EX, RMT, BU, NR: begin
                  D1 := Redondeo((Descuento/Cantidad), 2);
                  R1 := Redondeo(PrecioFinal + D1, 2);
                  if NoComputable <> 0 then
                    R2 := (1/1+(NoComputable / (PrecioNetoU - ((R0 * Bonificacion) / 100))))
                  else
                    R2 := 0;
                  R3 := Redondeo(Descuento, 2);
                  Epson.ImprimirItem(DetalleProducto, Cantidad, R1, AlicuotaIva, NoComputable{R2}, Part1, Part2);
                  Epson.DescuentoUltimoItem(Format('%7.2f', [Bonificacion])+'%', R3, True);
                end;
              end;
            end
            *)
            else begin
              D1 := 0;
              if NoComputable = 0 then
                R0 := 0
              else
                R0 := 1/(1+(NoComputable / PrecioNetoT));
              case TIvaEnt of
                RI, RNI, NC: begin
                  Epson.ImprimirItem(DetalleProducto, Cantidad, Redondeo(PrecioNetoU, 2), AlicuotaIva, NoComputable{R0}, Part1, Part2);
                end;
                CFi, EX, RMT, BU, NR: begin
                  Epson.ImprimirItem(DetalleProducto, Cantidad, Redondeo(PrecioFinal, 2), AlicuotaIva, NoComputable{R0}, Part1, Part2);
                end;
              end;
            end;
          end;
          //---------------------------------------------------------
        6:begin
            // LX-300F no implementado
            TAV := 0;
            case TIvaEnt of
              RI, RNI, NC: begin
                try
                  TAV := PrecioNetoT /(PrecioNetoT + NoComputable);
                except
                  TAV := 0;
                end;
              end;
              CFi, EX, RMT, BU, NR: begin
                try
                  TAV := ((PrecioFinal * (AlicuotaIva/100))/(1+(AlicuotaIva/100)))/PrecioFinal;
                except
                  TAV := 0;
                end;
              end;
            end;
            
            if Combustible = True then
            begin
              Epson.ImprimirTextoFiscal(Marca);
              Epson.ImprimirTextoFiscal(Detalle);
              Epson.ImprimirItem(Format('%10.2f %-15s',[Cantidad, Color]), Redondeo(PrecioFinal + (Descuento/Cantidad), CentavosP), Cantidad, AlicuotaIva, TAV)
            end
            else begin
              if Length(Marca+' '+Detalle) > MaxLineaTipoFactura then
              begin
                Epson.ImprimirTextoFiscal(Detalle);
                DetalleProducto := Marca+' '+Color;
              end
              else begin
                DetalleProducto := Marca+' '+Detalle+' '+Color;
              end;
              Epson.ImprimirItem(DetalleProducto, Cantidad, Redondeo(PrecioFinal + (Descuento/Cantidad), 2), AlicuotaIva, TAV);
              if Bonificacion > 0 then
                Epson.DescuentoUltimoItem('Desc: ' + FloatToStrF(Bonificacion, ffFixed, 6, 2) + '% ', Redondeo(Descuento, 4), True);
            end;
          end;
      end;
    finally
      if ExisteDemora then
        CloseDemora;
    end;
  end;
end;

procedure TfrmFiscal.ImprimirLineaBorrada(Producto: TItemFiscal);
begin
  if ControladorOK then
  begin
    ShowDemora('Borrando Items.');
    try
      case IF_Modelo of
      1,2,3,7,8,9: Hasar.DescuentoUltimoItem(Producto.Detalle, Redondeo(Producto.PrecioTotal, 2), True);
            4,5,6: Epson.DescuentoUltimoItem(Producto.Detalle, Redondeo(Producto.PrecioTotal, 2), True);
      end;
    finally
      CloseDemora;
    end;
  end;
end;

procedure TfrmFiscal.CancelarFactura(NotaDeCredito: Boolean);
begin
  if IF_Modelo = 9 then
  begin
    Case Factura.TipoCompCli of
      En_Ticket: begin
        if NotaDeCredito then
           Modelo_CF := 8
        else
           Modelo_CF := 3;
      end;
      En_Slip  : Modelo_CF := 8;
    end
  end
  else
    Modelo_CF := IF_Modelo;

  if ControladorOK then
  begin
    case Modelo_CF of
      1,
      3: begin
           Hasar.Modelo := Modelo_CF;
           if NotaDeCredito then
             Hasar.CerrarComprobanteNoFiscal
           else
             Hasar.CancelarComprobanteFiscal;
         end;
      2,7,
      8: begin
           Hasar.Modelo := Modelo_CF;
           if NotaDeCredito then
             Hasar.CerrarComprobanteNoFiscalHomologado
           else
             Hasar.CancelarComprobanteFiscal;
         end;
      4,
      5: if NotaDeCredito then
           Epson.CerrarComprobanteNoFiscalHomologado
         else
           Epson.CancelarComprobanteFiscal(CualTipoControlador);
      6: if NotaDeCredito then
           Epson.CerrarComprobanteNoFiscalHomologado
         else
           Epson.CancelarComprobanteFiscal(CualTipoControlador);
    end;
  end
  else begin
    case IF_Modelo of
    1,2,3,7,8,9: Hasar.TratarDeCancelarTodo;
          4,5,6: if CualTipoControlador = ControladorSoloTicket then
                   Epson.TratarDeCancelarTodoTkt
                 else
                   Epson.TratarDeCancelarTodoTktFac;
    end;
    Finalizar;
  end;
  UltimosNroComprobantes(PtoVta, False, 0, NroComp);
  if ExisteDemora then
    CloseDemora;
end;

procedure TfrmFiscal.Cerrar_Comprobante(DatosPago: TDatosPagos; var Factura: TFactura; Cartel:St40);
var
  i: Integer;
  s,d: Currency;
  pago: Double;
  Ult_Nro: String;
  Nota_Credito: Boolean;
begin
  Nota_Credito := (Factura.TipoFactura in [CreA, CreB]);
  if IF_Modelo = 9 then
  begin
    Case Factura.TipoCompCli of
      En_Ticket: begin
        if Nota_Credito then
           Modelo_CF := 8
        else
           Modelo_CF := 3;
      end;
      En_Slip  : Modelo_CF := 8;
    end
  end
  else
    Modelo_CF := IF_Modelo;

  if ControladorOK then
  begin
    try
      case Modelo_CF of
        1,
        3:begin
            try
              Hasar.Modelo := Modelo_CF;
              ShowDemora('Finalizando.');
              with DatosPago do
              begin
                if DatosPago.PagosDcto > 0 then
                  Hasar.DescuentoGeneral('Bonificacion: ',DatosPago.PagosDcto, True);
                if Contado in PagosRealizados then
                  Hasar.ImprimirPago('Efectivo: ', PagosContado);
                if Tarjeta in PagosRealizados then
                begin
                  for i := 1 to PagosTarjeta.CantTarjetas do
                    with PagosTarjeta.Movimientos[i] do
                      Hasar.ImprimirPago(NomTarjeta+' '+Cupon, TotalTarj);
                end;
                if PagosDcto > 0 then
                  Hasar.DescuentoGeneral('Descuento: ', PagosDcto, True);

                if PagosBonif.TotalBonif > 0 then
                  Hasar.DescuentoGeneral('Bonificacion: ', PagosBonif.TotalBonif, True);

                if Contado in PagosRealizados then
                  Hasar.ImprimirPago('Contado: ', PagosContado);

                if Tarjeta in PagosRealizados then
                begin
                  for i := 1 to PagosTarjeta.CantTarjetas do
                    with PagosTarjeta.Movimientos[i] do
                      Hasar.ImprimirPago(NomTarjeta+' ºP '+IntToStr(CantidadCuotas)+' Cº '+Cupon+'/'+Lote, TotalTarj);
                end;

                if Bonos in PagosRealizados then
                  Hasar.ImprimirPago('Bonos/Tkt: ', PagosBonosTk);

                if CtaCte in PagosRealizados then
                  Hasar.ImprimirPago('Cta.Cte.: ', PagosCtaCte.TotalCtaCte);

                if Valores in PagosRealizados then
                  Hasar.ImprimirPago('Cheques 3º: ', PagosValores.TotalValores);

                if Senas in PagosRealizados then
                  Hasar.ImprimirPago('Seña: ', PagosSena);

                if SdoAFav in PagosRealizados then
                  Hasar.ImprimirPago('c/SaF: ', SdoAFavor);

                if NotaCre in PagosRealizados then
                  Hasar.ImprimirPago('NCº '+PagosNCred.NroNotaCre, PagosNCred.MtoNotaCre);

                if DatosPago.RestaPagar > 0 then
                  Hasar.ImprimirPago('Su Vuelto: ', DatosPago.RestaPagar);
              end;

              // Lineas del sistema
              if Length(Trim(Cartel)) > 0 then
                SetDatos(12,Cartel)
              else
                SetDatos(12,'');
              if Factura.Empleado > 0 then
                SetDatos(13,'V: ' + IntToStr(Factura.Empleado)+' '+ Factura.NombreEmpleado)
              else
                SetDatos(13, '');
              Hasar.CerrarComprobanteFiscal;
            finally
              CloseDemora;
            end;
          end;
        2,
        7:begin
            try
              Hasar.Modelo := Modelo_CF;
              ShowDemora('Finalizando.');
              with DatosPago do
              begin
                if PagosDcto > 0 then
                  Hasar.DescuentoGeneral('Descuento: ', PagosDcto, True);

                if PagosBonif.TotalBonif > 0 then
                  Hasar.DescuentoGeneral('Bonificacion: ', PagosBonif.TotalBonif, True);

                if Contado in PagosRealizados then
                  Hasar.ImprimirPago('Contado: ', PagosContado);

                if Tarjeta in PagosRealizados then
                begin
                  for i := 1 to PagosTarjeta.CantTarjetas do
                    with PagosTarjeta.Movimientos[i] do
                      Hasar.ImprimirPago(NomTarjeta+' ºP '+IntToStr(CantidadCuotas)+' Cº '+Cupon+'/'+Lote, TotalTarj);
                end;
                if Bonos in PagosRealizados then
                  Hasar.ImprimirPago('Bonos/Tkt: ', PagosBonosTk);

                if CtaCte in PagosRealizados then
                  Hasar.ImprimirPago('Cta.Cte.: ', PagosCtaCte.TotalCtaCte);

                if Valores in PagosRealizados then
                  Hasar.ImprimirPago('Cheques 3º: ', PagosValores.TotalValores);

                if Senas in PagosRealizados then
                  Hasar.ImprimirPago('Seña: ', PagosSena);

                if SdoAFav in PagosRealizados then
                  Hasar.ImprimirPago('c/SaF: ', SdoAFavor);

                if NotaCre in PagosRealizados then
                  Hasar.ImprimirPago('NCº '+PagosNCred.NroNotaCre, PagosNCred.MtoNotaCre);
              end;
              // Lineas del sistema
              if Trim(Factura.NombreEmpleado) > Vacio then
              //  SetDatos(11,'Vendedor: ' + Factura.NombreEmpleado)
              SetDatos(11,'DEF.CONS. SAN JUAN TEL: 430 6400/05')
              else
               // SetDatos(11, ' ');
               SetDatos(11,'DEF.CONS. SAN JUAN TEL: 430 6400/05');

              if Length(Trim(Cartel)) > 0 then
                SetDatos(12,Cartel)
              else
                SetDatos(12,'');

              if (CtaCte in DatosPago.PagosRealizados) then
                SetDatos(13,'Firma y Documento___________________________')
              else
                SetDatos(12,'');

              if Nota_Credito then
              begin
                if Modelo_CF in [2,7] then
                  Hasar.Enviar(Chr(129)) // Cerrar NC en PR5F/715
                else
                  Hasar.CerrarComprobanteNoFiscalHomologado
              end
              else
                Hasar.CerrarComprobanteFiscal;
            finally
              CloseDemora;
            end;
          end;
        8:begin
            try
              Hasar.Modelo := Modelo_CF;
              ShowDemora('Finalizando.');
              with DatosPago do
              begin
                if PagosDcto > 0 then
                  Hasar.DescuentoGeneral('Descuento: ', PagosDcto, True);

                if PagosBonif.TotalBonif > 0 then
                  Hasar.DescuentoGeneral('Bonificacion: ', PagosBonif.TotalBonif, True);

                if Contado in PagosRealizados then
                  Hasar.ImprimirPago('Contado: ', PagosContado);

                if Tarjeta in PagosRealizados then
                begin
                  for i := 1 to PagosTarjeta.CantTarjetas do
                    with PagosTarjeta.Movimientos[i] do
                      Hasar.ImprimirPago(NomTarjeta+' ºP '+IntToStr(CantidadCuotas)+' Cº '+Cupon+'/'+Lote, TotalTarj);
                end;

                if Bonos in PagosRealizados then
                  Hasar.ImprimirPago('Bonos/Tkt: ', PagosBonosTk);

                if CtaCte in PagosRealizados then
                  Hasar.ImprimirPago('Cta.Cte.: ', PagosCtaCte.TotalCtaCte);

                if Valores in PagosRealizados then
                  Hasar.ImprimirPago('Cheques 3º: ', PagosValores.TotalValores);

                if Senas in PagosRealizados then
                  Hasar.ImprimirPago('Seña: ', PagosSena);

                if SdoAFav in PagosRealizados then
                  Hasar.ImprimirPago('c/SaF: ', SdoAFavor);

                if NotaCre in PagosRealizados then
                  Hasar.ImprimirPago('NCº '+PagosNCred.NroNotaCre, PagosNCred.MtoNotaCre);

                if DatosPago.RestaPagar > 0 then
                  Hasar.ImprimirPago('Su Vuelto: ', DatosPago.RestaPagar);
              end;

              if Factura.Empleado > 0 then
                SetDatos(11,'V: ' + IntToStr(Factura.Empleado)+' '+ Factura.NombreEmpleado)
              else
                SetDatos(11, '');

              if Length(Trim(Cartel)) > 0 then
                SetDatos(12,Cartel)
              else
                SetDatos(12,'');

              if Nota_Credito then
                Hasar.CerrarComprobanteNoFiscalHomologado
              else
                Hasar.CerrarComprobanteFiscal;
            finally
              CloseDemora;
            end;
          end;
        4,
        5:begin
            if Factura.TipoFactura = FacA then
            begin
              s := Epson.SubTotal;
              if Redondeo(s, 2) > Redondeo(Factura.Total, 2) then
              begin
                d := Redondeo((s - Factura.Total), 2);
                Epson.DescuentoGral('AJUSTE POR REDONDEO', d);
                s := Epson.SubTotal;
                if s <> Factura.Total then
                begin
                  d := Redondeo(Abs(Factura.Total - s), 2);
                  Epson.PercepcionGral('AJUSTE REDONDEO B.I.', d);
                end;
              end
              else begin
                d := Redondeo(Abs(Factura.Total - s), 2);
                Epson.PercepcionGral('AJUSTE REDONDEO B.I. ', d);
              end;
            end;

            try
              ShowDemora('Finalizando.');
              (*
              with DatosPago do
              begin
                if DatosPago.PagosDcto > 0 then
                begin
                  if Factura.TipoFactura = FacA then
                    Epson.DescuentoGral('Bonificacion: ',(DatosPago.PagosDcto/(1.21)))
                  else
                    Epson.DescuentoGral('Bonificacion: ',DatosPago.PagosDcto);
                end;
                if Contado in PagosRealizados then
                  Epson.ImprimirPago('Contado: ', PagosContado);
                if Tarjeta in PagosRealizados then
                  for i := 1 to PagosTarjeta.CantTarjetas do
                    Epson.ImprimirPago(PagosTarjeta.Movimientos[i].NomTarjeta +' '+
                                       PagosTarjeta.Movimientos[i].Cupon, PagosTarjeta.Movimientos[i].TotalTarj);
                if Bonos in PagosRealizados then
                  Epson.ImprimirPago('Bon/Tkt: ', PagosBonosTk);
                if CtaCte in PagosRealizados then
                  Epson.ImprimirPago('Cta.Cte:', PagosCtaCte.TotalCtaCte);
                if Valores in PagosRealizados then
                  Epson.ImprimirPago('Cheques', PagosValores.TotalValores);
                if (Senas in PagosRealizados) or
                   (SdoAFav in PagosRealizados) then
                begin
                  pago := (PagosSena+SdoAFavor);
                  Hasar.ImprimirPago('Vales: ', pago);
                end;
                if NotaCre in PagosRealizados then
                  Hasar.ImprimirPago('NCº '+PagosNCred.NroNotaCre, PagosNCred.MtoNotaCre);
                if DatosPago.RestaPagar > 0 then
                  Epson.ImprimirPago('Vuelto: ', DatosPago.RestaPagar);
              end;
              *)
              SetDatos(10, '');
              if Factura.Empleado > 0 then
                SetDatos(11,'V: ' + IntToStr(Factura.Empleado)+' '+ Factura.NombreEmpleado)
              else
                SetDatos(11, '');

              if Length(Trim(Cartel)) > 0 then
                SetDatos(13,Cartel)
              else
                SetDatos(13,'');
              SetDatos(14,'');

              if Nota_Credito then
                Epson.CerrarComprobanteNoFiscalHomologado
              else
                Epson.CerrarComprobanteFiscal;
            finally
              CloseDemora;
            end;
          end;

        6:begin
            try
              ShowDemora('Finalizando.');
              with DatosPago do
              begin
                if DatosPago.PagosDcto > 0 then
                  Epson.DescuentoGral('Bonificacion: ',DatosPago.PagosDcto);
                if Contado in PagosRealizados then
                  Epson.ImprimirPago('Contado: ', PagosContado);
                if Tarjeta in PagosRealizados then
                  for i := 1 to PagosTarjeta.CantTarjetas do
                    Epson.ImprimirPago('Tarjeta Nº '+ PagosTarjeta.Movimientos[i].Cupon, PagosTarjeta.Movimientos[i].TotalTarj);
                if Bonos in PagosRealizados then
                  Epson.ImprimirPago('Bonos/Tkt: ', PagosBonosTk);
                if CtaCte in PagosRealizados then
                  Epson.ImprimirPago('Cta.Cte: ', PagosCtaCte.TotalCtaCte);
                if Valores in PagosRealizados then
                  Epson.ImprimirPago('Cheques: ', PagosValores.TotalValores);
                if Senas in PagosRealizados then
                  Epson.ImprimirPago('Pg.c/Seña', Factura.Total);
                if DatosPago.RestaPagar > 0 then
                  Epson.ImprimirPago('Su Vuelto: ', DatosPago.RestaPagar);
              end;

              if Length(Factura.NombreEmpleado) > 0 then
                SetDatos(11,'Vendedor: ' + Factura.NombreEmpleado)
              else
                SetDatos(11, '');
              if Length(Trim(Cartel)) > 0 then
                SetDatos(13,Cartel)
              else
                SetDatos(13,'');

              if Nota_Credito then
                Epson.CerrarComprobanteNoFiscalHomologado
              else
                Epson.CerrarComprobanteFiscal;
            finally
              CloseDemora;
            end;
          end;
      end;

      case Modelo_CF of
        1,2,3,7,8,9: begin // Hasar
          Ult_Nro := Hasar.Respuesta[3];
          Hasar.ObtenerDatosDeInicializacion;
          PtoVta := Hasar.Respuesta[7];
          if dmGestion.qTerminalesImprimirTriplicado.AsInteger = Verdadero then
            Hasar.ReimprimirComprobante;
          if dmGestion.qTerminalesImprimirTriplicado.AsInteger = Verdadero then
            Hasar.ReimprimirComprobante;
          Factura.NroFactura := Format('%.4s-%.8s', [PtoVta, Ult_Nro]);
          Factura.PuntoVta := StrToInt(PtoVta);
        end;
        4,5,6: begin // Epson
          Ult_Nro := Epson.NroImpreso;
          Epson.ObtenerDatosDeInicializacion;
          PtoVta := Epson.Respuesta[2];
          Factura.NroFactura := Format('%.4s-%.8s', [PtoVta, Ult_Nro]);
          Factura.PuntoVta := StrToInt(PtoVta);
        end;
      end;

      with dmGestion do
      begin
        qTerminales.Close;
        qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
        qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
        qTerminales.Open;
        if not qTerminales.IsEmpty then
        begin
          try
            if not trGestion.InTransaction then
              trGestion.StartTransaction;
            qTerminales.Edit;
            qTerminalesNroPtoVtaControlador.AsString := Format('%.4s-', [PtoVta]);
            Case Factura.TipoFactura of
              FacA: qTerminalesCompA.AsString := Factura.NroFactura;
              DebA: qTerminalesCompA.AsString := Factura.NroFactura;
              CreA: qTerminalesNotCredA.AsString := Factura.NroFactura;
              RecA: qTerminalesCompA.AsString := Factura.NroFactura;
              Tkt : qTerminalesCompT.AsString := Factura.NroFactura;
              FacB: qTerminalesCompB.AsString := Factura.NroFactura;
              DebB: qTerminalesCompB.AsString := Factura.NroFactura;
              CreB: qTerminalesNotCredB.AsString := Factura.NroFactura;
              RecB: qTerminalesCompB.AsString := Factura.NroFactura;
            end;
            qTerminales.Post;
            qTerminales.Post;
            trGestion.Commit;
          except
            trGestion.Rollback;
          end;
        end;
      end;
      ComprobanteOk := True;
    except
      on E:Exception do
      begin
        ComprobanteOk := False;
        ShowMessage(E.Message);
      end;
    end;
  end
  else begin
    ComprobanteOk := False; // Tratar de cerrar comprobante
  end;
end;

function TfrmFiscal.ImprimirRemitoF(Var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
var
  Actual: Integer;
  DetalleR: St80;
  q: TMDOQuery;
begin
  if not ControladorOK then
    ControladorOK := InicializarControlador;

  ComprobanteOK := False;
  Result := False;
  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := dmGestion.trProc;
    q.SQL.Add('Select NROHASAR, NROEPSON ');
    q.SQL.Add('From TIPODOC Where TIPODOC =:T ');
    q.ParamByName('T').AsInteger := Factura.TipoDoc;
    q.Open;
    TDocH := q.Fields[0].AsInteger;
    TDocE := q.Fields[1].AsString;
  finally
    q.Free;
  end;

  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := dmGestion.trProc;
    q.SQL.Add('Select NROHASAR, NROEPSON ');
    q.SQL.Add('From TIPOIVA Where TIPOIVA =:T ');
    q.ParamByName('T').AsInteger := Factura.TipoIva;
    q.Open;
    TIvaH := q.Fields[0].AsInteger;
    TIvaE := q.Fields[1].AsString;
  finally
    q.Free;
  end;

  try
    case IF_Modelo of
      8,
      9:begin
          Hasar.DatosCliente(IntToStr(Factura.Entidad)+' '+Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH, Factura.Direccion);
          Hasar.Enviar(Chr(147)+Chr(28)+'1'+Chr(28)+Factura.CompRef); // Comprobante al cual hace ref. el Remito
          Hasar.AbrirComprobanteNoFiscalHomologado(DocumentoValido(IF_Modelo, RemitoX), Factura.NroFactura);
          try
            ShowDemora('Imprimiendo Remito.');
            if Trim(Factura.DomicilioE) > Vacio then
              Hasar.ImprimirItemEnRemito(Format('NOTA: %s ',[Factura.DomicilioE]), 0.00001);

            For Actual := 1 to Factura.CantArtic do
            begin
              with ItemsFactura[Actual] do
              begin
                if DetalleExtendido then
                begin
                  if Trim(DetalleExt[1]) > Cero then
                    Hasar.ImprimirItemEnRemito('* '+DetalleExt[1], 0.00001);
                  if Trim(DetalleExt[2]) > Cero then
                    Hasar.ImprimirItemEnRemito('* '+DetalleExt[2], 0.00001);
                  if Trim(DetalleExt[3]) > Cero then
                    Hasar.ImprimirItemEnRemito('* '+DetalleExt[3], 0.00001);
                  if Trim(DetalleExt[4]) > Cero then
                    Hasar.ImprimirItemEnRemito('* '+DetalleExt[4], 0.00001);
                end;
                DetalleR := Marca+' '+Detalle+' '+Color;
                if Factura.Situacion = Verdadero then
                  Hasar.ImprimirItemEnRemito(Format('%-80s %8.3m %9.3m',[DetalleR, PrecioFinal, PrecioTotal]), Cantidad)
                else
                  Hasar.ImprimirItemEnRemito(Format('%5s %-90s',[CodProd, DetalleR+' '+SubDet]), Cantidad);
              end;
            end;
            Hasar.CerrarComprobanteNoFiscalHomologado;
            ComprobanteOK := True;
            Result := True;
          finally
            UltimosNroComprobantes(PtoVta, False, Factura.TipoFactura, Factura.NroFactura);
            CloseDemora;
          end;
          while (Application.MessageBox(PChar('¿Imprimir copia del Remito?'), 'Comprobante', MB_ICONQUESTION + MB_YESNO) = IdYes) do
            Hasar.ReimprimirComprobante;
        end;
      6:begin
          // no implementado
        end;
    end;
  finally
    CloseDemora;
  end;
end;

procedure TfrmFiscal.ImprimirRemitoNF(Factura: TFactura; ItemsFactura: TBody_Fiscal);
var
  i: Integer;
begin
  case IF_Modelo of
    2,
    3:begin
        ComprobanteOK := False;
        Hasar.AbrirComprobanteNoFiscal;
        Hasar.ImprimirTextoNoFiscal('Entrega de Mercaderías');
        Hasar.ImprimirTextoNoFiscal('Nº FACTURA ORIGINAL: ' + Factura.NroFactura);
        Hasar.ImprimirTextoNoFiscal('Datos Cliente ');
        Hasar.ImprimirTextoNoFiscal(Factura.NombreEnt);
        Hasar.ImprimirTextoNoFiscal(Factura.Direccion);
        Hasar.ImprimirTextoNoFiscal(Factura.Localidad +' '+ Factura.Provincia);
        Hasar.ImprimirTextoNoFiscal('Tel.'+Factura.Telefono);
        for i := 1 to Factura.CantArtic do
        begin
          Hasar.ImprimirTextoNoFiscal(ItemsFactura[i].Marca + ' ' + ItemsFactura[i].Detalle);
          Hasar.ImprimirTextoNoFiscal(Format('%7.3f %-10s %7.2m %8.2m', [ItemsFactura[i].Cantidad, ItemsFactura[i].Color, ItemsFactura[i].PrecioFinal, ItemsFactura[i].PrecioTotal]));
        end;
        Hasar.ImprimirTextoNoFiscal('========================================');
        Hasar.ImprimirTextoNoFiscal(Format('Retirado: %30.3m', [Factura.Total]));
        Hasar.ImprimirTextoNoFiscal('========================================');
        Hasar.ImprimirTextoNoFiscal('                                        ');
        Hasar.ImprimirTextoNoFiscal('Recibí: ________________________________');
        Hasar.CerrarComprobanteNoFiscal;
        ComprobanteOK := True;
      end;
    4,
    5:begin
        ComprobanteOK := False;
        Epson.AbrirComprobanteNoFiscal;
        Epson.ImprimirTextoNoFiscal('Entrega de Mercaderías');
        Epson.ImprimirTextoNoFiscal('Nº COMPROBANTE ORIGINAL: ' + Factura.NroFactura);
        Epson.ImprimirTextoNoFiscal('Datos Cliente ');
        Epson.ImprimirTextoNoFiscal(Factura.NombreEnt);
        Epson.ImprimirTextoNoFiscal(Factura.Direccion);
        Epson.ImprimirTextoNoFiscal(Factura.Localidad +' '+ Factura.Provincia);
        Epson.ImprimirTextoNoFiscal('Tel.' + Factura.Telefono);
        for i := 1 to Factura.CantArtic do
        begin
          Epson.ImprimirTextoNoFiscal(ItemsFactura[i].Marca + ' ' + ItemsFactura[i].Detalle);
          Epson.ImprimirTextoNoFiscal(Format('%6.2f %-10s %7.3m %8.2m', [ItemsFactura[i].Cantidad, ItemsFactura[i].Color, ItemsFactura[i].PrecioFinal, ItemsFactura[i].PrecioTotal]));
        end;
        Epson.ImprimirTextoNoFiscal('========================================');
        Epson.ImprimirTextoNoFiscal(Format('Retirado: %20.3m', [Factura.Total]));
        Epson.ImprimirTextoNoFiscal('========================================');
        Epson.ImprimirTextoNoFiscal('                                        ');
        Epson.ImprimirTextoNoFiscal('Recibí: ________________________________');
        Epson.CerrarComprobanteNoFiscal;
        ComprobanteOK := True;
      end;
  end;
end;

function TfrmFiscal.Imprimir_Comprobante(Var Factura: TFactura; ItemsFactura: TBody_Fiscal; Var DatosPago: TDatosPagos): Boolean;
var
  i: Integer;
begin
  try
    Result := True;
    if not ControladorOK then
      InicializarControlador;
    ImprimirEncabezado(Factura);
    for i := 1 to Factura.CantArtic do
    begin
      if ItemsFactura[i].IdProducto > 0  then
      begin
        ImprimirLineaControlador(ItemsFactura[i], Factura.TipoFactura in [CreA, CreB]);
      end;
    end;
    Cerrar_Comprobante(DatosPago, Factura, Text_PieComprobante);
  except
    on E:Exception do
    begin
      Result := False;
      CancelarFactura(False);
      raise EUsuario.Create(E.Message);
    end;
  end;
end;

Function TfrmFiscal.ImprimirReciboF(Var DatosPago: TDatosPagos; Items: TBody_Fiscal; Detalles1, Detalles2: String): Boolean;
var
  RecX, i: Integer;
  q: TMDOQuery;
  Linea: String;
begin
  Result := False;
  if GetDatosEnt(DatosPago.IdEntidad, DatosPago.IdSucursal, 1, Datos_Ent) then
  begin
    if Datos_Ent.TipoDoc = CUIT then
      Datos_Ent.Documento := StringReplace(Datos_Ent.Documento, '-', '', [rfReplaceAll])
    else
      Datos_Ent.Documento := StringReplace(Datos_Ent.Documento, '.', '', [rfReplaceAll]);
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trProc;
      q.SQL.Add('Select NROHASAR, NROEPSON ');
      q.SQL.Add('From TIPODOC Where TIPODOC =:T ');
      q.ParamByName('T').AsInteger := Datos_Ent.TipoDoc;
      q.Open;
      TDocH := q.Fields[0].AsInteger;
      TDocE := q.Fields[1].AsString;
    finally
      q.Free;
    end;

    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trProc;
      q.SQL.Add('Select NROHASAR, NROEPSON ');
      q.SQL.Add('From TIPOIVA Where TIPOIVA = :T ');
      q.ParamByName('T').AsInteger := Datos_Ent.TipoIva;
      q.Open;
      TIvaH := q.Fields[0].AsInteger;
      TIvaE := q.Fields[1].AsString;
    finally
      q.Free;
    end;

    if not ControladorOk then
      ControladorOK := InicializarControlador;
    if not ControladorOK then
      raise EUsuario.Create('Error al inicializar el controlador');
    RecX := DocumentoValido(IF_Modelo, ReciboX);
    if RecX = NoEncontrado then
      raise EUsuario.Create('El controlador no puede emitir este tipo de documento');

    case IF_Modelo of
      8,
      9:begin
          ShowDemora('Abriendo Recibo X.');
          Hasar.DatosCliente(IntToStr(Datos_Ent.IdEnt)+' '+Datos_Ent.Nombre, Datos_Ent.Documento, TDocH, TIvaH, Datos_Ent.Direccion+' '+Datos_Ent.Localidad+' '+Datos_Ent.Provincia);
          Hasar.Enviar(Chr(147)+Chr(28)+'1'+Chr(28)+DatosPago.NroComprobante); // Comprobante al cual hace ref. el Recibo
          try
            Hasar.AbrirComprobanteNoFiscalHomologado(RecX, DatosPago.NroComprobante);
            Case DatosPago.TipoComprobante of
              SaldoAFavor: begin
                Hasar.ImprimirItem('Saldo A Favor ', 1.00, DatosPago.SdoAFavor, GetAlcIva(1), 0.00);
                if Trim(Detalles1) > Vacio then
                  Hasar.DetalleRecibo(Detalles1);
                if Trim(Detalles2) > Vacio then
                  Hasar.DetalleRecibo(Detalles2);
                if Trim(DatosPago.Observaciones) > Vacio then
                  Hasar.DetalleRecibo(DatosPago.Observaciones);
              end;
              Cobro_Sena: begin
                Hasar.ImprimirItem('Monto a Cuenta ', 1.00, DatosPago.TotalPagos, GetAlcIva(1), 0.00);
                if Trim(Detalles1) > Vacio then
                  Hasar.DetalleRecibo(Detalles1);
                if Trim(Detalles2) > Vacio then
                  Hasar.DetalleRecibo(Detalles2);
                if Trim(DatosPago.Observaciones) > Vacio then
                  Hasar.DetalleRecibo(DatosPago.Observaciones);
              end;
              ReciboX: begin
                Hasar.ImprimirItem('Cobro cuota(s) ', 1.00, DatosPago.TotalPagos, GetAlcIva(1), 0.00);
                Linea := Vacio;
                for i := 1 to DatosPago.CuotasPagadas do
                begin
                  if Items[i].IdProducto > 0 then
                  Begin
                    Linea := Format('%s %s %m ', [Items[i].Color, Items[i].DescProd, Items[i].PrecioFinal]);
                    Hasar.DetalleRecibo(Linea);
                  End;
                end;
              end;
            end;

            Linea := 'Pagos:';
            // Pagos
            if (SdoAFav in DatosPago.PagosRealizados) then
              Linea := Linea + Format(' SaF %m ', [DatosPago.SdoAFavor]);
            if (Senas in DatosPago.PagosRealizados) then
              Linea := Linea + Format(' Señas %m ', [DatosPago.PagosSena]);
            if Contado in DatosPago.PagosRealizados then
              Linea := Linea + Format(' Efectivo %m ', [DatosPago.PagosContado]);
            if Bonos in DatosPago.PagosRealizados then
              Linea := Linea + Format(' Tickets %m ', [DatosPago.PagosBonosTk]);
            if Tarjeta in DatosPago.PagosRealizados then
              Linea := Linea + Format(' Tarjetas %m ', [DatosPago.PagosTarjeta.TotalTarjeta]);
            if Valores in DatosPago.PagosRealizados then
              Linea := Linea + Format(' Cheques %m ', [DatosPago.PagosValores.TotalValores]);
            Hasar.DetalleRecibo(Linea);

            (*
            if (SdoAFav in DatosPago.PagosRealizados) or
               (Senas in DatosPago.PagosRealizados) then
            begin
              with dmSaveFile do
              begin
                Senas_Cobradas.First;
                while not Senas_Cobradas.Eof do
                begin
                  Hasar.DetalleRecibo(Format('%s Nro %s por %m',
                                      [GetText_Comprobante(Senas_CobradasTipoFac.AsInteger, True),
                                       Senas_CobradasNroSena.AsString,
                                       Senas_CobradasTotal.AsCurrency]));
                  Senas_Cobradas.Next;
                end;
              end;
            end;

            if Contado in DatosPago.PagosRealizados then
              Hasar.DetalleRecibo(Format('Efectivo: %m', [DatosPago.PagosContado]));

            if Bonos in DatosPago.PagosRealizados then
              Hasar.DetalleRecibo(Format('Tickets: %m', [DatosPago.PagosBonosTk]));

            if Tarjeta in DatosPago.PagosRealizados then
            begin
              for i := 1 to DatosPago.PagosTarjeta.CantTarjetas do
                with DatosPago.PagosTarjeta.Movimientos[i] do
                    Hasar.DetalleRecibo(Format('%s %d Cta %m',
                                        [NomTarjeta, CantidadCuotas, TotalTarj]));
            end;

            if Valores in DatosPago.PagosRealizados then
            begin
              DatosPago.PagosValores.Datos.First;
              while Not DatosPago.PagosValores.Datos.Eof do
              begin
                with DatosPago.PagosValores.Datos do
                begin
                  try
                    Hasar.DetalleRecibo(Format('Chq Bco: %s Nro: %s por %m',
                                       [Trim(FieldByName('NombreBanco').AsString),
                                        Trim(FieldByName('NroCheque').AsString),
                                        FieldByName('Monto').AsCurrency]));
                  except
                    Hasar.DetalleRecibo(Format('Cheque: %m', [DatosPago.PagosBonosTk]));
                  end;
                end;
                DatosPago.PagosValores.Datos.Next;
              end;
            end;

            if (Senas in DatosPago.PagosRealizados) then
            begin
              Hasar.DetalleRecibo(Format('Señas recibidas anteriormente: %m', [DatosPago.SdoAFavor]));
              Hasar.DetalleRecibo(Format('Sdo.a Favor operación anterior: %m', [DatosPago.SdoAFavor]));
            end;
            *)

          finally
            Hasar.CerrarComprobanteNoFiscalHomologado;
            Result := True;
            CloseDemora;
            while (Application.MessageBox(PChar('¿Imprimir copia del Recibo?'), 'Comprobante', MB_ICONQUESTION + MB_YESNO) = IdYes) do
              Hasar.ReimprimirComprobante;
          end;
        end;
      6:begin
          // Epson Tipo Factura
        end;
    end;
  end;
end;

function TfrmFiscal.ImprimirCotizacionF(Var Factura: TFactura; Items: TBody_Fiscal): Boolean;
var
  q: TMDOQuery;
  Actual, Coti: Integer;
begin
  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := dmGestion.trProc;
    q.SQL.Add('Select NROHASAR, NROEPSON ');
    q.SQL.Add('From TIPODOC Where TIPODOC =:T ');
    q.ParamByName('T').AsInteger := Factura.TipoDoc;
    q.Open;
    TDocH := q.Fields[0].AsInteger;
    TDocE := q.Fields[1].AsString;
  finally
    q.Free;
  end;

  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := dmGestion.trProc;
    q.SQL.Add('Select NROHASAR, NROEPSON ');
    q.SQL.Add('From TIPOIVA Where TIPOIVA =:T ');
    q.ParamByName('T').AsInteger := Factura.TipoIva;
    q.Open;
    TIvaH := q.Fields[0].AsInteger;
    TIvaE := q.Fields[1].AsString;
  finally
    q.Free;
  end;

  if Factura.TipoDoc = CUIT then
    Factura.NroDocumento := StringReplace(Factura.NroDocumento, '-', '', [rfReplaceAll])
  else
    Factura.NroDocumento := StringReplace(Factura.NroDocumento, '.', '', [rfReplaceAll]);

  if not ControladorOk then
    ControladorOK := InicializarControlador;
  if not ControladorOK then
    raise EUsuario.Create('Error al inicializar el controlador');
  Coti := DocumentoValido(IF_Modelo, Factura.TipoFactura);
  if Coti = NoEncontrado then
    raise EUsuario.Create('El controlador no puede emitir este tipo de documento');

  Case IF_Modelo of
    8,
    9:begin
        try
          ShowDemora('Abriendo cotización.');
          Hasar.DatosCliente(IntToStr(Factura.Entidad)+' '+Factura.NombreEnt, Factura.NroDocumento, TDocH, TIvaH,
                             Factura.Direccion+' '+Factura.Localidad+' '+Factura.Provincia);
          try
            Hasar.Enviar(Chr(147)+Chr(28)+'1'+Chr(28)+Factura.NroFactura);
            Hasar.AbrirComprobanteNoFiscalHomologado(Coti, Factura.NroFactura);
          except
            raise EUsuario.Create('Error al abrir Cotización.');
          end;
          for Actual := 1 to Factura.CantArtic do
          begin
            with Items[Actual] do
              Hasar.ImprimirItemEnCotizacion(Format('%-67s, %6.2f %8.2m %10.2m', [Marca+' '+Detalle, Cantidad, PrecioFinal, PrecioTotal]));
          end;
          Hasar.ImprimirItemEnCotizacion(Format('%-85s, %11.2m', ['           La presente cotización asciende a ', Factura.Total]));

          if Factura.DomicilioE <> VACIO then
            Hasar.ImprimirItemEnCotizacion('Observaciones: '+ Factura.DomicilioE);
        finally
          Hasar.CerrarComprobanteNoFiscalHomologado;
          CloseDemora;
          while Application.MessageBox(PChar('¿Imprimir copia del Presupuesto?'), 'Comprobante', MB_ICONQUESTION + MB_YESNO) = IdYes do
            Hasar.ReimprimirComprobante;
        end;
      end;
    6:begin
        // no implementado
      end;
  end;
end;

procedure TfrmFiscal.AbrirCajon;
begin
  case IF_Modelo of
  2,3,7,9: Hasar.AbrirCajonDeDinero;
      4,5: Epson.AbrirCajonDeDinero;
  end;
end;
//--------------------------------------
procedure TfrmFiscal.ReporteZ;
begin
  try
    ShowDemora('Cierre Diario Z.');
    case IF_Modelo of
      2,
      3,
      7: HASAR.ReporteZ;
      8: begin
           HASAR.ReporteZ;
           with dmGestion do
           begin
             if qTerminalesImprimirMarco.AsInteger = Verdadero then
               Hasar.ConfigurarControlador(IMPRESION_MARCO, 'P');
             if qTerminalesImprimirTriplicado.AsInteger = Verdadero then
               Hasar.ConfigurarControlador(COPIAS_DOCUMENTOS, '3');
           end;
         end;
      9: begin
           HASAR.ReporteZ;
           with dmGestion do
           begin
             if qTerminalesImprimirMarco.AsInteger = Verdadero then
               Hasar.ConfigurarControlador(IMPRESION_MARCO, 'P');
             if qTerminalesImprimirTriplicado.AsInteger = Verdadero then
               Hasar.ConfigurarControlador(COPIAS_DOCUMENTOS, '3');
           end;
         end;
      4,5,6: Epson.ReporteZ;
    end;
  finally
    CloseDemora;
  end;
end;

procedure TfrmFiscal.ReporteX;
begin
  try
    ShowDemora('Reporte X');
    case IF_Modelo of
      2,
      3,
      7,
      8,
      9: HASAR.ReporteX;
      4,
      5,
      6:begin
          Epson.ReporteX;
          Epson.Finalizar;
        end;
    end;
  finally
    CloseDemora;
  end;
end;

procedure TfrmFiscal.Imprimir_CajaCF(CajaD, CajaH: TDate; Montos: TDataSet);
var
  TotalCaja: Currency;
begin
  try
    ShowDemora('Imprimiendo caja.');
    Case IF_Modelo of
      2,3,7,8,9:
        with frmFiscal.Hasar do
        begin
          AbrirComprobanteNoFiscal;
          if CajaD = CajaH then
            ImprimirTextoNoFiscal('Fecha: ' + DateToStr(CajaD))
          else
            ImprimirTextoNoFiscal('Periodo: ' + DateToStr(CajaD)+' '+DateToStr(CajaH));
          ImprimirTextoNoFiscal('========================================');
          TotalCaja := 0;
          Montos.First;
          while not Montos.Eof do
          begin
            ImprimirTextoNoFiscal(Format('%-25s', [Montos.FieldByName('Detalle').AsString]));
            ImprimirTextoNoFiscal(Format(' %35.2m', [Montos.FieldByName('Total').AsCurrency]));
            TotalCaja := TotalCaja + Montos.FieldByName('Total').AsCurrency;
            Montos.Next;
          end;
          if TotalCaja <> 0.000 then
          begin
            ImprimirTextoNoFiscal('========================================');
            ImprimirTextoNoFiscal(Format('%-20s %15.2m', ['Recaudado:', TotalCaja]));
            ImprimirTextoNoFiscal(' ');
          end;
          CerrarComprobanteNoFiscal;
        end;
      4,5,6:
        with frmFiscal.Epson do
        begin
          AbrirComprobanteNoFiscal;
          if CajaD = CajaH then
            ImprimirTextoNoFiscal('Fecha: ' + DateToStr(CajaD))
          else
            ImprimirTextoNoFiscal('Periodo: ' + DateToStr(CajaD)+' '+DateToStr(CajaH));
          ImprimirTextoNoFiscal('========================================');
          TotalCaja := 0;
          Montos.First;
          while not Montos.Eof do
          begin
            ImprimirTextoNoFiscal(Format('%-25s', [Montos.FieldByName('Detalle').AsString]));
            ImprimirTextoNoFiscal(Format('%9.2m', [Montos.FieldByName('Total').AsCurrency]));
            TotalCaja := TotalCaja + Montos.FieldByName('Total').AsCurrency;
            Montos.Next;
          end;
          if TotalCaja <> 0.000 then
          begin
            ImprimirTextoNoFiscal('========================================');
            ImprimirTextoNoFiscal(Format('%-20s %15.2m', ['Recaudado:', TotalCaja]));
            ImprimirTextoNoFiscal(' ');
          end;
          CerrarComprobanteNoFiscal;
        end;
    end;
  finally
    CloseDemora;
  end;
  if Application.MessageBox('¿Imprimir reporte X?', 'Reporte X', MB_ICONQUESTION + MB_YESNO) = IDYES then
  begin
    ReporteX;
    ControladorOK := InicializarControlador;
  end;
end;
//------------------------------------------------------------------
procedure TfrmFiscal.ImprimirCobroCheque(IdFactura: Integer);
begin
  (*
  case IF_Modelo of
    2,3,8,9:
    with dmSaveFile do
    begin
      BancoTer.Filter := 'IdFactura = ' + IntToStr(IdFactura);
      BancoTer.Filtered := True;
      BancoTer.Open;
      if not BancoTer.IsEmpty then
      begin
        BancoTer.First;
        try
          Hasar.AbrirComprobanteNoFiscal;
          Hasar.ImprimirTextoNoFiscal(#244 + 'Cheque(s) de 3º Ingresados');
          while not BancoTer.Eof do
          begin
            Hasar.ImprimirTextoNoFiscal(Format('Banco: %s', [BancoTerNombreBanco.Value]));
            Hasar.ImprimirTextoNoFiscal(Format('Cuenta: %s', [BancoTerNroCuenta.Value]));
            Hasar.ImprimirTextoNoFiscal(Format('Cheque Nº %d - Imp: %m', [BancoTerNroCheque.Value, BancoTerMonto.Value]));
            Hasar.ImprimirTextoNoFiscal('Vencimiento: ' + BancoTerFechaVencimiento.AsString);
            BancoTer.Next;
          end;
        finally
          Hasar.CerrarComprobanteNoFiscal;
        end;
      end;
      BancoTer.Filter := '';
      BancoTer.Filtered := False;
      BancoTer.Close;
    end;
    4,5,6:
    with frmFiscal, dmSaveFile do
    begin
      Epson.AbrirComprobanteNoFiscal;
      BancoTer.Filter := 'IdFactura = ' + IntToStr(IdFactura);
      BancoTer.Filtered := True;
      try
        BancoTer.Open;
        BancoTer.First;
        Epson.ImprimirTextoNoFiscal(#244 + 'Pago con Cheques');
        while not BancoTer.Eof do
        begin
          Epson.ImprimirTextoNoFiscal(Format('Banco: %s', [BancoTerNombreBanco.Value]));
          Epson.ImprimirTextoNoFiscal(Format('Cuenta: %s', [BancoTerNroCuenta.Value]));
          Epson.ImprimirTextoNoFiscal(Format('Cheque Nº %d - Imp: %m', [BancoTerNroCheque.Value, BancoTerMonto.Value]));
          BancoTer.Next;
        end;
      finally
        BancoTer.Filter := '';
        BancoTer.Filtered := False;
        BancoTer.Close;
        Epson.CerrarComprobanteNoFiscal;
      end;
    end;
  end;
  *)
end;

procedure TfrmFiscal.ImprimirCobroTarjeta(DatosPago: TDatosPagos);
var
  i: Integer;
begin
  (*
  case IF_Modelo of
    2,3,8,9:
    with dmGestion, dmSaveFile do
    begin
      Hasar.AbrirComprobanteNoFiscal;
      Hasar.ImprimirTextoNoFiscal(#244 + 'Pago con Tarjeta');
      Tarjetas.Open;
      for i := 1 to DatosPago.PagosTarjeta.CantTarjetas do
      begin
        if Tarjetas.Locate('IdTarjeta', DatosPago.PagosTarjeta.Movimientos[i].IdTarMut, []) then
          Hasar.ImprimirTextoNoFiscal(Format('Tarjeta: %s', [TarjetasTarjeta.Value]))
        else
          Hasar.ImprimirTextoNoFiscal(Format('Tarjeta: %s', ['Sin identificación']));
        Hasar.ImprimirTextoNoFiscal(Format('Nº Tarjeta: %s', [DatosPago.PagosTarjeta.Movimientos[i].NomTarjeta]));
        Hasar.ImprimirTextoNoFiscal(Format('Importe: %m', [DatosPago.PagosTarjeta.Movimientos[i].TotalTarj]));
      end;
      Tarjetas.Close;
      Hasar.CerrarComprobanteNoFiscal;
    end;
    4,5,6:
    with dmGestion, dmSaveFile do
    begin
      Epson.AbrirComprobanteNoFiscal;
      Epson.ImprimirTextoNoFiscal('Pago con Tarjeta');
      Tarjetas.Open;
      for i := 1 to DatosPago.PagosTarjeta.CantTarjetas do
      begin
        if Tarjetas.Locate('IdTarjeta', DatosPago.PagosTarjeta.Movimientos[i].IdTarMut, []) then
          Epson.ImprimirTextoNoFiscal(Format('Tarjeta: %s', [TarjetasTarjeta.Value]))
        else
          Epson.ImprimirTextoNoFiscal(Format('Tarjeta: %s', ['Sin identificación']));
        Epson.ImprimirTextoNoFiscal(Format('Nº Tarjeta: %s', [DatosPago.PagosTarjeta.Movimientos[i].NomTarjeta]));
        Epson.ImprimirTextoNoFiscal(Format('Importe: %m', [DatosPago.PagosTarjeta.Movimientos[i].TotalTarj]));
      end;
      Tarjetas.Close;
      Epson.CerrarComprobanteNoFiscal;
    end;
  end;
  *)
end;
//---------------------------------------------------------------------------
procedure TfrmFiscal.HasarFaltaPapel(Sender: TObject);
var
  i: Integer;
  Esta: Boolean;
begin
  if not HuboFaltaPapel then
  begin
    Application.MessageBox('Falta papel en el controlador/impresora fiscal' + #13 + 'Colóquelo, de Aceptar y espere' , 'Falta papel', MB_ICONEXCLAMATION);
    HuboFaltaPapel := True;
  end
  else begin
    Esta := False;
    for i := 0 to Screen.FormCount - 1 do
      if ExisteDemora then
      begin
        Esta := True;
        Break;
      end;
    if not Esta then
    begin
      try
        CloseDemora;
      except
      end;
    end;
  end;
end;

procedure TfrmFiscal.FormCreate(Sender: TObject);
begin
  Epson := TEpson.Create;
  Epson.OnFaltaPapel := EpsonFaltaPapel;
  Epson.OnImpresoraOK := EpsonImpresoraOK;
  HuboFaltaPapel := False;
end;

procedure TfrmFiscal.HasarImpresoraOK(Sender: TObject);
begin
  if HuboFaltaPapel then
    HuboFaltaPapel := False;
end;

procedure TfrmFiscal.EpsonFaltaPapel(Sender: TObject);
begin
  if not HuboFaltaPapel then
  begin
    Application.MessageBox('Falta papel en el controlador/impresora fiscal' + #13 + 'Colóquelo, de Aceptar y espere' , 'Falta papel', MB_ICONEXCLAMATION);
    HuboFaltaPapel := True;
  end;
end;

procedure TfrmFiscal.EpsonImpresoraOK(Sender: TObject);
begin
  if HuboFaltaPapel then
    HuboFaltaPapel := False;
end;

function TfrmFiscal.ImprimirFactura_Servidor(Var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
var
  NumItems: Integer;
  ConPrecios: Boolean;
begin
  Result := False;
  if not ControladorOk then
    InicializarControlador;
  if ControladorOk then
  begin
    Case Factura.TipoFactura of
      RemitoX: begin
        try
          if Application.MessageBox('¿Imprimir remito con Precios?', 'Remito X', MB_ICONQUESTION + MB_YESNO) = IdYes then
            Factura.Situacion := Verdadero
          else
            Factura.Situacion := Falso;
          while Application.MessageBox('¿Imprimir?', 'Remito X', MB_ICONQUESTION + MB_YESNO) = IdYes do
          begin
            if (ImprimirEnControlador) and (Tipo_Factura or Tipo_Estacion) and (ControladorLocal) then
              ImprimirRemitoF(Factura, ItemsFiscal)
            else
              ImprimirRemitoNF(Factura, ItemsFiscal);
          end;
          Result := True;
        except
          on E: Exception do
          begin
            Result := False;
            Application.MessageBox(PChar(E.Message), 'Error', MB_ICONERROR);
          end;
        end;
      end;
      Presupuesto: begin
        // Imprimir Presupuesto
      end;
      else begin
        try
          ImprimirEncabezado(Factura);
          for NumItems := 1 to Factura.CantArtic do
            ImprimirLineaControlador(ItemsFiscal[NumItems], (Factura.TipoFactura in [CreA, CreB]));
          Cerrar_Comprobante(DatosPago, Factura, Text_PieComprobante);
          Result := True;
        except
          CancelarFactura((Factura.TipoFactura in [CreA, CreB]));
          Result := False;
        end;
      end;
    end;
  end;
end;

procedure TfrmFiscal.ImprimirVoucher(NombreCliente, NombreTarjeta: String; Tipo: Integer; NumeroDeTarjeta: String;
                     FechaDeVencimiento: TDate; TipoTarjeta: Integer; Cuotas: Integer; CodigoDeComercio: String;
                     NumeroDeTerminal: Integer; NumeroDeLote: Integer; Numero: String; TipoIngreso, TipoOperacion: Integer;
                     NumeroAutorizacion: LongInt; Monto, MontoCta: Currency; NumeroComprobanteAsociado: Integer; Copias: SmallInt);
var
  NumeroCupon, i: Integer;
  Anio, Mes, Dia: Word;
  FechTar, ValCta: String;
begin
  if Trim(CodigoDeComercio) = '' then
    CodigoDeComercio := '00000';
  ValCta := '';
  DecodeDate(FechaDeVencimiento, Anio, Mes, Dia);
  CodigoDeComercio := DeleteAlphaChars(CodigoDeComercio);
  NumeroDeTarjeta := DeleteAlphaChars(NumeroDeTarjeta);
  NombreCliente := Up_Case(NombreCliente);
  try
    NumeroCupon := StrToInt(Numero);
  except
    NumeroCupon := 0
  end;

  case IF_Modelo of
    1,3,8,9
     :begin
        if Trim(CodigoDeComercio) = '' then
          CodigoDeComercio := '00000';
        if IF_Modelo = 2 then
          CodigoDeComercio := DeleteAlphaChars(CodigoDeComercio);
        NumeroDeTarjeta := DeleteAlphaChars(NumeroDeTarjeta);
        // -----------------  Algunos modelos de Hasar no aceptan como Nro. de lote y Nro de cupon mas de 9999
        NumeroDeLote := NumeroDeLote mod 10000;
        NumeroCupon := NumeroCupon mod 10000;
       //-----------------------------------
        NombreCliente := Up_Case(NombreCliente);
        Hasar.ImprimirVoucher(NombreCliente, NombreTarjeta, VOUCHER_DE_COMPRA, NumeroDeTarjeta, FechaDeVencimiento,
                              TARJETA_CREDITO, Cuotas, CodigoDeComercio, NumeroDeTerminal, NumeroDeLote, NumeroCupon, INGRESO_DE_TARJETA_MANUAL,
                              OPERACION_TARJETA_OFFLINE, NumeroAutorizacion, FloatToStrF(Monto, ffCurrency, 10, 2), NumeroComprobanteAsociado, Copias);
      end;
    2,
    7:begin
        FechTar := Format('%.2d%.2d', [Anio mod 100,Mes]);
        ValCta  := Format('Cuota %10.2f ', [MontoCta]);
        for i := 1 to Copias do
        begin
          Hasar.Enviar(Chr(106) + Chr(FS) + NombreCliente + Chr(FS) + NombreTarjeta + Chr(FS) +
                       Chr(VOUCHER_DE_COMPRA)+ Chr(FS) + NumeroDeTarjeta + Chr(FS) + FechTar + Chr(FS) +
                       Chr(TARJETA_CREDITO) + Chr(FS) + Format('%d', [Cuotas]));
          try
            Hasar.Enviar(Chr(107) + Chr(FS) + CodigoDeComercio + Chr(FS) + Format('%d', [NumeroDeTerminal]) + Chr(FS) +
                         Format('%d', [NumeroDeLote mod 1000])+ Chr(FS) + Format('%d', [NumeroCupon mod 10000])+ Chr(FS) +
                         Chr(INGRESO_DE_TARJETA_MANUAL) + Chr(FS) +  Chr(OPERACION_TARJETA_OFFLINE) + Chr(FS) +
                         Format('%d', [NumeroAutorizacion mod 1000000])+ Chr(FS) + FloatToStrF(Monto, ffCurrency, 15, 2) + Chr(FS) +
                         Format('%d', [NumeroComprobanteAsociado]) + Chr(FS) + ValCta);
          except
            Hasar.Enviar(Chr(107) + Chr(FS) + CodigoDeComercio + Chr(FS) + Format('%d', [NumeroDeTerminal]) + Chr(FS) +
                         Format('%d', [NumeroDeLote mod 1000])+ Chr(FS) + Format('%d', [NumeroCupon mod 10000])+ Chr(FS) +
                         Chr(INGRESO_DE_TARJETA_MANUAL) + Chr(FS) +  Chr(OPERACION_TARJETA_OFFLINE) + Chr(FS) +
                         Format('%d', [NumeroAutorizacion mod 1000000])+ Chr(FS) + FloatToStrF(Monto, ffCurrency, 15, 2) + Chr(FS) +
                         Format('%d', [NumeroComprobanteAsociado]) + Chr(FS) + ' ');
          end;
          Hasar.Enviar(Chr(108) + Chr(FS) + IntToStr(Copias));
        end;
      end;
    4,
    5:begin
        NumeroDeTarjeta := DeleteAlphaChars(NumeroDeTarjeta);
        CodigoDeComercio := DeleteAlphaChars(CodigoDeComercio);
        NombreCliente := Up_Case(NombreCliente);
        Epson.ImprimirVoucher(NombreCliente, NombreTarjeta, VOUCHER_DE_COMPRA, NumeroDeTarjeta, FechaDeVencimiento,
                              TARJETA_CREDITO, Cuotas, CodigoDeComercio, NumeroDeTerminal, NumeroDeLote, NumeroCupon, INGRESO_DE_TARJETA_MANUAL,
                              OPERACION_TARJETA_OFFLINE, NumeroAutorizacion, Monto, MontoCta, NumeroComprobanteAsociado, Copias);
      end;
  end;
end;

procedure TfrmFiscal.FormDestroy(Sender: TObject);
begin
  Epson.Free;
  Epson := nil;
end;

end.
