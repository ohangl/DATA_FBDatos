unit udmSaveFile;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms,
  Dialogs, Db, uTools, Variants, MDOQuery, MDOCustomDataSet, MDOTable,
  MDODatabase, MDOStoredProc, DateUtils, DBClient, Provider, ppDB,
  ppDBPipe, ppEndUsr, ppComm, ppRelatv, ppProd, ppClass, ppReport,
  ppPrnabl, ppCtrls, ppCache, ppBands, ppParameter;

type
  TdmSaveFile = class(TDataModule)
    AuxBcoTer: TClientDataSet;
    AuxBcoTerNombreBanco: TStringField;
    AuxBcoTerNroCuenta: TStringField;
    AuxBcoTerNroCheque: TIntegerField;
    AuxBcoTerIdTitular: TIntegerField;
    AuxBcoTerTitular: TStringField;
    AuxBcoTerIdEndoso: TIntegerField;
    AuxBcoTerEndoso: TStringField;
    AuxBcoTerFechaVencimiento: TDateField;
    AuxBcoTerFechaEntrega: TDateField;
    AuxBcoTerIdEntrega: TIntegerField;
    AuxBcoTerEntrega: TStringField;
    AuxBcoTerIdOrdPago: TIntegerField;
    AuxBcoTerIdFactura: TIntegerField;
    AuxBcoTerMonto: TCurrencyField;

    AuxBcoPro: TClientDataSet;
    AuxBcoProIdBanco: TIntegerField;
    AuxBcoProDetalleBco: TStringField;
    AuxBcoProIdMov: TIntegerField;
    AuxBcoProTipoMov: TSmallintField;
    AuxBcoProNroCheque: TIntegerField;
    AuxBcoProFechaEmision: TDateField;
    AuxBcoProFechaVencimiento: TDateField;
    AuxBcoProFechaResumen: TDateField;
    AuxBcoProIdEntidad: TIntegerField;
    AuxBcoProDetalleMov: TStringField;
    AuxBcoProIdOrdPago: TIntegerField;
    AuxBcoProIdFactura: TIntegerField;
    AuxBcoProIdSucursal: TIntegerField;
    AuxBcoProDescripcion: TStringField;
    AuxBcoProDetTipoMov: TStringField;
    AuxBcoProMonto: TCurrencyField;
    AuxBcoProSumaResta: TIntegerField;

    SalChq3: TClientDataSet;
    SalChq3IdMov: TIntegerField;

    tUltimos: TMDOTable;
    tUltimosIDULTIMOS: TIntegerField;
    tUltimosUltimoCCCliente: TIntegerField;
    tUltimosUltimoCCProveedor: TIntegerField;
    tUltimosUltimoRendicion: TIntegerField;
    tUltimosUltimoFacC: TIntegerField;
    tUltimosUltimoFacV: TIntegerField;
    tUltimosUltimoFacT: TIntegerField;
    tUltimosUltimoFacO: TIntegerField;
    tUltimosUltimoOrdPago: TIntegerField;
    tUltimosUltimoRegPre: TIntegerField;
    tUltimosUltimoInventario: TIntegerField;
    tUltimosULTIMOLIQUIDACION: TIntegerField;

    dspUltimos: TDataSetProvider;
    Ultimos: TClientDataSet;
    UltimosIDULTIMOS: TIntegerField;
    UltimosUltimoCCCliente: TIntegerField;
    UltimosUltimoCCProveedor: TIntegerField;
    UltimosUltimoRendicion: TIntegerField;
    UltimosUltimoFacC: TIntegerField;
    UltimosUltimoFacV: TIntegerField;
    UltimosUltimoFacT: TIntegerField;
    UltimosUltimoFacO: TIntegerField;
    UltimosUltimoOrdPago: TIntegerField;
    UltimosUltimoRegPre: TIntegerField;
    UltimosUltimoInventario: TIntegerField;
    UltimosULTIMOLIQUIDACION: TIntegerField;

    tCliServFiscal: TMDOTable;
    tCliServFiscalIdFactura: TIntegerField;
    tCliServFiscalNombre: TStringField;

    tR_Rend: TMDOTable;
    tR_RendIdRend: TIntegerField;
    tR_RendIdSuc: TIntegerField;
    tR_RendFechaR: TDateField;
    tR_RendIdCuenta: TIntegerField;
    tR_RendFechaIS: TDateField;
    tR_RendTVENTA: TMDOBCDField;
    tR_RendTPESOS: TMDOBCDField;
    tR_RendTTICKETS: TMDOBCDField;
    tR_RendTTARJETA: TMDOBCDField;
    tR_RendTCHEQUES: TMDOBCDField;
    tR_RendTSENAS: TMDOBCDField;
    tR_RendTNCRED: TMDOBCDField;
    tR_RendTGASTOSE: TMDOBCDField;
    tR_RendTGASTOST: TMDOBCDField;
    tR_RendDIFERENCIA: TMDOBCDField;
    tR_RendDEPOSITO: TMDOBCDField;
    tR_RendIDMOVBCO: TIntegerField;
    tR_RendTSAF: TMDOBCDField;
    tR_RendTCOBOSUC: TMDOBCDField;
    tR_RendTCOBRADO: TMDOBCDField;
    tR_RendBOLDEP: TIntegerField;

    qSaveMovTar: TMDOQuery;
    qSaveMovCta: TMDOQuery;
    qSaveStk: TMDOQuery;
    qSaveComp: TMDOQuery;

    trSaveComp: TMDOTransaction;
    spModVrs: TMDOStoredProc;

    dsqOrdenes: TDataSource;
    qOrdenes: TMDODataSet;
    qOrdenesIDORDEN: TIntegerField;
    qOrdenesENTIDAD: TIntegerField;
    qOrdenesFECHAOP: TDateField;
    qOrdenesNROCOMPOP: TMDOStringField;
    qOrdenesCANTOP: TSmallintField;
    qOrdenesTOTALOP: TMDOBCDField;
    qOrdenesCONTADO: TMDOBCDField;
    qOrdenesTICKETS: TMDOBCDField;
    qOrdenesBANCOPROP: TMDOBCDField;
    qOrdenesBANCOTER: TMDOBCDField;
    qOrdenesBONIFPROV: TMDOBCDField;
    qOrdenesUSUARIO: TIntegerField;
    qOrdenesESTADO: TSmallintField;
    qOrdenesNOMENTIDAD: TMDOStringField;
    qOrdenesAUTORIZADO: TMDOStringField;
    qOrdenesNOMUSR: TMDOStringField;
    qOrdenesNOCOMPOP: TMDOBCDField;
    qOrdenesNETOOP: TMDOBCDField;
    qOrdenesRETENCIONI: TMDOBCDField;
    qOrdenesRETENCIONG: TMDOBCDField;
    qOrdenesRETENCIONB: TMDOBCDField;
    qOrdenesPRCRETG: TMDOBCDField;
    qOrdenesPRCRETI: TMDOBCDField;
    qOrdenesPRCRETB1: TMDOBCDField;
    qOrdenesPRCRETB2: TMDOBCDField;
    qOrdenesRETENCIONS: TMDOBCDField;
    qOrdenesPRCRETS: TMDOBCDField;
    qOrdenesRETENCIONH: TMDOBCDField;
    qOrdenesRETENCIONES: TMDOBCDField;
    qOrdenesNROCERTIVA: TMDOStringField;
    qOrdenesNROCERTGAN: TMDOStringField;
    qOrdenesNROCERTIBT: TMDOStringField;
    qOrdenesNROCERTSES: TMDOStringField;
    qOrdenesIDEMPRESA: TIntegerField;
    qOrdenesDetEmp: TStringField;

    dsqItemsOP: TDataSource;
    qItemsOP: TMDODataSet;
    qItemsOPIDORDPAGO: TIntegerField;
    qItemsOPIDITEMOP: TIntegerField;
    qItemsOPENTIDAD: TIntegerField;
    qItemsOPFECHAOP: TDateField;
    qItemsOPFECHAOR: TDateField;
    qItemsOPIDFACTURA: TIntegerField;
    qItemsOPIDSUCURSAL: TIntegerField;
    qItemsOPIDPUNTOVENTA: TIntegerField;
    qItemsOPIMPORTE: TMDOBCDField;
    qItemsOPSALDOMOV: TMDOBCDField;
    qItemsOPMONTOORG: TMDOBCDField;
    qItemsOPTIPOMOV: TSmallintField;
    qItemsOPCOMPROBANTE: TMDOStringField;
    qItemsOPNROFACTURA: TMDOStringField;
    qItemsOPESTADO: TSmallintField;
    qItemsOPMONTOCOMPROBANTE: TMDOBCDField;
    qItemsOPDETMOV: TMDOStringField;

    dsqItemsPG: TDataSource;
    qItemsPG: TMDODataSet;
    qItemsPGIDORDEN: TIntegerField;
    qItemsPGIDITEMPAG: TSmallintField;
    qItemsPGENTIDAD: TIntegerField;
    qItemsPGCOMPROBANTE: TMDOStringField;
    qItemsPGFECHA: TDateField;
    qItemsPGIMPORTE: TMDOBCDField;
    qItemsPGDETALLE: TMDOStringField;
    qItemsPGDESCRIPCION: TMDOStringField;
    qItemsPGIDMOVIMIENTO: TIntegerField;
    qItemsPGESTADO: TSmallintField;
    qItemsPGTIPOP: TMDOStringField;
    qItemsPGTIPOPAGO: TSmallintField;

    trVerComp: TMDOTransaction;

    dspCliServFiscal: TDataSetProvider;
    CliServFiscal: TClientDataSet;
    CliServFiscalIdFactura: TIntegerField;
    CliServFiscalNombre: TStringField;

    dspR_Rend: TDataSetProvider;
    R_Rend: TClientDataSet;
    R_RendIdRend: TIntegerField;
    R_RendIdSuc: TIntegerField;
    R_RendFechaR: TDateField;
    R_RendIdCuenta: TIntegerField;
    R_RendFechaIS: TDateField;
    R_RendTVENTA: TBCDField;
    R_RendTPESOS: TBCDField;
    R_RendTTICKETS: TBCDField;
    R_RendTTARJETA: TBCDField;
    R_RendTCHEQUES: TBCDField;
    R_RendTSENAS: TBCDField;
    R_RendTNCRED: TBCDField;
    R_RendTGASTOSE: TBCDField;
    R_RendTGASTOST: TBCDField;
    R_RendDIFERENCIA: TBCDField;
    R_RendDEPOSITO: TBCDField;
    R_RendIDMOVBCO: TIntegerField;
    R_RendTSAF: TBCDField;
    R_RendTCOBOSUC: TBCDField;
    R_RendTCOBRADO: TBCDField;
    R_RendBOLDEP: TIntegerField;

    dsChqModel: TDataSource;
    ChqModel: TClientDataSet;
    ChqModelChMonto: TCurrencyField;
    ChqModelChDiaEmi: TSmallintField;
    ChqModelChAnoEmi: TSmallintField;
    ChqModelChDiaVto: TSmallintField;
    ChqModelChAnoVto: TSmallintField;
    ChqModelChMesVto: TStringField;
    ChqModelChMesEmi: TStringField;
    ChqModelChTitular: TStringField;
    ChqModelChPesos1: TStringField;
    ChqModelChPesos2: TStringField;
    ChqModelChFirma: TStringField;
    ChqModelChCruzado: TBooleanField;
    ChqModelIdCheque: TSmallintField;
    ChqModelChNroChq: TStringField;
    ChqModelIdMov: TIntegerField;

    dsgModelChq: TppDesigner;
    dbpModelChq: TppDBPipeline;
    lstModelChq: TppReport;
    lpModelChq: TppParameterList;
    dbModelChq: TppDetailBand;
    lblDiaEmi: TppDBText;
    lblMesEmi: TppDBText;
    lblAnoEmi: TppDBText;
    lblDiaVto: TppDBText;
    lblMesVto: TppDBText;
    lblAnoVto: TppDBText;
    lblTitChq: TppDBText;
    lblPesos1Chq: TppDBText;
    lblPesos2Chq: TppDBText;
    lblMontoChq: TppDBText;
    lblDiaDelMes: TppLabel;

    NroChq: TClientDataSet;
    NroChqIdBanco: TIntegerField;
    NroChqCantMov: TSmallintField;
    NroChqNroCheque: TIntegerField;

    tTransBank: TMDOTable;
    tTransBankIDTBANK: TIntegerField;
    tTransBankIDCTAORG: TIntegerField;
    tTransBankIDMOVORG: TIntegerField;
    tTransBankIDCTADES: TIntegerField;
    tTransBankIDMOVDES: TIntegerField;
    tTransBankMONTOT: TMDOBCDField;
    tTransBankFECHAT: TDateField;
    tTransBankUSUARIO: TIntegerField;
    tTransBankESTADO: TSmallintField;
    tTransBankCANTMOV: TSmallintField;

    dspTransBank: TDataSetProvider;
    TransBank: TClientDataSet;
    TransBankIDTBANK: TIntegerField;
    TransBankIDCTAORG: TIntegerField;
    TransBankIDMOVORG: TIntegerField;
    TransBankIDCTADES: TIntegerField;
    TransBankIDMOVDES: TIntegerField;
    TransBankMONTOT: TBCDField;
    TransBankFECHAT: TDateField;
    TransBankUSUARIO: TIntegerField;
    TransBankESTADO: TSmallintField;
    TransBankCANTMOV: TSmallintField;

    tTBItems: TMDOTable;
    tTBItemsIDTBANK: TIntegerField;
    tTBItemsIDITEMTB: TSmallintField;
    tTBItemsFECHA: TDateField;
    tTBItemsDETALLE: TMDOStringField;
    tTBItemsMONTO: TMDOBCDField;

    dspTBItems: TDataSetProvider;
    TBItems: TClientDataSet;
    TBItemsIDTBANK: TIntegerField;
    TBItemsIDITEMTB: TSmallintField;
    TBItemsFECHA: TDateField;
    TBItemsDETALLE: TStringField;
    TBItemsMONTO: TBCDField;

    qCCProv: TMDODataSet;
    qCCProvNROMOVIMIENTO: TIntegerField;
    qCCProvIDCOMPROBANTE: TIntegerField;
    qCCProvIDSUCURSAL: TIntegerField;
    qCCProvTCOMP: TSmallintField;
    qCCProvENTIDAD: TIntegerField;
    qCCProvFECHA: TDateField;
    qCCProvFECHAORG: TDateField;
    qCCProvCOMPROBANTE: TMDOStringField;
    qCCProvDEBE: TMDOBCDField;
    qCCProvHABER: TMDOBCDField;
    qCCProvPAGOACTA: TMDOBCDField;
    qCCProvSALDOMOV: TMDOBCDField;
    qCCProvSALDO: TMDOBCDField;
    qCCProvESTADO: TSmallintField;
    qCCProvSTATE: TSmallintField;
    qCCProvIMPNETO: TMDOBCDField;
    qCCProvIMPNCOM: TMDOBCDField;
    qCCProvSALDONETO: TMDOBCDField;
    qCCProvIDORDPAGO: TIntegerField;
    qCCProvIDSUCORDP: TIntegerField;
    qCCProvFECHAPAGO: TDateField;
    qCCProvMONTORETG: TMDOBCDField;
    qCCProvMONTORETB: TMDOBCDField;
    qCCProvIDNROPREOP: TIntegerField;
    qCCProvMONTORETI: TMDOBCDField;
    qCCProvMONTORETH: TMDOBCDField;
    qCCProvMONTORETS: TMDOBCDField;
    qCCProvIDEMPRESA: TIntegerField;

    qTransBco: TMDODataSet;
    qTransBcoIDTBANK: TIntegerField;
    qTransBcoIDCTAORG: TIntegerField;
    qTransBcoIDMOVORG: TIntegerField;
    qTransBcoIDCTADES: TIntegerField;
    qTransBcoIDMOVDES: TIntegerField;
    qTransBcoMONTOT: TMDOBCDField;
    qTransBcoFECHAT: TDateField;
    qTransBcoUSUARIO: TIntegerField;
    qTransBcoESTADO: TSmallintField;
    qTransBcoCANTMOV: TSmallintField;

    qItemsTB: TMDODataSet;
    qItemsTBIDTBANK: TIntegerField;
    qItemsTBIDITEMTB: TSmallintField;
    qItemsTBFECHA: TDateField;
    qItemsTBDETALLE: TMDOStringField;
    qItemsTBMONTO: TMDOBCDField;

    qCards: TMDODataSet;
    qCardsIDTARJETA: TIntegerField;
    qCardsTARJETA: TMDOStringField;
    qCardsDIAPRESENTACION: TSmallintField;
    qCardsTELAUTORIZACION: TMDOStringField;
    qCardsCODCOMERCIO: TMDOStringField;
    qCardsCODENTIDAD: TMDOStringField;
    qCardsLIMITE: TMDOBCDField;
    qCardsDOMICILIO: TMDOStringField;
    qCardsDEPARTAMENTO: TMDOStringField;
    qCardsPROVINCIA: TMDOStringField;
    qCardsCOMISION: TMDOBCDField;
    qCardsSALDOVENCIDO: TMDOBCDField;
    qCardsSALDOAVENCER: TMDOBCDField;
    qCardsTIPOENT: TSmallintField;
    qCardsDOCUMENTO: TMDOStringField;
    qCardsTDOCFISCAL: TSmallintField;
    qCardsTIPOIVA: TSmallintField;
    qCardsIDPROVEEDOR: TIntegerField;
    qCardsCODPOSTAL: TMDOStringField;

    qPlanCard: TMDODataSet;
    qPlanCardIDTARJETA: TIntegerField;
    qPlanCardNROCUOTA: TIntegerField;
    qPlanCardIDSUCURSAL: TIntegerField;
    qPlanCardCOEFPLAN: TMDOBCDField;
    qPlanCardMODOPAGO: TSmallintField;
    qPlanCardMAXDCTO: TMDOBCDField;
    qPlanCardMAXDCTOII: TMDOBCDField;

    qMovCard: TMDODataSet;
    qMovCardIDMOV: TIntegerField;
    qMovCardIDTARJETA: TIntegerField;
    qMovCardIDFACTURA: TIntegerField;
    qMovCardIDCLIENTE: TIntegerField;
    qMovCardCUPON: TMDOStringField;
    qMovCardLOTE: TMDOStringField;
    qMovCardFECHAOP: TDateField;
    qMovCardCODTAR: TMDOStringField;
    qMovCardNROCUOTA: TSmallintField;
    qMovCardIMPCUOTA: TMDOBCDField;
    qMovCardTOTALOP: TMDOBCDField;
    qMovCardAUTORIZACION: TMDOStringField;
    qMovCardESTADO: TSmallintField;
    qMovCardFECHARESUMEN: TDateField;
    qMovCardFECHAIS: TDateField;
    qMovCardCUOTAPAG: TIntegerField;
    qMovCardNROLIQUIDACION: TMDOStringField;
    qMovCardVENCUOTA: TDateField;
    qMovCardNRORECPAGO: TMDOStringField;
    qMovCardCANTCUOTAS: TSmallintField;
    qMovCardSTATE: TSmallintField;
    qMovCardIDSUCURSAL: TIntegerField;
    qMovCardULTIMOPAGO: TDateField;
    qMovCardIDPUNTOVENTA: TIntegerField;
    qMovCardINTCUOTA: TMDOBCDField;

    qMovCtas: TMDODataSet;
    qMovCtasIDMOVCRED: TIntegerField;
    qMovCtasNROCUOTA: TSmallintField;
    qMovCtasIDFACTURA: TIntegerField;
    qMovCtasIDSUCURSAL: TIntegerField;
    qMovCtasFECHAV: TDateField;
    qMovCtasMONTOCUOTA: TMDOBCDField;
    qMovCtasNRORECPAGO: TMDOStringField;
    qMovCtasFECHAP: TDateField;
    qMovCtasMONTODEBITO: TMDOBCDField;
    qMovCtasNRONOTADEB: TMDOStringField;
    qMovCtasIDRECIBO: TIntegerField;
    qMovCtasIDSUCREC: TIntegerField;
    qMovCtasIDCLIENTE: TIntegerField;
    qMovCtasESTADO: TSmallintField;
    qMovCtasFECHAIS: TDateField;

    qSucursales: TMDODataSet;
    qSucursalesIDSUCURSAL: TIntegerField;
    qSucursalesNOMBRESUC: TMDOStringField;
    qSucursalesDIRECCIONSUC: TMDOStringField;
    qSucursalesLOCALIDADSUC: TMDOStringField;
    qSucursalesPROVINCIASUC: TMDOStringField;
    qSucursalesCOPOSTALSUC: TMDOStringField;
    qSucursalesTELEFONOSUC: TMDOStringField;
    qSucursalesDIRECTORIO: TMDOStringField;
    qSucursalesACTUALIZACIONES: TMDOStringField;
    qSucursalesREMOTA: TSmallintField;
    qSucursalesDETSUC: TMDOStringField;
    qSucursalesFECHAINICIO: TDateField;
    qSucursalesFECHATINV: TDateField;
    qSucursalesNROREMITOT: TMDOStringField;
    qSucursalesNROREMITOI: TMDOStringField;
    qSucursalesNEMP: TIntegerField;
    qSucursalesNPTO: TIntegerField;
    qSucursalesTIPOFTP: TSmallintField;
    qSucursalesHOSTNAME: TMDOStringField;
    qSucursalesUSUARIO: TMDOStringField;
    qSucursalesPASSWFTP: TMDOStringField;
    qSucursalesDIRFTPENVIOS: TMDOStringField;
    qSucursalesDIRFTPRECEP: TMDOStringField;
    qSucursalesCONSUBDEP: TSmallintField;
    qSucursalesULTIMA_ACT: TDateField;
    qSucursalesULTIMA_ACT_ORG: TDateField;
    qSucursalesIDBANCOT: TIntegerField;
    qSucursalesIDBANCOB: TIntegerField;
    qSucursalesIDBANCOE: TIntegerField;
    qSucursalesIDBANCOP: TIntegerField;
    qSucursalesIDLISTA: TIntegerField;
    qSucursalesPRCLISTA: TMDOBCDField;
    qSucursalesEMPRESA: TMDOStringField;
    qSucursalesDOCEMPRE: TMDOStringField;
    qSucursalesACTIVA: TSmallintField;

    qArtModPrc: TMDODataSet;
    qArtModPrcIDREMMOD: TIntegerField;
    qArtModPrcIDARTICULO: TIntegerField;
    qArtModPrcTIPOCOMP: TSmallintField;
    qArtModPrcNROREMITO: TMDOStringField;
    qArtModPrcFECHAR: TDateField;
    qArtModPrcDIAHORA: TDateTimeField;
    qArtModPrcUSUARIO: TIntegerField;
    qArtModPrcCOSTOOLD: TMDOBCDField;
    qArtModPrcCOSTONEW: TMDOBCDField;
    qArtModPrcPRECIOOLD: TMDOBCDField;
    qArtModPrcPRECIONEW: TMDOBCDField;
    qArtModPrcDETALLE: TMDOStringField;
    qArtModPrcCANTCTAS: TSmallintField;
    qArtModPrcIDSUCURSAL: TIntegerField;
    qArtModPrcFECHAALTA: TDateField;
    qArtModPrcFECHAFIN: TDateField;
    qArtModPrcVALORCTAS: TMDOBCDField;

    qArtOfertas: TMDODataSet;
    qArtOfertasIDARTICULO: TIntegerField;
    qArtOfertasCANTCTAS: TIntegerField;
    qArtOfertasIDSUCURSAL: TIntegerField;
    qArtOfertasFECHAALTA: TDateField;
    qArtOfertasFECHAFIN: TDateField;
    qArtOfertasPNETO: TMDOBCDField;
    qArtOfertasPRECIO: TMDOBCDField;
    qArtOfertasGANANCIAO: TMDOBCDField;
    qArtOfertasVALORCTAS: TMDOBCDField;
    qArtOfertasCANTAUT: TIntegerField;
    qArtOfertasCANTVEN: TIntegerField;

    qStocks: TMDODataSet;
    qStocksIDARTICULO: TIntegerField;
    qStocksIDSTOCK: TIntegerField;
    qStocksACTUAL: TMDOBCDField;
    qStocksINGRESOS: TMDOBCDField;
    qStocksEGRESOS: TMDOBCDField;
    qStocksFECHACONTROL: TDateField;
    qStocksSTKAINV: TMDOBCDField;
    qStocksFECHAINV: TDateField;
    qStocksDIFINV: TMDOBCDField;

    qConcBanc: TMDODataSet;
    qConcBancDIF_CONC: TMDOBCDField;
    qConcBancIDCONCILIACION: TIntegerField;
    qConcBancIDBANCO: TIntegerField;
    qConcBancOBSERVACION: TMDOStringField;
    qConcBancFECHA_CONC: TDateField;
    qConcBancCANT_MOV: TIntegerField;
    qConcBancSSBANCO: TMDOBCDField;
    qConcBancNROCTA: TMDOStringField;
    qConcBancBANCO: TMDOStringField;

    Senas_Cobradas: TClientDataSet;
    Senas_CobradasIdFactura: TIntegerField;
    Senas_CobradasIdSucursal: TIntegerField;
    Senas_CobradasIdPuntoVenta: TIntegerField;
    Senas_CobradasIdCliente: TIntegerField;
    Senas_CobradasTotal: TMDOBCDField;
    Senas_CobradasTipoFac: TSmallintField;
    Senas_CobradasNroSena: TStringField;
    Senas_CobradasFecSena: TDateField;

    qArtPreEsp: TMDODataSet;
    qArtPreEspIDARTICULO: TIntegerField;
    qArtPreEspIDSUCURSAL: TIntegerField;
    qArtPreEspPRECIOESP: TMDOBCDField;
    qArtPreEspDURACION: TDateField;
    qArtPreEspFECHAALTA: TDateField;

    qBancoProp: TMDODataSet;
    qBancoPropIDMOV: TIntegerField;
    qBancoPropIDBANCO: TIntegerField;
    qBancoPropIDORDPAGO: TIntegerField;
    qBancoPropTIPOMOV: TSmallintField;
    qBancoPropFECHAEMISION: TDateField;
    qBancoPropFECHAVENCIMIENTO: TDateField;
    qBancoPropFECHARESUMEN: TDateField;
    qBancoPropIDENTIDAD: TIntegerField;
    qBancoPropDETALLEMOV: TMDOStringField;
    qBancoPropMONTO: TMDOBCDField;
    qBancoPropDEBE: TMDOBCDField;
    qBancoPropHABER: TMDOBCDField;
    qBancoPropUSUARIO: TIntegerField;
    qBancoPropIDFACTURA: TIntegerField;
    qBancoPropIDSUCURSAL: TIntegerField;
    qBancoPropESTADO: TSmallintField;
    qBancoPropNROCHEQUE: TIntegerField;
    qBancoPropIDNROCONCILIACION: TIntegerField;
    qBancoPropIDEMPRESA: TIntegerField;
    dbpBancos: TppDBPipeline;

    CompOP: TClientDataSet;
    CompOPIdFactura: TIntegerField;
    CompOPIdSucursal: TIntegerField;
    CompOPIdPuntoVenta: TIntegerField;
    CompOPIdEmpresa: TIntegerField;
    CompOPNroMovCC: TIntegerField;
    CompOPTipoMov: TIntegerField;
    CompOPFechaOr: TDateField;
    CompOPFechaPg: TDateField;
    CompOPEntidad: TIntegerField;
    CompOPNroComp: TStringField;
    CompOPMontoOrg: TCurrencyField;
    CompOPImporte: TCurrencyField;
    CompOPSaldoMov: TCurrencyField;
    CompOPSaldoNeto: TCurrencyField;
    CompOPSaldoImpInt: TCurrencyField;

    TransBySuc: TClientDataSet;
    TransBySucIdOrigen: TIntegerField;
    TransBySucIdDestino: TIntegerField;
    TransBySucIdEmpleado: TIntegerField;
    TransBySucIdCliente: TIntegerField;
    TransBySucFechaF: TDateField;
    TransBySucNroCompRef: TStringField;
    TransBySucIdFacOrg: TIntegerField;
    TransBySucIdSucOrg: TIntegerField;
    TransBySucIdArticulo: TIntegerField;
    TransBySucCantidad: TIntegerField;

    procedure Save_Safe(DataSet: TDataSet);
    procedure DataModuleCreate(Sender: TObject);

    procedure AuxBcoTerIdTitularChange(Sender: TField);
    procedure AuxBcoTerIdEndosoChange(Sender: TField);
    procedure qItemsPGFECHAGetText(Sender: TField; var Text: String; DisplayText: Boolean);
    procedure qOrdenesAfterPost(DataSet: TDataSet);
    procedure qOrdenesBeforeEdit(DataSet: TDataSet);
    procedure qOrdenesCalcFields(DataSet: TDataSet);
    procedure qOrdenesAfterOpen(DataSet: TDataSet);
    procedure UltimosAfterPost(DataSet: TDataSet);
    procedure AuxBcoProNroChequeValidate(Sender: TField);
    procedure AuxBcoProAfterOpen(DataSet: TDataSet);
    procedure TransBankBeforeInsert(DataSet: TDataSet);
    procedure AuxBcoProTipoMovValidate(Sender: TField);

  private
    { Private declarations }
    OldEstadoOP: Integer;
  public
    { Public declarations }
    // Ventas
    function GrabarComprobanteVenta(var DatosPago: TDatosPagos; var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
    function DoPagoCambio(DatosPago: TDatosPagos): Boolean;
    function GrabarSolicitudCredito(var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
    function Grabar_Senas(var DatosPago: TDatosPagos; TipoComp: SmallInt): Boolean;

    // Tarjetas Mutuales
    procedure DoPagoTarjeta(var DatosPago: TDatosPagos);
    procedure DoPagoSenas(DatosPago: TDatosPagos);
    function DoPagoCuota(var DatosPago: TDatosPagos; ItemsRec: TBody_Fiscal): Boolean;
    // Valores de Terceros
    procedure DoPagoVentaValores(DatosPago: TDatosPagos);
    //Compras, Gastos, Remitos Prov
    function GrabarComprobanteEgresos(var DatosPago: TDatosPagos; var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;

    procedure DoPagoEfectivoProv(DatosPago: TDatosPagos);
    //Cuenta Corriente Proveedores
    procedure DoPagoCuentaProv(DatosPago: TDatosPagos);
    procedure Grabar_PagosCuentaProv(DatosPago: TDatosPagos; VerOP: Boolean);
    procedure Grabar_MovsCuentaProv(DatosPago: TDatosPagos);

    // Cheques propios y de Terceros
    procedure DoPagoComprasCheques(DatosPago: TDatosPagos);
    procedure DoPagoComprasValores(DatosPago: TDatosPagos);

    procedure DoPagoComprasBonificacion(DatosPago: TDatosPagos);

    function Llenar_OrdenDePagos(var DatosPago: TDatosPagos): Integer;
    // Remitos de Traspaso
    function GrabarComprobanteStock(var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
    // Ordenes de Compra
    function GrabarComprobanteInventario(var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
    // Remitos de Inventario
    //procedure Update_Parts(PartNo, Stk: Integer; Qty: Double; Talle, TC, TJ: Integer; Servicio, Kit: Boolean);
    // Ultimos Id de bd
    function Get_Ultimos(Cual: TUltimos): LongInt;
    // Lectura de Stock
  end;

var
  dmSaveFile: TdmSaveFile;

implementation

uses udmGestion, uOrdPagos, uClaveMod;

{$R *.DFM}

procedure TdmSaveFile.Save_Safe(DataSet: TDataSet);
begin
  if not trSaveComp.InTransaction then
    trSaveComp.StartTransaction;
  try
    TClientDataSet(DataSet).ApplyUpdates(0);
    trSaveComp.Commit;
  except
    trSaveComp.Rollback;
    raise;
  end;
end;

procedure TdmSaveFile.DataModuleCreate(Sender: TObject);
begin
  ReNumerar_Contadores;
  Ultimos.Open;
end;

//******************************************************************************
//                                 VENTAS
//******************************************************************************

function TdmSaveFile.GrabarComprobanteVenta(var DatosPago: TDatosPagos; var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
Const
  SaveFacV = 'Insert InTo '+
             'FacVen(IdFactura, IdSucursal, IdPuntoVenta, Sector, DiaHora, '+
             '       TipoFactura, Situacion, FechaF, FechaI, PuntoVta, '+
             '       NroFactura, CompRef, IdCompRef, Cliente, TipoIva, '+
             '       CantArtic, Impresa, IdMotNC, Bonificacion, Neto, '+
             '       Exento, NoComputables, IvaAlicuota1, IvaAlicuota2, '+
             '       Total, IdSubDep, Contado, Tarjeta, IdTarjeta, '+
             '       NroCtas, Tickets, CtaCte, Cheque, OtrosPagos, '+
             '       Senas, CobSenas, Usuario, Empleado, Dir_Entrega, '+
             '       State, FechaIS, EntContado, IdEmpresa) '+
             'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :Sector, :DiaHora, '+
             '       :TipoFactura, :Situacion, :FechaF, :FechaI, :PuntoVta, '+
             '       :NroFactura, :CompRef, :IdCompRef, :Cliente, :TipoIva, '+
             '       :CantArtic, :Impresa, :IdMotNC, :Bonificacion, :Neto, '+
             '       :Exento, :NoComputables, :IvaAlicuota1, :IvaAlicuota2, '+
             '       :Total, :IdSubDep, :Contado, :Tarjeta, :IdTarjeta, '+
             '       :NroCtas, :Tickets, :CtaCte, :Cheque, :OtrosPagos, '+
             '       :Senas, :CobSenas, :Usuario, :Empleado, :Dir_Entrega, '+
             '       :State, :FechaIS, :EntContado, :IdEmpresa) ';

  SaveItmV = 'Insert InTo '+
             'ItemsFV(IdFactura, IdSucursal, IdPuntoVenta, IdItem, IdArticulo, '+
             '        Talle, SubDet, FechaF, ValorLista, NroCtas, Cantidad, '+
             '        Descuento, PrcBonificacion, PrecioNeto, PrecioFinal, '+
             '        PrecioTotal, Exento, ImpInt, IvaIn, PrecioCosto, '+
             '        ValorLista, IdAlcIva, AlicuotaIva, IdSubDep, IdAlcIB, '+
             '        AlcIB, IngBto, Oferta, DctoStk, State, EntContado, '+
             '        MosDom, IdAutorDto, IdSucSalida) '+
             'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :IdItem, :IdArticulo, '+
             '       :Talle, :SubDet, :FechaF, :ValorLista, :NroCtas, :Cantidad, '+
             '       :Descuento, :PrcBonificacion, :PrecioNeto, :PrecioFinal, '+
             '       :PrecioTotal, :Exento, :ImpInt, :IvaIn, :PrecioCosto, '+
             '       :ValorLista, :IdAlcIva, :AlicuotaIva, :IdSubDep, :IdAlcIB, '+
             '       :AlcIB, :IngBto, :Oferta, :DctoStk, :State, :EntContado, '+
             '       :MosDom, :IdAutorDto, :IdSucSalida) ';

  SaveDetI = 'INSERT INTO '+
             'ITEMSFV_DET(IDFACTURA, IDSUCURSAL, IDITEM, DETALLE1, '+
             '            DETALLE2, DETALLE3, DETALLE4) '+
             'VALUES(:IDFACTURA, :IDSUCURSAL, :IDITEM, :DETALLE1, '+
             '       :DETALLE2, :DETALLE3, :DETALLE4) ';

var
  NumItems, TC: Integer;
  CoefDcto: Double;
  q: TMDOQuery;
begin
  CoefDcto := 0;
  TC := 1;
  Result := False;

  if (DatosPago.PagosDcto > 0) and
     (DatosPago.TipoOperacion = Venta) then
  begin
    Factura.Total := Factura.Total - DatosPago.PagosDcto;
    try
      CoefDcto := (DatosPago.PagosDcto * 100) / Factura.Total;
    except
      CoefDcto := 0;
    end;
  end;

  if Factura.TipoFactura in [CreA, CreB, CreC, CreditoAjuste] then
    TC := -1;

  if Factura.IdSucursal = IdBranch then
  begin
    DatosPago.IdComprobante := Get_Ultimos(FacVenta);
    Factura.IdFactura := DatosPago.IdComprobante;
    Factura.IdMotivo := DatosPago.IdMotivo;
    Factura.Contado := DatosPago.PagosContado;
    Factura.Tarjeta := DatosPago.PagosTarjeta.TotalTarjeta;
    Factura.IdTarjeta := DatosPago.IdTarjeta;
    Factura.CantCuotas := DatosPago.CantidadCuotas;
    Factura.BonosTkt := DatosPago.PagosBonosTk;
    Factura.CtaCte := DatosPago.PagosCtaCte.TotalCtaCte;
    Factura.ChequeTer := DatosPago.PagosValores.TotalValores;
    Factura.Descuento := -DatosPago.PagosDcto;
  end
  else begin
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := trSaveComp;
      q.SQL.Add('Select FechaF From FacVen ');
      q.SQL.Add('Where Empleado =:Empleado And ');
      q.SQL.Add('      NroFactura =:NroFactura And ');
      q.SQL.Add('      TipoFactura =:TipoFactura ');
      q.ParamByName('Empleado').AsInteger := Factura.Empleado;
      q.ParamByName('NroFactura').AsString := Factura.NroFactura;
      q.ParamByName('TipoFactura').AsInteger := Factura.TipoFactura;
      q.Open;
      if not q.IsEmpty then
      begin
        q.Close;
        Exit;
      end;
    finally
      q.Free;
    end;
  end;

  qSaveComp.Close;
  qSaveComp.Sql.Clear;
  qSaveComp.SQL.Text := SaveFacV;
  qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
  qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
  qSaveComp.ParamByName('IdPuntoVenta').AsInteger := Factura.IdPuntoVenta;
  qSaveComp.ParamByName('Sector').AsInteger := 0;
  qSaveComp.ParamByName('DiaHora').AsDateTime := Now;
  qSaveComp.ParamByName('TipoFactura').AsInteger := Factura.TipoFactura;
  qSaveComp.ParamByName('FechaF').AsDate := Factura.FechaF;
  qSaveComp.ParamByName('PuntoVta').AsInteger := StrToInt(Copy(Factura.NroFactura, 1, 4));
  qSaveComp.ParamByName('NroFactura').AsString := Factura.NroFactura;
  qSaveComp.ParamByName('CompRef').AsString := Factura.CompRef;
  qSaveComp.ParamByName('IdCompRef').AsInteger := Factura.IdCompRef;
  qSaveComp.ParamByName('Cliente').AsInteger := Factura.Entidad;
  qSaveComp.ParamByName('TipoIva').AsInteger := Factura.TipoIva;
  qSaveComp.ParamByName('CantArtic').AsInteger := Factura.CantArtic;
  qSaveComp.ParamByName('IdMotNC').AsInteger := Factura.IdMotivo;
  qSaveComp.ParamByName('Bonificacion').AsCurrency := TC*ABS((Factura.Descuento - ((Factura.Descuento * CoefDcto) / 100)));
  qSaveComp.ParamByName('Neto').AsCurrency := TC*ABS((Factura.Neto-((Factura.Neto * CoefDcto) / 100)));
  qSaveComp.ParamByName('Exento').AsCurrency := TC*ABS((Factura.Exento-((Factura.Exento * CoefDcto) / 100)));
  qSaveComp.ParamByName('NoComputables').AsCurrency:= TC*ABS((Factura.NoComputables-((Factura.NoComputables * CoefDcto) / 100)));
  qSaveComp.ParamByName('IvaAlicuota1').AsCurrency := TC*ABS((Factura.IvaAlicuota1-((Factura.IvaAlicuota1 * CoefDcto) / 100)));
  qSaveComp.ParamByName('IvaAlicuota2').AsCurrency := TC*ABS((Factura.IvaAlicuota2-((Factura.IvaAlicuota2 * CoefDcto) / 100)));
  qSaveComp.ParamByName('Total').AsCurrency := TC*ABS(Factura.Total);
  qSaveComp.ParamByName('IdSubDep').AsInteger := Factura.IdSubDep;
  qSaveComp.ParamByName('Empleado').AsInteger := Factura.Empleado;

  if Factura.TipoFactura in [CreA, CreB, CreC, CreditoAjuste] then
  begin
    qSaveComp.ParamByName('Situacion').AsInteger := DatosPago.OpcionNC;
    Case DatosPago.OpcionNC of
      0: begin
        qSaveComp.ParamByName('IdTarjeta').AsInteger := Factura.IdTarjeta;
        qSaveComp.ParamByName('Tarjeta').AsCurrency := TC*ABS(DatosPago.PagosTarjeta.TotalTarjeta);
        qSaveComp.ParamByName('NroCtas').AsInteger := Factura.CantCuotas;
        qSaveComp.ParamByName('OtrosPagos').AsCurrency := TC*ABS(DatosPago.SdoAFavor);
        qSaveComp.ParamByName('Contado').AsCurrency := 0;
        qSaveComp.ParamByName('Tickets').AsCurrency:= 0;
        qSaveComp.ParamByName('Cheque').AsCurrency := 0;
        qSaveComp.ParamByName('CobSenas').AsCurrency := 0;
        qSaveComp.ParamByName('CtaCte').AsCurrency := 0;
        qSaveComp.ParamByName('Senas').AsCurrency := 0;
      end;
      1: begin
        qSaveComp.ParamByName('IdTarjeta').AsInteger := Factura.IdTarjeta;
        qSaveComp.ParamByName('Tarjeta').AsCurrency := TC*ABS(DatosPago.PagosTarjeta.TotalTarjeta);
        qSaveComp.ParamByName('NroCtas').AsInteger := Factura.CantCuotas;
        qSaveComp.ParamByName('Contado').AsCurrency := TC*ABS(DatosPago.PagosContado);
        qSaveComp.ParamByName('Tickets').AsCurrency:= TC*ABS(DatosPago.PagosBonosTk);
        qSaveComp.ParamByName('Cheque').AsCurrency := TC*ABS(DatosPago.PagosValores.TotalValores);
        qSaveComp.ParamByName('OtrosPagos').AsCurrency := 0;
        qSaveComp.ParamByName('CobSenas').AsCurrency := TC*ABS(DatosPago.PagosSena);
        qSaveComp.ParamByName('CtaCte').AsCurrency := 0;
        qSaveComp.ParamByName('Senas').AsCurrency := 0;
      end;
      2: begin
        qSaveComp.ParamByName('IdTarjeta').AsInteger := 0;
        qSaveComp.ParamByName('Tarjeta').AsCurrency := 0;
        qSaveComp.ParamByName('NroCtas').AsInteger := 0;
        qSaveComp.ParamByName('OtrosPagos').AsCurrency := TC*ABS(DatosPago.TotalPagos);
        qSaveComp.ParamByName('Contado').AsCurrency := 0;
        qSaveComp.ParamByName('Tickets').AsCurrency:= 0;
        qSaveComp.ParamByName('Cheque').AsCurrency := 0;
        qSaveComp.ParamByName('CobSenas').AsCurrency := 0;
        qSaveComp.ParamByName('CtaCte').AsCurrency := 0;
        qSaveComp.ParamByName('Senas').AsCurrency := 0;
      end;
    end
  end
  else begin
    qSaveComp.ParamByName('Situacion').AsInteger := Factura.Situacion;
    qSaveComp.ParamByName('IdTarjeta').AsInteger := Factura.IdTarjeta;
    qSaveComp.ParamByName('Tarjeta').AsCurrency := DatosPago.PagosTarjeta.TotalTarjeta;
    qSaveComp.ParamByName('NroCtas').AsInteger := Factura.CantCuotas;
    qSaveComp.ParamByName('Contado').AsCurrency := DatosPago.PagosContado;
    qSaveComp.ParamByName('Tickets').AsCurrency:= DatosPago.PagosBonosTk;
    qSaveComp.ParamByName('Cheque').AsCurrency := DatosPago.PagosValores.TotalValores;
    if ABS(DatosPago.PagosNCred.MtoNotaCre) > 0 then
      qSaveComp.ParamByName('OtrosPagos').AsCurrency := ABS(DatosPago.PagosNCred.MtoNotaCre) - DatosPago.SdoAFavor
    else
      qSaveComp.ParamByName('OtrosPagos').AsCurrency := DatosPago.SdoAFavor;
    qSaveComp.ParamByName('CobSenas').AsCurrency := DatosPago.PagosSena;
    qSaveComp.ParamByName('CtaCte').AsCurrency := 0;
    qSaveComp.ParamByName('Senas').AsCurrency := 0;
  end;

  qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
  qSaveComp.ParamByName('Dir_Entrega').AsString := Factura.DomicilioE;
  qSaveComp.ParamByName('State').AsInteger := 0;

  if Factura.IdSucursal = IdBranch then
    qSaveComp.ParamByName('FechaIS').Clear
  else
    qSaveComp.ParamByName('FechaIS').AsDate := Factura.FechaIS;

  if ServidorFiscal then
  begin    //  SERVIDOR FISCAL  - Controlador Fiscal Compartido - Una Sola Caja
    if (Factura.TipoFactura in [CreA, CreB]) and (CualTipoControlador < ControladorTipoFactura) then
    begin
      qSaveComp.ParamByName('FechaI').AsDate := Factura.FechaF;
      qSaveComp.ParamByName('Impresa').AsInteger := Impresa
    end
    else begin
      qSaveComp.ParamByName('FechaI').AsDate := Factura.FechaF;
      qSaveComp.ParamByName('Impresa').AsInteger := NoImpresa;
      if (Factura.Entidad = Impersonal) and
         (Trim(Factura.NombreEnt) > Cero) then
      begin
        CliServFiscal.Open;
        CliServFiscal.Insert;
        CliServFiscalIdFactura.AsInteger := Factura.IdFactura;
        CliServFiscalNombre.AsString := Factura.NombreEnt;
        CliServFiscal.Post;
        CliServFiscal.Close;
      end;
    end
  end
  else begin
    qSaveComp.ParamByName('FechaI').AsDate := Factura.FechaF;
    qSaveComp.ParamByName('Impresa').AsInteger := Impresa;
  end;
  qSaveComp.ParamByName('EntContado').AsCurrency := Factura.EntContado;
  qSaveComp.ParamByName('IdEmpresa').AsInteger := Factura.IdEmpresa;

  try
    if not trSaveComp.InTransaction then
      trSaveComp.StartTransaction;
    try
      qSaveComp.ExecSQL; //Grabar
    except
      on E:Exception do
        raise EUsuario.Create('El Comprobante Nº '+Factura.NroFactura+' no se puede Grabar '+E.Message);
    end;

    try
      NumItems := 1;
      while NumItems <= Factura.CantArtic do
      begin
        qSaveComp.Close;
        qSaveComp.Sql.Clear;
        qSaveComp.SQL.Text := SaveItmV;
        if ItemsFactura[NumItems].IdProducto > 0 then
        begin
          with ItemsFactura[NumItems] do
          begin
            qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
            qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
            qSaveComp.ParamByName('IdPuntoVenta').AsInteger := Factura.IdPuntoVenta;
            qSaveComp.ParamByName('IdItem').AsInteger := NumItems;
            qSaveComp.ParamByName('IdArticulo').AsInteger := IdProducto;
            qSaveComp.ParamByName('Talle').AsInteger := Talle;
            qSaveComp.ParamByName('SubDet').AsString := SubDet;
            qSaveComp.ParamByName('FechaF').AsDate := Factura.FechaF;
            qSaveComp.ParamByName('NroCtas').AsInteger := Factura.CantCuotas;
            qSaveComp.ParamByName('Cantidad').AsFloat := TC*ABS(Cantidad);
            qSaveComp.ParamByName('Descuento').AsCurrency := TC*ABS(Descuento - ((Descuento * CoefDcto) / 100));
            qSaveComp.ParamByName('PrcBonificacion').AsCurrency := TC*ABS(Bonificacion - ((Bonificacion * CoefDcto) / 100));
            qSaveComp.ParamByName('PrecioNeto').AsCurrency := TC*ABS(PrecioNetoT - ((PrecioNetoT * CoefDcto) / 100));
            qSaveComp.ParamByName('PrecioFinal').AsCurrency := TC*ABS(PrecioFinal - ((PrecioFinal * CoefDcto) / 100));
            qSaveComp.ParamByName('PrecioTotal').AsCurrency := TC*ABS(PrecioTotal - ((PrecioTotal * CoefDcto) / 100));
            qSaveComp.ParamByName('Exento').AsCurrency := TC*ABS(Exento - ((Exento * CoefDcto) / 100));
            qSaveComp.ParamByName('ImpInt').AsCurrency := TC*ABS(NoComputable - ((NoComputable * CoefDcto) / 100));
            qSaveComp.ParamByName('IvaIn').AsCurrency := TC*ABS(MtoIva - ((MtoIva * CoefDcto) / 100));
            qSaveComp.ParamByName('PrecioCosto').AsCurrency := TC*ABS(PrecioCosto);
            qSaveComp.ParamByName('ValorLista').AsCurrency := TC*ABS(PrecioLista);
            qSaveComp.ParamByName('IdAlcIva').AsInteger := IdAlcIva;
            qSaveComp.ParamByName('AlicuotaIva').AsFloat := AlicuotaIva;
            qSaveComp.ParamByName('IdSubDep').AsInteger := IdSubDep;
            qSaveComp.ParamByName('IdAlcIB').AsInteger := IdAlcIB;
            qSaveComp.ParamByName('AlcIB').AsFloat := AlicuotaIB;
            qSaveComp.ParamByName('IngBto').AsCurrency:= TC*ABS(IngBto - ((IngBto * CoefDcto) / 100));

            if EnOferta then
            begin
              qSaveComp.ParamByName('Oferta').AsInteger := Verdadero;
              try
                q := TMDOQuery.Create(nil);
                q.Database := dmGestion.dbGestion;
                q.Transaction := trSaveComp;
                q.SQL.Add('UPDATE ARTOFERTAS  ');
                q.SQL.Add('   SET CANTVEN = CANTVEN + 1 ');
                q.SQL.Add('WHERE IDARTICULO = :IDART AND ');
                q.SQL.Add('      CANTCTAS = :CCTAS AND ');
                q.SQL.Add('      IDSUCURSAL = :IDSUC ');
                q.ParamByName('IdArt').AsInteger := IdProducto;
                q.ParamByName('CCtas').AsInteger := Factura.CantCuotas;
                q.ParamByName('IdSuc').AsInteger := Factura.IdSucursal;
                q.ExecSQL;
              finally
                q.Free;
              end;
            end
            else begin
              qSaveComp.ParamByName('Oferta').AsInteger := Falso;
            end;

            // Grabar Stock
            if (Factura.TipoFactura in [RemitoX, Presupuesto]) then
            begin
              if ConDescStk then
              begin
                qSaveComp.ParamByName('DctoStk').AsInteger := Verdadero;
                Update_Parts(IdProducto, Factura.IdSucursal, Cantidad, Talle,
                             Factura.TipoFactura, 1, Servicio, EsKit,
                             qSaveComp.Database, qSaveComp.Transaction);
              end
              else begin
                qSaveComp.ParamByName('DctoStk').AsInteger := Falso
              end
            end
            else begin
              qSaveComp.ParamByName('DctoStk').AsInteger := Verdadero;
              Update_Parts(IdProducto, Factura.IdSucursal, Cantidad, Talle,
                           Factura.TipoFactura, 1, Servicio, EsKit,
                           qSaveComp.Database, qSaveComp.Transaction);
            end;

            qSaveComp.ParamByName('State').AsInteger := Falso;
            qSaveComp.ParamByName('EntContado').AsCurrency := EntContado;
            qSaveComp.ParamByName('MosDom').AsInteger := MosDom;
            qSaveComp.ParamByName('IdAutorDto').AsInteger := IdAutorDto;
            qSaveComp.ParamByName('IdSucSalida').AsInteger := IdSucSalida;

            // Grabar Items
 //           SysUtils.Wr
//            Writeln(qSaveComp.SQL);
            Factura.NroFactura := qSaveComp.SQL.Text;
            qSaveComp.ExecSQL;
            if DetalleExtendido then // Grabar Detalle de Items
            begin
              try
                q := TMDOQuery.Create(nil);
                q.Database := qSaveComp.Database;
                q.Transaction := qSaveComp.Transaction;
                q.SQL.Text := SaveDetI;
                q.ParamByName('IDFACTURA').AsInteger := Factura.IdFactura;
                q.ParamByName('IDSUCURSAL').AsInteger:= Factura.IdSucursal;
                q.ParamByName('IDITEM').AsInteger := NumItems;
                q.ParamByName('DETALLE1').AsString := DetalleExt[1];
                q.ParamByName('DETALLE2').AsString := DetalleExt[2];
                q.ParamByName('DETALLE3').AsString := DetalleExt[3];
                q.ParamByName('DETALLE4').AsString := DetalleExt[4];
                q.ExecSQL;
              finally
                q.Free;
              end;
            end;
          end;
        end;
        Inc(NumItems);
      end;
    except
      on E:Exception do
        raise EUsuario.Create('Los Items del Comprobante Nº '+Factura.NroFactura+' no se pueden Grabar. '+E.Message);
    end;

    //Registrar tipos de Pagos
    if Factura.TipoFactura in [CreA, CreB, CreC, CreditoAjuste] then
    begin
      try
        if Tarjeta in DatosPago.PagosRealizados then
          DoPagoTarjeta(DatosPago);
      except
        on E:Exception do
          raise EUsuario.Create('La anulación de las tarjetas del Comprobante Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
      end;
    end
    else begin
      try // Registración de pagos con Tarjetas / Mutuales
        if Tarjeta in DatosPago.PagosRealizados then
          DoPagoTarjeta(DatosPago);
      except
        on E:Exception do
          raise EUsuario.Create('El pago de la Tarjeta del Comprobante Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
      end;
      try //Cheques de Terceros
        if Valores in DatosPago.PagosRealizados then
          DoPagoVentaValores(DatosPago);
      except
        on E:Exception do
          raise EUsuario.Create('El pago del Cheque del Comprobante Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
      end;

      try //Cobro de Señas
        if Senas in DatosPago.PagosRealizados then
          DoPagoSenas(DatosPago);
      except
        on E:Exception do
          raise EUsuario.Create('La cancelación de las Señas del Comprobante Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
      end;

      try // Marcar como usada la Nota de Credito por cambio
        if NotaCre in DatosPago.PagosRealizados then
        begin
          DoPagoCambio(DatosPago);
          try //Generar Saldo A Favor por el sobrante de la Nota de Credito
            if SdoAFav in DatosPago.PagosRealizados then
              Grabar_Senas(DatosPago, SaldoAFavor);
          except
            on E:Exception do
              raise EUsuario.Create('La generación del Saldo a Favor del Comprobante Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
          end;
        end;
      except
        on E:Exception do
          raise EUsuario.Create('No se puede marcar la Nota de Credito por cambio '+E.Message);
      end;
    end;

    if Factura.IdSucursal = IdBranch then
    begin
      try // Actualizar numeracion de Comprobantes
        with dmGestion do
        begin
          qTerminales.Close;
          qTerminales.Transaction := trSaveComp;
          qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
          qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
          qTerminales.Open;
          qTerminales.Edit;
          Case Factura.TipoFactura of
            FacA,DebA  : qTerminalesCompA.AsString := Factura.NroFactura;
            CreA       : qTerminalesNotCredA.AsString := Factura.NroFactura;
            FacB,DebB  : qTerminalesCompB.AsString := Factura.NroFactura;
            CreB       : qTerminalesNotCredB.AsString := Factura.NroFactura;
            Tkt        : qTerminalesCompT.AsString := Factura.NroFactura;
            RemitoX    : qTerminalesRemX.AsString  := Factura.NroFactura;
            Presupuesto: qTerminalesPresupuesto.AsString := Factura.NroFactura;
            AvisoMora_1,
            AvisoMora_2,
            AvisoMora_3: qTerminalesAvisosMora.AsString := Inc_NComp(Factura.NroFactura);
            AcuerdoExJud:qTerminalesACUERDOEXJ.AsString := Inc_NComp(Factura.NroFactura);
        end;
          qTerminales.Post;
        end;
      except
        on E:Exception do
        begin
          raise EUsuario.Create('No se pudo actualizar la numeración de los Comprobantes '+E.Message);
        end;
      end;
    end;
    trSaveComp.Commit;
    Result := True;
  except
    on E:Exception do
    begin
      trSaveComp.Rollback;
      raise EUsuario.Create('El Comprobante Nº '+Factura.NroFactura+' no se pudo Grabar.- '+E.Message);
    end;
  end;
end;

function TdmSaveFile.DoPagoCambio(DatosPago: TDatosPagos): Boolean;
Const
  SaveCam = 'UpDate FacVen '+
            '   Set Situacion = 22, '+
            '       FechaIS = null '+
            'Where IdFactura =:IdFac And '+
            '      IdSucursal =:IdSuc And '+
            '      IdPuntoVenta =:IdPto ';
var
  q: TMDOQuery;
begin
  try
    Result := True;
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := trSaveComp;
      q.SQL.Text := SaveCam;
      q.ParamByName('IdFac').AsInteger := DatosPago.PagosNCred.IdFNotaCre;
      q.ParamByName('IdSuc').AsInteger := DatosPago.PagosNCred.IdSNotaCre;
      q.ParamByName('IdPto').AsInteger := DatosPago.PagosNCred.IdPNotaCre;
      q.ExecSQL;
    finally
      q.Free;
    end;
  except
    Result := False;
  end;
end;

//******************************************************************************
//                                 FIN VENTAS
//******************************************************************************

//******************************************************************************
//                                   SEÑAS
//******************************************************************************

function TdmSaveFile.Grabar_Senas(var DatosPago: TDatosPagos; TipoComp: SmallInt): Boolean;
Const
  SaveSena = 'Insert InTo '+
             'FacVen(IdFactura, IdSucursal, IdPuntoVenta, Sector, DiaHora, '+
             '       TipoFactura, Situacion, FechaF, FechaI, PuntoVta, '+
             '       NroFactura, CompRef, IdCompRef, Cliente, TipoIva, '+
             '       CantArtic, Impresa, IdMotNC, Bonificacion, Neto, '+
             '       Exento, NoComputables, IvaAlicuota1, IvaAlicuota2, '+
             '       Total, Contado, Tarjeta, IdTarjeta, NroCtas, Tickets, '+
             '       CtaCte, Cheque, OtrosPagos, Senas, CobSenas, Usuario, '+
             '       Empleado, FechaIS, Dir_Entrega, State) '+
             'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :Sector, :DiaHora, '+
             '       :TipoFactura, :Situacion, :FechaF, :FechaI, :PuntoVta, '+
             '       :NroFactura, :CompRef, :IdCompRef, :Cliente, :TipoIva, '+
             '       :CantArtic, :Impresa, :IdMotNC, :Bonificacion, :Neto, '+
             '       :Exento, :NoComputables, :IvaAlicuota1, :IvaAlicuota2, '+
             '       :Total, :Contado, :Tarjeta, :IdTarjeta, :NroCtas, :Tickets, '+
             '       :CtaCte, :Cheque, :OtrosPagos, :Senas, :CobSenas, :Usuario, '+
             '       :Empleado, :FechaIS, :Dir_Entrega, :State) ';
var
  AuxRec: St13;
begin
  if TipoComp = SaldoAFavor then
  begin
    if (DatosPago.SdoAFavor <= 0) and
       (DatosPago.OpcionNC = 1) then
      Exit;
  end;

  try
    Result := False;
    qSaveComp.Close;
    qSaveComp.Sql.Clear;
    qSaveComp.SQL.Text := SaveSena;
    if TipoComp = Cobro_Sena then
    begin
      if not trSaveComp.InTransaction then
        trSaveComp.StartTransaction;
    end;

    DatosPago.IdComprobante := Get_Ultimos(FacVenta);
    DatosPago.NroComprobante := GetNumeroComprobante(IdBranch, PtoVta, 0, ReciboX);
    qSaveComp.ParamByName('IdFactura').AsInteger := DatosPago.IdComprobante;
    qSaveComp.ParamByName('IdSucursal').AsInteger := IdBranch;
    qSaveComp.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
    qSaveComp.ParamByName('Sector').AsInteger := SectorSistema;
    qSaveComp.ParamByName('DiaHora').AsDateTime := Now;
    qSaveComp.ParamByName('TipoFactura').AsInteger := TipoComp;
    qSaveComp.ParamByName('Situacion').AsInteger := 0;
    qSaveComp.ParamByName('FechaF').AsDate := DatosPago.FechaOp;
    qSaveComp.ParamByName('FechaI').AsDate := DatosPago.FechaOp;
    try
      qSaveComp.ParamByName('PuntoVta').AsInteger := StrToInt(Copy(DatosPago.NroComprobante, 1, 4));
    except
      qSaveComp.ParamByName('PuntoVta').AsInteger := IdSalesPoint;
    end;
    qSaveComp.ParamByName('NroFactura').AsString := DatosPago.NroComprobante;
    qSaveComp.ParamByName('CompRef').AsString := '0000-00000000';
    qSaveComp.ParamByName('IdCompRef').AsInteger := 0;
    qSaveComp.ParamByName('Cliente').AsInteger := DatosPago.IdEntidad;
    qSaveComp.ParamByName('TipoIva').AsInteger := 0;
    qSaveComp.ParamByName('CantArtic').AsInteger := 0;
    qSaveComp.ParamByName('Impresa').AsInteger := 1;
    qSaveComp.ParamByName('IdMotNC').AsInteger := 0;
    qSaveComp.ParamByName('Bonificacion').AsCurrency := 0;
    qSaveComp.ParamByName('Neto').AsCurrency := 0;
    qSaveComp.ParamByName('Exento').AsCurrency := 0;
    qSaveComp.ParamByName('NoComputables').AsCurrency := 0;
    qSaveComp.ParamByName('IvaAlicuota1').AsCurrency := 0;
    qSaveComp.ParamByName('IvaAlicuota2').AsCurrency := 0;
    qSaveComp.ParamByName('NroCtas').AsInteger := 0;
    qSaveComp.ParamByName('CtaCte').AsCurrency := 0;
    qSaveComp.ParamByName('Senas').AsCurrency := 0;
    qSaveComp.ParamByName('CobSenas').AsCurrency := 0;
    qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
    qSaveComp.ParamByName('Empleado').AsInteger := DatosPago.IdVendedor;
    qSaveComp.ParamByName('FechaIS').Clear;
    qSaveComp.ParamByName('Dir_Entrega').AsString := DatosPago.Observaciones;
    qSaveComp.ParamByName('State').AsInteger := Falso;

    if TipoComp = Cobro_Sena then
    begin
      qSaveComp.ParamByName('Total').AsCurrency := DatosPago.TotalPagos;
      qSaveComp.ParamByName('Contado').AsCurrency := DatosPago.PagosContado;
      qSaveComp.ParamByName('Tickets').AsCurrency := DatosPago.PagosBonosTk;
      qSaveComp.ParamByName('Tarjeta').AsCurrency := DatosPago.PagosTarjeta.TotalTarjeta;
      qSaveComp.ParamByName('IdTarjeta').AsInteger := DatosPago.IdTarjeta;
      qSaveComp.ParamByName('Cheque').AsCurrency := DatosPago.PagosValores.TotalValores;
      qSaveComp.ParamByName('OtrosPagos').AsCurrency := 0;
    end
    else begin
      qSaveComp.ParamByName('Total').AsCurrency := DatosPago.SdoAFavor;
      qSaveComp.ParamByName('Contado').AsCurrency := 0;
      qSaveComp.ParamByName('Tickets').AsCurrency := 0;
      qSaveComp.ParamByName('Tarjeta').AsCurrency := 0;
      qSaveComp.ParamByName('IdTarjeta').AsInteger := 0;
      qSaveComp.ParamByName('Cheque').AsCurrency := 0;
      qSaveComp.ParamByName('OtrosPagos').AsCurrency := DatosPago.SdoAFavor;
    end;
    qSaveComp.ExecSQL;

    // Actualizar numeracion de Comprobantes
    with dmGestion do
    begin
      qTerminales.Close;
      qTerminales.Transaction := trSaveComp;
      qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
      qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
      qTerminales.Open;
      qTerminales.Edit;
      AuxRec := Inc_NComp(DatosPago.NroComprobante);
      if qTerminalesRECX.AsString = AuxRec then
        qTerminalesRECX.AsString := Inc_NComp(AuxRec)
      else
        qTerminalesRECX.AsString := AuxRec;
      qTerminales.Post;
    end;
    Result := True;

    if TipoComp = Cobro_Sena then
    begin
      try // Registración de pagos con Tarjetas / Mutuales
        if Tarjeta in DatosPago.PagosRealizados then
          DoPagoTarjeta(DatosPago);
      except
        on E:Exception do
          raise EUsuario.Create('El pago de la Tarjeta del Comprobante Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
      end;
      try //Cheques de Terceros
        if Valores in DatosPago.PagosRealizados then
          DoPagoVentaValores(DatosPago);
      except
        on E:Exception do
          raise EUsuario.Create('El pago del Cheque del Comprobante Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
      end;
      try
        trSaveComp.Commit;
      except
        on E:Exception do
        begin
          trSaveComp.Rollback;
          Result := False;
          raise EUsuario.Create('La Seña/SaF Nº '+DatosPago.NroComprobante+' no se puede Grabar '+E.Message);
        end
      end;
    end;
  except
    Result := False;
  end;
end;

procedure TdmSaveFile.DoPagoSenas(DatosPago: TDatosPagos);
var
  AuxPago, TotalFacV: Currency;
begin
  if ((DatosPago.PagosSena > 0) or
      (DatosPago.SdoAFavor > 0)) and
     (Senas_Cobradas.Active) then
  begin
    begin
      TotalFacV := 0;
      if (DatosPago.PagosSena+DatosPago.SdoAFavor) > DatosPago.TotalPagos then
        AuxPago := DatosPago.TotalPagos
      else
        AuxPago := DatosPago.PagosSena+DatosPago.SdoAFavor;
      Senas_Cobradas.First;
      while not Senas_Cobradas.Eof do
      begin
        qSaveComp.Close;
        qSaveComp.Sql.Clear;
        qSaveComp.SQL.Add('Select Total From FacVen ');
        qSaveComp.SQL.Add('Where IdFactura = :IdFac And ');
        qSaveComp.SQL.Add('      IdSucursal = :IdSuc And ');
        qSaveComp.SQL.Add('      IdPuntoVenta = :IdPto ');
        qSaveComp.ParamByName('IdFac').AsInteger := Senas_CobradasIdFactura.AsInteger;
        qSaveComp.ParamByName('IdSuc').AsInteger := Senas_CobradasIdSucursal.AsInteger;
        qSaveComp.ParamByName('IdPto').AsInteger := Senas_CobradasIdPuntoVenta.AsInteger;
        qSaveComp.Open;
        TotalFacV := qSaveComp.FieldByName('Total').AsCurrency;
        qSaveComp.Close;
        qSaveComp.Sql.Clear;

        if AuxPago >= TotalFacV then
        begin      // Cobrada
          qSaveComp.SQL.Add('UpDate FacVen ');
          qSaveComp.SQL.Add('    Set Impresa = 2, ');
          qSaveComp.SQL.Add('    FechaI = :FAP, ');
          qSaveComp.SQL.Add('    CompRef = :NRF, ');
          qSaveComp.SQL.Add('    IdCompRef = :IFA, ');
          qSaveComp.SQL.Add('    FechaIS = :FIS ');
          qSaveComp.SQL.Add('Where IdFactura  =:IdFac And ');
          qSaveComp.SQL.Add('      IdSucursal =:IdSuc And ');
          qSaveComp.SQL.Add('      IdPuntoVenta =:IdPto And ');
          qSaveComp.SQL.Add('      TipoFactura in (42, 100) ');
        end
        else begin   // Uso Parcial
          qSaveComp.SQL.Add('UpDate FacVen ');
          qSaveComp.SQL.Add('   Set EntContado = Total, ');
          qSaveComp.SQL.Add('   Total = :TOT, ');
          qSaveComp.SQL.Add('   FechaI = :FAP, ');
          qSaveComp.SQL.Add('   CompRef = :NRF, ');
          qSaveComp.SQL.Add('   IdCompRef = :IFA, ');
          qSaveComp.SQL.Add('   FechaIS = null ');
          qSaveComp.SQL.Add('Where IdFactura =:IdFac And ');
          qSaveComp.SQL.Add('      IdSucursal =:IdSuc And ');
          qSaveComp.SQL.Add('      IdPuntoVenta =:IdPto And ');
          qSaveComp.SQL.Add('      TipoFactura in (42, 100) ');
          qSaveComp.ParamByName('TOT').AsCurrency := ABS(TotalFacV - AuxPago);
        end;
        qSaveComp.ParamByName('FAP').AsDate := DatosPago.FechaOp;
        qSaveComp.ParamByName('NRF').AsString := DatosPago.NroComprobante;
        qSaveComp.ParamByName('IFA').AsInteger := DatosPago.IdComprobante;
        qSaveComp.ParamByName('IdFac').AsInteger := Senas_CobradasIdFactura.AsInteger;
        qSaveComp.ParamByName('IdSuc').AsInteger := Senas_CobradasIdSucursal.AsInteger;
        qSaveComp.ParamByName('IdPto').AsInteger := Senas_CobradasIdPuntoVenta.AsInteger;
        qSaveComp.ExecSQL;
        AuxPago := AuxPago - TotalFacV;
        Senas_Cobradas.Next;
      end;
      Senas_Cobradas.Close;
    end;
  end;
end;
//******************************************************************************
//                                   FIN SEÑAS
//******************************************************************************

//******************************************************************************
//          Tarjetas y Mutuales
//******************************************************************************

procedure TdmSaveFile.DoPagoTarjeta(var DatosPago: TDatosPagos);
var
  i,j, CantMov: SmallInt;
  IdMovT: Integer;
  q: TMDOQuery;
begin
  if DatosPago.TipoComprobante in [CreB, CreA] then
  begin
    for i := 1 to DatosPago.PagosTarjeta.CantTarjetas do
    begin
      if ((DatosPago.PagosTarjeta.Movimientos[i].TipoEntidad in [2, 3]) And
          (DatosPago.OpcionNC = 0)) Or
         (DatosPago.OpcionNC = 1) then
      begin
        try  // Anulacion Operacion
          q := TMDOQuery.Create(nil);
          q.Database := dmGestion.dbGestion;
          q.Transaction := trSaveComp;
          q.SQL.Add('UpDate MovTar ');
          q.SQL.Add('   Set Estado = 4 ');
          q.SQL.Add('Where IdMov = :IdMov And ');
          q.SQL.Add('      IdTarjeta = :IdTar And ');
          q.SQL.Add('      IdSucursal = :IdSuc ');
          q.ParamByName('IdMov').AsInteger := DatosPago.PagosTarjeta.Movimientos[i].IdMovTar;
          q.ParamByName('IdTar').AsInteger := DatosPago.PagosTarjeta.Movimientos[i].IdTarMut;
          q.ParamByName('IdSuc').AsInteger := DatosPago.IdSucursal;
          q.ExecSQL;
        finally
          q.Free;
        end;
      end
    end;
  end
  else begin
    for i := 1 to DatosPago.PagosTarjeta.CantTarjetas do
    begin
      qSaveMovTar.Close;
      try
        q := TMDOQuery.Create(nil);
        q.Database := qSaveMovTar.Database;
        q.Transaction := qSaveMovTar.Transaction;
        q.SQL.Add('Select Max(IdMov) as Ultimo ');
        q.SQL.Add('From MovTar ');
        q.SQL.Add('Where IdSucursal = :S ');
        q.ParamByName('S').AsInteger := DatosPago.IdSucursal;
        q.Open;
        IdMovT := q.FieldByName('Ultimo').AsInteger + 1;
        q.Close;
      finally
        q.Free;
      end;

      if DatosPago.PagosTarjeta.Movimientos[i].IdCliente = 0 then
        DatosPago.PagosTarjeta.Movimientos[i].IdCliente := DatosPago.IdEntidad;

      with DatosPago.PagosTarjeta.Movimientos[i] do
      begin
        qSaveMovTar.ParamByName('IdMov').AsInteger := IdMovT;
        qSaveMovTar.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
        qSaveMovTar.ParamByName('IdTarjeta').AsInteger := IdTarMut;
        qSaveMovTar.ParamByName('CodTar').AsString := NumTarjeta;
        qSaveMovTar.ParamByName('IdCliente').AsInteger := IdCliente;
        qSaveMovTar.ParamByName('IdFactura').AsInteger := DatosPago.IdComprobante;
        qSaveMovTar.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
        qSaveMovTar.ParamByName('Autorizacion').AsString := Autorizacion;
        qSaveMovTar.ParamByName('NroCuota').AsInteger := CantidadCuotas;
        qSaveMovTar.ParamByName('ImpCuota').AsFloat := MontoCuota;
        qSaveMovTar.ParamByName('TotalOp').AsCurrency := TotalTarj;
        qSaveMovTar.ParamByName('FechaOp').AsDate := DatosPago.FechaOp;
        qSaveMovTar.ParamByName('Cupon').AsString := Cupon;
        qSaveMovTar.ParamByName('Lote').AsString := Lote;
        qSaveMovTar.ParamByName('Estado').AsInteger := 0;
        qSaveMovTar.ParamByName('CuotaPag').AsInteger := 0;
        qSaveMovTar.ParamByName('State').AsInteger := 0;
        qSaveMovTar.ParamByName('FechaIS').Clear;
        qSaveMovTar.ParamByName('UltimoPago').Clear;
        qSaveMovTar.ParamByName('NroFactOrg').AsString := DatosPago.NroComprobante;
        qSaveMovTar.ParamByName('IdTerminal').AsInteger := Terminal;
        qSaveMovTar.ExecSQL;
        // Generar Movimiento de Cuotas
        if CantidadCuotas > 0 then
        begin
          if TipoEntidad = 1 then
            CantMov := 1
          else
            CantMov := CantidadCuotas;
          Vencimiento := Venc_1a_Cta;
          DatosPago.IdMovTar := IdMovT;
          for j := 1 to CantMov do
          begin
            qSaveMovCta.ParamByName('IdMovCred').AsInteger := IdMovT;
            qSaveMovCta.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
            qSaveMovCta.ParamByName('NroCuota').AsInteger := j;
            qSaveMovCta.ParamByName('IdFactura').AsInteger := DatosPago.IdComprobante;
            qSaveMovCta.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
            qSaveMovCta.ParamByName('IdTarjeta').AsInteger := IdTarMut;
            qSaveMovCta.ParamByName('FechaV').AsDate := Vencimiento;
            qSaveMovCta.ParamByName('FecVtoOrg').AsDate := Vencimiento;
            qSaveMovCta.ParamByName('MontoCuota').AsCurrency := MontoCuota;
            qSaveMovCta.ParamByName('NroRecPago').AsString := '';
            qSaveMovCta.ParamByName('FechaP').Clear;
            qSaveMovCta.ParamByName('MontoDebito').AsCurrency := 0;
            qSaveMovCta.ParamByName('MontoCredito').AsCurrency := 0;
            qSaveMovCta.ParamByName('NroNotaDeb').AsString := '0000-00000000';
            qSaveMovCta.ParamByName('IdNroNota').AsInteger := 0;
            qSaveMovCta.ParamByName('IdRecibo').AsInteger := 0;
            qSaveMovCta.ParamByName('IdSucRec').AsInteger := 0;
            qSaveMovCta.ParamByName('IdPuntoRec').AsInteger := 0;
            qSaveMovCta.ParamByName('IdCliente').AsInteger := IdCliente;
            qSaveMovCta.ParamByName('Cobrado').AsCurrency := 0;
            qSaveMovCta.ParamByName('SaldoCuota').AsCurrency := MontoCuota;
            qSaveMovCta.ParamByName('Estado').AsInteger := 0;
            qSaveMovCta.ParamByName('FechaIS').Clear;
            qSaveMovCta.ParamByName('FechaIC').Clear;
            qSaveMovCta.ExecSQL;
            Vencimiento := IncMonth(Vencimiento, 1);
          end;
        end;
      end;
    end;
  end;
end;

function TdmSaveFile.DoPagoCuota(var DatosPago: TDatosPagos; ItemsRec: TBody_Fiscal): Boolean;
Const
  Up_Cred = 'UpDate MovTar '+
            '   Set CuotaPag = :CuotaPag, '+
            '       VenCuota = :VenCuota,  '+
            '       NroRecPago = :NroRecibo, '+
            '       NroLiquidacion = :NroLiquid, '+
            '       Estado = :Estado, '+
            '       FechaIS = :FechaIS, '+
            '       UltimoPago = :UltimoPago '+
            'Where IdMov = :IdMov And '+
            '      IdSucursal = :IdSucursal And '+
            '      IdTarjeta = :IdTarjeta ';

  Up_Cuota= 'UpDate MovCuotas '+
            '   Set NroRecPago = :NroRecibo, '+
            '       FechaP = :FecPag, '+
            '       FechaV = :FecVto, '+
            '       MontoDebito = :MontoDeb, '+
            '       MontoCredito = :MontoCre, '+
            '       NroNotaDeb = :NotaDeb, '+
            '       IdNroNota = :IdNroNota, '+
            '       IdRecibo = :IdRecibo, '+
            '       IdSucRec = :IdSucRec, '+
            '       IdPuntoRec = :IdPtoRec, '+
            '       Estado = :Estado, '+
            '       MontoCuota = :MontoCta, '+
            '       Cobrado = Cobrado + :Cobrado, '+
            '       SaldoCuota = :SaldoCta, '+
            '       CantPagos = :CantPag, '+
            '       FechaIS = Null '+
            'Where IdMovCred = :IdMov And '+
            '      IdSucursal = :IdSuc And '+
            '      NroCuota = :NrCta and '+
            '      IdCliente = :IdCli ';

  SaveRec = 'Insert InTo '+
            'FacVen(IdFactura, IdSucursal, IdPuntoVenta, Sector, DiaHora, '+
            '       TipoFactura, Situacion, FechaF, FechaI, PuntoVta, '+
            '       NroFactura, CompRef, IdCompRef, Cliente, TipoIva, '+
            '       CantArtic, Impresa, IdMotNC, Bonificacion, Neto, Exento, '+
            '       NoComputables,  IvaAlicuota1, IvaAlicuota2, Total, IdSubDep,  '+
            '       Contado, Tarjeta, IdTarjeta, NroCtas, Tickets, CtaCte, '+
            '       Cheque, OtrosPagos, Senas, CobSenas, Usuario, Empleado, '+
            '       State, FechaIS, IdEmpresa) '+
            'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :Sector, :DiaHora, '+
            '       :TipoFactura, :Situacion, :FechaF, :FechaI, :PuntoVta, '+
            '       :NroFactura, :CompRef, :IdCompRef, :Cliente, :TipoIva, '+
            '       :CantArtic, :Impresa, :IdMotNC, :Bonificacion, :Neto, :Exento, '+
            '       :NoComputables, :IvaAlicuota1, :IvaAlicuota2, :Total, :IdSubDep, '+
            '       :Contado, :Tarjeta, :IdTarjeta, :NroCtas, :Tickets, :CtaCte,  '+
            '       :Cheque, :OtrosPagos, :Senas, :CobSenas, :Usuario, :Empleado, '+
            '       :State, :FechaIS, :IdEmpresa) ';

  SaveCta = 'Insert InTo '+
            'ItemsFV(IdFactura, IdSucursal, IdPuntoVenta, IdItem, IdArticulo, '+
            '        Talle, SubDet, FechaF, NroCtas, Cantidad, Descuento, '+
            '        PrcBonificacion, PrecioNeto, PrecioFinal, PrecioTotal, '+
            '        Exento, ImpInt, IvaIn, PrecioCosto, ValorLista, IdAlcIva, '+
            '        AlicuotaIva, IdSubDep, IdAlcIB, AlcIB, IngBto, Oferta, '+
            '        IdSucSalida, IdAutorDto, State) '+
            'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :IdItem, :IdArticulo, '+
            '       :Talle, :SubDet, :FechaF, :NroCtas, :Cantidad, :Descuento, '+
            '       :PrcBonificacion, :PrecioNeto, :PrecioFinal, :PrecioTotal, '+
            '       :Exento, :ImpInt, :IvaIn, :PrecioCosto, :ValorLista, :IdAlcIva, '+
            '       :AlicuotaIva, :IdSubDep, :IdAlcIB, :AlcIB, :IngBto, :Oferta, '+
            '       :IdSucSalida, :IdAutorDto, :State) ';

  SaveCli = 'INSERT INTO  '+
            'CLIENTES(IDCLIENTE, IDSUCURSAL, NOMBRE, DIRECCION, LOCALIDAD, '+
            '         PROVINCIA, TIPOIVA, TIPODOC, DOCUMENTO, CODBUSCLI, TIPOCLI) '+
            'VALUES(:IDCLIENTE, :IDSUCURSAL, :NOMBRE, :DIRECCION, :LOCALIDAD, '+
            '       :PROVINCIA, :TIPOIVA, :TIPODOC, :DOCUMENTO, :CODBUSCLI, :TIPOCLI) ';

  Chq_Cli = 'Select IdCliente '+
            'From Clientes '+
            'Where DOCUMENTO = :NDoc And '+
            '      TIPODOC = :TDoc And '+
            '      IDSUCURSAL = :IdSc ';
var
  AuxRec: St13;
  AuxSen: Currency;
  NroCta, CtaPag, TipoTj, NumItems: SmallInt;
  IdCliLiq: Integer;
  q: TMDOQuery;
begin
  Result := False;
  AuxSen := 0;
  IdCliLiq := DatosPago.IdEntidad;
  try
    if not trSaveComp.InTransaction then
      trSaveComp.StartTransaction;

    if DatosPago.TipoComprobante = Liquidacion then
    begin
      try  // Chequear Cliente
        IdCliLiq := 0;
        q := TMDOQuery.Create(nil);
        q.Database := dmGestion.dbGestion;
        q.Transaction := trSaveComp;
        q.SQL.Text := Chq_Cli;
        q.ParamByName('NDoc').AsString := DatosPago.Documento;
        q.ParamByName('TDoc').AsInteger := DatosPago.TipoDoc;
        q.ParamByName('IdSc').AsInteger := DatosPago.IdSucursal;
        q.Open;
        IdCliLiq := q.FieldByName('IdCliente').AsInteger;
        q.Close;
      finally
        q.Free;
      end;

      if IdCliLiq = 0 then
      begin // Grabar Cliente nuevo
        try
          q := TMDOQuery.Create(nil);
          q.Database := dmGestion.dbGestion;
          q.Transaction := trSaveComp;
          q.SQL.Add('Select MAX(IDCLIENTE) As Ultimo ');
          q.SQL.Add('From CLIENTES ');
          q.SQL.Add('Where IDSUCURSAL =:IdSuc ');
          q.ParamByName('IdSuc').AsInteger := IdBranch;
          q.Open;
          IdCliLiq := q.FieldByName('Ultimo').AsInteger + 1;
          q.Close;
        finally
          q.Free;
        end;

        try
          q := TMDOQuery.Create(nil);
          q.Database := dmGestion.dbGestion;
          q.Transaction := trSaveComp;
          q.SQL.Text := SaveCli;
          q.ParamByName('IDCLIENTE').AsInteger := IdCliLiq;
          q.ParamByName('IDSUCURSAL').AsInteger := IdBranch;
          q.ParamByName('NOMBRE').AsString := 'Liq. '+DatosPago.NombreCli;
          q.ParamByName('DIRECCION').AsString := DatosPago.Direccion;
          q.ParamByName('LOCALIDAD').AsString := DatosPago.Localidad;
          q.ParamByName('PROVINCIA').AsString := DatosPago.Provincia;
          q.ParamByName('TIPOIVA').AsInteger := DatosPago.TipoIva;
          q.ParamByName('TIPODOC').AsInteger := DatosPago.TipoDoc;
          q.ParamByName('DOCUMENTO').AsString := DatosPago.Documento;
          q.ParamByName('CODBUSCLI').AsString := IntToStr(IdCliLiq);
          q.ParamByName('TIPOCLI').AsInteger := 1;
          q.ExecSQL;
        finally
          q.Free;
        end;
      end;
    end;

    DatosPago.IdEntidad := IdCliLiq;
    DatosPago.IdComprobante := Get_Ultimos(FacVenta);
    NroCta := 0;
    CtaPag := 0;
    TipoTj := 0;

    for NumItems := 1 to DatosPago.CuotasPagadas do
    begin
      try // Actualizar MovTar pago cuota
        q := TMDOQuery.Create(nil);
        q.Database := dmGestion.dbGestion;
        q.Transaction := trSaveComp;
        q.SQL.Add('Select M.NroCuota, M.CuotaPag, T.TipoEnt ');
        q.SQL.Add('From MovTar M ');
        q.SQL.Add('Join Tarjetas T ');
        q.SQL.Add('  on T.IdTarjeta = M.IdTarjeta ');
        q.SQL.Add('Where (M.IdMov = :IdM) And ');
        q.SQL.Add('      (M.IdSucursal = :IdS) And ');
        q.SQL.Add('      (M.IdTarjeta = :IdT) ');
        q.ParamByName('IdM').AsInteger := ItemsRec[NumItems].Talle;        // IdMov
        q.ParamByName('IdS').AsInteger := ItemsRec[NumItems].IdSubDep;     // IdSucursal
        q.ParamByName('IdT').AsInteger := ItemsRec[NumItems].IdSucSalida;  // IdTarjeta
        q.Open;
        NroCta := q.FieldByName('NroCuota').AsInteger;
        CtaPag := q.FieldByName('CuotaPag').AsInteger;
        TipoTj := q.FieldByName('TipoEnt').AsInteger;
        q.Close;
      finally
        q.Free;
      end;

      qSaveComp.Close;
      qSaveComp.Sql.Clear;
      qSaveComp.Transaction := trSaveComp;
      qSaveComp.SQL.Text := Up_Cred;
      qSaveComp.ParamByName('FechaIS').Clear;
      qSaveComp.ParamByName('NroRecibo').AsString := DatosPago.NroComprobante;
      qSaveComp.ParamByName('NroLiquid').AsString := DatosPago.NroOrdDePago;
      if (TipoTj in [1,2,4]) then  // Setear Estado del Credito
      begin
        qSaveComp.ParamByName('CuotaPag').AsInteger := CtaPag + 1;
        qSaveComp.ParamByName('Estado').AsInteger := 1 // Pagada
      end
      else begin
        if NroCta > CtaPag then
        begin
          qSaveComp.ParamByName('CuotaPag').AsInteger := CtaPag + 1;
          if CtaPag = 0 then
            qSaveComp.ParamByName('Estado').AsInteger := 0 // Normal
          else
            qSaveComp.ParamByName('Estado').AsInteger := 2 // en cobro
        end
        else begin
          if (NroCta > 0) and
             (CtaPag > 0) and
             (NroCta = (CtaPag + 1)) and
             (ItemsRec[NumItems].EnOferta) then
          begin
            qSaveComp.ParamByName('CuotaPag').AsInteger := CtaPag + 1;
            qSaveComp.ParamByName('Estado').AsInteger := 1; // Pagada
          end
          else begin
            qSaveComp.ParamByName('CuotaPag').AsInteger := CtaPag;
            qSaveComp.ParamByName('Estado').AsInteger := 2 // en cobro
          end
        end;
      end;
      qSaveComp.ParamByName('VenCuota').AsDate := ItemsRec[NumItems].VtoSte;
      qSaveComp.ParamByName('IdMov').AsInteger := ItemsRec[NumItems].Talle;
      qSaveComp.ParamByName('IdSucursal').AsInteger := ItemsRec[NumItems].IdSucursal;
      qSaveComp.ParamByName('IdTarjeta').AsInteger := ItemsRec[NumItems].IdSucSalida;
      qSaveComp.ParamByName('UltimoPago').AsDate := ItemsRec[NumItems].FechaF;
      qSaveComp.ExecSQL;
      // Pagar Cuota
      qSaveComp.Close;
      qSaveComp.Sql.Clear;
      qSaveComp.Transaction := trSaveComp;
      qSaveComp.SQL.Text := Up_Cuota;
      qSaveComp.ParamByName('NroRecibo').AsString := DatosPago.NroComprobante;
      qSaveComp.ParamByName('FecPag').AsDate := DatosPago.FechaOp;
      qSaveComp.ParamByName('FecVto').AsDate := ItemsRec[NumItems].VtoSte;
      qSaveComp.ParamByName('MontoDeb').AsCurrency := ItemsRec[NumItems].PrecioNetoT;
      qSaveComp.ParamByName('MontoCre').AsCurrency := ItemsRec[NumItems].Bonificacion;
      qSaveComp.ParamByName('NotaDeb').AsString := ItemsRec[NumItems].SubDet;
      qSaveComp.ParamByName('IdNroNota').AsInteger := ItemsRec[NumItems].IdAlcIva;
      qSaveComp.ParamByName('IdRecibo').AsInteger := DatosPago.IdComprobante;
      qSaveComp.ParamByName('IdSucRec').AsInteger := DatosPago.IdSucursal;
      qSaveComp.ParamByName('IdPtoRec').AsInteger := DatosPago.IdPuntoVenta;
      qSaveComp.ParamByName('MontoCta').AsCurrency := ItemsRec[NumItems].PrecioLista;
      qSaveComp.ParamByName('Cobrado').AsCurrency := ItemsRec[NumItems].PrecioFinal;
      qSaveComp.ParamByName('SaldoCta').AsCurrency := ItemsRec[NumItems].PrecioCosto;
      qSaveComp.ParamByName('CantPag').AsInteger := ItemsRec[NumItems].IdAlcIB;
      if (ItemsRec[NumItems].EnOferta) then
        qSaveComp.ParamByName('Estado').AsInteger := 1  // Pagada  Pago Total
      else
        qSaveComp.ParamByName('Estado').AsInteger := 0; // Impaga Pago parcial
      qSaveComp.ParamByName('IdMov').AsInteger := ItemsRec[NumItems].Talle;
      qSaveComp.ParamByName('IdSuc').AsInteger := ItemsRec[NumItems].IdSubDep;
      qSaveComp.ParamByName('NrCta').AsInteger := ItemsRec[NumItems].Cuota;
      qSaveComp.ParamByName('IdCli').AsInteger := ItemsRec[NumItems].IdAutorDto;
      qSaveComp.ExecSQL;
    end;

    //Grabar Recibo X
    qSaveComp.Close;
    qSaveComp.Sql.Clear;
    qSaveComp.Transaction := trSaveComp;
    qSaveComp.SQL.Text := SaveRec;
    qSaveComp.ParamByName('IdFactura').AsInteger := DatosPago.IdComprobante;
    qSaveComp.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
    qSaveComp.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
    qSaveComp.ParamByName('Sector').AsInteger := SectorSistema;
    qSaveComp.ParamByName('DiaHora').AsDateTime := Now;
    qSaveComp.ParamByName('TipoFactura').AsInteger := DatosPago.TipoComprobante;
    qSaveComp.ParamByName('FechaF').AsDate := DatosPago.FechaOp;
    qSaveComp.ParamByName('FechaI').AsDate := DatosPago.FechaOr;
    try
      qSaveComp.ParamByName('PuntoVta').AsInteger := StrToInt(Copy(DatosPago.NroComprobante, 1, 4));
    except
      qSaveComp.ParamByName('PuntoVta').AsInteger := IdSalesPoint;
    end;
    qSaveComp.ParamByName('NroFactura').AsString := DatosPago.NroComprobante;
    qSaveComp.ParamByName('CompRef').AsString := '0000-00000000';
    qSaveComp.ParamByName('IdCompRef').AsInteger := DatosPago.IdCompRef;
    qSaveComp.ParamByName('Cliente').AsInteger := DatosPago.IdEntidad;
    qSaveComp.ParamByName('TipoIva').AsInteger := DatosPago.TipoIva;
    qSaveComp.ParamByName('CantArtic').AsInteger := DatosPago.CuotasPagadas;
    qSaveComp.ParamByName('Impresa').AsInteger := 1;
    qSaveComp.ParamByName('IdMotNC').AsInteger := 0;
    qSaveComp.ParamByName('Bonificacion').AsCurrency := DatosPago.PagosDcto;
    qSaveComp.ParamByName('Neto').AsCurrency := 0;
    qSaveComp.ParamByName('Exento').AsCurrency := 0;
    qSaveComp.ParamByName('NoComputables').AsCurrency := 0;
    qSaveComp.ParamByName('IvaAlicuota1').AsCurrency := 0;
    qSaveComp.ParamByName('IvaAlicuota2').AsCurrency := 0;
    qSaveComp.ParamByName('Situacion').AsInteger := 0;
    qSaveComp.ParamByName('Total').AsCurrency := DatosPago.TotalPagos;
    qSaveComp.ParamByName('IdSubDep').AsInteger := 0;
    qSaveComp.ParamByName('IdEmpresa').AsInteger:= DatosPago.IdEmpresa;
    qSaveComp.ParamByName('Contado').AsCurrency := DatosPago.PagosContado;
    qSaveComp.ParamByName('Tickets').AsCurrency := DatosPago.PagosBonosTk;
    qSaveComp.ParamByName('Tarjeta').AsCurrency := DatosPago.PagosTarjeta.TotalTarjeta;
    qSaveComp.ParamByName('IdTarjeta').AsInteger:= DatosPago.PagosTarjeta.Movimientos[1].IdTarMut;
    qSaveComp.ParamByName('NroCtas').AsInteger := DatosPago.CuotasPagadas;
    qSaveComp.ParamByName('CtaCte').AsCurrency := 0;
    qSaveComp.ParamByName('Cheque').AsCurrency := DatosPago.PagosValores.TotalValores;
    qSaveComp.ParamByName('OtrosPagos').AsCurrency := 0;
    qSaveComp.ParamByName('Senas').AsCurrency := 0;
    if (DatosPago.PagosSena + DatosPago.SdoAFavor) >
       (DatosPago.TotalPagos - (DatosPago.PagosContado+DatosPago.PagosTarjeta.TotalTarjeta+DatosPago.PagosBonosTk+DatosPago.PagosValores.TotalValores)) then
    begin
      qSaveComp.ParamByName('CobSenas').AsCurrency := (DatosPago.TotalPagos - (DatosPago.PagosContado+DatosPago.PagosTarjeta.TotalTarjeta+DatosPago.PagosBonosTk+DatosPago.PagosValores.TotalValores));
      AuxSen := (DatosPago.TotalPagos - (DatosPago.PagosContado+DatosPago.PagosTarjeta.TotalTarjeta+DatosPago.PagosBonosTk+DatosPago.PagosValores.TotalValores));
    end
    else begin
      if (DatosPago.PagosSena + DatosPago.SdoAFavor) > 0 then
      begin
        qSaveComp.ParamByName('CobSenas').AsCurrency := (DatosPago.PagosSena + DatosPago.SdoAFavor);
        AuxSen := (DatosPago.PagosSena + DatosPago.SdoAFavor);
      end
      else begin
        qSaveComp.ParamByName('CobSenas').AsCurrency := 0;
        AuxSen := 0;
      end;
    end;
    qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
    qSaveComp.ParamByName('Empleado').AsInteger := DatosPago.IdVendedor;
    qSaveComp.ParamByName('State').AsInteger := 0;
    qSaveComp.ParamByName('FechaIS').Clear;
    qSaveComp.ExecSQL;
    DatosPago.PagosSena := AuxSen;
    try
      NumItems := 1;
      for NumItems := 1 to DatosPago.CuotasPagadas do
      begin
        qSaveComp.Close;
        qSaveComp.Sql.Clear;
        qSaveComp.SQL.Text := SaveCta;
        qSaveComp.ParamByName('IdFactura').AsInteger := DatosPago.IdComprobante;
        qSaveComp.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
        qSaveComp.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
        qSaveComp.ParamByName('IdItem').AsInteger := NumItems;
        qSaveComp.ParamByName('IdArticulo').AsInteger := ItemsRec[NumItems].IdProducto;
        qSaveComp.ParamByName('Talle').AsInteger := ItemsRec[NumItems].Talle;               //IdMovCred
        qSaveComp.ParamByName('IdSubDep').AsInteger := ItemsRec[NumItems].IdSubDep;         //IdSucCred
        qSaveComp.ParamByName('SubDet').AsString := ItemsRec[NumItems].SubDet;              //Nro Nota Deb/Cre
        qSaveComp.ParamByName('FechaF').AsDate := ItemsRec[NumItems].FecVto;                //Fecha Vto
        qSaveComp.ParamByName('NroCtas').AsInteger := ItemsRec[NumItems].Cuota;             //Cuota Pagada
        qSaveComp.ParamByName('Cantidad').AsFloat := 1;
        qSaveComp.ParamByName('Descuento').AsCurrency := ItemsFiscal[NumItems].Bonificacion;// Va descuento
        qSaveComp.ParamByName('PrcBonificacion').AsCurrency := 0;
        qSaveComp.ParamByName('PrecioNeto').AsCurrency :=  ItemsRec[NumItems].PrecioNetoT;  // Va monto por mora
        qSaveComp.ParamByName('PrecioFinal').AsCurrency := ItemsRec[NumItems].PrecioFinal;  // Cobrado de la Cuota
        qSaveComp.ParamByName('PrecioTotal').AsCurrency := ItemsRec[NumItems].PrecioTotal;  // Monto cobrado actual
        qSaveComp.ParamByName('PrecioCosto').AsCurrency := ItemsRec[NumItems].PrecioCosto;  // Saldo total impago
        qSaveComp.ParamByName('ValorLista').AsCurrency := ItemsRec[NumItems].PrecioLista;   // Monto Original Cuota
        qSaveComp.ParamByName('Exento').AsCurrency := 0;
        qSaveComp.ParamByName('ImpInt').AsCurrency := 0;
        qSaveComp.ParamByName('IvaIn').AsCurrency := 0;
        qSaveComp.ParamByName('IdAlcIva').AsInteger := ItemsFiscal[NumItems].IdAlcIVA;      // Id Nota de Credito / Debito
        qSaveComp.ParamByName('AlicuotaIva').AsFloat := 0;
        qSaveComp.ParamByName('IdAlcIB').AsInteger := ItemsFiscal[NumItems].IdAlcIB;        // Cantidad de Pagos de la Cuota
        qSaveComp.ParamByName('AlcIB').AsFloat := 0;
        qSaveComp.ParamByName('IngBto').AsCurrency:= 0;
        qSaveComp.ParamByName('IdSucSalida').AsInteger := ItemsFiscal[NumItems].IdSucSalida; // IdTarjeta
        qSaveComp.ParamByName('IdAutorDto').AsInteger := ItemsFiscal[NumItems].IdAutorDto;   // IdCliente
        if ItemsRec[NumItems].EnOferta then                                                  // Pago Es total o parcial
          qSaveComp.ParamByName('Oferta').AsInteger := Verdadero
        else
          qSaveComp.ParamByName('Oferta').AsInteger := Falso;
        qSaveComp.ParamByName('State').AsInteger := Falso;
        qSaveComp.ExecSQL; // Grabar Items
      end;
    except
      on E:Exception do
        raise EUsuario.Create('Los Items del Recibo Nº '+Factura.NroFactura+' no se pueden Grabar. '+E.Message);
    end;

    if DatosPago.TipoComprobante = ReciboX then
    begin
      try //Registrar tipos de Pagos
        if Tarjeta in DatosPago.PagosRealizados then
          DoPagoTarjeta(DatosPago);
      except
        on E:Exception do
          raise EUsuario.Create('El pago de la Tarjeta del Recibo Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
      end;

      try //Registrar tipos de Pagos
        if Valores in DatosPago.PagosRealizados then
          DoPagoVentaValores(DatosPago);
      except
        on E:Exception do
          raise EUsuario.Create('El pago del Cheque del Recibo Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
      end;

      try
        if Senas in DatosPago.PagosRealizados then
          DoPagoSenas(DatosPago);
      except
        on E:Exception do
          raise EUsuario.Create('La cancelación de las Señas del Recibo Nº '+Factura.NroFactura+' no se pueden Grabar '+E.Message);
      end;

      with dmGestion do  // Actualizar numeracion de Comprobantes
      begin
        qTerminales.Close;
        qTerminales.Transaction := trSaveComp;
        qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
        qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
        qTerminales.Open;
        qTerminales.Edit;
        AuxRec := Inc_NComp(DatosPago.NroComprobante);
        if qTerminalesRECX.AsString = AuxRec then
          qTerminalesRECX.AsString := Inc_NComp(AuxRec)
        else
          qTerminalesRECX.AsString := AuxRec;
        qTerminales.Post;
      end;
    end;
    trSaveComp.Commit;
    Result := True;
  except
    on E: Exception do
    begin
      trSaveComp.Rollback;
      Result := False;
      raise EUsuario.Create('El Recibo Nº '+DatosPago.NroComprobante+' no se GRABO. ' + E.Message);
    end;
  end;
end;
//*****************************************************************************
//          FIN TARJETAS DE CREDITOS Y MUTUALES
//*****************************************************************************

//*****************************************************************************
//                        COMPRAS
//*****************************************************************************
function TdmSaveFile.GrabarComprobanteEgresos(var DatosPago: TDatosPagos; var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
Const
  SaveFacC = 'Insert InTo '+
             'FacCom(IdFactura, IdSucursal, IdPuntoVenta, IdEmpresa, DiaHora, '+
             '       IdCompRef, TipoFactura, Periodo, FechaF, NroFactura,  '+
             '       CompRef, CaiProv, Proveedor, TipoIva, CantArtic, '+
             '       PrcBonif, AlcPercepcion, Bonificacion, Neto, Exento, '+
             '       NoComputables, RetIva, RetGan, RetIBto, RetLH, '+
             '       IvaAlicuota1, IvaAlicuota2, IvaOtAlc, Total, Contado, '+
             '       Tickets, CtaCte,ChequeProp, ChequeTer, OtrosPagos, '+
             '       Comision, Usuario, TipoOp, State, FecPreLiqDesde,  '+
             '       FecPreLiqHasta, IdEntTarMut, IdNumeroLiq, Detalle) '+
             'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :IdEmpresa, :DiaHora, '+
             '       :IdCompRef, :TipoFactura, :Periodo, :FechaF, :NroFactura, '+
             '       :CompRef, :CaiProv, :Proveedor, :TipoIva, :CantArtic, '+
             '       :PrcBonif, :AlcPercepcion, :Bonificacion, :Neto, :Exento, '+
             '       :NoComputables, :RetIva, :RetGan,:RetIBto, :RetLH, '+
             '       :IvaAlicuota1, :IvaAlicuota2, :IvaOtAlc, :Total, :Contado, '+
             '       :Tickets, :CtaCte, :ChequeProp, :ChequeTer, :OtrosPagos, '+
             '       :Comision, :Usuario, :TipoOp, :State, :FecPreLiqDesde, '+
             '       :FecPreLiqHasta, :IdEntTarMut, :IdNumeroLiq, :Detalle) ';

  SaveItFC = 'Insert InTo '+
             'ItemsFC(IdFactura, IdSucursal, IdPuntoVenta, IdItem, IdArticulo, '+
             '        FechaF, Talle, Cantidad, PrcDcto, Descuento, PrecioNeto, '+
             '        PrecioFinal, PrecioTotal, Exento, ImpInt, MtoIva, IdAlcIva, '+
             '        AlicuotaIva, Sector, State, IdRemito, IdSucRem, IdPtoRem, '+
             '        IdItmRem, DctoStk, EnRemito, Cant_Rem) '+
             'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :IdItem, :IdArticulo, '+
             '       :FechaF, :Talle, :Cantidad, :PrcDcto, :Descuento, :PrecioNeto, '+
             '       :PrecioFinal, :PrecioTotal, :Exento, :ImpInt, :MtoIva, :IdAlcIva, '+
             '       :AlicuotaIva, :Sector, :State, :IdRemito, :IdSucRem, :IdPtoRem, '+
             '       :IdItmRem, :DctoStk, :EnRemito, :Cant_Rem) ';

  SaveArtM = 'Insert InTo '+
             'ArtModPrc(IdRemMod, IdArticulo, TipoComp, NroRemito, FechaR, DiaHora, '+
             '          Usuario, CostoOld, CostoNew, PrecioOld, PrecioNew, Detalle) '+
             'Values(:IdRemMod, :IdArticulo, :TipoComp, :NroRemito, :FechaR, :DiaHora, '+
             '       :Usuario, :CostoOld, :CostoNew, :PrecioOld, :PrecioNew, :Detalle) ';

  Save_Art = 'UpDate Articulos '+
             'Set ImpInt =:ImpInt, '+
             '    CostoAnt = Costo, '+
             '    Costo = :NCosto, '+
             '    PNeto = :PNeto, '+
             '    PBase = :PBase, '+
             '    PrecioAnt = Precio, '+
             '    Precio = :NPrecio, '+
             '    FechaAlta = :FechaA, '+
             '    Usuario = :Usuario, '+
             '    Ganancia = :Ganancia '+
             'Where IdArticulo = :IdArt ';

  Save_Pro = 'Insert InTo '+
             'ProvByArt(IdProveedor, IdArticulo, UltimaCompra, '+
             '          PrecioProv,  Descuento, Cantidad, IdFactura, '+
             '          IdSucursal, IdPuntoVta, NroFactura, IdEmpresa) '+
             'Values(:IdProveedor, :IdArticulo, :UltimaCompra, '+
             '       :PrecioProv, :Descuento, :Cantidad, :IdFactura, '+
             '       :IdSucursal, :IdPuntoVta, :NroFactura, :IdEmpresa) ';

  Save_PCL = 'INSERT INTO PCL_TARMUT '+
             '  (IDLIQUIDACION, IDENTIDAD, IDSUCOPER, IDPROVEEDOR, FECHA, '+
             '   CANTOP, TOTAL, NETO, COMISION, IDFACTURA, IDSUCURSAL, '+
             '   IDPUNTOVENTA, TIPOOP, USUARIO, STATE, NROOPERACION, ESTADO, '+
             '   IDRECIBO, IDEMPRESA, RETENIB, RETENLH, FECHAPAG, NRORECPAGO, '+
             '   NROCERTRET, FECHAIS) '+
             'VALUES '+
             '  (:IDLIQUIDACION, :IDENTIDAD, :IDSUCOPER, :IDPROVEEDOR, :FECHA, '+
             '   :CANTOP, :TOTAL, :NETO, :COMISION, :IDFACTURA, :IDSUCURSAL, '+
             '   :IDPUNTOVENTA, :TIPOOP, :USUARIO, :STATE, :NROOPERACION, :ESTADO, '+
             '   :IDRECIBO, :IDEMPRESA, :RETENIB, :RETENLH, :FECHAPAG, :NRORECPAGO, '+
             '   :NROCERTRET, :FECHAIS) ';

  UpDt_PCL = 'UPDATE PCL_TARMUT '+
             '   SET ESTADO = :ESTADO, '+
             '       IDRECIBO = :IDRECIBO, '+
             '       RETENIB = :RETENIB, '+
             '       RETENLH = :RETENLH, '+
             '       FECHAPAG = :FECHAPAG, '+
             '       NRORECPAGO = :NRORECPAGO, '+
             '       NROCERTRET = :NROCERTRET '+
             'WHERE (IDLIQUIDACION = :IDLIQUIDACION) AND '+
             '      (IDENTIDAD = :IDENTIDAD )';
var
  NumItems, TC, CanPre,
  CtasPagadas, UltRemPrc,
  NroCuota, IdMov, IdSuc,
  NrCta: Integer;
  AuxCantP: Double;
  q, k: TMDOQuery;
  AuxNro: String;
begin
  Result := False;
  TC := 1;
  CanPre := 0;
  AuxNro := Vacio;
  Factura.IdFactura := Get_Ultimos(FacCompra);
  DatosPago.IdComprobante := Factura.IdFactura;
  DatosPago.IdSucursal := Factura.IdSucursal;
  DatosPago.IdPuntoVenta := Factura.IdPuntoVenta;
  Case Factura.TipoOper of
    fcCompra :DatosPago.TipoOperacion := Compra;
    fcRemito :DatosPago.TipoOperacion := Remito;
    fcGastos :DatosPago.TipoOperacion := Gastos;
    fcLiqPre :DatosPago.TipoOperacion := Cobros;
  end;
  if (Factura.TipoFactura in [CreA, CreB, CreC, CreditoAjuste]) then
    TC := -1;

  if (Factura.TipoOper = fcLiqPre) And
     ((Factura.TipoFactura = PresentacionTM) or
     ((Factura.TipoFactura in [LiquidacionA, LiquidacionC]) And
      (Factura.TipoComRef = Falso))) And
     (Factura.NroLiquidacion = 0) then
  begin
    if CanPre = 0 then  //  Grabar registro de Presentacion
    begin
      try
        Factura.NroLiquidacion := Get_Ultimos(PCL_TM);
        AuxNro := Format('%.4d-%.8d',[Factura.IdSucursal, Factura.NroLiquidacion]);
        Factura.NroFactura := AuxNro;
        qSaveComp.Close;
        qSaveComp.Sql.Clear;
        qSaveComp.SQL.Text := Save_PCL;
        qSaveComp.ParamByName('IDLIQUIDACION').AsInteger := Factura.NroLiquidacion;
        qSaveComp.ParamByName('IDENTIDAD').AsInteger := Factura.IdTarjeta;
        qSaveComp.ParamByName('IDSUCOPER').AsInteger := Factura.IdCompRef;
        qSaveComp.ParamByName('IDPROVEEDOR').AsInteger := Factura.Entidad;
        qSaveComp.ParamByName('FECHA').AsDateTime := Factura.FechaF;
        qSaveComp.ParamByName('CANTOP').AsInteger := Factura.CantArtic;
        qSaveComp.ParamByName('TOTAL').AsCurrency := Factura.Total;
        qSaveComp.ParamByName('NETO').AsCurrency := Factura.Neto;
        qSaveComp.ParamByName('COMISION').AsCurrency := Factura.Comision;
        qSaveComp.ParamByName('IDFACTURA').AsInteger := Factura.IdFactura;
        qSaveComp.ParamByName('IDSUCURSAL').AsInteger := Factura.IdSucursal;
        qSaveComp.ParamByName('IDPUNTOVENTA').AsInteger := Factura.IdPuntoVenta;
        qSaveComp.ParamByName('TIPOOP').AsInteger := Factura.TipoFactura;
        qSaveComp.ParamByName('USUARIO').AsInteger := Factura.Empleado;
        qSaveComp.ParamByName('STATE').AsInteger := 0;
        qSaveComp.ParamByName('NROOPERACION').AsString := Factura.NroFactura;
        qSaveComp.ParamByName('ESTADO').AsInteger := 0;
        qSaveComp.ParamByName('IDRECIBO').AsInteger := 0;
        qSaveComp.ParamByName('IDEMPRESA').AsInteger := Factura.IdEmpresa;
        qSaveComp.ParamByName('RETENIB').AsCurrency := Factura.RetIBt;
        qSaveComp.ParamByName('RETENLH').AsCurrency := Factura.RetLH;
        qSaveComp.ParamByName('FECHAPAG').Clear;
        qSaveComp.ParamByName('NRORECPAGO').AsString := '0000-00000000';
        qSaveComp.ParamByName('NROCERTRET').AsString := '0000-00000000';
        qSaveComp.ParamByName('FECHAIS').Clear;
        qSaveComp.ExecSQL;
      except
        on E:Exception do
          raise EUsuario.Create(E.Message);
      end;
    end;
  end;

  try
    if not trSaveComp.InTransaction then
      trSaveComp.StartTransaction;
    qSaveComp.Close;
    qSaveComp.Sql.Clear;
    qSaveComp.SQL.Text := SaveFacC;
    qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
    qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
    qSaveComp.ParamByName('IdPuntoVenta').AsInteger := Factura.IdPuntoVenta;
    qSaveComp.ParamByName('IdEmpresa').AsInteger := Factura.IdEmpresa;
    qSaveComp.ParamByName('DiaHora').AsDateTime := Now;
    qSaveComp.ParamByName('TipoFactura').AsInteger := Factura.TipoFactura;
    qSaveComp.ParamByName('Periodo').AsDate := Factura.Periodo;
    qSaveComp.ParamByName('FechaF').AsDate := Factura.FechaF;
    qSaveComp.ParamByName('NroFactura').AsString := Factura.NroFactura;
    qSaveComp.ParamByName('CompRef').AsString := Factura.CompRef;
    qSaveComp.ParamByName('IdCompRef').AsInteger := Factura.IdCompRef;
    qSaveComp.ParamByName('CaiProv').AsString := Factura.CaiProv;
    qSaveComp.ParamByName('Proveedor').AsInteger := Factura.Entidad;
    qSaveComp.ParamByName('TipoIva').AsInteger := Factura.TipoIva;
    qSaveComp.ParamByName('CantArtic').AsInteger := Factura.CantArtic;
    qSaveComp.ParamByName('PrcBonif').AsFloat := TC*Factura.PrcDscto;
    qSaveComp.ParamByName('Bonificacion').AsCurrency := TC*Factura.Descuento;
    qSaveComp.ParamByName('Neto').AsCurrency := TC*Factura.Neto;
    qSaveComp.ParamByName('Exento').AsCurrency := TC*Factura.Exento;
    qSaveComp.ParamByName('NoComputables').AsCurrency := TC*Factura.NoComputables;
    qSaveComp.ParamByName('AlcPercepcion').AsFloat := TC*Factura.AlcPercep;
    qSaveComp.ParamByName('RetIva').AsCurrency := TC*Factura.PPCuenta;
    qSaveComp.ParamByName('RetGan').AsCurrency := TC*Factura.RetGan;
    qSaveComp.ParamByName('RetIBto').AsCurrency := TC*Factura.RetIBt;
    qSaveComp.ParamByName('RetLH').AsCurrency := TC*Factura.RetLH;
    qSaveComp.ParamByName('IvaAlicuota1').AsCurrency := TC*Factura.IvaAlicuota1;
    qSaveComp.ParamByName('IvaAlicuota2').AsCurrency := TC*Factura.IvaAlicuota2;
    qSaveComp.ParamByName('IvaOtAlc').AsCurrency := TC*Factura.IvaOtAlc;
    qSaveComp.ParamByName('Total').AsCurrency := TC*Factura.Total;
    qSaveComp.ParamByName('Contado').AsCurrency := DatosPago.PagosContado;
    qSaveComp.ParamByName('Tickets').AsCurrency := DatosPago.PagosBonosTk;
    qSaveComp.ParamByName('CtaCte').AsCurrency := DatosPago.PagosCtaCte.TotalCtaCte;
    qSaveComp.ParamByName('ChequeProp').AsCurrency := DatosPago.PagosCheques.TotalValores;
    qSaveComp.ParamByName('ChequeTer').AsCurrency := DatosPago.PagosValores.TotalValores;
    qSaveComp.ParamByName('OtrosPagos').AsCurrency := DatosPago.PagosDcto;
    qSaveComp.ParamByName('Comision').AsCurrency := Factura.Comision;
    qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
    qSaveComp.ParamByName('TipoOP').AsInteger := Factura.TipoOper;
    qSaveComp.ParamByName('FecPreLiqDesde').AsDate := Factura.FechaLD;
    qSaveComp.ParamByName('FecPreLiqHasta').AsDate := Factura.FechaLH;
    qSaveComp.ParamByName('IdEntTarMut').AsInteger := Factura.IdTarjeta;
    qSaveComp.ParamByName('IdNumeroLiq').AsInteger := Factura.NroLiquidacion;
    qSaveComp.ParamByName('Detalle').AsString := Factura.Detalle;
    qSaveComp.ParamByName('State').AsInteger := 0;
    qSaveComp.ExecSQL;

    DatosPago.ImpNeto := Factura.Neto;
    DatosPago.ImpNComp:= Factura.NoComputables;

    if Factura.TipoOper in [fcCompra, fcGastos] then
    begin
      if CompOP.Active then
        CompOP.EmptyDataSet
      else
        CompOP.CreateDataSet;
      CompOP.Append;
      CompOPIdFactura.AsInteger := Factura.IdFactura;
      CompOPIdSucursal.AsInteger := Factura.IdSucursal;
      CompOPIdPuntoVenta.AsInteger  := Factura.IdPuntoVenta;
      CompOPIdEmpresa.AsInteger := Factura.IdEmpresa;
      CompOPNroMovCC.AsInteger := 0;
      CompOPTipoMov.AsInteger := Factura.TipoFactura;
      CompOPEntidad.AsInteger := Factura.Entidad;
      CompOPNroComp.AsString := Factura.NroFactura;
      CompOPMontoOrg.AsCurrency := Factura.Total;
      CompOPImporte.AsCurrency := Factura.Total;
      CompOPSaldoMov.AsCurrency := 0;
      CompOPFechaOr.AsDateTime := DatosPago.FechaOr;
      CompOPFechaPg.AsDateTime := DatosPago.FechaOp;
      CompOP.Post;

      if (Contado in DatosPago.PagosRealizados) or
         (Bonos in DatosPago.PagosRealizados) then
        DoPagoEfectivoProv(DatosPago);

      if CtaCte in DatosPago.PagosRealizados then
        DoPagoCuentaProv(DatosPago);
    end;

    if Factura.TipoOper = fcLiqPre then
    begin
      Case Factura.TipoFactura of
        PresentacionTM: begin
          try
            q := TMDOQuery.Create(nil);
            q.Database := dmGestion.dbGestion;
            q.Transaction := trSaveComp;
            q.SQL.Add('UpDate DatosSis ');
            q.SQL.Add('   Set NROLIQPRES = :NP ');
            q.SQL.Add('Where IDEMPRESA = :EM ');
            q.ParamByName('NP').AsString := Inc_NComp(Factura.NroFactura);
            q.ParamByName('EM').AsInteger:= Factura.IdEmpresa;
            q.ExecSQL;
            q.Close;
          finally
            q.Free;
          end;
        end;
        LiquidacionA,
        LiquidacionC: begin
          try
            //Cheques Propios
            if Cheque in DatosPago.PagosRealizados then
              DoPagoComprasCheques(DatosPago);
            //Cheques de Terceros
            if Valores in DatosPago.PagosRealizados then
              DoPagoVentaValores(DatosPago);
          except
            on E:Exception do
              raise EUsuario.Create(E.Message);
          end;
        end;
      end;
    end;

    // ************************************************************************
    // Grabar items comprobantes
    NumItems := 1;
    while ItemsFactura[NumItems].IdProducto > 0 do
    begin
      qSaveComp.Close;
      qSaveComp.Sql.Clear;
      qSaveComp.SQL.Text := SaveItFC;
      with ItemsFactura[NumItems] do
      begin
        qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
        qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
        qSaveComp.ParamByName('IdPuntoVenta').AsInteger := Factura.IdPuntoVenta;
        qSaveComp.ParamByName('IdItem').AsInteger := NumItems;
        qSaveComp.ParamByName('IdArticulo').AsInteger := IdProducto;
        qSaveComp.ParamByName('FechaF').AsDateTime := Factura.FechaF;
        qSaveComp.ParamByName('Talle').AsInteger := Talle;
        qSaveComp.ParamByName('PrcDcto').AsFloat := TC*Bonificacion;
        qSaveComp.ParamByName('Descuento').AsCurrency := TC*Descuento;
        qSaveComp.ParamByName('Cantidad').AsFloat := TC*Cantidad;
        qSaveComp.ParamByName('PrecioNeto').AsCurrency  := TC*PrecioNetoT;
        qSaveComp.ParamByName('PrecioFinal').AsCurrency := TC*PrecioFinal;
        qSaveComp.ParamByName('PrecioTotal').AsCurrency := TC*PrecioTotal;
        qSaveComp.ParamByName('Exento').AsCurrency := TC*Exento;
        qSaveComp.ParamByName('ImpInt').AsCurrency := TC*NoComputable;
        qSaveComp.ParamByName('MtoIva').AsCurrency := TC*MtoIva;
        qSaveComp.ParamByName('IdAlcIva').AsInteger := IdAlcIva;
        qSaveComp.ParamByName('AlicuotaIva').AsFloat:= GetAlcIva(IdAlcIva);
        qSaveComp.ParamByName('Sector').AsInteger := IdSector;
        qSaveComp.ParamByName('State').AsInteger := 0;
        qSaveComp.ParamByName('IdRemito').AsInteger := IdFacDomRem;
        qSaveComp.ParamByName('IdSucRem').AsInteger := IdSucDomRem;
        qSaveComp.ParamByName('IdPtoRem').AsInteger := IdPtoDomRem;
        qSaveComp.ParamByName('IdItmRem').AsInteger := IdItmDomRem;
        qSaveComp.ParamByName('DctoStk').AsInteger := 0;  // Ya se vera
        qSaveComp.ParamByName('EnRemito').AsInteger := EnRemito;
        if Factura.TipoFactura = RemitoR then
          qSaveComp.ParamByName('Cant_Rem').AsFloat := Cantidad
        else
          qSaveComp.ParamByName('Cant_Rem').AsFloat := 0;
        qSaveComp.ExecSQL;
        if Factura.TipoOper = fcLiqPre then
        begin
          Case Factura.TipoFactura of
            PresentacionTM: begin
              try
                q := TMDOQuery.Create(nil);
                q.Database := dmGestion.dbGestion;
                q.Transaction := trSaveComp;
                q.SQL.Add('UpDate MovTar Set Estado = 2 '); // En Cobro
                q.SQL.Add('Where (IdMov = :IdM) And (IdSucursal = :IdS) ');
                q.ParamByName('IdM').AsInteger := Talle;
                q.ParamByName('IdS').AsInteger := IdSector;
                try
                  q.ExecSQL;
                except
                  on E:Exception do
                    raise EUsuario.Create(E.Message);
                end;
                q.Close;
              finally
                q.Free;
              end;

              try
                q := TMDOQuery.Create(nil);
                q.Database := dmGestion.dbGestion;
                q.Transaction := trSaveComp;
                q.SQL.Add('UpDate MovCuotas Set Estado = 3 '); // Presentada
                q.SQL.Add('Where (IdMovCred = :IdM) And ');
                q.SQL.Add('      (IdSucursal = :IdS) And (NroCuota = :NCt) ');
                q.ParamByName('IdM').AsInteger := Talle;
                q.ParamByName('IdS').AsInteger := IdSector;
                q.ParamByName('NCt').AsInteger := Trunc(Cantidad);
                try
                  q.ExecSQL;
                except
                  on E:Exception do
                    raise EUsuario.Create(E.Message);
                end;
                q.Close;
              finally
                q.Free;
              end;
            end;

            LiquidacionA,
            LiquidacionC: begin
              if (Factura.TipoComRef = Verdadero) then   // Con Presentacion
              begin
                try
                  q := TMDOQuery.Create(nil);
                  q.Database := dmGestion.dbGestion;
                  q.Transaction := trSaveComp;
                  q.SQL.Text := UpDt_PCL;
                  q.ParamByName('ESTADO').AsInteger := 1;
                  q.ParamByName('IDRECIBO').AsInteger := Factura.IdFactura;
                  q.ParamByName('RETENIB').AsCurrency := Factura.RetIBt;
                  q.ParamByName('RETENLH').AsCurrency := Factura.RetLH;
                  q.ParamByName('FECHAPAG').AsDate := Factura.FechaF;
                  q.ParamByName('NRORECPAGO').AsString := Factura.NroFactura;
                  q.ParamByName('NROCERTRET').AsString := Factura.CompRef;
                  q.ParamByName('IDLIQUIDACION').AsInteger := IdAlcIva;
                  q.ParamByName('IDENTIDAD').AsInteger := IdProducto;
                  q.ExecSQL;
                except
                  on E:Exception do
                    raise EUsuario.Create(E.Message);
                end;

                try
                  k := TMDOQuery.Create(nil);
                  k.Database := dmGestion.dbGestion;
                  k.Transaction := trSaveComp;
                  k.SQL.Add('Select Talle, Sector, Cantidad  ');
                  k.SQL.Add('From ItemsFC ');
                  k.SQL.Add('Where (IdFactura = :IdF) And ');
                  k.SQL.Add('      (IdSucursal = :IdS) And ');
                  k.SQL.Add('      (IdPuntoVenta = :IdP) ');
                  k.ParamByName('IdF').AsInteger := Trunc(Exento);
                  k.ParamByName('IdS').AsInteger := Trunc(MtoIva);
                  k.ParamByName('IdP').AsInteger := Trunc(NoComputable);
                  try
                    k.Open;
                    if not k.IsEmpty then
                    begin
                      k.First;
                      while not k.Eof do
                      begin
                        IdMov := k.FieldByName('Talle').AsInteger;
                        IdSuc := k.FieldByName('Sector').AsInteger;
                        NrCta := k.FieldByName('Cantidad').AsInteger;
                        CtasPagadas := 0;
                        NroCuota := 0;
                        try  // Calculando Cuotas Pagadas por credito mutual o tarjeta
                          q := TMDOQuery.Create(nil);
                          q.Database := dmGestion.dbGestion;
                          q.Transaction := trSaveComp;
                          q.SQL.Add('Select Count(*) as CPag From MovCuotas ');
                          q.SQL.Add('Where (Estado = 1) And (FechaP is not null) And  ');
                          q.SQL.Add('      (IdMovCred = :IdM) And (IdSucursal = :IdS) ');
                          q.ParamByName('IdM').AsInteger := IdMov;
                          q.ParamByName('IdS').AsInteger := IdSuc;
                          q.Open;
                          CtasPagadas := q.FieldByName('CPag').AsInteger;
                          q.Close;
                        finally
                          q.Free;
                        end;

                        try
                          q := TMDOQuery.Create(nil);
                          q.Database := dmGestion.dbGestion;
                          q.Transaction := trSaveComp;
                          q.SQL.Add('Select NroCuota From MovTar ');
                          q.SQL.Add('Where (IdMov = :IdM) And ');
                          q.SQL.Add('      (IdSucursal = :IdS) ');
                          q.ParamByName('IdM').AsInteger := IdMov;
                          q.ParamByName('IdS').AsInteger := IdSuc;
                          q.Open;
                          NroCuota := q.FieldByName('NroCuota').AsInteger;
                          q.Close;
                        finally
                          q.Free;
                        end;

                        try
                          q := TMDOQuery.Create(nil);
                          q.Database := dmGestion.dbGestion;
                          q.Transaction := trSaveComp;
                          q.SQL.Add('UpDate MovTar ');
                          q.SQL.Add('   Set CuotaPag = :CPg, Estado = :Est, ');
                          q.SQL.Add('       NroRecPago = :NRP, UltimoPago = :FUP ');
                          q.SQL.Add('Where (IdMov = :IdM) and (IdSucursal = :IdS) ');
                          q.ParamByName('CPg').AsInteger := CtasPagadas + 1;
                          if Factura.TipoAj = 1 then // Tarjeta de Credito
                            q.ParamByName('Est').AsInteger := 1    // Pagado
                          else begin
                            if (CtasPagadas + 1) >= NroCuota then
                              q.ParamByName('Est').AsInteger := 1  // Pagado
                            else
                              q.ParamByName('Est').AsInteger := 2; // En Cobro
                          end;
                          q.ParamByName('NRP').AsString  := Factura.NroFactura;
                          q.ParamByName('FUP').AsDate := Factura.FechaF;
                          q.ParamByName('IdM').AsInteger := IdMov;
                          q.ParamByName('IdS').AsInteger := IdSuc;
                          try
                            q.ExecSQL;
                          except
                            on E:Exception do
                              raise EUsuario.Create(E.Message);
                          end;
                          q.Close;
                        finally
                          q.Free;
                        end;

                        try
                          q := TMDOQuery.Create(nil);
                          q.Database := dmGestion.dbGestion;
                          q.Transaction := trSaveComp;
                          q.SQL.Add('UpDate MovCuotas ');
                          q.SQL.Add('   Set Estado = 1, ');
                          q.SQL.Add('       IdRecibo = :IdR, ');
                          q.SQL.Add('       IdSucRec = :IdU, ');
                          q.SQL.Add('       IdPuntoRec = :IdP, ');
                          q.SQL.Add('       NroRecPago = :NRP, ');
                          q.SQL.Add('       Cobrado = MontoCuota, ');
                          q.SQL.Add('       SaldoCuota = 0, ');
                          q.SQL.Add('       FechaP = :FhP ');
                          q.SQL.Add('Where (IdMovCred = :IdM) And ');
                          q.SQL.Add('      (IdSucursal = :IdS) And ');
                          q.SQL.Add('      (NroCuota = :NCt) ');
                          q.ParamByName('IdR').AsInteger := Factura.IdFactura;
                          q.ParamByName('IdU').AsInteger := Factura.IdSucursal;
                          q.ParamByName('IdP').AsInteger := Factura.IdPuntoVenta;
                          q.ParamByName('NRP').AsString  := Factura.NroFactura;
                          q.ParamByName('FhP').AsDate := Factura.FechaF;
                          q.ParamByName('IdM').AsInteger := IdMov;
                          q.ParamByName('IdS').AsInteger := IdSuc;
                          q.ParamByName('NCt').AsInteger := NrCta;
                          try
                            q.ExecSQL;
                          except
                            on E:Exception do
                              raise EUsuario.Create(E.Message);
                          end;
                          q.Close;
                        finally
                          q.Free;
                        end;
                        k.Next;
                      end;
                    end;
                  except
                    on E:Exception do
                      raise EUsuario.Create(E.Message);
                  end;
                  k.Close;
                finally
                  k.Free;
                end;
              end
              else begin // Conciliacion
                try
                  q := TMDOQuery.Create(nil);
                  q.Database := dmGestion.dbGestion;
                  q.Transaction := trSaveComp;
                  q.SQL.Add('UpDate MovTar ');
                  q.SQL.Add('   Set CuotaPag = NroCuota, ');
                  q.SQL.Add('       Estado = 1, ');
                  q.SQL.Add('       NroRecPago = :NRP, ');
                  q.SQL.Add('       UltimoPago = :FUP ');
                  q.SQL.Add('Where (IdMov = :IdM) And (IdSucursal = :IdS) ');
                  q.ParamByName('NRP').AsString  := Factura.NroFactura;
                  q.ParamByName('FUP').AsDate := Factura.FechaF;
                  q.ParamByName('IdM').AsInteger := Talle;
                  q.ParamByName('IdS').AsInteger := IdSector;
                  try
                    q.ExecSQL;
                  except
                    on E:Exception do
                      raise EUsuario.Create(E.Message);
                  end;
                  q.Close;
                finally
                  q.Free;
                end;

                try
                  q := TMDOQuery.Create(nil);
                  q.Database := dmGestion.dbGestion;
                  q.Transaction := trSaveComp;
                  q.SQL.Add('UpDate MovCuotas ');
                  q.SQL.Add('   Set Estado = 1, ');
                  q.SQL.Add('       IdRecibo = :IdR, ');
                  q.SQL.Add('       IdSucRec = :IdU, ');
                  q.SQL.Add('       IdPuntoRec = :IdP, ');
                  q.SQL.Add('       NroRecPago = :NRP, ');
                  q.SQL.Add('       Cobrado = MontoCuota, ');
                  q.SQL.Add('       SaldoCuota = 0, ');
                  q.SQL.Add('       FechaP = :FhP ');
                  q.SQL.Add('Where (IdMovCred = :IdM) And ');
                  q.SQL.Add('      (IdSucursal = :IdS) And ');
                  q.SQL.Add('      (NroCuota = :IdC) ');
                  q.ParamByName('IdR').AsInteger := Factura.IdFactura;
                  q.ParamByName('IdU').AsInteger := Factura.IdSucursal;
                  q.ParamByName('IdP').AsInteger := Factura.IdPuntoVenta;
                  q.ParamByName('NRP').AsString  := Factura.NroFactura;
                  q.ParamByName('FhP').AsDate := Factura.FechaF;
                  q.ParamByName('IdM').AsInteger := Talle;
                  q.ParamByName('IdS').AsInteger := IdSector;
                  q.ParamByName('IdC').AsInteger := Trunc(Cantidad);
                  try
                    q.ExecSQL;
                  except
                    on E:Exception do
                      raise EUsuario.Create(E.Message);
                  end;
                  q.Close;
                finally
                  q.Free;
                end;
              end;
            end;
          End;
        end;

        //----------- Actualiza Stock y Precios --------------
        if Factura.TipoOper = fcCompra then
        begin
          if Factura.TipoFactura in [CreA, CreC] then
          begin
            Update_Parts(IdProducto, IdBranch, Cantidad, Talle,
                         Factura.TipoFactura, -1, False, False,
                         qSaveComp.Database, qSaveComp.Transaction)
          end
          else begin
            if EnRemito = Falso then
            begin
              Update_Parts(IdProducto, IdBranch, Cantidad, Talle,
                           Factura.TipoFactura,-1, False, False,
                           qSaveComp.Database, qSaveComp.Transaction);
            end
            else begin  // Marcar productos recibidos por Remito R
              qSaveComp.Close;
              qSaveComp.Sql.Clear;
              qSaveComp.SQL.Add('Select Cant_Rem ');
              qSaveComp.SQL.Add('        ');
              qSaveComp.SQL.Add('From ItemsFC ');
              qSaveComp.SQL.Add('Where (IdFactura = :IdF) And ');
              qSaveComp.SQL.Add('      (IdSucursal = :IdS) And ');
              qSaveComp.SQL.Add('      (IdPuntoVenta = :IdP) And ');
              qSaveComp.SQL.Add('      (IdItem = :IdI) And ');
              qSaveComp.SQL.Add('      (IdArticulo = :IdA) And ');
              qSaveComp.SQL.Add('      (EnRemito = 0)  ');
              qSaveComp.ParamByName('IdF').AsInteger := IdFacDomRem;
              qSaveComp.ParamByName('IdS').AsInteger := IdSucDomRem;
              qSaveComp.ParamByName('IdP').AsInteger := IdPtoDomRem;
              qSaveComp.ParamByName('IdI').AsInteger := IdItmDomRem;
              qSaveComp.ParamByName('IdA').AsInteger := IdProducto;
              qSaveComp.Open;
              if not qSaveComp.IsEmpty then
              begin
                try
                  q := TMDOQuery.Create(nil);
                  q.Database := qSaveComp.Database;
                  q.Transaction := qSaveComp.Transaction;
                  q.SQL.Add('UpDate ItemsFC ');
                  q.SQL.Add('   Set IdRemito = :IdR, ');
                  q.SQL.Add('       IdSucRem = :IdS, ');
                  q.SQL.Add('       IdPtoRem = :IdP, ');
                  q.SQL.Add('       IdItmRem = :IdI, ');
                  q.SQL.Add('       EnRemito = :LLe, ');
                  q.SQL.Add('       Cant_Rem = :Cnt ');
                  q.SQL.Add('Where (IdFactura = :IdF) And ');
                  q.SQL.Add('      (IdSucursal = :IdB) And ');
                  q.SQL.Add('      (IdPuntoVenta = :IdV) And ');
                  q.SQL.Add('      (IdArticulo = :IdA) ');
                  q.ParamByName('IdR').AsInteger := Factura.IdFactura;
                  q.ParamByName('IdS').AsInteger := Factura.IdSucursal;
                  q.ParamByName('IdP').AsInteger := Factura.IdPuntoVenta;
                  q.ParamByName('IdI').AsInteger := IdItem;
                  if (ABS(qSaveComp.FieldByName('Cant_Rem').Value) - ABS(Cantidad)) = 0 then
                  begin
                    q.ParamByName('LLe').AsInteger := 1;
                    q.ParamByName('Cnt').AsFloat := 0;
                  end
                  else begin
                    q.ParamByName('LLe').AsInteger := 0;
                    q.ParamByName('Cnt').AsFloat := (ABS(qSaveComp.FieldByName('Cant_Rem').Value) - ABS(Cantidad));
                  end;
                  q.ParamByName('IdF').AsInteger := IdFacDomRem;
                  q.ParamByName('IdB').AsInteger := IdSucDomRem;
                  q.ParamByName('IdV').AsInteger := IdPtoDomRem;
                  q.ParamByName('IdA').AsInteger := IdProducto;
                  try
                    q.ExecSQL;
                  except
                    on E:Exception do
                      raise EUsuario.Create('Error. Marcando remito: '+E.Message);
                  end;
                  q.Close;
                finally
                  q.Free;
                end;
              end;
            end;

            //----------- Actualiza Cambios de Precios --------------
            (*
            try
              UltRemPrc := 0;
              q := TMDOQuery.Create(nil);
              q.Database := qSaveComp.Database;
              q.Transaction := qSaveComp.Transaction;
              q.SQL.Add('Select Max(IdRemMod) as Ultimo ');
              q.SQL.Add('From ArtModPrc ');
              q.Open;
              UltRemPrc := q.FieldByName('Ultimo').AsInteger + 1;
              q.Close;
            finally
              q.Free;
            end;
            *)

            UltRemPrc := Get_Ultimos(RegPrc);
            qSaveComp.Close;
            qSaveComp.Sql.Clear;
            qSaveComp.SQL.Text := SaveArtM;
            qSaveComp.ParamByName('IdRemMod').AsInteger := UltRemPrc;
            qSaveComp.ParamByName('IdArticulo').AsInteger := IdProducto;
            qSaveComp.ParamByName('TipoComp').AsInteger := Factura.TipoFactura;
            qSaveComp.ParamByName('NroRemito').AsString := Factura.NroFactura;
            qSaveComp.ParamByName('FechaR').AsDateTime := Factura.FechaF;
            qSaveComp.ParamByName('DiaHora').AsDateTime := Now;
            qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
            qSaveComp.ParamByName('CostoOld').AsCurrency := PrecioCosto;
            qSaveComp.ParamByName('CostoNew').AsCurrency := PrecioFinal;
            qSaveComp.ParamByName('PrecioOld').AsCurrency := PrecioActual;
            qSaveComp.ParamByName('PrecioNew').AsCurrency := PrecioPublico;
            qSaveComp.ParamByName('Detalle').AsString := Factura.NombreEnt;
            qSaveComp.ExecSQL;

            //----------- Actualiza Productos --------------
            qSaveComp.Close;
            qSaveComp.Sql.Clear;
            qSaveComp.SQL.Text := Save_Art;
            qSaveComp.ParamByName('ImpInt').AsCurrency := NoComputable / Cantidad;
            qSaveComp.ParamByName('NCosto').AsCurrency := PrecioFinal;
            qSaveComp.ParamByName('PNeto').AsCurrency := (PrecioPublico-NoComputable)/(1+AlicuotaIva/100);
            qSaveComp.ParamByName('PBase').AsCurrency := (PrecioPublico-NoComputable)/(1+AlicuotaIva/100);
            qSaveComp.ParamByName('NPrecio').AsCurrency := PrecioPublico;
            qSaveComp.ParamByName('FechaA').AsDateTime := Date;
            qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
            try
              qSaveComp.ParamByName('Ganancia').AsFloat := (((PrecioPublico-NoComputable)/(1+AlicuotaIva/100) / PrecioNetoU) - 1) * 100;
            except
              qSaveComp.ParamByName('Ganancia').AsFloat := CoefMarkUp;
            end;
            qSaveComp.ParamByName('IdArt').AsInteger := IdProducto;
            qSaveComp.ExecSQL;
          end;

          //----------- Actualiza Historial del Proveedor --------------
          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.SQL.Text := Save_Pro;
          qSaveComp.ParamByName('IdProveedor').AsInteger := Factura.Entidad;
          qSaveComp.ParamByName('IdArticulo').AsInteger := IdProducto;
          qSaveComp.ParamByName('UltimaCompra').AsDate := Factura.FechaF;
          qSaveComp.ParamByName('PrecioProv').AsCurrency := PrecioNetoU;
          qSaveComp.ParamByName('Descuento').AsFloat := Bonificacion;
          qSaveComp.ParamByName('Cantidad').AsFloat := TC*Cantidad;
          qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
          qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
          qSaveComp.ParamByName('IdPuntoVta').AsInteger := Factura.IdPuntoVenta;
          qSaveComp.ParamByName('IdEmpresa').AsInteger := Factura.IdEmpresa;
          qSaveComp.ParamByName('NroFactura').AsString := Factura.NroFactura;
          qSaveComp.ExecSQL;
          //----------- Actualiza si hay pedidos del producto comprado --------------
          if EnPedido = Verdadero then
          begin
            qSaveComp.Close;
            qSaveComp.Sql.Clear;
            qSaveComp.SQL.Add('Select Estado, CantidadP, CantidadR, ');
            qSaveComp.SQL.Add('       FechaRec, PrecioR ');
            qSaveComp.SQL.Add('From ItemsOC ');
            qSaveComp.SQL.Add('Where IdOrdCmp = :IdOrd And ');
            qSaveComp.SQL.Add('      IdSucursal = :IdSuc And ');
            qSaveComp.SQL.Add('      IdItemOC = :IdItm And ');
            qSaveComp.SQL.Add('      IdArticulo = :IdArt ');
            qSaveComp.ParamByName('IdOrd').AsInteger := IdOrdPedido;
            qSaveComp.ParamByName('IdSuc').AsInteger := IdBranch;
            qSaveComp.ParamByName('IdItm').AsInteger := IdItmPedido;
            qSaveComp.ParamByName('IdArt').AsInteger := IdProducto;
            qSaveComp.Open;
            if not qSaveComp.IsEmpty then
            begin
              if qSaveComp.FieldByName('Estado').AsInteger = 0 then
              begin
                AuxCantP := qSaveComp.FieldByName('CantidadP').AsFloat;
                qSaveComp.Close;
                qSaveComp.Sql.Clear;
                qSaveComp.SQL.Add('Update ItemsOC ');
                if Round(Cantidad) = Round(AuxCantP) then
                begin
                  qSaveComp.SQL.Add('  Set Estado = 1 ')
                end
                else begin
                  qSaveComp.SQL.Add('  Set CantidadP =:CantP, ');
                  qSaveComp.SQL.Add('      CantidadR =:CantR, ');
                  qSaveComp.SQL.Add('      FechaRec =:Fecha, ');
                  qSaveComp.SQL.Add('      PrecioR  =:PrecR ');
                  qSaveComp.SQL.Add('Where IdOrdCmp =:IdOrd And ');
                  qSaveComp.SQL.Add('      IdSucursal =:IdSuc And ');
                  qSaveComp.SQL.Add('      IdItemOC =:IdItm And ');
                  qSaveComp.SQL.Add('      IdArticulo =:IdArt ');
                  qSaveComp.ParamByName('CantP').AsFloat := AuxCantP - Cantidad;
                  qSaveComp.ParamByName('CantR').AsFloat := Cantidad;
                  qSaveComp.ParamByName('Fecha').AsDate  := Factura.FechaF;
                  qSaveComp.ParamByName('PrecR').AsCurrency := PrecioNetoU + NoComputable;
                end;
                qSaveComp.ParamByName('IdOrd').AsInteger := IdOrdPedido;
                qSaveComp.ParamByName('IdSuc').AsInteger := IdBranch;
                qSaveComp.ParamByName('IdItm').AsInteger := IdItmPedido;
                qSaveComp.ParamByName('IdArt').AsInteger := IdProducto;
                qSaveComp.ExecSQL;
              end;
            end;
          end;
        end;

        if Factura.TipoOper = fcRemito then
        begin
          Update_Parts(IdProducto, IdBranch, Cantidad, Talle, Factura.TipoFactura,
                       -1, False, False, qSaveComp.Database, qSaveComp.Transaction);
        end;

        if Factura.TipoOper = fcGastos then
        begin

        end;
      end;
      Inc(NumItems);
    end;
    trSaveComp.Commit;
    Result := True;
  except
    on E:Exception do
    begin
      Result := False;
      trSaveComp.Rollback;
      raise EUsuario.Create(E.Message);
    end;
  end;
end;

//******************************************************************************
//                        FIN COMPRAS
//******************************************************************************

//******************************************************************************
//           BANCOS CUENTAS PROPIAS Y VALORES DE TERCEROS
//******************************************************************************

procedure TdmSaveFile.AuxBcoTerIdTitularChange(Sender: TField);
begin
  if GetDatosEnt(Sender.AsInteger, IdBranch, 1, Datos_Ent) then
    AuxBcoTerTitular.AsString := Datos_Ent.Nombre;
end;

procedure TdmSaveFile.AuxBcoTerIdEndosoChange(Sender: TField);
begin
  if GetDatosEnt(Sender.AsInteger, IdBranch, 1, Datos_Ent) then
    AuxBcoTerEndoso.AsString := Datos_Ent.Nombre;
end;

(*
INSERT INTO BANCOPROP
  (IDMOV, IDBANCO, IDORDPAGO, TIPOMOV, FECHAEMISION, FECHAVENCIMIENTO,
   FECHARESUMEN, IDENTIDAD, DETALLEMOV, MONTO, DEBE, HABER, USUARIO, IDFACTURA,
   IDSUCURSAL, ESTADO, NROCHEQUE, IDNROCONCILIACION, IDEMPRESA)
VALUES
  (:IDMOV, :IDBANCO, :IDORDPAGO, :TIPOMOV, :FECHAEMISION, :FECHAVENCIMIENTO,
   :FECHARESUMEN, :IDENTIDAD, :DETALLEMOV, :MONTO, :DEBE, :HABER, :USUARIO,
   :IDFACTURA, :IDSUCURSAL, :ESTADO, :NROCHEQUE, :IDNROCONCILIACION, :IDEMPRESA)
*)

procedure TdmSaveFile.DoPagoComprasCheques(DatosPago: TDatosPagos);
Const
  InChq = 'Insert InTo '+
          'BancoProp(IdMov, IdBanco, TipoMov, NroCheque, FechaEmision, '+
          '        FechaVencimiento, IdOrdPago, IdEntidad, DetalleMov, '+
          '        Monto, Usuario, IdFactura, IdSucursal, Estado, '+
          '        IdNroConciliacion, IdEmpresa) '+
          'Values(:IdMov, :IdBanco, :TipoMov, :NroCheque, :FechaEmision, '+
          '       :FechaVencimiento, :IdOrdPago, :IdEntidad, :DetalleMov, '+
          '       :Monto, :Usuario, :IdFactura, :IdSucursal, :Estado, '+
          '       :IdNroConciliacion, :IdEmpresa) ';

var
  q,
  s: TMDOQuery;
  ultimo: Integer;
begin
  try
    with DatosPago.PagosCheques do
    begin
      Datos.First;
      while not Datos.Eof do
      begin
        try
          q := TMDOQuery.Create(nil);
          q.Database := dmGestion.dbGestion;
          q.Transaction := trSaveComp;
          q.SQL.Text := InChq;
          try
            ultimo := 0;
            s := TMDOQuery.Create(nil);
            s.Database := dmGestion.dbGestion;
            s.Transaction := trSaveComp;
            s.SQL.Add('Select Max(IdMov) as Ultimo ');
            s.SQL.Add('From BancoProp ');
            s.Open;
            ultimo := s.FieldByName('Ultimo').AsInteger + 1;
            s.Close;
          finally
            s.Free;
          end;
          q.Close;
          q.ParamByName('IdMov').AsInteger := ultimo;
          q.ParamByName('IdBanco').AsInteger := Datos.FieldByName('IdBanco').AsInteger;
          q.ParamByName('TipoMov').AsInteger := Datos.FieldByName('TipoMov').AsInteger;
          q.ParamByName('NroCheque').AsInteger := Datos.FieldByName('NroCheque').AsInteger;
          q.ParamByName('FechaEmision').AsDate := Datos.FieldByName('FechaEmision').AsDateTime;
          q.ParamByName('FechaVencimiento').AsDate := Datos.FieldByName('FechaVencimiento').AsDateTime;
          q.ParamByName('IdOrdPago').AsInteger := DatosPago.IdOrdPago;
          q.ParamByName('IdEntidad').AsInteger := Datos.FieldByName('IdEntidad').AsInteger;
          q.ParamByName('DetalleMov').AsString := DatosPago.NomEntidad;
          q.ParamByName('Monto').AsCurrency := Datos.FieldByName('Monto').AsCurrency;
          q.ParamByName('Usuario').AsInteger := Usuario;
          q.ParamByName('IdFactura').AsInteger := DatosPago.IdComprobante;
          q.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
          q.ParamByName('Estado').AsInteger := 0;
          q.ParamByName('IdNroConciliacion').AsInteger := 0;
          q.ParamByName('IdEmpresa').AsInteger := DatosPago.IdEmpresa;
          q.ExecSQL;
        finally
          q.Free;
        end;
        Datos.Next;
      end;
      Datos.Close;
    end;
  except
    On E:Exception do
    begin
      raise EUsuario.Create(E.Message);
    end;
  end;
end;

procedure TdmSaveFile.DoPagoVentaValores(DatosPago: TDatosPagos);
Const
  InChq = 'Insert InTo '+
          'BancoTer(IdMov, NombreBanco, NroCuenta, NroCheque, IdTitular, '+
          '         Titular, IdEndoso, Endoso, IdFactura, IdSucursal, '+
          '         IdPuntoVenta, IdOrdPago, NroFactura, FechaVencimiento, '+
          '         Situacion, Monto, FechaIS, IdMovSuc, IdEmpresa) '+
          'Values(:IdMov, :NombreBanco, :NroCuenta, :NroCheque, :IdTitular, '+
          '       :Titular, :IdEndoso, :Endoso, :IdFactura, :IdSucursal, '+
          '       :IdPuntoVenta, :IdOrdPago, :NroFactura, :FechaVencimiento, '+
          '       :Situacion, :Monto, :FechaIS, :IdMovSuc, :IdEmpresa) ';
var
  q, s: TMDOQuery;
  u: Integer;
begin
  try
    with DatosPago.PagosValores do
    begin
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := trSaveComp;
      q.SQL.Text := InChq;
      Datos.First;
      while not Datos.Eof do
      begin
        try
          u := 1;
          s := TMDOQuery.Create(nil);
          s.Database := dmGestion.dbGestion;
          s.Transaction := trSaveComp;
          s.SQL.Add('Select Max(IdMov) as Ultimo ');
          s.SQL.Add('From BancoTer ');
          s.Open;
          u := s.FieldByName('Ultimo').AsInteger + 1;
          s.Close;
        finally
          s.Free;
        end;
        q.Close;
        q.ParamByName('IdMov').AsInteger := u;
        q.ParamByName('NombreBanco').AsString := Datos.FieldByName('NombreBanco').AsString;
        q.ParamByName('NroCuenta').AsString := Datos.FieldByName('NroCuenta').AsString;
        q.ParamByName('NroCheque').AsInteger := Datos.FieldByName('NroCheque').AsInteger;
        q.ParamByName('IdTitular').AsInteger := Datos.FieldByName('IdTitular').AsInteger;
        q.ParamByName('Titular').AsString := Datos.FieldByName('Titular').AsString;
        q.ParamByName('IdEndoso').AsInteger := Datos.FieldByName('IdEndoso').AsInteger;
        q.ParamByName('Endoso').AsString := Datos.FieldByName('Endoso').AsString;
        q.ParamByName('IdFactura').AsInteger := DatosPago.IdComprobante;
        q.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
        q.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
        q.ParamByName('IdOrdPago').AsInteger := 0;
        q.ParamByName('NroFactura').AsString := DatosPago.NroComprobante;
        q.ParamByName('FechaVencimiento').AsDate := Datos.FieldByName('FechaVencimiento').AsDateTime;
        q.ParamByName('Situacion').AsInteger := btEnCartera;
        q.ParamByName('Monto').AsCurrency := Datos.FieldByName('Monto').AsCurrency;
        q.ParamByName('FechaIS').Clear;
        q.ParamByName('IdMovSuc').AsInteger := u;
        q.ParamByName('IdEmpresa').AsInteger := DatosPago.IdEmpresa;
        q.ExecSQL;
        Datos.Next;
      end;
      Datos.Close;
    end;
  finally
    q.Free;
  end;
end;

procedure TdmSaveFile.DoPagoComprasValores(DatosPago: TDatosPagos);
Const
  UdChq = 'UpDate BancoTer '+
          'Set Situacion = :Situacion, '+
          '    IdEntrega = :IdEntrega, '+
          '    Entrega = :Entrega, '+
          '    FechaEntrega = :FechaEntrega, '+
          '    IdOrdPago = :IdOrdPago '+
          'Where IdMov = :IdMovT ';
var
  q: TMDOQuery;
begin
  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := trSaveComp;
    q.SQL.Text := UdChq;
    DatosPago.PagosValores.Datos.First;
    while not DatosPago.PagosValores.Datos.Eof do
    begin
      q.ParamByName('Situacion').AsInteger := btEntregado;
      q.ParamByName('IdEntrega').AsInteger := DatosPago.IdEntidad;
      q.ParamByName('Entrega').AsString := DatosPago.NomEntidad;
      q.ParamByName('FechaEntrega').AsDate := DatosPago.FechaOp;
      q.ParamByName('IdOrdPago').AsInteger := DatosPago.IdOrdPago;
      q.ParamByName('IdMovT').AsInteger := DatosPago.PagosValores.Datos.FieldByName('IdMov').AsInteger;
      q.ExecSQL;
      DatosPago.PagosValores.Datos.Next;
    end;
    DatosPago.PagosValores.Datos.Close;
  finally
    q.Free;
  end;
end;

procedure TdmSaveFile.AuxBcoProNroChequeValidate(Sender: TField);
var
  q: TMDOQuery;
  d, h: Integer;
begin
  if (AuxBcoProTipoMov.AsInteger = bpCheque) And
     (AuxBcoProNroCheque.AsInteger > 0) then
  begin
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trProc;
      q.SQL.Add('Select NroChqDesde, NroChqHasta From Bancos ');
      q.SQL.Add('Where IdBanco =:IdBanco ');
      q.ParamByName('IdBanco').AsInteger := AuxBcoProIdBanco.AsInteger;
      q.Open;
      if not q.IsEmpty then
      begin
        d := q.FieldByName('NroChqDesde').AsInteger;
        h := q.FieldByName('NroChqHasta').AsInteger + 1;
        if not((AuxBcoProNroCheque.AsInteger >= d) and
           ((AuxBcoProNroCheque.AsInteger) <= h)) then
          ShowMessage('Número de Cheque no valido');
      end;
      q.Close;
    finally
      q.Free;
    end;
  end;
end;

procedure TdmSaveFile.AuxBcoProTipoMovValidate(Sender: TField);
begin
  with dmGestion do
  begin
    if Bancos.Locate(BancosIDBANCO.FieldName, AuxBcoProIdBanco.AsInteger, []) then
    begin
      if NroChq.Locate(NroChqIdBanco.FieldName, AuxBcoProIdBanco.AsInteger, []) then
      begin
        NroChq.Edit;
        NroChqCantMov.AsInteger := NroChqCantMov.AsInteger+1;
        NroChqNroCheque.AsInteger := NroChqNroCheque.AsInteger+1;
        NroChq.Post;
      end
      else begin
        NroChq.Append;
        NroChqIdBanco.AsInteger := BancosIDBANCO.AsInteger;
        NroChqCantMov.AsInteger := 1;
        NroChqNroCheque.AsInteger := BancosNROCHQDESDE.AsInteger;
        NroChq.Post;
      end;
      AuxBcoProNroCheque.AsInteger := NroChqNroCheque.AsInteger + 1
    end
    else begin
      ShowMessage('La cuenta no existe');
    end;
  end;
end;

procedure TdmSaveFile.AuxBcoProAfterOpen(DataSet: TDataSet);
begin
  if NroChq.Active then
    NroChq.EmptyDataSet
  else
    NroChq.CreateDataSet;
end;

procedure TdmSaveFile.TransBankBeforeInsert(DataSet: TDataSet);
var
  q: TMDOQuery;
  u: Integer;
begin
  try
    u := 0;
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := trSaveComp;
    q.SQL.Add('Select Max(IdTBank) as Ultimo From TransBank ');
    q.Open;
    if not q.IsEmpty then
    begin
      u := q.FieldByName('Ultimo').AsInteger + 1;
      q.Close;
    end;
  finally
    q.Free;
  end;
  TransBankIdTBank.AsInteger := u;
end;

//******************************************************************************
//           FIN BANCOS CUENTAS PROPIAS Y VALORES DE TERCEROS
//******************************************************************************

//******************************************************************************
//          STOCK, COMPROBANTES, ID
//******************************************************************************
function TdmSaveFile.GrabarComprobanteStock(var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
Const
  ChkTrasp = 'Select Count(*) as Cantidad '+
             'From Traspaso '+
             'Where NroFactura = :NroFactura And '+
             '      IdStOrigen = :IdStOrigen And '+
             '      IdStDestino = :IdStDestino And '+
             '      FechaF = :FechaF And '+
             '      TipoFactura = :TipoFactura ';

  SaveTrsp = 'Insert InTo '+
             'Traspaso(IdFactura, IdSucursal, IdPuntoVenta, IdStOrigen, '+
             '       IdStDestino, DiaHora, TipoFactura, NroRemSuc, '+
             '       FechaF, NroFactura, CantArtic, Total, Empleado, '+
             '       Usuario, TipoAj, Estado, IdSubDepO, IdSubDepD, '+
             '       State, EntregarA, DomicilioE, IdFletero, En_Ambas, '+
             '       TNeto, TNoComp, TCosto) '+
             'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :IdStOrigen, '+
             '       :IdStDestino, :DiaHora, :TipoFactura, :NroRemSuc, '+
             '       :FechaF, :NroFactura, :CantArtic, :Total, :Empleado, '+
             '       :Usuario, :TipoAj, :Estado, :IdSubDepO, :IdSubDepD, '+
             '       :State, :EntregarA, :DomicilioE, :IdFletero, :En_Ambas, '+
             '       :TNeto, :TNoComp, :TCosto) ';

  SaveITrp = 'Insert InTo '+
             'ItemsTR(IdFactura, IdSucursal, IdPuntoVenta, IdItem, '+
             '       IdArticulo, Talle, FechaF, Cantidad, TMov, TipoAj, '+
             '       PrecioFinal, PrecioTotal, IdSucursalO, IdSucursalD, '+
             '       Detalle1, Detalle2, Detalle3, Detalle4, State, '+
             '       PrecioCosto, PrecioNeto, NoComputables) '+
             'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :IdItem, '+
             '       :IdArticulo, :Talle, :FechaF, :Cantidad, :TMov, :TipoAj, '+
             '       :PrecioFinal, :PrecioTotal, :IdSucursalO, :IdSucursalD, '+
             '       :Detalle1, :Detalle2, :Detalle3, :Detalle4, :State, '+
             '       :PrecioCosto, :PrecioNeto, :NoComputables)';

  Save_CCP = 'Insert InTo '+
             'CCProv(NroMovimiento, Entidad, TComp, FechaOrg, Fecha, '+
             '       IdComprobante, IdSucursal, IdPuntoVenta, Comprobante, '+
             '       Debe, Haber, PagoACta, SaldoMov, Estado, State, '+
             '       IdEmpresa) '+
             'Values(:NroMovimiento, :Entidad, :TComp, :FechaOrg, :Fecha, '+
             '       :IdComprobante, :IdSucursal, :IdPuntoVenta, :Comprobante, '+
             '       :Debe, :Haber, :PagoACta, :SaldoMov, :Estado, :State, '+
             '       :IdEmpresa) ';

  Set_Domi = 'Update ItemsFV '+
             '    Set MosDom = -1, '+
             '        REMSUCSAL = :SS, '+
             '        REMFACSAL = :FS, '+
             '        FECHASAL = :FE '+
             'Where IdFactura = :IF And '+
             '      IdSucursal = :IS And '+
             '      IdPuntoVenta = :IP And '+
             '      IdItem = :IT ';
var
  NumItems: Integer;
  q: TMDOQuery;
begin
  Result := False;
  // chequeo de comprobante repetido
  qSaveComp.Close;
  qSaveComp.Sql.Clear;
  qSaveComp.SQL.Text := ChkTrasp;
  qSaveComp.ParamByName('NroFactura').AsString := Factura.NroFactura;
  qSaveComp.ParamByName('IdStOrigen').AsInteger := Factura.IdStOrigen;
  qSaveComp.ParamByName('IdStDestino').AsInteger := Factura.IdStDestino;
  qSaveComp.ParamByName('FechaF').AsDate := Factura.FechaF;
  qSaveComp.ParamByName('TipoFactura').AsInteger := Factura.TipoFactura;
  qSaveComp.Open;

  if qSaveComp.FieldByName('Cantidad').asInteger > 0 then
  begin
    qSaveComp.Close;
    ShowMessage('El Comprobante ya fue ingresado.-');
  end
  else begin
    try
      NumItems := 0;
      if not trSaveComp.InTransaction then
        trSaveComp.StartTransaction;
      AuxNCmp := Factura.NroFactura;
      Factura.IdFactura := Get_Ultimos(RemTrasp);

      Case Factura.TipoFactura of
        RemitoTraspaso: begin
          if ControladorLocal and
             Tipo_Factura then
          begin
            try // Actualizar numeración de Comprobantes
              with dmGestion do
              begin
                qTerminales.Close;
                qTerminales.Transaction := trSaveComp;
                qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
                qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
                qTerminales.Open;
                qTerminales.Edit;
                qTerminalesRemX.AsString  := Factura.NroFactura;
                qTerminales.Post;
              end;
            except
              raise EUsuario.Create('No se pudo actualizar la numeración de los Comprobantes');
            end;
          end
          else begin
            try
              q := TMDOQuery.Create(nil);
              q.Database := dmGestion.dbGestion;
              q.Transaction := trSaveComp;
              q.SQL.Add('UpDate Sucursales ');
              q.SQL.Add('Set NroRemitoT = :NroRem ');
              q.SQL.Add('Where IdSucursal = :IdSucD ');
              q.ParamByName('NroRem').AsString := Inc_NComp(AuxNCmp);
              q.ParamByName('IdSucD').AsInteger := Factura.IdStDestino;
              q.ExecSQL;
              dmGestion.Sucursales.ApplyUpdates(0);
            finally
              q.Free;
            end;
          end;
        end;

        RemitoAjusteST: begin
          try
            q := TMDOQuery.Create(nil);
            q.Database := dmGestion.dbGestion;
            q.Transaction := trSaveComp;
            q.SQL.Add('UpDate DatosSis ');
            q.SQL.Add('Set RemitoAj = :NroRem ');
            q.ParamByName('NroRem').AsString := AuxNCmp;
            q.ExecSQL;
            dmGestion.Empresas.ApplyUpdates(0);
          finally
            q.Free;
          end;
        end;

        Descuento_D: begin
          try
            q := TMDOQuery.Create(nil);
            q.Database := dmGestion.dbGestion;
            q.Transaction := trSaveComp;
            q.SQL.Add('UpDate DatosSis ');
            q.SQL.Add('Set NOrdPago = :NroRem ');
            q.ParamByName('NroRem').AsString := AuxNCmp;
            q.ExecSQL;
            dmGestion.Empresas.ApplyUpdates(0);
          finally
            q.Free;
          end;

          qSaveComp.Close;        // Grabar mov en Cta Cte del Prov
          qSaveComp.Sql.Clear;
          qSaveComp.SQL.Text := Save_CCP;
          qSaveComp.ParamByName('NroMovimiento').AsInteger := Get_Ultimos(CCProveedor);
          qSaveComp.ParamByName('Entidad').AsInteger := Factura.Entidad;
          qSaveComp.ParamByName('TComp').AsInteger := Factura.TipoFactura;
          qSaveComp.ParamByName('FechaOrg').AsDate := Factura.FechaF;
          qSaveComp.ParamByName('Fecha').AsDate := Factura.FechaF;
          qSaveComp.ParamByName('IdComprobante').AsInteger := Factura.IdFactura;
          qSaveComp.ParamByName('IdSucursal').AsInteger := IdBranch;
          qSaveComp.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
          qSaveComp.ParamByName('Comprobante').AsString := Factura.NroFactura;
          qSaveComp.ParamByName('Haber').AsCurrency := Factura.Total;
          qSaveComp.ParamByName('Debe').AsCurrency := 0;
          qSaveComp.ParamByName('PagoACta').AsCurrency := 0;
          qSaveComp.ParamByName('SaldoMov').AsCurrency := Factura.Total;
          qSaveComp.ParamByName('Estado').AsInteger := ccPendiente; // Impaga
          qSaveComp.ParamByName('State').AsInteger := 0;
          qSaveComp.ParamByName('IdEmpresa').AsInteger := Factura.IdEmpresa;
          qSaveComp.ExecSQL;

        end;
        RemitoR: begin
          if ControladorLocal and
             Tipo_Factura then
          begin
            try // Actualizar numeración de Comprobantes
              with dmGestion do
              begin
                qTerminales.Close;
                qTerminales.Transaction := trSaveComp;
                qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
                qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
                qTerminales.Open;
                qTerminales.Edit;
                qTerminalesRemX.AsString  := Factura.NroFactura;
                qTerminales.Post;
              end;
            except
              raise EUsuario.Create('No se pudo actualizar la numeración de los Comprobantes');
            end;
          end
          else begin
            try
              q := TMDOQuery.Create(nil);
              q.Database := dmGestion.dbGestion;
              q.Transaction := trSaveComp;
              q.SQL.Add('UpDate Sucursales ');
              q.SQL.Add('Set NroRemitoT = :NroRem ');
              q.SQL.Add('Where IdSucursal = :IdSucD ');
              q.ParamByName('NroRem').AsString := Inc_NComp(AuxNCmp);
              q.ParamByName('IdSucD').AsInteger := Factura.IdStDestino;
              q.ExecSQL;
              dmGestion.Sucursales.ApplyUpdates(0);
            finally
              q.Free;
            end;
          end;
        end;
      end;

      try
        qSaveComp.Close;
        qSaveComp.Sql.Clear;
        qSaveComp.SQL.Text := SaveTrsp;
        qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
        qSaveComp.ParamByName('IdSucursal').AsInteger := IdBranch;
        qSaveComp.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
        qSaveComp.ParamByName('IdStOrigen').AsInteger := Factura.IdStOrigen;
        qSaveComp.ParamByName('IdStDestino').AsInteger := Factura.IdStDestino;
        qSaveComp.ParamByName('DiaHora').AsDateTime := Now;
        qSaveComp.ParamByName('FechaF').AsDate := Factura.FechaF;
        qSaveComp.ParamByName('TipoFactura').AsInteger := Factura.TipoFactura;
        qSaveComp.ParamByName('NroRemSuc').AsString := Factura.CompRef;
        qSaveComp.ParamByName('NroFactura').AsString := Factura.NroFactura;
        qSaveComp.ParamByName('CantArtic').AsInteger := Factura.CantArtic;
        qSaveComp.ParamByName('Total').AsCurrency := Factura.Total;
        qSaveComp.ParamByName('Empleado').AsInteger := Factura.Empleado;
        qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
        qSaveComp.ParamByName('TipoAj').AsInteger := Factura.TipoAj;
        qSaveComp.ParamByName('Estado').AsInteger := 1;
        qSaveComp.ParamByName('IdSubDepO').AsInteger := Factura.IdSubDepO;
        qSaveComp.ParamByName('IdSubDepD').AsInteger := Factura.IdSubDepD;
        qSaveComp.ParamByName('State').AsInteger := 0;
        qSaveComp.ParamByName('EntregarA').AsString := Factura.EntregarA;
        qSaveComp.ParamByName('DomicilioE').AsString:= Factura.DomicilioE;
        qSaveComp.ParamByName('IdFletero').AsInteger := Factura.IdFletero;
        qSaveComp.ParamByName('En_Ambas').AsInteger := 1;
        qSaveComp.ParamByName('TNeto').AsCurrency := 0;
        qSaveComp.ParamByName('TNoComp').AsCurrency := 0;
        qSaveComp.ParamByName('TCosto').AsCurrency := 0;
        qSaveComp.ExecSQL;
      except
        on E: Exception do
          raise Exception.Create('Error al grabar el remito ' + #13 + E.Message);
      end;

      try  // Items
        NumItems := 1;
        while (ItemsFactura[NumItems].IdProducto > 0) And
              (NumItems <= Factura.CantArtic) do
        begin
          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.SQL.Text := SaveITrp;
          with ItemsFactura[NumItems] do
          begin
            qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
            qSaveComp.ParamByName('IdSucursal').AsInteger := IdBranch;
            qSaveComp.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
            qSaveComp.ParamByName('IdItem').AsInteger := NumItems;
            qSaveComp.ParamByName('IdArticulo').AsInteger := IdProducto;
            qSaveComp.ParamByName('Talle').AsInteger := Talle;
            qSaveComp.ParamByName('FechaF').AsDate := Factura.FechaF;
            qSaveComp.ParamByName('Cantidad').AsFloat := Cantidad;
            qSaveComp.ParamByName('TMov').AsInteger := Factura.TipoFactura;
            qSaveComp.ParamByName('TipoAj').AsInteger := TipoAj;
            qSaveComp.ParamByName('PrecioFinal').AsCurrency := PrecioFinal;
            qSaveComp.ParamByName('PrecioTotal').AsCurrency := PrecioTotal;
            qSaveComp.ParamByName('IdSucursalO').AsInteger := Factura.IdStOrigen;
            qSaveComp.ParamByName('IdSucursalD').AsInteger := Factura.IdStDestino;
            qSaveComp.ParamByName('Detalle1').AsString := DetalleExt[1];
            qSaveComp.ParamByName('Detalle2').AsString := DetalleExt[2];
            qSaveComp.ParamByName('Detalle3').AsString := DetalleExt[3];
            qSaveComp.ParamByName('Detalle4').AsString := DetalleExt[4];
            qSaveComp.ParamByName('PrecioCosto').AsCurrency := PrecioCosto;
            qSaveComp.ParamByName('PrecioNeto').AsCurrency := PrecioNetoT;
            qSaveComp.ParamByName('NoComputables').AsCurrency := NoComputable;
            qSaveComp.ParamByName('State').AsInteger := 0;
            qSaveComp.ExecSQL;
            Case Factura.TipoFactura of
              RemitoTraspaso: begin
                Update_Parts(IdProducto, Factura.IdStOrigen, Cantidad,
                             Talle, RemitoTraspaso,-1, Servicio, EsKit,
                             qSaveComp.Database, qSaveComp.Transaction);
                Update_Parts(IdProducto, Factura.IdStDestino, Cantidad,
                             Talle, RemitoTraspaso, 1, Servicio, EsKit,
                             qSaveComp.Database, qSaveComp.Transaction);
                if MosDom = Verdadero then
                begin
                  try
                    q := TMDOQuery.Create(nil);
                    q.Database := qSaveComp.Database;
                    q.Transaction := qSaveComp.Transaction;
                    q.SQL.Text := Set_Domi;
                    q.ParamByName('IF').AsInteger := IdFacDomRem;
                    q.ParamByName('IS').AsInteger := IdSucDomRem;
                    q.ParamByName('IP').AsInteger := IdPtoDomRem;
                    q.ParamByName('IT').AsInteger := IdItmDomRem;
                    q.ParamByName('SS').AsInteger := IdBranch;
                    q.ParamByName('FS').AsInteger := Factura.IdFactura;
                    q.ParamByName('FE').AsDate := Factura.FechaF;
                    q.ExecSQL;
                  finally
                    q.Free;
                  end;
                end;
              end;

              RemitoAjusteSt: begin
                  Update_Parts(IdProducto, Factura.IdStOrigen, Cantidad, Talle,
                               Factura.TipoFactura, TipoAj, Servicio, EsKit,
                               qSaveComp.Database, qSaveComp.Transaction);
              end;

              Descuento_D: begin
                  Update_Parts(IdProducto, Factura.IdStOrigen, Cantidad, Talle,
                               Factura.TipoFactura, TipoAj, Servicio, EsKit,
                               qSaveComp.Database, qSaveComp.Transaction);
              end;
            End;
          End;
          Inc(NumItems);
        end;
      except
        on E: Exception do
          raise Exception.Create('Error al grabar items en remito' + #13 + E.Message);
      end;
      trSaveComp.Commit;
      Result := True;
    except
      on E:Exception do
      begin
        Result := False;
        trSaveComp.Rollback;
        raise EUsuario.Create('Error grabando Remito: '+E.Message);
      end;
    end;
  end;
end;

function TdmSaveFile.GrabarComprobanteInventario(var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
Const
  ChkInven = 'Select Count(*) as Cantidad '+
             'From Traspaso '+
             'Where NroFactura = :NroFactura And '+
             '      IdStOrigen = :IdStOrigen And '+
             '      IdStDestino = :IdStDestino And '+
             '      FechaF = :FechaF And '+
             '      TipoFactura = :TipoFactura ';

  Save_CInv = 'Insert InTo '+
              'Traspaso(IdFactura, IdSucursal, IdPuntoVenta, IdStOrigen, '+
              '       IdStDestino, DiaHora, TipoFactura, NroRemSuc, '+
              '       FechaF, NroFactura, CantArtic, Total, Empleado, '+
              '       Usuario, TipoAj, Estado, IdSubDepO, IdSubDepD, '+
              '       State, EntregarA, DomicilioE, IdFletero, En_Ambas, '+
              '       TNeto, TNoComp, TCosto) '+
              'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :IdStOrigen, '+
              '       :IdStDestino, :DiaHora, :TipoFactura, :NroRemSuc, '+
              '       :FechaF, :NroFactura, :CantArtic, :Total, :Empleado, '+
              '       :Usuario, :TipoAj, :Estado, :IdSubDepO, :IdSubDepD, '+
              '       :State, :EntregarA, :DomicilioE, :IdFletero, :En_Ambas, '+
              '       :TNeto, :TNoComp, :TCosto) ';

  Save_IInv = 'Insert InTo '+
              'ItemsTR(IdFactura, IdSucursal, IdPuntoVenta, IdItem, '+
              '       IdArticulo, Talle, FechaF, Cantidad, TMov, TipoAj, '+
              '       PrecioFinal, PrecioTotal, IdSucursalO, IdSucursalD, '+
              '       PrecioCosto, PrecioNeto, NoComputables, State) '+
              'Values(:IdFactura, :IdSucursal, :IdPuntoVenta, :IdItem, '+
              '       :IdArticulo, :Talle, :FechaF, :Cantidad, :TMov, :TipoAj, '+
              '       :PrecioFinal, :PrecioTotal, :IdSucursalO, :IdSucursalD, '+
              '       :PrecioCosto, :PrecioNeto, :NoComputables, :State) ';
var
  NumItems: Integer;
  q: TMDOQuery;
begin
  Result := False;
  qSaveComp.Close;
  qSaveComp.Sql.Clear;  // chequeo de comprobante repetido
  qSaveComp.SQL.Text := ChkInven;
  qSaveComp.ParamByName('NroFactura').AsString := Factura.NroFactura;
  qSaveComp.ParamByName('IdStOrigen').AsInteger := Factura.IdStOrigen;
  qSaveComp.ParamByName('IdStDestino').AsInteger := Factura.IdStDestino;
  qSaveComp.ParamByName('FechaF').AsDate := Factura.FechaF;
  qSaveComp.ParamByName('TipoFactura').AsInteger := Factura.TipoFactura;
  qSaveComp.Open;

  if qSaveComp.FieldByName('Cantidad').asInteger > 0 then
  begin
    qSaveComp.Close;
    ShowMessage('El Comprobante ya fue ingresado.-');
  end
  else begin
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := trSaveComp;
      q.SQL.Add('UpDate Sucursales ');
      q.SQL.Add('  Set NroRemitoI = :NR ');
      q.SQL.Add('Where IdSucursal = :SI ');
      q.ParamByName('NR').AsString  := Factura.NroFactura;
      q.ParamByName('SI').AsInteger := Factura.IdStOrigen;
      q.ExecSQL;
    finally
      q.Free;
    end;

    try
      if not trSaveComp.InTransaction then
        trSaveComp.StartTransaction;
      try
        Factura.IdFactura := Get_Ultimos(RemTrasp);
        qSaveComp.Close;
        qSaveComp.Sql.Clear;
        qSaveComp.SQL.Text := Save_CInv;
        qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
        qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
        qSaveComp.ParamByName('IdPuntoVenta').AsInteger := Factura.IdPuntoVenta;
        qSaveComp.ParamByName('IdStOrigen').AsInteger := Factura.IdStOrigen;   // Sucursal del Inventario
        qSaveComp.ParamByName('IdStDestino').AsInteger := Factura.IdStDestino; // Periodo del Inventario
        qSaveComp.ParamByName('DiaHora').AsDateTime := Now;
        qSaveComp.ParamByName('TipoFactura').AsInteger := Factura.TipoFactura;
        qSaveComp.ParamByName('NroRemSuc').AsString := Vacio;
        qSaveComp.ParamByName('FechaF').AsDate := Factura.FechaF;
        qSaveComp.ParamByName('NroFactura').AsString := Factura.NroFactura;
        qSaveComp.ParamByName('CantArtic').AsInteger := Factura.CantArtic;
        qSaveComp.ParamByName('Total').AsCurrency := Factura.Total;
        qSaveComp.ParamByName('Empleado').AsInteger := Factura.Empleado;
        qSaveComp.ParamByName('Usuario').AsInteger := Factura.Empleado;
        qSaveComp.ParamByName('TipoAj').AsInteger := 0;
        qSaveComp.ParamByName('Estado').AsInteger := 0;
        qSaveComp.ParamByName('IdSubDepD').AsInteger := 0;
        qSaveComp.ParamByName('IdSubDepO').AsInteger := 0;
        qSaveComp.ParamByName('Empleado').AsInteger := Factura.Empleado;
        qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
        qSaveComp.ParamByName('State').AsInteger := 0;
        qSaveComp.ParamByName('EntregarA').AsString := Vacio;
        qSaveComp.ParamByName('DomicilioE').AsString := Vacio;
        qSaveComp.ParamByName('IdFletero').AsInteger := 0;
        qSaveComp.ParamByName('En_Ambas').AsInteger := 0;
        qSaveComp.ParamByName('TNeto').AsCurrency := Factura.Neto;
        qSaveComp.ParamByName('TNoComp').AsCurrency := Factura.NoComputables;
        qSaveComp.ParamByName('TCosto').AsCurrency := Factura.Exento;
        qSaveComp.ExecSQL;
      except
        on E:Exception do
          raise EUsuario.Create('El remito de Inventario Nº '+Factura.NroFactura+
                                ' no se puede Grabar. Error '+E.Message);
      end;
      // Items Inventario
      NumItems := 1;
      try
        while (ItemsFactura[NumItems].IdProducto > 0) and
              (NumItems <= Factura.CantArtic) do
        begin
          with ItemsFactura[NumItems] do
          begin
            qSaveComp.Close;
            qSaveComp.Sql.Clear;
            qSaveComp.SQL.Text := Save_IInv;
            qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
            qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
            qSaveComp.ParamByName('IdPuntoVenta').AsInteger := Factura.IdPuntoVenta;
            qSaveComp.ParamByName('IdItem').AsInteger := NumItems;
            qSaveComp.ParamByName('IdArticulo').AsInteger := IdProducto;
            qSaveComp.ParamByName('Talle').AsInteger := Talle;
            qSaveComp.ParamByName('FechaF').AsDateTime := Factura.FechaF;
            qSaveComp.ParamByName('Cantidad').AsInteger := Round(Cantidad);
            qSaveComp.ParamByName('TMov').AsInteger := Factura.TipoFactura;
            qSaveComp.ParamByName('TipoAj').AsInteger := 0;
            qSaveComp.ParamByName('PrecioFinal').AsCurrency := PrecioFinal;
            qSaveComp.ParamByName('PrecioTotal').AsCurrency := PrecioTotal;
            qSaveComp.ParamByName('IdSucursalO').AsInteger := Factura.IdStOrigen;  // Suc Inventario
            qSaveComp.ParamByName('IdSucursalD').AsInteger := Factura.IdStDestino; // Periodo
            qSaveComp.ParamByName('PrecioCosto').AsCurrency := PrecioCosto;
            qSaveComp.ParamByName('PrecioNeto').AsCurrency := PrecioNetoT;
            qSaveComp.ParamByName('NoComputables').AsCurrency := NoComputable;
            qSaveComp.ParamByName('State').AsInteger := 0;
            qSaveComp.ExecSQL;
          end;
          Inc(NumItems);
        end;
      except
        on E:Exception do
          raise EUsuario.Create('Error. Los Items del Remito de Inventario Nº '+
                                Factura.NroFactura+' no se puede Grabar. '+E.Message);
      end;
      Result := True;
      trSaveComp.Commit;
    except
      on E: Exception do
      begin
        Result := False;
        trSaveComp.Rollback;
        raise EUsuario.Create('Error. Remito de Inventario Nº '+
                              Factura.NroFactura+' no se puede Grabar. '+E.Message);
      end;
    end;
  end;
end;

(*
function TdmSaveFile.GrabarComprobanteInventario(var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
Const
  Save_CInv = 'Insert InTo ' +
              'Inventario(IdFactura, IdSucursal, IdStock, DiaHora, FechaI, '+
              '       NroFact, CantArt, Periodo, TNeto, TFac, TNoComp, '+
              '       TCosto, Total, Empleado) '+
              'Values(:IdFactura, :IdSucursal, :IdStock, :DiaHora, :FechaI, '+
              '       :NroFact, :CantArt, :Periodo, :TNeto, :TFac, :TNoComp, '+
              '       :TCosto, :Total, :Empleado) ';
  Save_IInv = 'Insert Into '+
              'ItemsIN(IdFactura, IdSucursal, IdStock, IdItem, Periodo, '+
              '        IdArticulo, Talle, FechaI, Cantidad, IPrecio, '+
              '        ITotal, Costo, INeto, INoComp, TFac) '+
              'Values(:IdFactura, :IdSucursal, :IdStock, :IdItem, :Periodo, '+
              '       :IdArticulo, :Talle, :FechaI, :Cantidad, :IPrecio, '+
              '       :ITotal, :Costo, :INeto, :INoComp, :TFac) ';
var
  NumItems: Integer;
  q: TMDOQuery;
begin
  Result := False;
  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := dmGestion.trProc;
    q.SQL.Add('Select FechaF From Inventario ');
    q.SQL.Add('Where NroFact =:NroFactura And ');
    q.SQL.Add('      IdStock =:IdStock And CantArt =:CantArt ');
    q.ParamByName('NroFact').AsString := Factura.NroFactura;
    q.ParamByName('IdStock').AsInteger := Factura.IdStOrigen;
    q.ParamByName('CantArt').AsInteger := Factura.CantArtic;
    q.Open;
    if not q.IsEmpty then
    begin
      q.Close;
      Exit;
    end;
  finally
    q.Free;
  end;

  try
    with dmGestion do
    begin
      if Sucursales.Locate(SucursalesIdSucursal.FieldName, Factura.IdStOrigen, []) then
      begin
        Sucursales.Edit;
        SucursalesNroRemitoI.AsString := Factura.NroFactura;
        Sucursales.Post;
      end;
    end;
    if not trSaveComp.InTransaction then
      trSaveComp.StartTransaction;
    try
      Factura.IdFactura := Get_Ultimos(RemInv);
      qSaveComp.Close;
      qSaveComp.Sql.Clear;
      qSaveComp.SQL.Text := Save_CInv;
      qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
      qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
      qSaveComp.ParamByName('IdStock').AsInteger := Factura.IdStOrigen;
      qSaveComp.ParamByName('DiaHora').AsDateTime := Now;
      qSaveComp.ParamByName('FechaI').AsDate := Factura.FechaF;
      qSaveComp.ParamByName('NroFact').AsString := Factura.NroFactura;
      qSaveComp.ParamByName('CantArt').AsInteger := Factura.CantArtic;
      qSaveComp.ParamByName('Periodo').AsInteger := Factura.IdCompRef;
      qSaveComp.ParamByName('TNeto').AsCurrency := Factura.Neto;
      qSaveComp.ParamByName('TFac').AsInteger := Factura.TipoFactura;
      qSaveComp.ParamByName('TNoComp').AsCurrency := Factura.NoComputables;
      qSaveComp.ParamByName('TCosto').AsCurrency := Factura.Exento;
      qSaveComp.ParamByName('Total').AsCurrency := Factura.Total;
      qSaveComp.ParamByName('Empleado').AsInteger := Factura.Empleado;
      qSaveComp.ExecSQL;
    except
      on E:Exception do
        raise EUsuario.Create('El Comprobante Nº '+Factura.NroFactura+
                              ' no se puede Grabar '+E.Message);
    end;
    NumItems := 1;
    try
      while (ItemsFactura[NumItems].IdProducto > 0) and
            (NumItems <= Factura.CantArtic) do
      begin
        with ItemsFactura[NumItems] do
        begin
          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.SQL.Text := Save_IInv;
          qSaveComp.ParamByName('IdFactura').AsInteger := Factura.IdFactura;
          qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
          qSaveComp.ParamByName('IdStock').AsInteger := Factura.IdStOrigen;
          qSaveComp.ParamByName('IdItem').AsInteger := NumItems;
          qSaveComp.ParamByName('Periodo').AsInteger := Factura.IdCompRef;
          qSaveComp.ParamByName('IdArticulo').AsInteger := IdProducto;
          qSaveComp.ParamByName('Talle').AsInteger := Talle;
          qSaveComp.ParamByName('FechaI').AsDateTime := Factura.FechaF;
          qSaveComp.ParamByName('Cantidad').AsFloat := Cantidad;
          qSaveComp.ParamByName('IPrecio').AsCurrency := PrecioFinal;
          qSaveComp.ParamByName('ITotal').AsCurrency := PrecioTotal;
          qSaveComp.ParamByName('Costo').AsCurrency := PrecioCosto;
          qSaveComp.ParamByName('INeto').AsCurrency := PrecioNetoT;
          qSaveComp.ParamByName('INoComp').AsCurrency := NoComputable;
          qSaveComp.ParamByName('TFac').AsInteger := Factura.TipoFactura;
          qSaveComp.ExecSQL;
          if Factura.TipoFactura = RemitoAjusteST then
            Update_Parts(IdProducto, Factura.IdStOrigen, Cantidad, Talle,
                         Factura.TipoFactura, TipoAj, Servicio, False,
                         qSaveComp.Database, qSaveComp.Transaction);
        end;
        Inc(NumItems);
      end;
    except
      on E:Exception do
        raise EUsuario.Create('Los Items no se puede Grabar '+E.Message);
    end;
    trSaveComp.Commit;
    Result := True;
  except
    Result := False;
    trSaveComp.Rollback;
    raise;
  end;
end;

*)

procedure TdmSaveFile.UltimosAfterPost(DataSet: TDataSet);
begin
  with dmGestion do
  begin
    if not trGestion.InTransaction then
      trGestion.StartTransaction;
    try
      Ultimos.ApplyUpdates(0);
      trGestion.Commit;
    except
      trGestion.Rollback;
    end;
  end;
end;

function TdmSaveFile.Get_Ultimos(Cual: TUltimos): LongInt;
begin
  Result := 0;
  try
    try
      if not dmGestion.trProc.InTransaction then
        dmGestion.trProc.StartTransaction;
      Ultimos.Close;
      tUltimos.Transaction := dmGestion.trProc;
      Ultimos.Open;
      Ultimos.First;
      Ultimos.Edit;
      Case Cual of
        CCCliente: begin
          Result := UltimosUltimoCCCliente.AsInteger;
          UltimosUltimoCCCliente.AsInteger := UltimosUltimoCCCliente.AsInteger + 1;
        end;
        CCProveedor: begin
          Result := UltimosUltimoCCProveedor.AsInteger;
          UltimosUltimoCCProveedor.AsInteger := UltimosUltimoCCProveedor.AsInteger + 1;
        end;
        CajaRend: begin
          Result := UltimosUltimoRendicion.AsInteger;
          UltimosUltimoRendicion.AsInteger := UltimosUltimoRendicion.AsInteger + 1;
        end;
        FacCompra: begin
          Result := UltimosUltimoFacC.AsInteger;
          UltimosUltimoFacC.AsInteger := UltimosUltimoFacC.AsInteger + 1;
        end;
        FacVenta: begin
          Result := UltimosUltimoFacV.AsInteger;
          UltimosUltimoFacV.AsInteger := UltimosUltimoFacV.AsInteger + 1;
        end;
        RemTrasp: begin
          Result := UltimosUltimoFacT.AsInteger;
          UltimosUltimoFacT.AsInteger := UltimosUltimoFacT.AsInteger + 1;
        end;
        FacOC: begin
          Result := UltimosUltimoFacO.AsInteger;
          UltimosUltimoFacO.AsInteger := UltimosUltimoFacO.AsInteger + 1;
        end;
        OrdPag: begin
          Result := UltimosUltimoOrdPago.AsInteger;
          UltimosUltimoOrdPago.AsInteger := UltimosUltimoOrdPago.AsInteger + 1;
        end;
        RegPrc: begin
          Result := UltimosUltimoRegPre.AsInteger;
          UltimosUltimoRegPre.AsInteger := UltimosUltimoRegPre.AsInteger + 1;
        end;
        RemInv: begin
          Result := UltimosUltimoInventario.AsInteger;
          UltimosUltimoInventario.AsInteger := UltimosUltimoInventario.AsInteger + 1;
        end;
        PCL_TM: begin
          Result := UltimosULTIMOLIQUIDACION.AsInteger;
          UltimosULTIMOLIQUIDACION.AsInteger := UltimosULTIMOLIQUIDACION.AsInteger + 1;
        end;
      end;
      Ultimos.Post;
      Ultimos.ApplyUpdates(0);
      Ultimos.Close;
      dmGestion.trProc.Commit;
    except
      on E:Exception do
      begin
        dmGestion.trProc.RollBack;
        raise EUsuario.Create(E.Message);
      end;
    end;
  finally
    tUltimos.Transaction := dmSaveFile.trSaveComp;
  end;
end;

//******************************************************************************
//                        BONIFICACIONES PROVEEDORES
//******************************************************************************

procedure TdmSaveFile.DoPagoComprasBonificacion(DatosPago: TDatosPagos);
Const
  Save_BP = 'Insert InTo '+
            'BonifProv(IdBonifProv, IdFactura, IdSucursal, Entidad, IdEmpresa, '+
            '          NroComprobante, FechaDesc, MontoDesc, MontoACta, SaldoDesc) '+
            'Values(:IdBonifProv, :IdFactura, :IdSucursal, :Entidad, :IdEmpresa, '+
            '       :NroComprobante, :FechaDesc, :MontoDesc, :MontoACta, :SaldoDesc) ';
var
  q: TMDOQuery;
  u: Integer;
begin
  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := trSaveComp;
    q.SQL.Add('Select Max(IdBonifProv) as Ultimo ');
    q.SQL.Add('From BonifProv');
    q.Open;
    u := q.FieldByName('Ultimo').AsInteger + 1;
    q.Close;
  finally
    q.Free;
  end;
  qSaveComp.Close;
  qSaveComp.Sql.Clear;
  qSaveComp.SQL.Text := Save_BP;
  qSaveComp.ParamByName('IdBonifProv').AsInteger := u;
  qSaveComp.ParamByName('IdFactura').AsInteger := DatosPago.IdComprobante;
  qSaveComp.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
  qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
  qSaveComp.ParamByName('IdEmpresa').AsInteger := DatosPago.IdEmpresa;
  qSaveComp.ParamByName('NroComprobante').AsString := DatosPago.NroComprobante;
  qSaveComp.ParamByName('FechaDesc').AsDateTime := DatosPago.FechaOp;
  qSaveComp.ParamByName('MontoDesc').AsCurrency := DatosPago.PagosBonif.TotalBonif;
  qSaveComp.ParamByName('MontoACta').AsCurrency := 0;
  qSaveComp.ParamByName('SaldoDesc').AsCurrency := 0;
  qSaveComp.ExecSQL;
end;

//******************************************************************************
//                        Cuenta Corriente Proveedores
//******************************************************************************

procedure TdmSaveFile.DoPagoCuentaProv(DatosPago: TDatosPagos);
Const
  Save_CCP = 'INSERT INTO CCPROV '+
             '  (NROMOVIMIENTO, IDCOMPROBANTE, IDSUCURSAL, TCOMP, ENTIDAD, FECHA, '+
             '   FECHAORG, COMPROBANTE, DEBE, HABER, PAGOACTA, SALDOMOV, SALDO, '+
             '   ESTADO, STATE, IMPNETO, IMPNCOM, SALDONETO, IDORDPAGO, IDSUCORDP, '+
             '   FECHAPAGO, MONTORETI, MONTORETG, MONTORETB, MONTORETH, MONTORETS, '+
             '   IDNROPREOP, IDEMPRESA, IDPUNTOVENTA) '+
             'VALUES '+
             '  (:NROMOVIMIENTO, :IDCOMPROBANTE, :IDSUCURSAL, :TCOMP, :ENTIDAD, :FECHA, '+
             '   :FECHAORG, :COMPROBANTE, :DEBE, :HABER, :PAGOACTA, :SALDOMOV, :SALDO, '+
             '   :ESTADO, :STATE, :IMPNETO, :IMPNCOM, :SALDONETO, :IDORDPAGO, :IDSUCORDP, '+
             '   :FECHAPAGO, :MONTORETI, :MONTORETG, :MONTORETB, :MONTORETH, :MONTORETS, '+
             '   :IDNROPREOP, :IDEMPRESA, :IDPUNTOVENTA) ';
begin
  qSaveComp.Close;
  qSaveComp.Sql.Clear;
  qSaveComp.SQL.Text := Save_CCP;
  qSaveComp.ParamByName('NroMovimiento').AsInteger := Get_Ultimos(CCProveedor);
  qSaveComp.ParamByName('IdComprobante').AsInteger := DatosPago.IdComprobante;
  qSaveComp.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
  qSaveComp.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
  qSaveComp.ParamByName('TComp').AsInteger := DatosPago.TipoComprobante;
  qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
  qSaveComp.ParamByName('Fecha').AsDate := DatosPago.PagosCtaCte.FechaVence;
  qSaveComp.ParamByName('FechaOrg').AsDate := DatosPago.FechaOp;
  qSaveComp.ParamByName('Comprobante').AsString := DatosPago.NroComprobante;
  if DatosPago.TipoComprobante in [CreA, CreB, CreC, CreditoAjuste, PresentacionTM] then
  begin
    qSaveComp.ParamByName('Debe').AsCurrency := 0;
    qSaveComp.ParamByName('Haber').AsCurrency := ABS(DatosPago.PagosCtaCte.TotalCtaCte);
    qSaveComp.ParamByName('PagoACta').AsCurrency := 0;
    qSaveComp.ParamByName('SaldoMov').AsCurrency := ABS(DatosPago.PagosCtaCte.TotalCtaCte);
  end
  else begin
    qSaveComp.ParamByName('Debe').AsCurrency := DatosPago.PagosCtaCte.TotalCtaCte;
    qSaveComp.ParamByName('Haber').AsCurrency := 0;
    qSaveComp.ParamByName('PagoACta').AsCurrency := 0;
    qSaveComp.ParamByName('SaldoMov').AsCurrency := DatosPago.PagosCtaCte.TotalCtaCte;
  end;
  qSaveComp.ParamByName('Saldo').AsCurrency := 0;
  qSaveComp.ParamByName('Estado').AsInteger := ccPendiente; // Impaga
  qSaveComp.ParamByName('State').AsInteger := 0;
  qSaveComp.ParamByName('IMPNETO').AsCurrency := DatosPago.ImpNeto;
  qSaveComp.ParamByName('IMPNCOM').AsCurrency := DatosPago.ImpNComp;
  qSaveComp.ParamByName('SALDONETO').AsCurrency := 0;
  qSaveComp.ParamByName('IDORDPAGO').AsCurrency := 0;
  qSaveComp.ParamByName('IDSUCORDP').AsCurrency := 0;
  qSaveComp.ParamByName('FECHAPAGO').Clear;
  qSaveComp.ParamByName('MONTORETI').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETG').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETB').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETH').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETS').AsCurrency := 0;
  qSaveComp.ParamByName('IDNROPREOP').AsInteger := 0;
  qSaveComp.ParamByName('IDEMPRESA').AsInteger := DatosPago.IdEmpresa;
  qSaveComp.ExecSQL;
  qSaveComp.Close;
end;

procedure TdmSaveFile.DoPagoEfectivoProv(DatosPago: TDatosPagos);
Const
  Save_CCP = 'INSERT INTO CCPROV '+
             '  (NROMOVIMIENTO, IDCOMPROBANTE, IDSUCURSAL, TCOMP, ENTIDAD, FECHA, '+
             '   FECHAORG, COMPROBANTE, DEBE, HABER, PAGOACTA, SALDOMOV, SALDO, '+
             '   ESTADO, STATE, IMPNETO, IMPNCOM, SALDONETO, IDORDPAGO, IDSUCORDP, '+
             '   FECHAPAGO, MONTORETI, MONTORETG, MONTORETB, MONTORETH, MONTORETS, '+
             '   IDNROPREOP, IDEMPRESA, IDPUNTOVENTA) '+
             'VALUES '+
             '  (:NROMOVIMIENTO, :IDCOMPROBANTE, :IDSUCURSAL, :TCOMP, :ENTIDAD, :FECHA, '+
             '   :FECHAORG, :COMPROBANTE, :DEBE, :HABER, :PAGOACTA, :SALDOMOV, :SALDO, '+
             '   :ESTADO, :STATE, :IMPNETO, :IMPNCOM, :SALDONETO, :IDORDPAGO, :IDSUCORDP, '+
             '   :FECHAPAGO, :MONTORETI, :MONTORETG, :MONTORETB, :MONTORETH, :MONTORETS, '+
             '   :IDNROPREOP, :IDEMPRESA, :IDPUNTOVENTA) ';
var
  iOP: Integer;
begin
  iOP := Llenar_OrdenDePagos(DatosPago);
  qSaveComp.Close;
  qSaveComp.Sql.Clear;
  qSaveComp.SQL.Text := Save_CCP;
  qSaveComp.ParamByName('NroMovimiento').AsInteger := Get_Ultimos(CCProveedor);
  qSaveComp.ParamByName('IdComprobante').AsInteger := DatosPago.IdComprobante;
  qSaveComp.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
  qSaveComp.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
  qSaveComp.ParamByName('TComp').AsInteger := DatosPago.TipoComprobante;
  qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
  qSaveComp.ParamByName('Fecha').AsDate := DatosPago.FechaOp;
  qSaveComp.ParamByName('FechaOrg').AsDate := DatosPago.FechaOp;
  qSaveComp.ParamByName('Comprobante').AsString := DatosPago.NroComprobante;
  if DatosPago.TipoComprobante in [CreA, CreB, CreC, CreditoAjuste, PresentacionTM] then
  begin
    qSaveComp.ParamByName('Debe').AsCurrency := 0;
    qSaveComp.ParamByName('Haber').AsCurrency := ABS(DatosPago.TotalPagos);
    qSaveComp.ParamByName('PagoACta').AsCurrency := 0;
    qSaveComp.ParamByName('SaldoMov').AsCurrency := 0;
  end
  else begin
    qSaveComp.ParamByName('Debe').AsCurrency := ABS(DatosPago.TotalPagos);
    qSaveComp.ParamByName('Haber').AsCurrency := 0;
    qSaveComp.ParamByName('PagoACta').AsCurrency := 0;
    qSaveComp.ParamByName('SaldoMov').AsCurrency := 0;
  end;
  qSaveComp.ParamByName('Saldo').AsCurrency := 0;
  qSaveComp.ParamByName('Estado').AsInteger := ccPagada; // pagada
  qSaveComp.ParamByName('State').AsInteger := 0;
  qSaveComp.ParamByName('IMPNETO').AsCurrency := DatosPago.ImpNeto;
  qSaveComp.ParamByName('IMPNCOM').AsCurrency := DatosPago.ImpNComp;
  qSaveComp.ParamByName('SALDONETO').AsCurrency := 0;
  qSaveComp.ParamByName('IDORDPAGO').AsCurrency := iOP;
  qSaveComp.ParamByName('IDSUCORDP').AsCurrency := 0;
  qSaveComp.ParamByName('FECHAPAGO').AsDate := DatosPago.FechaOp;
  qSaveComp.ParamByName('MONTORETI').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETG').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETB').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETH').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETS').AsCurrency := 0;
  qSaveComp.ParamByName('IDNROPREOP').AsInteger := 0;
  qSaveComp.ParamByName('IDEMPRESA').AsInteger := DatosPago.IdEmpresa;
  qSaveComp.ExecSQL;
  qSaveComp.Close;

  qSaveComp.Close;
  qSaveComp.Sql.Clear;
  qSaveComp.Database := dmGestion.dbGestion;
  qSaveComp.Transaction := trSaveComp;
  qSaveComp.SQL.Add('UpDate DatosSis ');
  qSaveComp.SQL.Add('   Set NOrdPago =:NOP ');
  qSaveComp.SQL.Add('Where IdEmpresa =:IEP ');
  qSaveComp.ParamByName('NOP').AsString := DatosPago.NroOrdDePago;
  qSaveComp.ParamByName('IEP').AsInteger:= DatosPago.IdEmpresa;
  qSaveComp.ExecSQL;

  qOrdenes.Close;
  qOrdenes.SelectSQL.Text := Ordenes + ' Where O.IDORDEN =:IdOrden ';
  qOrdenes.ParamByName('IdOrden').AsInteger := iOP;
  qOrdenes.Open;

  if Application.MessageBox('¿Imprime Orden de Pagos. Contado?', 'Proveedores',MB_ICONQUESTION+MB_YESNO) = ID_YES then
    TfrmOrdPagos.Imprimir_OrdenPagos(iOP, False);

  qSaveComp.Close;
  qSaveComp.Sql.Clear;
  qSaveComp.Database := dmGestion.dbGestion;
  qSaveComp.Transaction := trSaveComp;
  qSaveComp.SQL.Text := Save_CCP;
  qSaveComp.ParamByName('NroMovimiento').AsInteger := Get_Ultimos(CCProveedor);
  qSaveComp.ParamByName('IdComprobante').AsInteger := iOP;
  qSaveComp.ParamByName('IdSucursal').AsInteger := IdBranch;
  qSaveComp.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
  qSaveComp.ParamByName('TComp').AsInteger := OrdenDePago;
  qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
  qSaveComp.ParamByName('Fecha').AsDate := DatosPago.FechaOp;
  qSaveComp.ParamByName('FechaOrg').AsDate := DatosPago.FechaOp;
  qSaveComp.ParamByName('Comprobante').AsString := DatosPago.NroOrdDePago;
  qSaveComp.ParamByName('Debe').AsCurrency := 0;
  qSaveComp.ParamByName('Haber').AsCurrency := DatosPago.TotalPagos;
  qSaveComp.ParamByName('PagoACta').AsCurrency := 0;
  qSaveComp.ParamByName('SaldoMov').AsCurrency := 0;
  qSaveComp.ParamByName('Saldo').AsCurrency := 0;
  qSaveComp.ParamByName('Estado').AsInteger := ccPendiente; // Impaga
  qSaveComp.ParamByName('State').AsInteger := 0;
  qSaveComp.ParamByName('IMPNETO').AsCurrency := DatosPago.ImpNeto;
  qSaveComp.ParamByName('IMPNCOM').AsCurrency := 0;
  qSaveComp.ParamByName('SALDONETO').AsCurrency := 0;
  qSaveComp.ParamByName('IDORDPAGO').AsInteger := 0;
  qSaveComp.ParamByName('IDSUCORDP').AsInteger := 0;
  qSaveComp.ParamByName('FECHAPAGO').Clear;
  qSaveComp.ParamByName('MONTORETI').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETG').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETB').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETH').AsCurrency := 0;
  qSaveComp.ParamByName('MONTORETS').AsCurrency := 0;
  qSaveComp.ParamByName('IDEMPRESA').AsInteger  := DatosPago.IdEmpresa;
  qSaveComp.ExecSQL;
end;

procedure TdmSaveFile.qItemsPGFECHAGetText(Sender: TField; var Text: String; DisplayText: Boolean);
begin
  if Sender.IsNull then
    Text := ' '
  else
    Text := Sender.AsString;
end;

function TdmSaveFile.Llenar_OrdenDePagos(var DatosPago: TDatosPagos): Integer;
Const
  Save_OP = 'INSERT INTO ORDENES '+
            '  (IDORDEN, ENTIDAD, FECHAOP, NROCOMPOP, CANTOP, TOTALOP, CONTADO, TICKETS, '+
            '   BANCOPROP, BANCOTER, BONIFPROV, RETENCIONES, USUARIO, ESTADO, NETOOP, '+
            '   RETENCIONI, RETENCIONG, RETENCIONB, PRCRETG, PRCRETI, PRCRETB1, PRCRETB2, '+
            '   RETENCIONS, PRCRETS, RETENCIONH, NROCERTIVA, NROCERTGAN, NROCERTIBT, '+
            '   NROCERTSES, NOCOMPOP, IDEMPRESA) '+
            'VALUES '+
            '  (:IDORDEN, :ENTIDAD, :FECHAOP, :NROCOMPOP, :CANTOP, :TOTALOP, :CONTADO, '+
            '   :TICKETS, :BANCOPROP, :BANCOTER, :BONIFPROV, :RETENCIONES, :USUARIO, '+
            '   :ESTADO, :NETOOP, :RETENCIONI, :RETENCIONG, :RETENCIONB, :PRCRETG, :PRCRETI, '+
            '   :PRCRETB1, :PRCRETB2, :RETENCIONS, :PRCRETS, :RETENCIONH, :NROCERTIVA, '+
            '   :NROCERTGAN, :NROCERTIBT, :NROCERTSES, :NOCOMPOP, :IDEMPRESA) ';

  Save_IO = 'Insert InTo '+
            'ItemsOP(IdOrdPago, IdItemOP, Entidad, IdFactura, IdSucursal, IdPuntoVenta, TipoMov, '+
            '        NroFactura, FechaOr, FechaOP, Comprobante, Importe, MontoOrg, SaldoMov) '+
            'Values(:IdOrdPago, :IdItemOP, :Entidad, :IdFactura, :IdSucursal, :IdPuntoVenta, :TipoMov, '+
            '       :NroFactura, :FechaOr, :FechaOP, :Comprobante, :Importe, :MontoOrg, :SaldoMov) ';

  Save_IP = 'INSERT INTO  '+
            'ITEMSPG (IDORDEN, IDITEMPAG, ENTIDAD, COMPROBANTE, FECHA, IMPORTE, ' +
            '         DETALLE, DESCRIPCION, IDMOVIMIENTO, ESTADO, TIPOPAGO) '+
            'VALUES (:IDORDEN, :IDITEMPAG, :ENTIDAD, :COMPROBANTE, :FECHA, :IMPORTE, '+
            '        :DETALLE, :DESCRIPCION, :IDMOVIMIENTO, :ESTADO, :TIPOPAGO) ';

var
  t, i, j, iOP, TC, IdCheque: Integer;
  Tiene_PreImp: Boolean;
  NroOp: St13;
  NroCR: String;
  Parte1, Parte2: St80;
  q, s: TMDOQuery;

begin
  Result := 0;
  try
    iOP := Get_Ultimos(OrdPag);
    NroOP := Format('%.4d-%.8d',[1, iOP]);
    qSaveComp.Close;
    qSaveComp.Sql.Clear;
    qSaveComp.Database := dmGestion.dbGestion;
    qSaveComp.Transaction := trSaveComp;
    qSaveComp.SQL.Text := Save_OP;
    qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
    qSaveComp.ParamByName('NroCompOP').AsString := NroOP;
    qSaveComp.ParamByName('Estado').AsInteger := opNormal;
    qSaveComp.ParamByName('FechaOP').AsDateTime := Date;
    qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
    qSaveComp.ParamByName('CantOp').AsInteger := CompOP.RecordCount;
    qSaveComp.ParamByName('NetoOP').AsCurrency := DatosPago.ImpNeto;
    qSaveComp.ParamByName('NoCompOP').AsCurrency := DatosPago.ImpNComp;
    qSaveComp.ParamByName('RetencionI').AsCurrency := DatosPago.ImpRetIva;
    qSaveComp.ParamByName('PRCRETI').AsFloat := DatosPago.PrcRetIva;
    qSaveComp.ParamByName('NROCERTIVA').AsString := '0000-0000-000000';
    qSaveComp.ParamByName('RetencionG').AsCurrency := DatosPago.ImpRetGan;
    qSaveComp.ParamByName('PRCRETG').AsFloat := DatosPago.PrcRetGan;
    qSaveComp.ParamByName('NROCERTGAN').AsString := '0000-0000-000000';
    qSaveComp.ParamByName('RetencionB').AsCurrency := DatosPago.ImpRetIB1;
    qSaveComp.ParamByName('PRCRETB1').AsFloat := DatosPago.PrcRetIB1;
    qSaveComp.ParamByName('RetencionH').AsCurrency := DatosPago.ImpRetIB2;
    qSaveComp.ParamByName('PRCRETB2').AsFloat := DatosPago.PrcRetIB2;
    qSaveComp.ParamByName('RETENCIONS').AsCurrency := DatosPago.ImpRetSS;
    qSaveComp.ParamByName('PRCRETS').AsFloat := DatosPago.PrcRetSS;
    qSaveComp.ParamByName('TotalOP').AsCurrency := DatosPago.Total_Oper;
    qSaveComp.ParamByName('Contado').AsCurrency := DatosPago.PagosContado;
    qSaveComp.ParamByName('Tickets').AsCurrency := DatosPago.PagosBonosTk;
    qSaveComp.ParamByName('BancoProp').AsCurrency := DatosPago.PagosCheques.TotalValores;
    qSaveComp.ParamByName('BancoTer').AsCurrency := DatosPago.PagosValores.TotalValores;
    qSaveComp.ParamByName('BonifProv').AsCurrency := DatosPago.Bonificacion;
    qSaveComp.ParamByName('Retenciones').AsCurrency := DatosPago.PagosReten;
    qSaveComp.ParamByName('NROCERTIBT').AsString := '0000-0000-000000';
    qSaveComp.ParamByName('NROCERTSES').AsString := '0000-0000-000000';
    qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
    qSaveComp.ParamByName('IdEmpresa').AsInteger := DatosPago.IdEmpresa;
    qSaveComp.ExecSQL;
    DatosPago.NroOrdDePago := NroOP;
    CompOP.First;
    i := 1;
    while not CompOP.Eof do
    begin
      TC := 1;
      if CompOPTipoMov.AsInteger in [CreA, CreB, CreC, CreditoAjuste, Descuento_B, Descuento_D] then
        TC := -1;
      qSaveComp.Close;
      qSaveComp.Sql.Clear;
      qSaveComp.Database := dmGestion.dbGestion;
      qSaveComp.Transaction := trSaveComp;
      qSaveComp.SQL.Text := Save_IO;
      qSaveComp.ParamByName('IdOrdPago').AsInteger := iOP;
      qSaveComp.ParamByName('IdItemOP').AsInteger := i;
      qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
      qSaveComp.ParamByName('IdFactura').AsInteger := CompOPIdFactura.AsInteger;
      qSaveComp.ParamByName('IdSucursal').AsInteger := CompOPIdSucursal.AsInteger;
      qSaveComp.ParamByName('IdPuntoVenta').AsInteger := CompOPIdPuntoVenta.AsInteger;
      qSaveComp.ParamByName('TipoMov').AsInteger := CompOPTipoMov.AsInteger;
      qSaveComp.ParamByName('NroFactura').AsString := CompOPNroComp.AsString;
      qSaveComp.ParamByName('FechaOr').AsDateTime := CompOPFechaOr.AsDateTime;
      qSaveComp.ParamByName('FechaOp').AsDateTime := CompOPFechaPg.AsDateTime;
      qSaveComp.ParamByName('Comprobante').AsString := NroOP;
      qSaveComp.ParamByName('Importe').AsCurrency := TC*CompOPImporte.AsCurrency;
      qSaveComp.ParamByName('MontoOrg').AsCurrency := TC*CompOPMontoOrg.AsCurrency;
      qSaveComp.ParamByName('SaldoMov').AsCurrency := TC*CompOPSaldoMov.AsCurrency;
      qSaveComp.ExecSQL;
      Inc(i);
      CompOP.Next;
    end;

    i := 1;
    with DatosPago do
    begin
      IdOrdPago := iOP;
      if Contado in PagosRealizados then
      begin
        qSaveComp.Close;
        qSaveComp.Sql.Clear;
        qSaveComp.Database := dmGestion.dbGestion;
        qSaveComp.Transaction := trSaveComp;
        qSaveComp.SQL.Text := Save_IP;
        qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
        qSaveComp.ParamByName('IdItemPag').AsInteger := i;
        qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
        qSaveComp.ParamByName('Comprobante').AsString := '';
        qSaveComp.ParamByName('Fecha').AsDate := Date;
        qSaveComp.ParamByName('Importe').AsCurrency := PagosContado;
        qSaveComp.ParamByName('Detalle').AsString := '';
        qSaveComp.ParamByName('Descripcion').AsString := '';
        qSaveComp.ParamByName('IdMovimiento').AsInteger := 0;
        qSaveComp.ParamByName('Estado').AsInteger := 0;
        qSaveComp.ParamByName('TipoPago').AsInteger := 1;
        qSaveComp.ExecSQL;
        Inc(i);
      end;

      if Bonos in PagosRealizados then
      begin
        qSaveComp.Close;
        qSaveComp.Sql.Clear;
        qSaveComp.Database := dmGestion.dbGestion;
        qSaveComp.Transaction := trSaveComp;
        qSaveComp.SQL.Text := Save_IP;
        qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
        qSaveComp.ParamByName('IdItemPag').AsInteger := i;
        qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
        qSaveComp.ParamByName('Comprobante').AsString := '';
        qSaveComp.ParamByName('Fecha').AsDate := Date;
        qSaveComp.ParamByName('Importe').AsCurrency := PagosBonosTk;
        qSaveComp.ParamByName('Detalle').AsString := '';
        qSaveComp.ParamByName('Descripcion').AsString := '';
        qSaveComp.ParamByName('IdMovimiento').AsInteger := 0;
        qSaveComp.ParamByName('Estado').AsInteger := 0;
        qSaveComp.ParamByName('TipoPago').AsInteger := 2;
        qSaveComp.ExecSQL;
        Inc(i);
      end;

      if Cheque in PagosRealizados then
      begin
        if ChqModel.Active then
          ChqModel.EmptyDataSet
        else
          ChqModel.CreateDataSet;

        PagosCheques.Datos := AuxBcoPro;
        PagosCheques.Datos.First;
        j:= 0;
        while not PagosCheques.Datos.Eof do
        begin
          with DatosPago.PagosCheques do
          begin
            try
              // Grabar Cheque propio
              q := TMDOQuery.Create(nil);
              q.Database := dmGestion.dbGestion;
              q.Transaction := trSaveComp;
              q.SQL.Add('Select Max(IdMov) as Ultimo ');
              q.SQL.Add('From BancoProp ');
              q.Open;
              IdCheque := q.FieldByName('Ultimo').AsInteger + 1;
              q.Close;
            finally
              q.Free;
            end;
            Tiene_PreImp := False;
            qSaveComp.Close;
            qSaveComp.Sql.Clear;
            qSaveComp.Database := dmGestion.dbGestion;
            qSaveComp.Transaction := trSaveComp;
            qSaveComp.SQL.Add('Insert InTo ');
            qSaveComp.SQL.Add('BancoProp(IdMov, IdBanco, TipoMov, NroCheque, FechaEmision, ');
            qSaveComp.SQL.Add('       FechaVencimiento, IdOrdPago, IdEntidad, DetalleMov, ');
            qSaveComp.SQL.Add('       Monto, Usuario, IdFactura, IdSucursal, Estado, ');
            qSaveComp.SQL.Add('       IdNroConciliacion, IdEmpresa)');
            qSaveComp.SQL.Add('Values(:IdMov, :IdBanco, :TipoMov, :NroCheque, :FechaEmision, ');
            qSaveComp.SQL.Add('       :FechaVencimiento, :IdOrdPago, :IdEntidad, :DetalleMov, ');
            qSaveComp.SQL.Add('       :Monto, :Usuario, :IdFactura, :IdSucursal, :Estado, ');
            qSaveComp.SQL.Add('       :IdNroConciliacion, :IdEmpresa)');
            qSaveComp.ParamByName('IdMov').AsInteger := IdCheque;
            qSaveComp.ParamByName('IdBanco').AsInteger := Datos.FieldByName('IdBanco').AsInteger;
            qSaveComp.ParamByName('TipoMov').AsInteger := Datos.FieldByName('TipoMov').AsInteger;
            qSaveComp.ParamByName('NroCheque').AsInteger := Datos.FieldByName('NroCheque').AsInteger;
            qSaveComp.ParamByName('FechaEmision').AsDateTime := Datos.FieldByName('FechaEmision').AsDateTime;
            qSaveComp.ParamByName('FechaVencimiento').AsDateTime := Datos.FieldByName('FechaVencimiento').AsDateTime;
            qSaveComp.ParamByName('IdOrdPago').AsInteger := iOP;
            qSaveComp.ParamByName('IdEntidad').AsInteger := Datos.FieldByName('IdEntidad').AsInteger;
            qSaveComp.ParamByName('DetalleMov').AsString := Datos.FieldByName('Descripcion').AsString;
            qSaveComp.ParamByName('Monto').AsCurrency := Datos.FieldByName('Monto').AsCurrency;
            qSaveComp.ParamByName('Usuario').AsInteger := Usuario;
            qSaveComp.ParamByName('IdFactura').AsInteger := DatosPago.IdComprobante;
            qSaveComp.ParamByName('IdSucursal').AsInteger := DatosPago.IdSucursal;
            qSaveComp.ParamByName('Estado').AsInteger := 0;
            qSaveComp.ParamByName('IdNroConciliacion').AsInteger := 0;
            qSaveComp.ParamByName('IdEmpresa').AsInteger := DatosPago.IdEmpresa;
            qSaveComp.ExecSQL;

            qSaveComp.Close;
            qSaveComp.Sql.Clear; // Selecionar ultimo movimiento
            qSaveComp.Database := dmGestion.dbGestion;
            qSaveComp.Transaction := trSaveComp;
            qSaveComp.SQL.Add('Select P.IdMov, B.ModName ');
            qSaveComp.SQL.Add('From BancoProp P ');
            qSaveComp.SQL.Add('Join Bancos B ');
            qSaveComp.SQL.Add('  on B.IdBanco = P.IdBanco ');
            qSaveComp.SQL.Add('Where P.IdBanco = :IdB And  ');
            qSaveComp.SQL.Add('      P.IdOrdPago = :IdO And ');
            qSaveComp.SQL.Add('      P.NroCheque = :NCh ');
            qSaveComp.ParamByName('IdB').AsInteger := Datos.FieldByName('IdBanco').AsInteger;
            qSaveComp.ParamByName('IdO').AsInteger := iOP;
            qSaveComp.ParamByName('NCh').AsInteger := Datos.FieldByName('NroCheque').AsInteger;
            qSaveComp.Open;
            IdCheque := qSaveComp.FieldByName('IdMov').AsInteger;
            Tiene_PreImp := not (qSaveComp.FieldByName('ModName').IsNull);
            qSaveComp.Close;

            try
              Datos.Edit;
              Datos.FieldByName('IdMov').AsInteger := IdCheque;
              Datos.Post;
            except
              on E:Exception do
                raise EUsuario.Create('Error asignando idmovbco '+E.Message);
            end;

            qSaveComp.Sql.Clear; //Agregar Item de Pago
            qSaveComp.Database := dmGestion.dbGestion;
            qSaveComp.Transaction := trSaveComp;
            qSaveComp.SQL.Text := Save_IP;
            qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
            qSaveComp.ParamByName('IdItemPag').AsInteger := i;
            qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
            qSaveComp.ParamByName('Comprobante').AsString := Datos.FieldByName('NroCheque').AsString;
            qSaveComp.ParamByName('Fecha').AsDateTime := Datos.FieldByName('FechaVencimiento').AsDateTime;
            qSaveComp.ParamByName('Importe').AsCurrency := Datos.FieldByName('Monto').AsCurrency;
            qSaveComp.ParamByName('Detalle').AsString := Datos.FieldByName('DetalleBco').AsString;
            qSaveComp.ParamByName('Descripcion').AsString := Datos.FieldByName('Descripcion').AsString;
            qSaveComp.ParamByName('IdMovimiento').AsInteger := IdCheque;
            qSaveComp.ParamByName('Estado').AsInteger := 0;
            qSaveComp.ParamByName('TipoPago').AsInteger := 3;
            qSaveComp.ExecSQL;
            Inc(i);

            if Tiene_PreImp then
            begin
              Inc(j);
              N_A_L('', Datos.FieldByName('Monto').AsCurrency, 45, '*', Parte1, Parte2);
              ChqModel.Append;
              ChqModelIdCheque.AsInteger := j;
              ChqModelIdMov.AsInteger := IdCheque;
              ChqModelChNroChq.AsString := Datos.FieldByName('NroCheque').AsString;
              ChqModelChMonto.AsCurrency := Datos.FieldByName('Monto').AsCurrency;
              ChqModelChDiaEmi.AsInteger := DayOf(Datos.FieldByName('FechaEmision').AsDateTime);
              ChqModelChMesEmi.AsString :=  LongMonthNames[MonthOf(Datos.FieldByName('FechaEmision').AsDateTime)];
              ChqModelChAnoEmi.AsInteger := YearOf((Datos.FieldByName('FechaEmision').AsDateTime));
              ChqModelChDiaVto.AsInteger := DayOf(Datos.FieldByName('FechaVencimiento').AsDateTime);
              ChqModelChMesVto.AsString :=  LongMonthNames[MonthOf(Datos.FieldByName('FechaVencimiento').AsDateTime)];
              ChqModelChAnoVto.AsInteger := YearOf((Datos.FieldByName('FechaVencimiento').AsDateTime));
              ChqModelChTitular.AsString := DatosPago.NomEntidad;
              ChqModelChPesos1.AsString := Parte1;
              ChqModelChPesos2.AsString := Parte2;
              ChqModelChFirma.AsString := Vacio;
              ChqModelChCruzado.AsBoolean := False;
              ChqModel.Post;
            end;
          end;
          PagosCheques.Datos.Next;
        end;
      end;

      if Valores in PagosRealizados then
      begin
        DatosPago.PagosValores.Datos := SalChq3;
        PagosValores.Datos.First;
        SalChq3.First;
        while not SalChq3.Eof do
        begin
          if GetDatosCheques3(SalChq3IdMov.AsInteger, DatosChq3) then
          begin
            qSaveComp.Close;
            qSaveComp.Sql.Clear;
            qSaveComp.Database := dmGestion.dbGestion;
            qSaveComp.Transaction := trSaveComp;
            qSaveComp.SQL.Text := Save_IP;
            qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
            qSaveComp.ParamByName('IdItemPag').AsInteger := i;
            qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
            qSaveComp.ParamByName('Comprobante').AsString := Format('%d', [DatosChq3.NChq]);
            qSaveComp.ParamByName('Fecha').AsDateTime := DatosChq3.Venc;
            qSaveComp.ParamByName('Importe').AsCurrency := DatosChq3.Mont;
            qSaveComp.ParamByName('Detalle').AsString := DatosChq3.NBco;;
            qSaveComp.ParamByName('Descripcion').AsString := 'Cª '+DatosChq3.NCta;
            qSaveComp.ParamByName('IdMovimiento').AsInteger := SalChq3IdMov.AsInteger;
            qSaveComp.ParamByName('Estado').AsInteger := 0;
            qSaveComp.ParamByName('TipoPago').AsInteger := 4;
            qSaveComp.ExecSQL;
            Inc(i);
          end;
          SalChq3.Next;
        end;
        DoPagoComprasValores(DatosPago);
      end;

      if dmGestion.Empresas.Locate(dmGestion.EmpresasIDEMPRESA.FieldName,
                   DatosPago.IdEmpresa, []) then
      begin
       // Retenciones
        if ImpRetIva <> 0 then
        begin
          NroCR := Inc_NCert(dmGestion.EmpresasCERT_RETI.AsString);
          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Text := Save_IP;
          qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
          qSaveComp.ParamByName('IdItemPag').AsInteger := i;
          qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
          qSaveComp.ParamByName('Comprobante').AsString := NroCR;
          qSaveComp.ParamByName('Fecha').AsDateTime := Date;
          qSaveComp.ParamByName('Importe').AsCurrency := ImpRetIva;
          qSaveComp.ParamByName('Detalle').AsString := 'IVA';
          qSaveComp.ParamByName('Descripcion').AsString := '';
          qSaveComp.ParamByName('IdMovimiento').AsInteger := 0;
          qSaveComp.ParamByName('Estado').AsInteger := 0;
          qSaveComp.ParamByName('TipoPago').AsInteger := 5;
          qSaveComp.ExecSQL;
          Inc(i);

          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Add('UpDate ORDENES Set NROCERTIVA =:NroCert ');
          qSaveComp.SQL.Add('Where IdOrden =:Nro_Ord ');
          qSaveComp.ParamByName('Nro_Ord').AsInteger := iOP;
          qSaveComp.ParamByName('NroCert').AsString := NroCR;
          qSaveComp.ExecSQL;

          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Add('UpDate DatosSis Set CERT_RETI =:NroCert ');
          qSaveComp.ParamByName('NroCert').AsString := NroCR;
          qSaveComp.ExecSQL;
        end;

        if ImpRetGan <> 0 then
        begin
          NroCR := Inc_NCert(dmGestion.EmpresasCERT_RETG.AsString);
          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Text := Save_IP;
          qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
          qSaveComp.ParamByName('IdItemPag').AsInteger := i;
          qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
          qSaveComp.ParamByName('TipoPago').AsInteger := 5;
          qSaveComp.ParamByName('Comprobante').AsString := NroCR;
          qSaveComp.ParamByName('Importe').AsCurrency := ImpRetGan;
          qSaveComp.ParamByName('Detalle').AsString := 'Ganancias';
          qSaveComp.ParamByName('Fecha').AsDateTime := Date;
          qSaveComp.ParamByName('Descripcion').AsString := '';
          qSaveComp.ParamByName('IdMovimiento').AsInteger := 0;
          qSaveComp.ParamByName('Estado').AsInteger := 0;
          qSaveComp.ExecSQL;
          Inc(i);

          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Add('UpDate ORDENES Set NROCERTGAN =:NroCert ');
          qSaveComp.SQL.Add('Where IdOrden =:Nro_Ord ');
          qSaveComp.ParamByName('Nro_Ord').AsInteger := iOP;
          qSaveComp.ParamByName('NroCert').AsString := NroCR;
          qSaveComp.ExecSQL;

          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Add('UpDate DatosSis Set CERT_RETG =:NroCert ');
          qSaveComp.ParamByName('NroCert').AsString := NroCR;
          qSaveComp.ExecSQL;
        end;

        if ImpRetIB1 <> 0 then
        begin
          NroCR := Inc_NCert(dmGestion.EmpresasCERT_RETB.AsString);
          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Text := Save_IP;
          qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
          qSaveComp.ParamByName('IdItemPag').AsInteger := i;
          qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
          qSaveComp.ParamByName('TipoPago').AsInteger := 5;
          qSaveComp.ParamByName('Comprobante').AsString := NroCR;
          qSaveComp.ParamByName('Importe').AsCurrency := ImpRetIB1;
          qSaveComp.ParamByName('Detalle').AsString := 'Ing.Brutos';
          qSaveComp.ParamByName('Fecha').AsDateTime := Date;
          qSaveComp.ParamByName('Descripcion').AsString := '';
          qSaveComp.ParamByName('IdMovimiento').AsInteger := 0;
          qSaveComp.ParamByName('Estado').AsInteger := 0;
          qSaveComp.ExecSQL;
          Inc(i);

          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Add('UpDate ORDENES Set NROCERTIBT =:NroCert ');
          qSaveComp.SQL.Add('Where IdOrden =:Nro_Ord ');
          qSaveComp.ParamByName('Nro_Ord').AsInteger := iOP;
          qSaveComp.ParamByName('NroCert').AsString := NroCR;
          qSaveComp.ExecSQL;

          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Add('UpDate DatosSis Set CERT_RETB =:NroCert ');
          qSaveComp.ParamByName('NroCert').AsString := NroCR;
          qSaveComp.ExecSQL;

          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Text := Save_IP;
          qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
          qSaveComp.ParamByName('IdItemPag').AsInteger := i;
          qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
          qSaveComp.ParamByName('TipoPago').AsInteger := 5;
          qSaveComp.ParamByName('Comprobante').AsString := NroCR;
          qSaveComp.ParamByName('Importe').AsCurrency := ImpRetIB2;
          qSaveComp.ParamByName('Detalle').AsString := 'Lote Hogar';
          qSaveComp.ParamByName('Fecha').AsDateTime := Date;
          qSaveComp.ParamByName('Descripcion').AsString := '';
          qSaveComp.ParamByName('IdMovimiento').AsInteger := 0;
          qSaveComp.ParamByName('Estado').AsInteger := 0;
          qSaveComp.ExecSQL;
          Inc(i);
        end;

        if ImpRetSS <> 0 then
        begin
          NroCR := Inc_NCert(dmGestion.EmpresasCERT_RETS.AsString);
          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Text := Save_IP;
          qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
          qSaveComp.ParamByName('IdItemPag').AsInteger := i;
          qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
          qSaveComp.ParamByName('TipoPago').AsInteger := 5;
          qSaveComp.ParamByName('Comprobante').AsString := NroCR;
          qSaveComp.ParamByName('Importe').AsCurrency := ImpRetSS;
          qSaveComp.ParamByName('Detalle').AsString := 'Seg. Social';
          qSaveComp.ParamByName('Fecha').AsDateTime := Date;
          qSaveComp.ParamByName('Descripcion').AsString := '';
          qSaveComp.ParamByName('IdMovimiento').AsInteger := 0;
          qSaveComp.ParamByName('Estado').AsInteger := 0;
          qSaveComp.ExecSQL;
          Inc(i);

          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Add('UpDate ORDENES Set NROCERTSES =:NroCert ');
          qSaveComp.SQL.Add('Where IdOrden =:Nro_Ord ');
          qSaveComp.ParamByName('Nro_Ord').AsInteger := iOP;
          qSaveComp.ParamByName('NroCert').AsString := NroCR;
          qSaveComp.ExecSQL;

          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.Database := dmGestion.dbGestion;
          qSaveComp.Transaction := trSaveComp;
          qSaveComp.SQL.Add('UpDate DatosSis Set CERT_RETS =:NroCert ');
          qSaveComp.ParamByName('NroCert').AsString := NroCR;
          qSaveComp.ExecSQL;
        end;
      end;

      if (Bonif in PagosRealizados) And
         (PagosBonif.CantPagos = 0) then
      begin
        qSaveComp.Close;
        qSaveComp.Sql.Clear;
        qSaveComp.Database := dmGestion.dbGestion;
        qSaveComp.Transaction := trSaveComp;
        qSaveComp.SQL.Text := Save_IP;
        qSaveComp.ParamByName('IdOrden').AsInteger := iOP;
        qSaveComp.ParamByName('IdItemPag').AsInteger := i;
        qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
        qSaveComp.ParamByName('TipoPago').AsInteger := 6;
        qSaveComp.ParamByName('Comprobante').AsString := '';
        qSaveComp.ParamByName('Importe').AsCurrency := PagosBonif.TotalBonif;
        qSaveComp.ParamByName('Detalle').AsString := '';
        qSaveComp.ParamByName('Fecha').AsDateTime := Date;
        qSaveComp.ParamByName('Descripcion').AsString := '';
        qSaveComp.ParamByName('IdMovimiento').AsInteger := 0;
        qSaveComp.ParamByName('Estado').AsInteger := 0;
        qSaveComp.ExecSQL;
        Inc(i);
        DoPagoComprasBonificacion(DatosPago);
      end;
    end;
  finally
    Result := iOP;
  end;
end;

procedure TdmSaveFile.Grabar_PagosCuentaProv(DatosPago: TDatosPagos; VerOP: Boolean);
Const
  Save_CCP = 'INSERT INTO CCPROV '+
             '  (NROMOVIMIENTO, IDCOMPROBANTE, IDSUCURSAL, TCOMP, ENTIDAD, FECHA, '+
             '   FECHAORG, COMPROBANTE, DEBE, HABER, PAGOACTA, SALDOMOV, SALDO, '+
             '   ESTADO, STATE, IMPNETO, IMPNCOM, SALDONETO, IDORDPAGO, IDSUCORDP, '+
             '   FECHAPAGO, MONTORETI, MONTORETG, MONTORETB, MONTORETH, MONTORETS, '+
             '   IDEMPRESA, IDPUNTOVENTA) '+
             'VALUES '+
             '  (:NROMOVIMIENTO, :IDCOMPROBANTE, :IDSUCURSAL, :TCOMP, :ENTIDAD, :FECHA, '+
             '   :FECHAORG, :COMPROBANTE, :DEBE, :HABER, :PAGOACTA, :SALDOMOV, :SALDO, '+
             '   :ESTADO, :STATE, :IMPNETO, :IMPNCOM, :SALDONETO, :IDORDPAGO, :IDSUCORDP, '+
             '   :FECHAPAGO, :MONTORETI, :MONTORETG, :MONTORETB, :MONTORETH, :MONTORETS, '+
             '   :IDEMPRESA, :IDPUNTOVENTA) ';
var
  iOP, CCEst: Integer;
  Dif_Pag: Double;
  CCPACta, CCDebe, CCHaber,
  CCSaldo, CCSdoMv, CCSdoNt: Currency;
begin
  try
    if not trSaveComp.InTransaction then
      trSaveComp.StartTransaction;

    iOP := Llenar_OrdenDePagos(DatosPago);
    CompOP.First;
    while not CompOP.Eof do
    begin
      CCPACta := 0;
      CCDebe  := 0;
      CCHaber := 0;
      CCSaldo := 0;
      CCSdoMv := 0;
      CCSdoNt := 0;
      qSaveComp.Close;
      qSaveComp.SQL.Clear;
      qSaveComp.Database := dmGestion.dbGestion;
      qSaveComp.Transaction := trSaveComp;
      qSaveComp.SQL.Add('Select PagoACta, Debe, ');
      qSaveComp.SQL.Add('       Haber, Saldo, ImpNeto ');
      qSaveComp.SQL.Add('From CCProv ');
      qSaveComp.SQL.Add('Where NroMovimiento = :NMov ');
      qSaveComp.ParamByName('NMov').AsInteger := CompOPNroMovCC.AsInteger;
      qSaveComp.Open;
      if not qSaveComp.IsEmpty then
      begin
        CCPACta := qSaveComp.FieldByName('PagoACta').AsCurrency;
        CCDebe  := qSaveComp.FieldByName('Debe').AsCurrency;
        CCHaber := qSaveComp.FieldByName('Haber').AsCurrency;
        CCSaldo := qSaveComp.FieldByName('Saldo').AsCurrency;
        CCSdoNt := qSaveComp.FieldByName('ImpNeto').AsCurrency;
        CCPACta := CCPACta + CompOPImporte.AsCurrency;
        if CompOPTipoMov.AsInteger in [CreA, CreB, CreC, CreditoAjuste,
                                       SaldoAFavor, Descuento_B, Descuento_D,
                                       PresentacionTM, LiquidacionA, LiquidacionC] then
          CCSdoMv := CCHaber - CCPACta
        else
          CCSdoMv := CCDebe - CCPACta;

        if Round(CCSdoMv) = 0 then
        begin
          CCEst := ccPagada
        end
        else begin
          CCEst := ccPendiente;
          CCSdoNt := (CCSdoMv / 1.21);
        end;
        qSaveComp.Close;
        qSaveComp.Database := dmGestion.dbGestion;
        qSaveComp.Transaction := trSaveComp;
        qSaveComp.SQL.Clear;
        qSaveComp.SQL.Add('UpDate CCProv ');
        qSaveComp.SQL.Add('Set PagoACta =:PagoACta, ');
        qSaveComp.SQL.Add('    SaldoMov =:SaldoMov, ');
        qSaveComp.SQL.Add('    ImpNeto =:ImpNeto, ');
        qSaveComp.SQL.Add('    Estado =:Estado ');
        qSaveComp.SQL.Add('Where NroMovimiento = :NMov');
        qSaveComp.ParamByName('PagoACta').AsCurrency := CCPACta;
        qSaveComp.ParamByName('SaldoMov').AsCurrency := CCSdoMv;
        qSaveComp.ParamByName('ImpNeto').AsCurrency := CCSdoNt;
        qSaveComp.ParamByName('Estado').AsInteger := CCEst;
        qSaveComp.ParamByName('NMov').AsInteger := CompOPNroMovCC.AsInteger;
        qSaveComp.ExecSQL;
      end;
      CompOP.Next;
    end;

    qSaveComp.Close;
    qSaveComp.Sql.Clear;
    qSaveComp.Database := dmGestion.dbGestion;
    qSaveComp.Transaction := trSaveComp;
    qSaveComp.SQL.Text := Save_CCP;
    qSaveComp.ParamByName('NroMovimiento').AsInteger := Get_Ultimos(CCProveedor);
    qSaveComp.ParamByName('IdComprobante').AsInteger := iOP;
    qSaveComp.ParamByName('IdSucursal').AsInteger := IdBranch;
    qSaveComp.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
    qSaveComp.ParamByName('TComp').AsInteger := DatosPago.TipoComprobante;
    qSaveComp.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
    qSaveComp.ParamByName('Fecha').AsDate := DatosPago.FechaOp;
    qSaveComp.ParamByName('FechaOrg').AsDate := DatosPago.FechaOp;
    qSaveComp.ParamByName('Comprobante').AsString := DatosPago.NroOrdDePago;
    qSaveComp.ParamByName('Debe').AsCurrency := 0;
    qSaveComp.ParamByName('Haber').AsCurrency := DatosPago.Total_Oper;
    qSaveComp.ParamByName('PagoACta').AsCurrency := 0;
    qSaveComp.ParamByName('SaldoMov').AsCurrency := 0;
    qSaveComp.ParamByName('Saldo').AsCurrency := 0;
    qSaveComp.ParamByName('Estado').AsInteger := ccPendiente; // Impaga
    qSaveComp.ParamByName('State').AsInteger := 0;
    qSaveComp.ParamByName('IMPNETO').AsCurrency := DatosPago.ImpNeto;
    qSaveComp.ParamByName('IMPNCOM').AsCurrency := 0;
    qSaveComp.ParamByName('SALDONETO').AsCurrency := 0;
    qSaveComp.ParamByName('IDORDPAGO').AsInteger := 0;
    qSaveComp.ParamByName('IDSUCORDP').AsInteger := 0;
    qSaveComp.ParamByName('FECHAPAGO').Clear;
    qSaveComp.ParamByName('MONTORETI').AsCurrency := DatosPago.ImpRetIva;
    qSaveComp.ParamByName('MONTORETG').AsCurrency := DatosPago.ImpRetGan;
    qSaveComp.ParamByName('MONTORETB').AsCurrency := DatosPago.ImpRetIB1;
    qSaveComp.ParamByName('MONTORETH').AsCurrency := DatosPago.ImpRetIB2;
    qSaveComp.ParamByName('MONTORETS').AsCurrency := DatosPago.ImpRetSS;
    qSaveComp.ParamByName('IDEMPRESA').AsInteger  := DatosPago.IdEmpresa;
    qSaveComp.ExecSQL;

    qOrdenes.Close;
    qSaveComp.Sql.Clear;
    qSaveComp.Database := dmGestion.dbGestion;
    qSaveComp.Transaction := trSaveComp;
    qOrdenes.SelectSQL.Text := Ordenes + ' Where O.IDORDEN = :IdOrden ';
    qOrdenes.ParamByName('IdOrden').AsInteger := iOP;
    qOrdenes.Open;

    qSaveComp.Close;
    qSaveComp.Sql.Clear;
    qSaveComp.Database := dmGestion.dbGestion;
    qSaveComp.Transaction := trSaveComp;
    qSaveComp.SQL.Add('UpDate DatosSis ');
    qSaveComp.SQL.Add('   Set NOrdPago = :NOP ');
    qSaveComp.SQL.Add('Where IdEmpresa = :IEP ');
    qSaveComp.ParamByName('NOP').AsString := DatosPago.NroOrdDePago;
    qSaveComp.ParamByName('IEP').AsInteger:= DatosPago.IdEmpresa;
    qSaveComp.ExecSQL;
    trSaveComp.Commit;
  except
    on E:Exception do
    begin
      trSaveComp.Rollback;
      raise EUsuario.Create(E.Message);
    end;
  end;

  if Application.MessageBox('¿Imprime comprobante de Pago?', 'Proveedores',
                             MB_ICONQUESTION+MB_YESNO) = ID_YES then
    TfrmOrdPagos.Imprimir_OrdenPagos(iOP, VerOP);
end;

procedure TdmSaveFile.Grabar_MovsCuentaProv(DatosPago: TDatosPagos);
Const
  Save_CCP = 'INSERT INTO CCPROV '+
             '  (NROMOVIMIENTO, IDCOMPROBANTE, IDSUCURSAL, TCOMP, ENTIDAD, FECHA, '+
             '   FECHAORG, COMPROBANTE, DEBE, HABER, PAGOACTA, SALDOMOV, SALDO, '+
             '   ESTADO, STATE, IMPNETO, IMPNCOM, SALDONETO, IDORDPAGO, IDSUCORDP, '+
             '   FECHAPAGO, MONTORETI, MONTORETG, MONTORETB, MONTORETH, MONTORETS, '+
             '   IDEMPRESA, IDPUNTOVENTA) '+
             'VALUES '+
             '  (:NROMOVIMIENTO, :IDCOMPROBANTE, :IDSUCURSAL, :TCOMP, :ENTIDAD, :FECHA, '+
             '   :FECHAORG, :COMPROBANTE, :DEBE, :HABER, :PAGOACTA, :SALDOMOV, :SALDO, '+
             '   :ESTADO, :STATE, :IMPNETO, :IMPNCOM, :SALDONETO, :IDORDPAGO, :IDSUCORDP, '+
             '   :FECHAPAGO, :MONTORETI, :MONTORETG, :MONTORETB, :MONTORETH, :MONTORETS, '+
             '   :IDEMPRESA, :IDPUNTOVENTA) ';
var
  i: Integer;
  q: TMDOQuery;
begin
  try
    if not trSaveComp.InTransaction then
      trSaveComp.StartTransaction;
    Case DatosPago.TipoComprobante of
      Descuento_B: begin
        i:= Get_Ultimos(CCProveedor);
        try
          q := TMDOQuery.Create(nil);
          q.Database := dmGestion.dbGestion;
          q.Transaction := trSaveComp;
          q.SQL.Text := Save_CCP;
          q.ParamByName('NroMovimiento').AsInteger := i;
          q.ParamByName('IdComprobante').AsInteger := 0;
          q.ParamByName('IdSucursal').AsInteger := IdBranch;
          q.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
          q.ParamByName('TComp').AsInteger := Descuento_B;
          q.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
          q.ParamByName('Fecha').AsDate := DatosPago.FechaOr;
          q.ParamByName('FechaOrg').AsDate := DatosPago.FechaOr;
          q.ParamByName('Comprobante').AsString := Format('%.4d-%.8d',[DatosPago.IdEntidad, i]);
          q.ParamByName('Debe').AsCurrency := 0;
          q.ParamByName('Haber').AsCurrency := DatosPago.TotalPagos;
          q.ParamByName('PagoACta').AsCurrency := 0;
          q.ParamByName('SaldoMov').AsCurrency := DatosPago.TotalPagos;
          q.ParamByName('Saldo').AsCurrency := 0;
          q.ParamByName('Estado').AsInteger := ccPendiente; // Impaga
          q.ParamByName('State').AsInteger := 0;
          q.ParamByName('IMPNETO').AsCurrency := 0;
          q.ParamByName('IMPNCOM').AsCurrency := 0;
          q.ParamByName('SALDONETO').AsCurrency := 0;
          q.ParamByName('IDORDPAGO').AsInteger := 0;
          q.ParamByName('IDSUCORDP').AsInteger := 0;
          q.ParamByName('FECHAPAGO').Clear;
          q.ParamByName('MONTORETI').AsCurrency := 0;
          q.ParamByName('MONTORETG').AsCurrency := 0;
          q.ParamByName('MONTORETB').AsCurrency := 0;
          q.ParamByName('IDEMPRESA').AsInteger := DatosPago.IdEmpresa;
          q.ExecSQL;
        finally
          q.Free
        end;
      end;

      SaldoInicial: begin
        i:= dmSaveFile.Get_Ultimos(CCProveedor);
        try
          q := TMDOQuery.Create(nil);
          q.Database := dmGestion.dbGestion;
          q.Transaction := dmGestion.trProc;
          q.SQL.Text := Save_CCP;
          q.ParamByName('NroMovimiento').AsInteger := i;
          q.ParamByName('IdComprobante').AsInteger := 0;
          q.ParamByName('IdSucursal').AsInteger := IdBranch;
          q.ParamByName('IdPuntoVenta').AsInteger := DatosPago.IdPuntoVenta;
          q.ParamByName('TComp').AsInteger := Descuento_B;
          q.ParamByName('Entidad').AsInteger := DatosPago.IdEntidad;
          q.ParamByName('Fecha').AsDate := DatosPago.FechaOr;
          q.ParamByName('FechaOrg').AsDate := DatosPago.FechaOr;
          q.ParamByName('Comprobante').AsString := Format('%.4d-%.8d', [DatosPago.IdEntidad, i]);
          if DatosPago.TotalPagos > 0 then
          begin
            q.ParamByName('Debe').AsCurrency := DatosPago.TotalPagos;
            q.ParamByName('Haber').AsCurrency := 0;
          end
          else begin
            q.ParamByName('Debe').AsCurrency := 0;
            q.ParamByName('Haber').AsCurrency := Abs(DatosPago.TotalPagos);
          end;
          q.ParamByName('PagoACta').AsCurrency := 0;
          q.ParamByName('SaldoMov').AsCurrency := Abs(DatosPago.TotalPagos);
          q.ParamByName('Saldo').AsCurrency := 0;
          q.ParamByName('Estado').AsInteger := ccPendiente; // Impaga
          q.ParamByName('State').AsInteger := 0;
          q.ParamByName('IMPNETO').AsCurrency := 0;
          q.ParamByName('IMPNCOM').AsCurrency := 0;
          q.ParamByName('SALDONETO').AsCurrency := 0;
          q.ParamByName('SALDOIMPINT').AsCurrency := 0;
          q.ParamByName('IDORDPAGO').AsInteger := 0;
          q.ParamByName('IDSUCORDP').AsInteger := 0;
          q.ParamByName('FECHAPAGO').Clear;
          q.ParamByName('MONTORETI').AsCurrency := 0;
          q.ParamByName('MONTORETG').AsCurrency := 0;
          q.ParamByName('MONTORETB').AsCurrency := 0;
          q.ParamByName('IDEMPRESA').AsInteger := DatosPago.IdEmpresa;
          q.ExecSQL;
        finally
          q.Free
        end;
      end;
    end;
    trSaveComp.Commit;
  except
    trSaveComp.Rollback;
  end;
end;

//******************************************************************************
//           Fin Cuenta Corriente Proveedores
//******************************************************************************

procedure TdmSaveFile.qOrdenesAfterPost(DataSet: TDataSet);
var
  q: TMDOQuery;
begin
  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := trSaveComp;
    q.SQL.Add('UpDate CCProv Set ');
    q.SQL.Add('   Comprobante = :Comprobante, ');
    q.SQL.Add('   Fecha = :Fecha, ');
    q.SQL.Add('   Entidad = :Entidad, ');
    q.SQL.Add('   Haber = :Haber, ');
    q.SQL.Add('   SaldoMov = :SaldoMov, ');
    q.SQL.Add('   IdEmpresa = :IdEmpresa, ');
    q.SQL.Add('   Debe = 0, ');
    q.SQL.Add('   PagoACta = 0 ');
    q.SQL.Add('Where IdComprobante = :IdComprobante And ');
    q.SQL.Add('      Entidad = :IdEntidad ');
    q.ParamByName('Comprobante').AsString := qOrdenesNroCompOP.AsString;
    q.ParamByName('Fecha').AsDate := qOrdenesFechaOP.AsDateTime;
    q.ParamByName('Entidad').AsInteger := qOrdenesEntidad.AsInteger;
    q.ParamByName('Haber').AsCurrency := qOrdenesTotalOP.AsCurrency;
    q.ParamByName('SaldoMov').AsCurrency := qOrdenesTotalOP.AsCurrency;
    q.ParamByName('IdEmpresa').AsInteger := qOrdenesIDEMPRESA.AsInteger;
    q.ParamByName('IdComprobante').AsInteger := qOrdenesIdOrden.AsInteger;
    q.ParamByName('IdEntidad').AsInteger := qOrdenesEntidad.AsInteger;
    try
      q.ExecSQL;
    except
      on E:Exception do
      begin
        raise EUsuario.Create(E.Message);
      end;
    end;
  finally
    q.Free;
  end;
end;

procedure TdmSaveFile.qOrdenesBeforeEdit(DataSet: TDataSet);
begin
  OldEstadoOP := qOrdenesEstado.AsInteger;
end;

procedure TdmSaveFile.qOrdenesCalcFields(DataSet: TDataSet);
begin
  if GetDatosEnt(qOrdenesENTIDAD.AsInteger, IdBranch, 2, Datos_Ent) then
  begin
    qOrdenesNOMENTIDAD.AsString := Datos_Ent.Nombre;
    qOrdenesAutorizado.AsString := Datos_Ent.Autorizado;
  end;

  if GetDatosEmp(qOrdenesUSUARIO.AsInteger, Vacio, 3, Datos_Ent) then
    qOrdenesNOMUSR.AsString := Datos_Ent.Nombre;

  if dmGestion.Empresas.Locate(dmGestion.EmpresasIDEMPRESA.FieldName,
                               qOrdenesIDEMPRESA.AsInteger, []) then
     qOrdenesDetEmp.AsString := dmGestion.EmpresasDETEMP.AsString
  else
     qOrdenesDetEmp.AsString := 'ERR';
end;

procedure TdmSaveFile.qOrdenesAfterOpen(DataSet: TDataSet);
begin
  qItemsOP.Open;
  qItemsPG.Open;
end;

//******************************************************************************
//                                 APERTURA DE CREDITOS
//******************************************************************************

function TdmSaveFile.GrabarSolicitudCredito(var Factura: TFactura; ItemsFactura: TBody_Fiscal): Boolean;
Const
  SaveCre = 'Insert InTo '+
             'Creditos(IdSucursal, IdCliente, IdVendedor, CantArtic, FechaOP, CantCuotas, Venc1Cta, '+
             '       ValorCta, InfCodesa, Estado, IdFactura, IdPuntoVenta, IdGarante1, IdGarante2) '+
             'Values(:IdSucursal, :IdCliente, :IdVendedor, :CantArtic, :FechaOP, :CantCuotas, :Venc1Cta, '+
             '       :ValorCta, :InfCodesa, :Estado, :IdFactura, :IdPuntoVenta, :IdGarante1, :IdGarante2)';

  SaveICR = 'Insert InTo '+
            'ItemsCR(IdCredito, IdSucursal, IdItem, IdArticulo, Cantidad, Precio) '+
            'Values(:IdCredito, :IdSucursal, :IdItem, :IdArticulo, :Cantidad, :Precio) ';
var
  NumItems: Smallint;
begin
  Result := False;
  if Factura.IdSucursal = IdBranch then
  begin
    qSaveComp.Close;
    qSaveComp.Sql.Clear;
    qSaveComp.SQL.Text := SaveCre;
    qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
    qSaveComp.ParamByName('IdCliente').AsInteger := Factura.Entidad;
    qSaveComp.ParamByName('IdVendedor').AsInteger := Factura.Empleado;
    qSaveComp.ParamByName('CantArtic').AsInteger := Factura.CantArtic;
    qSaveComp.ParamByName('FechaOP').AsDate := Factura.FechaF;
    qSaveComp.ParamByName('CantCuotas').AsInteger := Factura.CantCuotas;
    qSaveComp.ParamByName('Venc1Cta').AsDate := Factura.FechaI;
    qSaveComp.ParamByName('ValorCta').AsCurrency := Factura.ValorCta;
    qSaveComp.ParamByName('InfCodesa').AsString := Factura.CompRef;
    qSaveComp.ParamByName('Estado').AsInteger := 1;
    qSaveComp.ParamByName('IdFactura').AsInteger := 0;
    qSaveComp.ParamByName('IdPuntoVenta').AsInteger := 0;
    qSaveComp.ParamByName('IdGarante1').AsInteger := Factura.Garante1;
    qSaveComp.ParamByName('IdGarante2').AsInteger := Factura.Garante2;
    try
      if not trSaveComp.InTransaction then
        trSaveComp.StartTransaction;
      try
        qSaveComp.ExecSQL; //Grabar
      except
        on E:Exception do
          raise EUsuario.Create('El Comprobante Nº '+Factura.NroFactura+' no se puede Grabar '+E.Message);
      end;

      try
        NumItems := 1;
        while NumItems <= Factura.CantArtic do
        begin
          qSaveComp.Close;
          qSaveComp.Sql.Clear;
          qSaveComp.SQL.Text := SaveICR;
          if ItemsFactura[NumItems].IdProducto > 0 then
          begin
            with ItemsFactura[NumItems] do
            begin
              qSaveComp.ParamByName('IdCredito').AsInteger := Factura.IdFactura;
              qSaveComp.ParamByName('IdSucursal').AsInteger := Factura.IdSucursal;
              qSaveComp.ParamByName('IdItem').AsInteger := NumItems;
              qSaveComp.ParamByName('IdArticulo').AsInteger := IdProducto;
              qSaveComp.ParamByName('Cantidad').AsInteger := Round(Cantidad);
              qSaveComp.ParamByName('Precio').AsCurrency := PrecioTotal;
            end;
            qSaveComp.ExecSQL;
            Inc(NumItems);
          end;
        end;
      except
        on E:Exception do
          raise EUsuario.Create('Los Items de la Solicitud de credito no se pueden Grabar. '+E.Message);
      end;

      trSaveComp.Commit;
      Result := True;
    except
      on E:Exception do
      begin
        trSaveComp.Rollback;
        raise EUsuario.Create('La solicitud de Crédito no se pudo Grabar.- '+E.Message);
      end;
    end;
  end;
end;

//******************************************************************************
//                                 FIN APERTURA DE CREDITOS
//******************************************************************************

end.
