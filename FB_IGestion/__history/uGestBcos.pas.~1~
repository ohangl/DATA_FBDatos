unit uGestBcos;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  Db, StdCtrls, Mask, DBCtrls, ExtCtrls, ComCtrls, wwSpeedButton, wwDBNavigator,
  wwclearpanel, wwDialog, Wwlocate, ToolWin, wwrcdvw, wwdblook, wwdbedit, Wwdotdot,
  Wwdbcomb, Buttons, Wwdbigrd, Grids, Wwdbgrid, Wwquery, Spin, mxExport, Provider,
  wwdbdatetimepicker, Variants, RzButton, RzPanel, RzTabs,  RzDTP, Menus, Wwdbspin,
  DBClient, ppDB, ppDBPipe, ppComm, ppRelatv, ppProd, ppClass, ppReport, ppPrnabl,
  ppCtrls, ppBands, ppCache, ppVar, DateUtils, ppStrtch, ppSubRpt, Registry,
  MDOCustomDataSet, MDOQuery, RzDBNav, MDOTable, RzEdit, RzSpnEdt, ppEndUsr,
  Printers, RzBorder, RzLabel, RzRadGrp, RzCmboBx;

type
  TfrmGestBco = class(TForm)
    pcGestBco: TRzPageControl;
    tsBancos: TRzTabSheet;
    tsMovProp: TRzTabSheet;
    tsChqTer: TRzTabSheet;
    lblNomBco: TLabel;
    lblCtaBco: TLabel;
    lblDirBco: TLabel;
    lblTelBco: TLabel;
    lblWebBco: TLabel;
    lblNomGte: TLabel;
    lblTelGte: TLabel;
    lblOfiBco: TLabel;
    lblTelOfi: TLabel;
    edtNombre: TwwDBEdit;
    edtCuenta: TwwDBEdit;
    edtDireccion: TwwDBEdit;
    edtTelefono: TwwDBEdit;
    edtWebBanco: TwwDBEdit;
    edtGerente: TwwDBEdit;
    edtTelGerente: TwwDBEdit;
    edtOficialCta: TwwDBEdit;
    edtTelOfic: TwwDBEdit;
    pnlConsultaMovTer: TRzGroupBox;
    gMovTer: TwwDBGrid;

    dsMovTer: TDataSource;
    qMovTer: TMDOQuery;
    qMovTerIdMov: TIntegerField;
    qMovTerNombreBanco: TStringField;
    qMovTerNroCuenta: TStringField;
    qMovTerNroCheque: TIntegerField;
    qMovTerIdTitular: TIntegerField;
    qMovTerTitular: TStringField;
    qMovTerIdEndoso: TIntegerField;
    qMovTerEndoso: TStringField;
    qMovTerIdFactura: TIntegerField;
    qMovTerNroFactura: TStringField;
    qMovTerFechaVencimiento: TDateField;
    qMovTerFechaEntrega: TDateField;
    qMovTerIdEntrega: TIntegerField;
    qMovTerEntrega: TStringField;
    qMovTerSituacion: TSmallintField;

    tsConciliacion: TRzTabSheet;
    qConcilia: TMDOQuery;
    qConciliaTipoMov: TSmallintField;
    qConciliaFechaEmision: TDateField;
    qConciliaFechaVencimiento: TDateField;
    qConciliaDetalleMov: TStringField;
    qConciliaSelected: TSmallIntField;
    qConciliaIdBanco: TIntegerField;
    qConciliaIdMov: TIntegerField;
    qConciliaFechaResumen: TDateField;
    qConciliaIdEntidad: TIntegerField;
    dsConcilia: TDataSource;

    qLibroBancos: TMDOQuery;
    dsqLibroBancos: TDataSource;

    cdsLibBcoIDMOV: TIntegerField;
    cdsLibBcoFECHAEMISION: TDateField;
    cdsLibBcoNROCHEQUE: TIntegerField;
    cdsLibBcoFECHAVENCIMIENTO: TDateField;
    cdsLibBcoDETALLEMOV: TStringField;
    cdsLibBcoDEBE: TBCDField;
    cdsLibBcoHABER: TBCDField;
    cdsLibBcoFECHARESUMEN: TDateField;
    cdsLibBcoTIPOMOVBCO: TStringField;
    cdsLibBcoSALDO: TBCDField;
    cdsLibBcoSUMA_O_RESTA: TSmallintField;
    cdsLibBcoTIPOMOV: TSmallintField;

    dsMovProp: TDataSource;
    qMovProp: TMDOQuery;
    qMovPropIDMOV: TIntegerField;
    qMovPropFECHAEMISION: TDateField;
    qMovPropNROCHEQUE: TIntegerField;
    qMovPropFECHAVENCIMIENTO: TDateField;
    qMovPropDETALLEMOV: TMDOStringField;
    qMovPropDEBE: TMDOBCDField;
    qMovPropHABER: TMDOBCDField;
    qMovPropFECHARESUMEN: TDateField;
    qMovPropTIPOMOVBCO: TMDOStringField;
    qMovPropSALDO: TMDOBCDField;
    qMovPropSUMA_O_RESTA: TSmallintField;
    qMovPropTIPOMOV: TSmallintField;

    tsVencimientos: TRzTabSheet;
    qVencimientos: TMDOQuery;
    qVencimientosIdBanco: TIntegerField;
    qVencimientosIdMov: TIntegerField;
    qVencimientosIdEntidad: TIntegerField;
    qVencimientosTipoMov: TSmallintField;
    qVencimientosFechaEmision: TDateField;
    qVencimientosFechaVencimiento: TDateField;
    qVencimientosDetalleMov: TStringField;
    qVencimientosNomBanco: TStringField;
    qVencimientosNumCuenta: TStringField;
    dsqVencimientos: TDataSource;

    qEnCartera: TMDOQuery;
    qEnCarteraIdMov: TIntegerField;
    qEnCarteraNombreBanco: TStringField;
    qEnCarteraNroCuenta: TStringField;
    qEnCarteraNroCheque: TIntegerField;
    qEnCarteraIdTitular: TIntegerField;
    qEnCarteraTitular: TStringField;
    qEnCarteraIdEndoso: TIntegerField;
    qEnCarteraEndoso: TStringField;
    qEnCarteraIdFactura: TIntegerField;
    qEnCarteraNroFactura: TStringField;
    qEnCarteraFechaVencimiento: TDateField;
    qEnCarteraFechaEntrega: TDateField;
    qEnCarteraIdEntrega: TIntegerField;
    qEnCarteraEntrega: TStringField;
    qEnCarteraSituacion: TSmallintField;
    dsqEnCartera: TDataSource;

    qTotalPorBancoPorMes: TMDOQuery;
    qTotalPorBancoPorMesIdBanco: TIntegerField;
    dsqTotalPorBancoPorMes: TDataSource;
    qTotalPorBancoPorMesBanco: TStringField;
    qTotalPorBancoPorMesNroCta: TStringField;
    qTotalPorBancoPorMesTOTALBANCO: TMDOBCDField;

    pnlMovProp: TRzGroupBox;
    lblNurMov: TLabel;
    lblMovPropEmision: TLabel;
    lblMovPropVto: TLabel;
    lblMovPropFRes: TLabel;
    lblMovPropDetalle: TLabel;
    lblMovPropImporte: TLabel;
    lblNombreBanco: TLabel;
    lblNroChq: TDBText;
    lblMovPropTit: TLabel;
    lblOper: TLabel;
    lblMovPropNroComp: TLabel;
    edtDetalle: TwwDBEdit;
    edtImporte: TwwDBEdit;
    edtTitular: TwwDBEdit;
    cbTipoMov: TwwDBLookupCombo;
    edtNroComp: TwwDBEdit;
    edtVencimiento: TwwDBDateTimePicker;
    edtEmision: TwwDBDateTimePicker;
    edtFecResumen: TwwDBDateTimePicker;
    cbBancoProp: TwwDBLookupCombo;
    pnlCodBco: TRzPanel;
    lblCodBco: TDBText;
    qConciliaDetTipoMov: TStringField;
    qVencimientosDetTipoMov: TStringField;
    gbTMovs: TRzGroupBox;
    gTMovs: TwwDBGrid;
    dsTipoMovBco: TDataSource;
    pcInfBcos: TRzPageControl;
    tsSaldoBcos: TRzTabSheet;
    tsVenChqPropios: TRzTabSheet;
    tsEnCartera: TRzTabSheet;
    gSaldosBancos: TwwDBGrid;
    gVencimientos: TwwDBGrid;
    gEnCartera: TwwDBGrid;
    pnlBtnBco: TRzPanel;
    btnSalir: TRzBitBtn;
    qEnCarteraIdSucursal: TIntegerField;
    qEnCarteraIdOrdPago: TIntegerField;

    pmExpMovs: TPopupMenu;
    SaldosBcos: TMenuItem;
    MovimientosPropios: TMenuItem;
    ChequesEnCartera: TMenuItem;
    qMovTerIdSucursal: TIntegerField;
    qMovTerIdOrdPago: TIntegerField;
    qConcR: TMDOQuery;
    dsqConcR: TDataSource;
    tsLibro: TRzTabSheet;
    pnlLibro: TRzPanel;
    lblMes: TLabel;
    lblAnio: TLabel;
    lblCualBco: TLabel;
    btnImpLibro: TRzBitBtn;
    btnExpLibro: TRzBitBtn;
    cbMesLib: TRzComboBox;
    cbBcoLibro: TRzComboBox;
    gLibBco: TwwDBGrid;
    btnLibBco: TRzBitBtn;
    cdsLibBco: TClientDataSet;
    dspLibBco: TDataSetProvider;
    rptLibBco: TppReport;
    dbpLibBco: TppDBPipeline;
    hbBanco: TppHeaderBand;
    dbLineaBco: TppDetailBand;
    fbBanco: TppFooterBand;
    lblTitulo: TppLabel;
    lblPeriodo: TppLabel;
    lblPagina: TppSystemVariable;
    lblEmision: TppDBText;
    lblNroComp: TppDBText;
    lblDetalle: TppDBText;
    lblTMov: TppDBText;
    lblDebe: TppDBText;
    lblHaber: TppDBText;
    lblSaldoA: TppDBText;
    lblFVenc: TppDBText;
    lblFConc: TppDBText;
    ppLine1: TppLine;
    ppLine2: TppLine;
    ppLine3: TppLine;
    ppLine4: TppLine;
    shpTitBco: TppShape;
    shpPieBco: TppShape;
    lblFEmision: TppLabel;
    lblTyNro: TppLabel;
    lblDetMov: TppLabel;
    lblVenMov: TppLabel;
    lblDebeLB: TppLabel;
    lblHaberLB: TppLabel;
    lblSaldoB: TppLabel;
    ppLabel6: TppLabel;
    ppLine5: TppLine;
    cbSetTipoMov: TwwDBComboBox;
    pnlVenc: TRzPanel;
    lblVtoDesde: TLabel;
    edtVtoDesde: TRzDateTimeEdit;
    edtVtoHasta: TRzDateTimeEdit;
    btnCalcularVtos: TRzBitBtn;
    btnExportarVenc: TRzMenuButton;
    pmImpMovs: TPopupMenu;
    ImpSaldos: TMenuItem;
    ImpVencProp: TMenuItem;
    ImpSaldoChq3: TMenuItem;
    btnImprimirVenc: TRzMenuButton;

    dsqTipoMovBco: TDataSource;
    qTipoMovBco: TMDOQuery;
    qTipoMovBcoIDMOVBCO: TIntegerField;
    qTipoMovBcoTipoMovBco: TStringField;
    qTipoMovBcoSUMA_RESTA: TSmallintField;
    qTipoMovBcoCONTRAMOV: TIntegerField;

    cbContraMov: TwwDBLookupCombo;
    rpConciliacion: TppReport;
    dbpIncluidos: TppDBPipeline;
    dbpNoIncluidos: TppDBPipeline;

    qIncluidos: TMDOQuery;
    qIncluidosTipoMov: TSmallintField;
    qIncluidosDetTipoMov: TStringField;
    qIncluidosFechaEmision: TDateField;
    qIncluidosFechaVencimiento: TDateField;
    qIncluidosDetalleMov: TStringField;

    qNoIncluidos: TMDOQuery;
    qNoIncluidosTipoMov: TSmallintField;
    qNoIncluidosFechaEmision: TDateField;
    qNoIncluidosFechaVencimiento: TDateField;
    qNoIncluidosDetalleMov: TStringField;
    qNoIncluidosDetTipoMov: TStringField;
    hbConciliacion: TppHeaderBand;
    dbConciliacion: TppDetailBand;
    srIncluidos: TppSubReport;
    chrIncluidos: TppChildReport;
    dsqIncluidos: TDataSource;
    dsqNoIncluidos: TDataSource;
    ppDetailBand2: TppDetailBand;
    lblTitMovInc: TppLabel;
    lblDetTMI: TppDBText;
    lblFEmisionI: TppDBText;
    lblNroChqI: TppDBText;
    lblDetMovI: TppDBText;
    lblMontoI: TppDBText;
    lblFecVenI: TppDBText;
    ppGroup1: TppGroup;
    ppGroupHeaderBand1: TppGroupHeaderBand;
    ppGroupFooterBand1: TppGroupFooterBand;
    lblTotMovInc: TppDBCalc;
    lblCantMovInc: TppDBCalc;
    shMovInc: TppShape;
    lblTMovInc: TppLabel;
    lblFEmisInc: TppLabel;
    lblNroMovInc: TppLabel;
    lblDetMovInc: TppLabel;
    lblMtoInc: TppLabel;
    lblFecVenInc: TppLabel;
    shTitInc: TppShape;
    srNoIncluidos: TppSubReport;
    chrNoIncluidos: TppChildReport;
    ppDetailBand3: TppDetailBand;
    lblDMovNI: TppDBText;
    lblFEmisNoInc: TppDBText;
    lblNMovNoInc: TppDBText;
    lblDMovNoInc: TppDBText;
    lblMontoNoInc: TppDBText;
    lblFVencNoInc: TppDBText;
    ppGroup2: TppGroup;
    ppGroupHeaderBand2: TppGroupHeaderBand;
    shTitNoInc: TppShape;
    lblTMovNoInc: TppLabel;
    lblEmisionNoInc: TppLabel;
    lblNroMovNoInc: TppLabel;
    lblDetMovNoInc: TppLabel;
    lblMtoNoInc: TppLabel;
    lblVencNoInc: TppLabel;
    ppGroupFooterBand2: TppGroupFooterBand;
    shTotNoInc: TppShape;
    lblTotNoInc: TppDBCalc;
    lblCantMovNoInc: TppDBCalc;
    lblTituloConc: TppLabel;
    lblSaldoBco: TppLabel;
    lblDetalleMovInc: TppDBText;
    lblTiNoInc: TppLabel;
    lblDetalleMovNoInc: TppDBText;
    sbConciliacion: TppSummaryBand;
    shConciliacion: TppShape;
    lblSSgCon: TppLabel;
    lblSSgLib: TppLabel;
    lblDifer: TppLabel;
    shResultConc: TppShape;
    lblSdoCon: TppLabel;
    lblSdolLib: TppLabel;
    lblSdoDif: TppLabel;
    lblFecImp: TppSystemVariable;
    qTotNoInc: TMDOQuery;
    qTotNoIncTipoMov: TSmallintField;
    qTotNoIncDetTipoMov: TStringField;
    qTotNoIncSuma_Resta: TSmallIntField;
    ppDBText1: TppDBText;
    qNoIncluidosMONTO: TMDOBCDField;
    qIncluidosMONTO: TMDOBCDField;
    qMovTerMONTO: TMDOBCDField;
    qConciliaMONTO: TMDOBCDField;
    qVencimientosMONTO: TMDOBCDField;
    qEnCarteraMONTO: TMDOBCDField;
    qTotNoIncTOTMTO: TMDOBCDField;

    dsqBancoProp: TDataSource;
    qBancoProp: TMDODataSet;
    qBancoPropIDMOV: TIntegerField;
    qBancoPropIDBANCO: TIntegerField;
    qBancoPropIDORDPAGO: TIntegerField;
    qBancoPropTIPOMOV: TSmallintField;
    qBancoPropFECHAEMISION: TDateField;
    qBancoPropFECHAVENCIMIENTO: TDateField;
    qBancoPropFECHARESUMEN: TDateField;
    qBancoPropIDENTIDAD: TIntegerField;
    qBancoPropDETALLEMOV: TMDOStringField;
    qBancoPropMONTO: TMDOBCDField;
    qBancoPropDEBE: TMDOBCDField;
    qBancoPropHABER: TMDOBCDField;
    qBancoPropUSUARIO: TIntegerField;
    qBancoPropNOMBRE: TMDOStringField;
    qBancoPropNROCOMPOP: TMDOStringField;
    qBancoPropNOMUSR: TMDOStringField;
    qBancoPropESTADO: TSmallintField;
    qBancoPropIDFACTURA: TIntegerField;
    qBancoPropIDSUCURSAL: TIntegerField;
    qBancoPropIDNROCONCILIACION: TIntegerField;

    dsqBancoTer: TDataSource;
    qBancoTer: TMDODataSet;
    qBancoTerIDMOV: TIntegerField;
    qBancoTerIDORDPAGO: TIntegerField;
    qBancoTerNOMBREBANCO: TMDOStringField;
    qBancoTerNROCUENTA: TMDOStringField;
    qBancoTerNROCHEQUE: TIntegerField;
    qBancoTerIDTITULAR: TIntegerField;
    qBancoTerTITULAR: TMDOStringField;
    qBancoTerIDENDOSO: TIntegerField;
    qBancoTerENDOSO: TMDOStringField;
    qBancoTerIDFACTURA: TIntegerField;
    qBancoTerNROFACTURA: TMDOStringField;
    qBancoTerFECHAVENCIMIENTO: TDateField;
    qBancoTerFECHAENTREGA: TDateField;
    qBancoTerIDENTREGA: TIntegerField;
    qBancoTerENTREGA: TMDOStringField;
    qBancoTerMONTO: TMDOBCDField;
    qBancoTerSITUACION: TSmallintField;
    qBancoTerFECHAIS: TDateField;
    qBancoTerNROCOMPOP: TMDOStringField;

    pnlNavPro: TRzPanel;
    btnPriorPro: TRzBitBtn;
    btnInsertPro: TRzBitBtn;
    btnSavePro: TRzBitBtn;
    btnAnularPro: TRzBitBtn;
    btnCancelPro: TRzBitBtn;
    btnLastPro: TRzBitBtn;
    btnBuscarPro: TRzBitBtn;
    btnNextPro: TRzBitBtn;
    btnFirstPro: TRzBitBtn;
    dsBancos: TDataSource;
    tsTransBank: TRzTabSheet;

    qBancos: TMDOQuery;
    qBancosIDBANCO: TIntegerField;
    qBancosBANCO: TMDOStringField;
    qBancosNROCTA: TMDOStringField;
    dsqBancos: TDataSource;

    btnEliminarPro: TRzBitBtn;
    edtYearLibro: TRzSpinner;
    btnModPro: TRzBitBtn;
    btnImpPro: TRzBitBtn;
    qBancoPropNROCHEQUE: TIntegerField;
    rpMovPropEntreFechas: TppReport;
    dbpMovPropEntreFechas: TppDBPipeline;
    pnlConsultaMovProp: TRzGroupBox;
    hbMovProp: TppHeaderBand;
    dbMovProp: TppDetailBand;
    lblTituloBP1: TppLabel;
    lblTituloBP2: TppLabel;
    lblPaginaBP: TppSystemVariable;
    lblTipoBP: TppDBText;
    lblNroCBP: TppDBText;
    lblDetaBP: TppDBText;
    lblFEmiBP: TppDBText;
    lblFVtoBP: TppDBText;
    lblDebeBP: TppDBText;
    lblHaberBP: TppDBText;
    lblSaldoBP: TppDBText;
    lblFResBP: TppDBText;
    shMovProp1: TppShape;
    shMovProp2: TppShape;
    lblDTipoBP: TppLabel;
    lblDNroCBP: TppLabel;
    lblDMovBP: TppLabel;
    lblDEmiBP: TppLabel;
    lblDVtoBP: TppLabel;
    lblDDebeBP: TppLabel;
    lblDHaberBP: TppLabel;
    lblDFResBP: TppLabel;

    qConciliaNROCHEQUE: TIntegerField;
    qNoIncluidosNROCHEQUE: TIntegerField;
    qNoIncluidosFECHARESUMEN: TDateField;
    qVencimientosNROCHEQUE: TIntegerField;
    qIncluidosNROCHEQUE: TIntegerField;
    qIncluidosFECHARESUMEN: TDateField;
    gbTransRealizadas: TRzGroupBox;
    gTransRel: TwwDBGrid;
    dsTransBank: TDataSource;
    dsItemsTB: TDataSource;
    TBank: TClientDataSet;
    TBankIdCtaOrg: TIntegerField;
    TBankIdCtaDes: TIntegerField;
    TBankMontoT: TCurrencyField;
    TBankFechaT: TDateField;
    TBankCantMov: TSmallintField;
    TBankIdTransBank: TIntegerField;
    TBankDetCtaOrg: TStringField;
    TBankDetCtaDes: TStringField;
    ItemsT_B: TClientDataSet;
    ItemsT_BIdItem: TSmallintField;
    ItemsT_BFechaT: TDateField;
    ItemsT_BDetalle: TStringField;
    ItemsT_BMonto: TCurrencyField;
    ItemsT_BIdTransBank: TIntegerField;
    ItemsT_BCantIt: TAggregateField;
    dsqTransRel: TDataSource;
    rpTransBank: TppReport;
    ppHeaderBand2: TppHeaderBand;
    shpTitTranB: TppShape;
    lblDetCtaOrg: TppDBText;
    lblCtaOrg: TppLabel;
    lblCtaDest: TppLabel;
    lblDetCtaDes: TppDBText;
    lblTransN: TppLabel;
    lblNroTrans: TppDBText;
    lblFechaT: TppDBText;
    lblMontoT: TppDBText;
    lblTituloTB: TppLabel;
    lblFecTB: TppLabel;
    lblMontoTB: TppLabel;
    ppDetailBand4: TppDetailBand;
    srItemsTB: TppSubReport;
    ppChildReport1: TppChildReport;
    ppTitleBand1: TppTitleBand;
    lblDetTB: TppLabel;
    ppDetailBand5: TppDetailBand;
    lblFecha: TppDBText;
    lblIdItemTB: TppDBText;
    lblDetalleITB: TppDBText;
    lblMontoITB: TppDBText;
    ppSummaryBand2: TppSummaryBand;
    shpPieTB: TppShape;
    lblEmisionTB: TppSystemVariable;
    shpConforme: TppShape;
    lblConforme: TppLabel;
    dbpTransBank: TppDBPipeline;
    dbpTransBankppField1: TppField;
    dbpTransBankppField2: TppField;
    dbpTransBankppField3: TppField;
    dbpTransBankppField4: TppField;
    dbpTransBankppField5: TppField;
    dbpTransBankppField6: TppField;
    dbpItemsTB: TppDBPipeline;
    dbpItemsTBppField1: TppField;
    dbpItemsTBppField2: TppField;
    dbpItemsTBppField3: TppField;
    dbpItemsTBppField4: TppField;
    dbpItemsTBppField5: TppField;
    qTransRel: TMDOQuery;
    qTransRelIDTBANK: TIntegerField;
    qTransRelIDCTAORG: TIntegerField;
    qTransRelIDMOVORG: TIntegerField;
    qTransRelIDCTADES: TIntegerField;
    qTransRelIDMOVDES: TIntegerField;
    qTransRelMONTOT: TMDOBCDField;
    qTransRelFECHAT: TDateField;
    qTransRelUSUARIO: TIntegerField;
    qTransRelESTADO: TSmallintField;
    qTransRelCANTMOV: TSmallintField;
    qTransRelORIGEN: TMDOStringField;
    qTransRelDESTINO: TMDOStringField;
    qBancoTerIDMOVSUC: TIntegerField;
    qBancoTerIDSUCURSAL: TIntegerField;
    lblConciliado: TRzLabel;
    gMovProp: TwwDBGrid;
    gbMovTer: TRzGroupBox;
    bvlNroMov: TBevel;
    lblNroMov: TLabel;
    lblBancoTer: TLabel;
    lblNroCta: TLabel;
    lblNroValTer: TLabel;
    lblCodEnd: TLabel;
    lblTitular: TLabel;
    lblCodTit: TLabel;
    lblEndoso: TLabel;
    lblVto: TLabel;
    lblFecSal: TLabel;
    lblCodSal: TLabel;
    lblEntrega: TLabel;
    lblImporte: TLabel;
    lblNroChqTer: TDBText;
    lblNroFac: TLabel;
    lblSituacion: TLabel;
    lblSituacionChTer: TRzLabel;
    edtCtaChqTer: TwwDBEdit;
    edtNroCheque: TwwDBEdit;
    edtCodTitular: TwwDBEdit;
    edtTitularChqTer: TwwDBEdit;
    edtCodEndoso: TwwDBEdit;
    edtEndoso: TwwDBEdit;
    edtCodEntrega: TwwDBEdit;
    edtEntrega: TwwDBEdit;
    edtMtoChqTer: TwwDBEdit;
    edtNroFac: TwwDBEdit;
    edtFecVencimiento: TwwDBDateTimePicker;
    edtFecEntrega: TwwDBDateTimePicker;
    cbSituacion: TwwDBLookupCombo;
    edtNomBcoTer: TwwDBEdit;
    pnlNavTer: TRzPanel;
    btnPriorTer: TRzBitBtn;
    btnInsertTer: TRzBitBtn;
    btnSaveTer: TRzBitBtn;
    btnAnularTer: TRzBitBtn;
    btnCancelTer: TRzBitBtn;
    btnLastTer: TRzBitBtn;
    btnBuscarTer: TRzBitBtn;
    btnNextTer: TRzBitBtn;
    btnFirstTer: TRzBitBtn;
    btnEliminarTer: TRzBitBtn;
    btnEditTer: TRzBitBtn;
    gbChequesPreImpresos: TRzGroupBox;
    brBanco: TRzBorder;
    lblCantChq: TDBText;
    lblImpAsigForm: TLabel;
    edtVigHasta: TwwDBEdit;
    edtVigDesde: TwwDBEdit;
    btnModRepChk: TRzBitBtn;
    cbPrinters: TwwDBComboBox;
    lblVigDesde: TLabel;
    gbDatosTrans: TRzGroupBox;
    lblBcoOrg: TLabel;
    lblMtoTran: TLabel;
    lblCtaDes: TLabel;
    lblFecTran: TLabel;
    lblCantTB: TDBText;
    cbCtaOrg: TwwDBLookupCombo;
    cbCtaDes: TwwDBLookupCombo;
    edtMtoTran: TwwDBEdit;
    edtFecTran: TwwDBDateTimePicker;
    btnNewTran: TRzBitBtn;
    btnDelTran: TRzBitBtn;
    btnSaveTran: TRzBitBtn;
    btnImpTrans: TRzBitBtn;
    btnCancelTran: TRzBitBtn;
    pnlTopConsMovProp: TRzPanel;
    lblBcoCtaMP: TLabel;
    lblMDesde: TLabel;
    cbBcoMovP: TRzComboBox;
    edtDesdeMP: TRzDateTimeEdit;
    edtHastaMP: TRzDateTimeEdit;
    btnMovPro: TRzBitBtn;
    btnImpMovPro: TRzBitBtn;
    btnExpMovPro: TRzBitBtn;
    rgTipoVencMP: TRzRadioGroup;
    lblMHasta: TLabel;

    pnlTopMovTer: TRzPanel;
    lblBTDesde: TLabel;
    lblBTHasta: TLabel;
    lblBTSituacion: TLabel;
    btnExpTer: TRzBitBtn;
    edtDesdeTer: TRzDateTimeEdit;
    edtHastaTer: TRzDateTimeEdit;
    btnMovTer: TRzBitBtn;
    cbMovTer: TRzComboBox;
    lblCantConcBco: TDBText;
    brCantConcBco: TRzBorder;
    gbDepositoTer: TRzGroupBox;
    lblBancoCta: TLabel;
    lblFecDep: TLabel;
    lblCompDepTer: TLabel;
    edtFecDepTer: TwwDBDateTimePicker;
    btnGrabarDep: TRzBitBtn;
    btnCancelarDep: TRzBitBtn;
    edtCmpDepTer: TwwDBEdit;
    brDepTer: TRzBorder;
    cbBcoTDep: TRzComboBox;

    qConcRBANCO: TMDOStringField;
    qConcRNROCTA: TMDOStringField;
    qConcRIDCONCILIACION: TIntegerField;
    qConcRIDBANCO: TIntegerField;
    qConcRFECHA_CONC: TDateField;
    qConcRCANT_MOV: TIntegerField;
    qConcRSSBANCO: TMDOBCDField;
    qConcRDIF_CONC: TMDOBCDField;
    qConcROBSERVACION: TMDOStringField;
    pcAdmConciliaciones: TRzPageControl;
    tsConcRealizadas: TRzTabSheet;
    tsConciliar: TRzTabSheet;
    gbConc: TRzGroupBox;
    lblBcoCta: TLabel;
    lblFecRes: TLabel;
    lblSSBco: TLabel;
    btnImpConc: TRzBitBtn;
    btnConciliar: TRzBitBtn;
    edtFecConc: TRzDateTimeEdit;
    cbBcoConc: TRzComboBox;
    btnExpConc: TRzBitBtn;
    edtSalConc: TRzNumericEdit;
    gConciliacion: TwwDBGrid;
    gConcR: TwwDBGrid;
    lblDetEmpresa: TLabel;
    cbEmpresa: TwwDBLookupCombo;
    qBancoPropIDEMPRESA: TIntegerField;
    lblDetEmpBT: TLabel;
    cbDetEmpBT: TwwDBLookupCombo;
    qBancoTerIDEMPRESA: TIntegerField;
    qConciliaIDNROCONCILIACION: TIntegerField;
    pnlViewTBank: TRzPanel;
    btnExportarTB: TRzBitBtn;
    btnRefrescarTB: TRzBitBtn;
    lblBcoVtos: TLabel;
    cbBcoVenc: TRzComboBox;
    dbqVencimientos: TppDBPipeline;
    dbpTotByBcoByMes: TppDBPipeline;
    dbpqEnCartera: TppDBPipeline;
    rpVencimientos: TppReport;
    rpTotByBcoByMes: TppReport;
    rpEnCartera: TppReport;
    hbVencBco: TppHeaderBand;
    dbVencBco: TppDetailBand;
    fbVencBco: TppFooterBand;
    lblVBTitulo: TppLabel;
    lblVBEmision: TppSystemVariable;
    lblVBFecEm: TppDBText;
    lblVBDetMov: TppDBText;
    lblVBNroMov: TppDBText;
    lblVBDetaMov: TppDBText;
    lblVBFecVto: TppDBText;
    ppDBText11: TppDBText;
    ppGroup3: TppGroup;
    ppGroupHeaderBand3: TppGroupHeaderBand;
    ppGroupFooterBand3: TppGroupFooterBand;
    lblVBIdCta: TppDBText;
    lblVBNomBco: TppDBText;
    lblVBNroCta: TppDBText;
    lblVBTotBco: TppDBCalc;
    shpVB1: TppShape;
    lblVBNroPag: TppSystemVariable;
    ppDBCalc1: TppDBCalc;
    shpVB2: TppShape;
    hbVtoTer: TppHeaderBand;
    dbVtoTer: TppDetailBand;
    fbVtoTer: TppFooterBand;
    lblBTTitulo: TppLabel;
    lblBTEmision: TppSystemVariable;
    lblBTNroMov: TppDBText;
    lblBTBanco: TppDBText;
    lblBTNroChq: TppDBText;
    lblBTTitChq: TppDBText;
    lblBTEndoso: TppDBText;
    ppDBText10: TppDBText;
    ppSystemVariable1: TppSystemVariable;
    ppGroup4: TppGroup;
    ppGroupHeaderBand4: TppGroupHeaderBand;
    ppGroupFooterBand4: TppGroupFooterBand;
    lblBTVencimiento: TppDBText;
    shpBT1: TppShape;
    lblVTTotDia: TppDBCalc;
    lblVTTotPer: TppDBCalc;
    ppDBCalc2: TppDBCalc;
    ppHeaderBand3: TppHeaderBand;
    ppDetailBand6: TppDetailBand;
    lblSBTitulo: TppLabel;
    lblSBEmision: TppSystemVariable;
    lblSBIdCta: TppDBText;
    lblSBBanco: TppDBText;
    lblSBNroCta: TppDBText;
    ppDBText5: TppDBText;
    shpSdoBcos1: TppShape;
    ppDBCalc3: TppDBCalc;
    ppSummaryBand1: TppSummaryBand;
    shpSdoBcos2: TppShape;
    lblTotBcoProp: TppDBCalc;
    ppSummaryBand3: TppSummaryBand;
    shMovProp3: TppShape;
    rgOrdConc: TRzRadioGroup;
    btnSel_All_Conciliacion: TRzBitBtn;
    btnUnSell_All_Conciliacion: TRzBitBtn;
    gMovTran: TwwDBGrid;
    navBancos: TRzDBNavigator;
    qBancoTerIDPUNTOVENTA: TIntegerField;
    qEnCarteraIDPUNTOVENTA: TIntegerField;
    qMovTerIDPUNTOVENTA: TIntegerField;


    procedure cbPrintersChange(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
    procedure cbBancoPropEnter(Sender: TObject);
    procedure cbBancoPropExit(Sender: TObject);
    procedure cbTipoMovEnter(Sender: TObject);
    procedure cbTipoMovExit(Sender: TObject);
    procedure edtEmisionEnter(Sender: TObject);
    procedure edtEmisionExit(Sender: TObject);
    procedure edtNroCompEnter(Sender: TObject);
    procedure edtNroCompExit(Sender: TObject);
    procedure edtFecResumenEnter(Sender: TObject);
    procedure edtFecResumenExit(Sender: TObject);
    procedure edtTitularKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtCodEntregaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtCodTitularKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtCodEndosoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure gMovTerUpdateFooter(Sender: TObject);
    procedure qMovTerSituacionGetText(Sender: TField; var Text: String;DisplayText: Boolean);
    procedure btnSalirClick(Sender: TObject);
    procedure gConciliacionCalcCellColors(Sender: TObject; Field: TField; State: TGridDrawState; Highlight: Boolean; AFont: TFont; ABrush: TBrush);
    procedure qConciliaSelectedChange(Sender: TField);
    procedure gConciliacionMultiSelectRecord(Grid: TwwDBGrid; Selecting: Boolean; var Accept: Boolean);
    procedure btnImpConcClick(Sender: TObject);
    procedure btnImpLibroClick(Sender: TObject);
    procedure btnExpLibroClick(Sender: TObject);
    procedure btnMovProClick(Sender: TObject);
    procedure gMovPropCalcCellColors(Sender: TObject; Field: TField; State: TGridDrawState; Highlight: Boolean; AFont: TFont; ABrush: TBrush);
    procedure btnImpMovProClick(Sender: TObject);
    procedure btnCalcularVtosClick(Sender: TObject);
    procedure gSaldosBancosUpdateFooter(Sender: TObject);
    procedure gVencimientosUpdateFooter(Sender: TObject);
    procedure gEnCarteraUpdateFooter(Sender: TObject);
    procedure gConciliacionUpdateFooter(Sender: TObject);
    procedure gMovTerDblClick(Sender: TObject);
    procedure edtNombreKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btnExpTerClick(Sender: TObject);
    procedure edtSalConcExit(Sender: TObject);
    procedure btnExpMovProClick(Sender: TObject);
    procedure edtMontoAcuerdoCCKeyPress(Sender: TObject; var Key: Char);
    procedure edtImporteKeyPress(Sender: TObject; var Key: Char);
    procedure edtMtoChqTerKeyPress(Sender: TObject; var Key: Char);
    procedure cbSituacionChange(Sender: TObject);
    procedure btnGrabarDepClick(Sender: TObject);
    procedure btnCancelarDepClick(Sender: TObject);
    procedure cbBcoDepTKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtFecDepTerKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtCmpDepTerKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure pcGestBcoTabClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure gMovPropDblClick(Sender: TObject);
    procedure SaldosBcosClick(Sender: TObject);
    procedure MovimientosPropiosClick(Sender: TObject);
    procedure ChequesEnCarteraClick(Sender: TObject);
    procedure btnMovTerClick(Sender: TObject);
    procedure gMovTerTitleButtonClick(Sender: TObject; AFieldName: String);
    procedure gVencimientosTitleButtonClick(Sender: TObject; AFieldName: String);
    procedure gEnCarteraTitleButtonClick(Sender: TObject; AFieldName: String);
    procedure btnExpConcClick(Sender: TObject);
    procedure btnLibBcoClick(Sender: TObject);
    procedure cbBcoLibroChange(Sender: TObject);
    procedure ImpSaldosClick(Sender: TObject);
    procedure ImpVencPropClick(Sender: TObject);
    procedure ImpSaldoChq3Click(Sender: TObject);
    procedure qBancoPropIDENTIDADChange(Sender: TField);
    procedure qBancoPropNewRecord(DataSet: TDataSet);
    procedure qBancoPropBeforePost(DataSet: TDataSet);
    procedure dsqBancoPropDataChange(Sender: TObject; Field: TField);
    procedure qBancoTerNewRecord(DataSet: TDataSet);
    procedure qBancoTerIDENTREGAChange(Sender: TField);
    procedure qBancoTerIDENDOSOChange(Sender: TField);
    procedure qBancoTerIDTITULARChange(Sender: TField);
    procedure qBancoTerBeforeDelete(DataSet: TDataSet);
    procedure dsqBancoTerDataChange(Sender: TObject; Field: TField);
    procedure btnFirstProClick(Sender: TObject);
    procedure btnPriorProClick(Sender: TObject);
    procedure btnNextProClick(Sender: TObject);
    procedure btnLastProClick(Sender: TObject);
    procedure btnInsertProClick(Sender: TObject);
    procedure btnSaveProClick(Sender: TObject);
    procedure btnCancelProClick(Sender: TObject);
    procedure btnBuscarProClick(Sender: TObject);
    procedure btnAnularProClick(Sender: TObject);
    procedure btnFirstTerClick(Sender: TObject);
    procedure btnPriorTerClick(Sender: TObject);
    procedure btnNextTerClick(Sender: TObject);
    procedure btnLastTerClick(Sender: TObject);
    procedure btnInsertTerClick(Sender: TObject);
    procedure btnSaveTerClick(Sender: TObject);
    procedure btnCancelTerClick(Sender: TObject);
    procedure btnBuscarTerClick(Sender: TObject);
    procedure btnAnularTerClick(Sender: TObject);
    procedure btnEliminarProClick(Sender: TObject);
    procedure btnEliminarTerClick(Sender: TObject);
    procedure qBancoPropIDMOVGetText(Sender: TField; var Text: String; DisplayText: Boolean);
    procedure btnModProClick(Sender: TObject);
    procedure btnImpProClick(Sender: TObject);
    procedure btnEditTerClick(Sender: TObject);
    procedure btnModRepChkClick(Sender: TObject);
    procedure btnNewTranClick(Sender: TObject);
    procedure btnCancelTranClick(Sender: TObject);
    procedure btnSaveTranClick(Sender: TObject);
    procedure btnImpTransClick(Sender: TObject);
    procedure cbCtaOrgKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtMtoTranKeyPress(Sender: TObject; var Key: Char);
    procedure gMovTranEnter(Sender: TObject);
    procedure gMovTranKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure gMovTranKeyPress(Sender: TObject; var Key: Char);
    procedure TBankAfterPost(DataSet: TDataSet);
    procedure TBankNewRecord(DataSet: TDataSet);
    procedure ItemsT_BAfterPost(DataSet: TDataSet);
    procedure ItemsT_BNewRecord(DataSet: TDataSet);
    procedure gMovTranUpdateFooter(Sender: TObject);
    procedure gTransRelDblClick(Sender: TObject);
    procedure qBancoTerBeforePost(DataSet: TDataSet);
    procedure edtSalConcKeyPress(Sender: TObject; var Key: Char);
    procedure cdsLibBcoFechaResumenGetText(Sender: TField; var Text: string; DisplayText: Boolean);
    procedure btnDelTranClick(Sender: TObject);
    procedure gLibBcoDblClick(Sender: TObject);
    procedure gConciliacionDblClick(Sender: TObject);
    procedure pcGestBcoClose(Sender: TObject; var AllowClose: Boolean);
    procedure qMovPropFECHARESUMENGetText(Sender: TField; var Text: string; DisplayText: Boolean);
    procedure gConcRDblClick(Sender: TObject);
    procedure edtSalConcEnter(Sender: TObject);
    procedure edtFecConcEnter(Sender: TObject);
    procedure btnExportarTBClick(Sender: TObject);
    procedure btnRefrescarTBClick(Sender: TObject);
    procedure edtNomBcoTerKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure qBancoTerIDMOVGetText(Sender: TField; var Text: string; DisplayText: Boolean);
    procedure btnConciliarClick(Sender: TObject);
    procedure btnSel_All_ConciliacionClick(Sender: TObject);
    procedure btnUnSell_All_ConciliacionClick(Sender: TObject);
    procedure cbBancoPropKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure gLibBcoCalcCellColors(Sender: TObject; Field: TField;
      State: TGridDrawState; Highlight: Boolean; AFont: TFont; ABrush: TBrush);
    procedure gbDepositoTerEnter(Sender: TObject);
  private
    { Private declarations }
    TotalItems, IdBank, IdProv,
    ActPro, ActTer, TotEnRes, Ult_Con, Can_Mov, Cant_Propios: Integer;
    Sit_BT: SmallInt;
    Entidad_Libro: String;
    TotalPropios, TotalTerceros, TotalTransB,
    TotalEnCartera, TotalBancos, EnResumen, SdoSBco: Currency;
    Add_Trans, Load_Trans, AltaTer, AltaPro, Mod_Con: Boolean;
    Reg: TRegistry;

    function BancoPropLast: Integer;
    function BancoPropNext(Act: Integer): Integer;
    function BancoPropPrior(Act: Integer): Integer;
    function BancoPropFirst: Integer;

    function BancoTerLast: Integer;
    function BancoTerNext(Act: Integer): Integer;
    function BancoTerPrior(Act: Integer): Integer;
    function BancoTerFirst: Integer;

    procedure Libro_Bancos;
    procedure Movimientos_Propios;
    procedure Mov_En_Cartera(Orden: String);
    procedure Venc_Propios(Orden: String; IdBco: Integer);
    procedure Venc_Terceros(Orden: String);

    function Ultima_Conciliacion(IdB: Integer): Integer;
    procedure Incrementa_Conciliacion(IdB, UCB: Integer);
    procedure Conciliar(AOrden: String);

    procedure SaveTranB;
    procedure LoadTranB;
    procedure UpdateTotalsTransB;

    function GetPrinterName(NBank: String): String;
  public
    { Public declarations }
  end;

var
  frmGestBco: TfrmGestBco;

implementation

uses udmGestion, uProveedores, uBuscaMovBanco, uTools, uEntidades,
     udmSaveFile, uClaveMod, uModMovBco;

{$R *.DFM}

function TfrmGestBco.BancoPropLast: Integer;
var
  q: TMDOQuery;
begin
  Result := 1;
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoProp.Database;
    q.Transaction := qBancoProp.Transaction;
    q.SQL.Add('Select Max(IDMOV) as L ');
    q.SQL.Add('From BANCOPROP ');
    q.SQL.Add('Where (Estado <> 999) ');
    q.Open;
    Result := q.FieldByName('L').AsInteger;
  finally
    q.Free;
  end;
end;

function TfrmGestBco.BancoPropNext(Act: Integer): Integer;
var
  q: TMDOQuery;
begin
  Result := 1;
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoProp.Database;
    q.Transaction := qBancoProp.Transaction;
    q.SQL.Add('Select Min(IDMOV) as N ');
    q.SQL.Add('From BANCOPROP ');
    q.SQL.Add('Where (IdMov >:Act) and (Estado <> 999)');
    q.ParamByName('Act').AsInteger := Act;
    q.Open;
    if q.FieldByName('N').AsInteger = 0 then
      Result := Act
    else
      Result := q.FieldByName('N').AsInteger;
  finally
    q.Free;
  end;
end;

function TfrmGestBco.BancoPropPrior(Act: Integer): Integer;
var
  q: TMDOQuery;
begin
  Result := 1;
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoProp.Database;
    q.Transaction := qBancoProp.Transaction;
    q.SQL.Add('Select Max(IDMOV) as P ');
    q.SQL.Add('From BANCOPROP ');
    q.SQL.Add('Where (IdMov <:Act) and (Estado <> 999) ');
    q.ParamByName('Act').AsInteger := Act;
    q.Open;
    if q.FieldByName('P').AsInteger = 0 then
      Result := Act
    else
      Result := q.FieldByName('P').AsInteger;
  finally
    q.Free;
  end;
end;

function TfrmGestBco.BancoPropFirst: Integer;
var
  q: TMDOQuery;
begin
  Result := 1;
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoProp.Database;
    q.Transaction := qBancoProp.Transaction;
    q.SQL.Add('Select Min(IDMOV) as F ');
    q.SQL.Add('From BANCOPROP ');
    q.SQL.Add('Where (Estado <> 999) ');
    q.Open;
    Result := q.FieldByName('F').AsInteger;
  finally
    q.Free;
  end;
end;

function TfrmGestBco.BancoTerLast: Integer;
var
  q: TMDOQuery;
begin
  Result := 1;
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoTer.Database;
    q.Transaction := qBancoTer.Transaction;
    q.SQL.Add('Select Max(IDMOV) as L ');
    q.SQL.Add('From BANCOTER ');
    q.SQL.Add('Where (Situacion < 10) ');
    q.Open;
    Result := q.FieldByName('L').AsInteger;
  finally
    q.Free;
  end;
end;

function TfrmGestBco.BancoTerNext(Act: Integer): Integer;
var
  q: TMDOQuery;
begin
  Result := 1;
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoTer.Database;
    q.Transaction := qBancoTer.Transaction;
    q.SQL.Add('Select Min(IDMOV) as N ');
    q.SQL.Add('From BANCOTER ');
    q.SQL.Add('Where (IdMov >:Act) And (Situacion < 10) ');
    q.ParamByName('Act').AsInteger := Act;
    q.Open;
    if q.FieldByName('N').AsInteger = 0 then
      Result := Act
    else
      Result := q.FieldByName('N').AsInteger;
  finally
    q.Free;
  end;
end;

function TfrmGestBco.BancoTerPrior(Act: Integer): Integer;
var
  q: TMDOQuery;
begin
  Result := 1;
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoTer.Database;
    q.Transaction := qBancoTer.Transaction;
    q.SQL.Add('Select Max(IDMOV) as P ');
    q.SQL.Add('From BANCOTER ');
    q.SQL.Add('Where (IdMov <:Act) And (Situacion < 10) ');
    q.ParamByName('Act').AsInteger := Act;
    q.Open;
    if q.FieldByName('P').AsInteger = 0 then
      Result := Act
    else
      Result := q.FieldByName('P').AsInteger;
  finally
    q.Free;
  end;
end;

function TfrmGestBco.BancoTerFirst: Integer;
var
  q: TMDOQuery;
begin
  Result := 1;
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoTer.Database;
    q.Transaction := qBancoTer.Transaction;
    q.SQL.Add('Select Min(IDMOV) as F ');
    q.SQL.Add('from BANCOTER ');
    q.SQL.Add('Where (Situacion < 10) ');
    q.Open;
    Result := q.FieldByName('F').AsInteger;
  finally
    q.Free;
  end;
end;

procedure TfrmGestBco.qBancoTerBeforePost(DataSet: TDataSet);
var
  q: TMDOQuery;
begin
  if qBancoTerIDSUCURSAL.AsInteger = 0 then
    qBancoTerIDSUCURSAL.AsInteger := IdBranch;
  if AltaTer then
  begin
    if (qBancoTerIDEMPRESA.AsInteger = 0) then
    begin
      cbDetEmpBT.SetFocus;
      raise EUsuario.Create('No Se puede grabar un movimiento sin empresa asignada.-');
    end;
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := qBancoTer.Transaction;
      q.SQL.Add('Select Max(IdMov) as Ultimo ');
      q.SQL.Add('From BancoTer ');
      q.Open;
      qBancoTerIDMOV.AsInteger := q.FieldByName('Ultimo').AsInteger + 1;
      qBancoTerIDMOVSUC.AsInteger := q.FieldByName('Ultimo').AsInteger + 1;
      q.Close;
    finally
      q.Free;
    end;
  end;
end;

procedure TfrmGestBco.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action := caFree;
end;

procedure TfrmGestBco.pcGestBcoTabClick(Sender: TObject);
begin
  if pcGestBco.ActivePage = tsMovProp then
    cbBcoMovP.SetFocus;
  if pcGestBco.ActivePage = tsChqTer then
    cbMovTer.SetFocus;
  if (pcGestBco.ActivePage = tsConciliacion) and
     (pcAdmConciliaciones.ActivePage = tsConciliar) then
    cbBcoConc.SetFocus;
  if pcGestBco.ActivePage = tsTransBank then
  begin
    if not qTransRel.Active then
      qTransRel.Open;
  end;

  if pcGestBco.ActivePage = tsLibro then
    cbBcoLibro.SetFocus
end;

procedure TfrmGestBco.FormShow(Sender: TObject);
begin
  edtFecConc.Date := Date;
  edtDesdeMP.Date := StartOfTheMonth(Date);
  edtHastaMP.Date := Date;
  edtVtoDesde.Date := StartOfTheMonth(Date);;
  edtVtoHasta.Date := Date;

  edtDesdeTer.Date := StartOfTheMonth(Date);
  edtHastaTer.Date := Date;
  Sit_BT := btEnCartera;
  btnExpTer.Enabled := False;

  lblConciliado.Caption := '';
  lblConciliado.Visible := False;
  lblSituacionChTer.Caption := '';
  lblSituacionChTer.Visible := False;

  gConciliacion.ColumnByName('Monto').FooterValue := '0.00';
  gMovProp.ColumnByName('Monto').FooterValue := '0.00';
  gMovTer.ColumnByName('Monto').FooterValue := '0.00';
  gVencimientos.ColumnByName('Monto').FooterValue := '0.00';
  gVencimientos.GroupFieldName := 'NomBanco';
  gSaldosBancos.ColumnByName('TotalBanco').FooterValue := '0.00';
  gEnCartera.ColumnByName('Monto').FooterValue := '0.00';

  qBancoProp.Close;
  qBancoProp.ParamByName('IdMov').AsInteger := BancoPropLast;
  qBancoProp.Open;

  qBancoTer.Close;
  qBancoTer.ParamByName('IdMov').AsInteger := BancoTerLast;
  qBancoTer.Open;
end;

function TfrmGestBco.GetPrinterName(NBank: String): String;
begin
  Result := 'Default';
  try
    Result := Reg.ReadString(NBank);
  except
    on E: Exception do
    begin
      raise EUsuario.Create('No se pudo leer la impresora para el formulario. Se utilizara la impresora por defecto. ' + E.Message);
    end;
  end;
end;

procedure TfrmGestBco.FormCreate(Sender: TObject);
var
  PrinterName: String;
  i: SmallInt;
begin
  with dmGestion do
  begin
    if not Bancos.Active then
      Bancos.Open;
    if not TipoMovBco.Active then
      TipoMovBco.Open;
    if not EstMovTer.Active then
      EstMovTer.Open;
  end;

  qConcR.Close;
  qConcR.Open;
  qTipoMovBco.Open;

  Reg := TRegistry.Create;
  for i := 0 to Printer.Printers.Count-1 do
    cbPrinters.Items.Add(Printer.Printers.Strings[i]);

  if Reg.OpenKey('\Software\IyC\FB_Gestion\Comp_Printers', True) then
  begin
    PrinterName := Reg.ReadString(dmGestion.BancosBanco.AsString);
    if Trim(PrinterName) = VACIO then
    begin
      PrinterName := 'Default';
      Reg.WriteString(dmGestion.BancosBanco.AsString, PrinterName);
    end;
    cbPrinters.Text := PrinterName;
    cbPrinters.ItemIndex := cbPrinters.Items.IndexOf(PrinterName);
  end;

  try
    dmSaveFile.lstModelChq.PrinterSetup.PrinterName := GetPrinterName(dmGestion.BancosBanco.AsString);
  except
    dmSaveFile.lstModelChq.PrinterSetup.PrinterName := 'Default';
  end;

  cbMovTer.Items.Clear;
  cbMovTer.Items.AddObject('En Cartera', TObject(btEnCartera));
  cbMovTer.Items.AddObject('Entregado ', TObject(btEntregado));
  cbMovTer.Items.AddObject('Rechazado ', TObject(btRechazado));
  cbMovTer.Items.AddObject('Depositado', TObject(btDepositado));
  cbMovTer.Items.AddObject('Cobrado   ', TObject(btCobrado));
  cbMovTer.Items.AddObject('<TODOS>   ', TObject(NoEncontrado));
  cbMovTer.ItemIndex := 0;

  cbBcoMovP.Items.Clear;
  cbBcoConc.Items.Clear;
  cbBcoTDep.Items.Clear;
  cbBcoLibro.Items.Clear;
  cbBcoVenc.Items.Clear;
  cbBcoVenc.Items.AddObject('<TODAS>', TObject(0));
  qBancos.Open;
  if not qBancos.IsEmpty then
  begin
    qBancos.First;
    while not qBancos.Eof do
    begin
      cbBcoMovP.Items.AddObject(qBancosBANCO.AsString+' '+qBancosNroCta.AsString,
                                TObject(qBancosIdBanco.AsInteger));
      cbBcoConc.Items.AddObject(qBancosBANCO.AsString+' '+qBancosNroCta.AsString,
                                TObject(qBancosIdBanco.AsInteger));
      cbBcoVenc.Items.AddObject(qBancosBANCO.AsString+' '+qBancosNroCta.AsString,
                                TObject(qBancosIdBanco.AsInteger));
      cbBcoTDep.Items.AddObject(qBancosBANCO.AsString+' '+qBancosNroCta.AsString,
                                TObject(qBancosIdBanco.AsInteger));
      cbBcoLibro.Items.AddObject(qBancosBANCO.AsString+' '+qBancosNroCta.AsString,
                                TObject(qBancosIdBanco.AsInteger));
      qBancos.Next;
    end;
  end;
  cbBcoMovP.ItemIndex := 0;
  cbBcoConc.ItemIndex := 0;
  cbBcoVenc.ItemIndex := 0;
  cbBcoTDep.ItemIndex := 0;
  cbBcoLibro.ItemIndex:= 0;

  cbMesLib.Items.Clear;
  for i := 1 to 12 do
    cbMesLib.Items.AddObject(LongMonthNames[i], TObject(i));
  cbMesLib.ItemIndex := MonthOf(Date)-1;
  edtYearLibro.Value := CurrentYear;
end;

procedure TfrmGestBco.cbBancoPropEnter(Sender: TObject);
begin
  pnlBtnBco.Caption := cbBancoProp.Hint;
end;

procedure TfrmGestBco.cbBancoPropExit(Sender: TObject);
begin
  pnlBtnBco.Caption := '';
end;

procedure TfrmGestBco.cbBancoPropKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  {$INCLUDE IyC_NextEdit.Inc}
end;

procedure TfrmGestBco.cbTipoMovEnter(Sender: TObject);
begin
  pnlBtnBco.Caption := cbTipoMov.Hint;
end;

procedure TfrmGestBco.cbTipoMovExit(Sender: TObject);
begin
  pnlBtnBco.Caption := '';
end;

procedure TfrmGestBco.cdsLibBcoFechaResumenGetText(Sender: TField; var Text: string; DisplayText: Boolean);
begin
  if cdsLibBcoFECHARESUMEN.AsDateTime <= Ano_2000 then
    Text := 's/conc'
  else
    Text := FormatDateTime('dd/mm/yy', cdsLibBcoFECHARESUMEN.AsDateTime)
end;

procedure TfrmGestBco.edtEmisionEnter(Sender: TObject);
begin
  pnlBtnBco.Caption := (Sender as TwwDBDateTimePicker).Hint;
end;

procedure TfrmGestBco.edtEmisionExit(Sender: TObject);
begin
  pnlBtnBco.Caption := '';
end;

procedure TfrmGestBco.edtNroCompEnter(Sender: TObject);
begin
  pnlBtnBco.Caption := edtNroComp.Hint;
end;

procedure TfrmGestBco.edtNroCompExit(Sender: TObject);
begin
  pnlBtnBco.Caption := '';
end;

procedure TfrmGestBco.edtFecResumenEnter(Sender: TObject);
begin
  pnlBtnBco.Caption := edtFecResumen.Hint;
end;

procedure TfrmGestBco.edtFecResumenExit(Sender: TObject);
begin
  pnlBtnBco.Caption := '';
  btnSavePro.SetFocus;
end;

procedure TfrmGestBco.edtTitularKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (Shift = []) And
     (Key = VK_F3) then
  begin
    IdProv := Busca_Pro;
    if IdProv > NoEncontrado then
      qBancoPropIdEntidad.AsInteger := IdProv;
  end
  else begin
   {$INCLUDE IyC_NextEdit.Inc}
  end;
end;

procedure TfrmGestBco.edtCodEntregaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (Shift = []) And
     (Key = VK_F3) then
  begin
    IdProv := Busca_Pro;
    if IdProv > NoEncontrado then
      qBancoTerIdEntrega.AsInteger := IdProv;
  end
  else begin
    {$INCLUDE IyC_NextEdit.Inc}
  end;
end;

procedure TfrmGestBco.edtCodTitularKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (Shift = []) And
     (Key = VK_F3) then
  begin
    if Busca_Cli(IdEntidad, IdSucEnt) then
    begin
      qBancoTer.Edit;
      qBancoTerIdTitular.AsInteger := IdEntidad;
    end;
  end
  else begin
    {$INCLUDE IyC_NextEdit.Inc}
  end;
end;

procedure TfrmGestBco.edtCodEndosoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (Shift = []) And
     (Key = VK_F3) then
  begin
    if Busca_Cli(IdEntidad, IdSucEnt) then
    begin
      qBancoTer.Edit;
      qBancoTerIdEndoso.AsInteger := IdEntidad;
    end;
  end
  else begin
    {$INCLUDE IyC_NextEdit.Inc}
  end;
end;

procedure TfrmGestBco.cbPrintersChange(Sender: TObject);
begin
  Reg.WriteString(dmGestion.BancosMODNAME.AsString, cbPrinters.Text);
end;

procedure TfrmGestBco.gMovTerUpdateFooter(Sender: TObject);
begin
  gMovTer.ColumnByName('Monto').FooterValue := Format('%m', [TotalTerceros]);
end;

procedure TfrmGestBco.qMovPropFECHARESUMENGetText(Sender: TField; var Text: string; DisplayText: Boolean);
begin
  if qMovPropFECHARESUMEN.AsDateTime <= Ano_2000 then
    Text := 's/conc'
  else
    Text := FormatDateTime('dd/mm/yy', qMovPropFECHARESUMEN.AsDateTime)
end;

procedure TfrmGestBco.qMovTerSituacionGetText(Sender: TField; var Text: String; DisplayText: Boolean);
begin
  try
    case Sender.Value of
      btEnCartera:  Text := 'En Cartera';
      btEntregado:  Text := 'Entregado';
      btRechazado:  Text := 'Rechazado';
      btDepositado: Text := 'Depositado';
      btCobrado   : Text := 'Cobrado   '
      else Text := 'S/E';
    end;
  except
    Text := Sender.AsString;
  end;
end;

procedure TfrmGestBco.btnSalirClick(Sender: TObject);
begin
  Close;
end;

procedure TfrmGestBco.btnImpLibroClick(Sender: TObject);
begin
  if not cdsLibBco.IsEmpty then
  begin
    lblTitulo.Caption := 'Libro Bancos - '+Entidad_Libro;
    lblPeriodo.Caption:= Format('Periodo: %s / %d ', [cbMesLib.Text, edtYearLibro.Value]);
    rptLibBco.Print;
  end;
end;

procedure TfrmGestBco.Libro_Bancos;
//  LibroBancos = 'Select * FROM BANCOS_MOVIMIENTOS_PROPIOS(:IdCta, :Desde, :Hasta, :CualV) ';
Var
  Dia, Mes, Ano: Word;
  FDate, LDate: TDate;
begin
  try
    Screen.Cursor := crHourGlass;
    cdsLibBco.Close;
    gLibBco.Visible := False;

    Ano := edtYearLibro.Value;
    Mes := Integer(cbMesLib.Items.Objects[cbMesLib.ItemIndex]);
    Dia := MonthDays[IsLeapYear(Ano), Mes];
    FDate := EncodeDate(Ano, Mes, 1);
    LDate := EncodeDate(Ano, Mes, Dia);
    IdBank := Integer(cbBcoLibro.Items.Objects[cbBcoLibro.ItemIndex]);

    if IdBank <= 0 then
    begin
      cbBcoLibro.SetFocus;
      Entidad_Libro := Vacio;
      raise EUsuario.Create('Debe seleccionar un Banco');
    end
    else begin
      if qBancos.Locate(qBancosIDBANCO.FieldName, IdBank, []) then
      begin
        Entidad_Libro := Format('Banco: %s Cuenta: %s ', [qBancosBANCO.AsString, qBancosNROCTA.AsString]);
        pnlBtnBco.Caption := Entidad_Libro+' '+DateToStr(FDate)+' '+DateToStr(LDate)
      end;
    end;
    cdsLibBco.Params.ParamByName('IdCta').AsInteger := IdBank;
    cdsLibBco.Params.ParamByName('Desde').AsDate := FDate;
    cdsLibBco.Params.ParamByName('Hasta').AsDate := LDate;
    cdsLibBco.Params.ParamByName('CualV').AsInteger := 0;
    cdsLibBco.Open;
  finally
    Screen.Cursor := crDefault;
  end;
  if not cdsLibBco.IsEmpty then
  begin
    cdsLibBco.First;
    btnExpLibro.Enabled := True;
    btnImpLibro.Enabled := True;
    gLibBco.GroupFieldName := 'FECHAEMISION';
    gLibBco.Visible := True;
    gLibBco.SetFocus;
  end;
end;

procedure TfrmGestBco.btnLibBcoClick(Sender: TObject);
begin
  Libro_Bancos;
end;

procedure TfrmGestBco.cbBcoLibroChange(Sender: TObject);
begin
  btnExpLibro.Enabled := False;
  btnImpLibro.Enabled := False;
end;

procedure TfrmGestBco.btnExpLibroClick(Sender: TObject);
begin
  if not cdsLibBco.IsEmpty then
  begin
    dmGestion.IyC_Exp.DataSet := cdsLibBco;
    dmGestion.IyC_Exp.Select;
  end;
end;

procedure TfrmGestBco.Movimientos_Propios;
begin
  try
    IdBank := Integer(cbBcoMovP.Items.Objects[cbBcoMovP.ItemIndex]);
  except
    IdBank := 0;
  end;
  if (IdBank <= 0) or
     (edtDesdeMP.Date > edtHastaMP.Date) then
  begin
    cbBcoMovP.SetFocus;
    IdBank := 0;
    raise EUsuario.Create('Algun dato ha sido mal ingresado.-');
  end;
  try
    Screen.Cursor := crSQLWait;
    btnImpMovPro.Enabled := False;
    btnExpMovPro.Enabled := False;

    qMovProp.Close;
    qMovProp.ParamByName('IdCta').AsInteger := IdBank;
    qMovProp.ParamByName('Desde').AsDate := edtDesdeMP.Date;
    qMovProp.ParamByName('Hasta').AsDate := edtHastaMP.Date;
    qMovProp.ParamByName('CualV').AsInteger := rgTipoVencMP.ItemIndex;
    qMovProp.Open;

    if not qMovProp.IsEmpty then
    begin
      qMovProp.First;
      gMovProp.RefreshDisplay;
      btnImpMovPro.Enabled := True;
      btnExpMovPro.Enabled := True;
    end
    else
      ShowMessage('Periodo sin movimientos')
  finally
    Screen.Cursor := crDefault;
  end;
end;

procedure TfrmGestBco.gMovPropCalcCellColors(Sender: TObject; Field:
          TField; State: TGridDrawState; Highlight: Boolean; AFont: TFont; ABrush: TBrush);
begin
  if not Highlight then
  begin
    if qMovPropSUMA_O_RESTA.AsInteger < 0 then
      AFont.Color := clRed
    else
      AFont.Color := clBlue;
  end;
end;

procedure TfrmGestBco.btnImpMovProClick(Sender: TObject);
begin
  try
    qMovProp.DisableControls;
    lblTituloBP1.Caption := cbBcoMovP.Text + ' Movimientos entre el '+
                            DateToStr(edtDesdeMP.Date)+' hasta el '+
                            DateToStr(edtHastaMP.Date);
    lblTituloBP2.Caption := OwnerName;
    rpMovPropEntreFechas.Print;
  finally
    qMovProp.EnableControls;
  end
end;

procedure TfrmGestBco.btnMovProClick(Sender: TObject);
begin
  Movimientos_Propios;
end;

//------------------------------------------------------------------------------

procedure TfrmGestBco.Venc_Propios(Orden: String; IdBco: Integer);
var
  CondP: String;
  q: TMDOQuery;
Const
  VPrp = 'Select B.IdBanco, B.IdMov, B.IdEntidad, B.TipoMov,  '+
         '       B.FechaEmision, B.NroCheque, B.FechaVencimiento, '+
         '       B.DetalleMov, B.Monto, T.TipoMovBco as DetTipoMov, '+
         '       E.Banco as NomBanco, E.NroCta as NumCuenta '+
         'From BancoProp B '+
         'Left Outer Join TipoMovBco T '+
         '  on T.IdMovBco = B.TipoMov '+
         'Join Bancos E '+
         '  on E.IdBanco = B.IdBanco '+
         'Where <CondP> '+
         'Order By <Orden> ';

  TPrp = 'Select Sum(B.Monto) as T '+
         'From BANCOPROP B '+
         'Where <CondP> ';

  CPrp = 'Select Count(B.IdMov) as C '+
         'From BANCOPROP B '+
         'Where <CondP> ';
begin
  TotalPropios := 0;
  Cant_Propios := 0;
  qVencimientos.Close;
  qVencimientos.SQL.Clear;
  qVencimientos.SQL.Text := VPrp;
  CondP := '(B.Estado <> 999) And '+
           '((B.FechaResumen < :A) Or (B.FechaResumen is null)) And '+
           '(B.TipoMov = 1) And '+
           '(B.FechaVencimiento between :D and :H) ';

  if IdBco > 0 then
    CondP := CondP + 'And (B.IdBanco = '+IntToStr(IdBco)+')';
  gVencimientos.GroupFieldName := 'NomBanco';
  qVencimientos.SQL.Text := StringReplace(qVencimientos.SQL.Text, '<CondP>', CondP, [rfReplaceAll]);
  qVencimientos.SQL.Text := StringReplace(qVencimientos.SQL.Text, '<Orden>', Orden, [rfReplaceAll]);

  qVencimientos.ParamByName('A').AsDate := Ano_2000;
  qVencimientos.ParamByName('D').AsDate := edtVtoDesde.Date;
  qVencimientos.ParamByName('H').AsDate := edtVtoHasta.Date;
  qVencimientos.Open;

  if not qVencimientos.IsEmpty then
  begin
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trGestion;
      q.SQL.Text := StringReplace(TPrp, '<CondP>', CondP, [rfReplaceAll]);
      q.ParamByName('A').AsDate := Ano_2000;
      q.ParamByName('D').AsDate := edtVtoDesde.Date;
      q.ParamByName('H').AsDate := edtVtoHasta.Date;
      q.Open;
      TotalPropios := q.FieldByName('T').AsCurrency;
      q.Close;
    finally
      q.Free;
    end;

    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trGestion;
      q.SQL.Text := StringReplace(CPrp, '<CondP>', CondP, [rfReplaceAll]);
      q.ParamByName('A').AsDate := Ano_2000;
      q.ParamByName('D').AsDate := edtVtoDesde.Date;
      q.ParamByName('H').AsDate := edtVtoHasta.Date;
      q.Open;
      Cant_Propios := q.FieldByName('C').AsInteger;
      q.Close;
    finally
      q.Free;
    end;
  end;
  gVencimientos.ColumnByName('NroCheque').FooterValue := Format('%d', [Cant_Propios]);
  gVencimientos.ColumnByName('Monto').FooterValue := Format('%m', [TotalPropios]);
  gVencimientos.Refresh;
end;

procedure TfrmGestBco.Venc_Terceros(Orden: String);
Const
  MTer = 'Select IdMov, NombreBanco, NroCuenta, NroCheque, IdTitular, '+
         '       Titular, IdEndoso, Endoso, IdFactura, IdSucursal, '+
         '       IdPuntoVenta, IdOrdPago, NroFactura, FechaVencimiento, '+
         '       FechaEntrega, IdEntrega, Entrega, Monto, Situacion '+
         'From BancoTer '+
         'Where (FechaVencimiento between :D and :H) And '+
         '      (Situacion = 0) '+
         'Order By <Orden> ';
var
  q: TMDOQuery;
begin
  TotalEnCartera := 0;
  qEnCartera.Close;
  qEnCartera.SQL.Clear;
  qEnCartera.SQL.Text := StringReplace(MTer, '<Orden>', Orden, [rfReplaceAll]);
  qEnCartera.ParamByName('D').AsDate := edtVtoDesde.Date;
  qEnCartera.ParamByName('H').AsDate := edtVtoHasta.Date;
  qEnCartera.Open;
  if not qEnCartera.IsEmpty then
  begin
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trGestion;
      q.SQL.Add('Select Sum(Monto) as TotTer ');
      q.SQL.Add('From BANCOTER ');
      q.SQL.Add('Where (FechaVencimiento between :D and :H) And ');
      q.SQL.Add('      (Situacion = 0)');
      q.ParamByName('D').AsDate := edtVtoDesde.Date;
      q.ParamByName('H').AsDate := edtVtoHasta.Date;
      q.Open;
      TotalEnCartera := q.FieldByName('TotTer').AsCurrency;
      q.Close;
    finally
      q.Free;
    end;
  end;
  gEnCartera.ColumnByName('Monto').FooterValue := Format('%m', [TotalEnCartera]);
end;

procedure TfrmGestBco.btnCalcularVtosClick(Sender: TObject);
Const
  SdosBcos = 'Select P.IdBanco, B.NroCta, B.Banco, '+
             '       Sum(P.Monto * T.Suma_Resta) as TotalBanco '+
             'From BancoProp P '+
             'Join Bancos B '+
             '  on B.IdBanco = P.IdBanco '+
             'Join TipoMovBco T '+
             '  on T.IdMovBco = P.TipoMov '+
             'Where (P.FechaVencimiento between :D and :H) And '+
             '      ((P.FechaResumen < :A) Or (P.FechaResumen is null)) And '+
             '      (P.Estado <> 999) '+
             'Group By P.IdBanco, B.Banco, B.NroCta ';

  TotalSdo = 'Select Sum(P.Monto * T.Suma_Resta) as SaldoTotal '+
             'From BancoProp P '+
             'Join TipoMovBco T '+
             '  on T.IdMovBco = P.TipoMov '+
             'Where (P.FechaVencimiento between :D and :H) And '+
             '      ((P.FechaResumen < :A) Or (P.FechaResumen is null)) And '+
             '      (P.Estado <> 999) ';
var
  q : TMDOQuery;
begin
  try
    IdBank := Integer(cbBcoVenc.Items.Objects[cbBcoVenc.ItemIndex]);
  except
    IdBank := 0;
  end;
  Venc_Propios('B.IdBanco, B.FechaVencimiento ', IdBank);     // Movimientos Propios
  Venc_Terceros('FechaVencimiento');            // Movimientos de Terceros

  TotalBancos := 0;                             // Saldos Bancos Propios
  qTotalPorBancoPorMes.Close;
  qTotalPorBancoPorMes.SQL.Clear;
  qTotalPorBancoPorMes.SQL.Text := SdosBcos;
  qTotalPorBancoPorMes.ParamByName('D').AsDate := edtVtoDesde.Date;
  qTotalPorBancoPorMes.ParamByName('H').AsDate := edtVtoHasta.Date;
  qTotalPorBancoPorMes.ParamByName('A').AsDate := Ano_2000;
  qTotalPorBancoPorMes.Open;
  if not qTotalPorBancoPorMes.IsEmpty then
  begin
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trGestion;
      q.SQL.Text := TotalSdo;
      q.ParamByName('D').AsDate := edtVtoDesde.Date;
      q.ParamByName('H').AsDate := edtVtoHasta.Date;
      q.ParamByName('A').AsDate := Ano_2000;
      q.Open;
      TotalBancos := q.FieldByName('SaldoTotal').AsCurrency;
      q.Close;
    finally
      q.Free;
    end;
  end;
  gSaldosBancos.ColumnByName('TotalBanco').FooterValue := Format('%m', [TotalBancos]);
end;

procedure TfrmGestBco.gSaldosBancosUpdateFooter(Sender: TObject);
begin
  gSaldosBancos.ColumnByName('TotalBanco').FooterValue := Format('%m', [TotalBancos]);
end;

procedure TfrmGestBco.gVencimientosUpdateFooter(Sender: TObject);
begin
  gVencimientos.ColumnByName('NroCheque').FooterValue := Format('%d', [Cant_Propios]);
  gVencimientos.ColumnByName('Monto').FooterValue := Format('%m', [TotalPropios]);
end;

procedure TfrmGestBco.gEnCarteraUpdateFooter(Sender: TObject);
begin
  gEnCartera.ColumnByName('Monto').FooterValue := Format('%m', [TotalEnCartera]);
end;

procedure TfrmGestBco.gMovTerDblClick(Sender: TObject);
begin
  qBancoTer.Close;
  qBancoTer.ParamByName('IdMov').AsInteger := qMovTerIdMov.AsInteger;
  qBancoTer.Open;
end;

procedure TfrmGestBco.edtNomBcoTerKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  {$INCLUDE IyC_NextEdit.Inc}
end;

procedure TfrmGestBco.edtNombreKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  {$INCLUDE IyC_NextEdit.Inc}
end;

procedure TfrmGestBco.gbDepositoTerEnter(Sender: TObject);
begin
  cbBcoTDep.SetFocus;
end;

procedure TfrmGestBco.gConciliacionCalcCellColors(Sender: TObject; Field: TField; State: TGridDrawState; Highlight: Boolean; AFont: TFont; ABrush: TBrush);
begin
  if not qConciliaFechaResumen.IsNull then
    AFont.Color:= clRed;
  if Field.FieldName = 'Selected' then
     ABrush.Color:= clRed
  else begin
    if (not highlight) and
       (Sender as TwwDBGrid).isSelected then
    begin
      ABrush.Color:= clYellow;
      AFont.Color:= clBlack;
    end;
  end;
end;

procedure TfrmGestBco.gConciliacionDblClick(Sender: TObject);
begin
  Get_ModBco(qConciliaIdMov.AsInteger);
end;

procedure TfrmGestBco.qConciliaSelectedChange(Sender: TField);
begin
  if Sender.Value then
    qConciliaFechaResumen.AsDateTime := edtFecConc.Date
  else
    qConciliaFechaResumen.Clear;
end;

procedure TfrmGestBco.gConciliacionMultiSelectRecord(Grid: TwwDBGrid; Selecting: Boolean; var Accept: Boolean);
begin
  if Selecting then
  begin
    EnResumen := EnResumen + qConciliaMonto.AsCurrency;
    Inc(TotEnRes);
  end
  else begin
    EnResumen := EnResumen - qConciliaMonto.AsCurrency;
    Dec(TotEnRes);
  end;
  gConciliacion.ColumnByName('DetalleMov').FooterValue := 'Total incluido ';
  gConciliacion.ColumnByName('Monto').FooterValue := Format('%m', [EnResumen]);
  gConciliacion.ColumnByName('NroCheque').FooterValue := Format('%d', [TotEnRes]);
end;

procedure TfrmGestBco.gConciliacionUpdateFooter(Sender: TObject);
begin
  gConciliacion.ColumnByName('DetalleMov').FooterValue := 'Total incluido ';
  gConciliacion.ColumnByName('Monto').FooterValue := Format('%m', [EnResumen]);
  gConciliacion.ColumnByName('NroCheque').FooterValue := Format('%d', [TotEnRes]);
end;

procedure TfrmGestBco.gConcRDblClick(Sender: TObject);
Const
  ConcB = 'Select B.IdBanco, B.IdMov, B.IdEntidad, B.TipoMov,  '+
          '       B.FechaEmision, B. NroCheque, B.FechaVencimiento, '+
          '       B.DetalleMov, B.Monto, B.FechaResumen, '+
          '       B.IdNroConciliacion, T.TipoMovBco as DetTipoMov '+
          'From BancoProp B '+
          'Join TipoMovBco T '+
          '  on T.IdMovBco = B.TipoMov '+
          'Where (B.IdBanco =:IdBank) And '+
          '      (B.IdNroConciliacion =:IdConc) Or '+
          '      (((B.FechaResumen <=:FAntes) Or '+
          '      (B.FechaResumen is null)) And '+
          '      (B.FechaEmision <=:FecRes) And  '+
          '      (B.IdNroConciliacion = 0)) And '+
          '      (B.Estado <> 999) '+
          'Order By B.FechaEmision ';
begin
  btnImpConc.Enabled := False;
  btnExpConc.Enabled := False;
  qConcilia.Close;
  qConcilia.SQL.Clear;
  qConcilia.SQL.Text := ConcB;
  qConcilia.ParamByName('IdBank').AsInteger := qConcRIDBANCO.AsInteger;
  qConcilia.ParamByName('IdConc').AsInteger := qConcRIDCONCILIACION.AsInteger;
  qConcilia.ParamByName('FAntes').AsDate := Ano_2000;
  qConcilia.ParamByName('FecRes').AsDate := qConcRFECHA_CONC.AsDateTime;
  qConcilia.Open;
  if not qConcilia.IsEmpty then
  begin
    btnExpConc.Enabled := True;
    btnImpConc.Enabled := True;
    edtSalConc.Value := qConcRSSBANCO.AsCurrency;
    edtFecConc.Date := qConcRFECHA_CONC.AsDateTime;
    Mod_Con := True;
    Ult_Con := qConcRIDCONCILIACION.AsInteger;
    Can_Mov := qConcRCANT_MOV.AsInteger;
    pcAdmConciliaciones.ActivePage := tsConciliar;
    tsConciliar.Show;
  end
  else begin
    ShowMessage('No hay conciliaciones realizadas.-');
  end;
end;

function TfrmGestBco.Ultima_Conciliacion(IdB: Integer): Integer;
var
  q: TMDOQuery;
  u: Integer;
begin
  Result := 1;
  u := 1;
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoProp.Database;
    q.Transaction := qBancoProp.Transaction;
    q.SQL.Add('Select Max(IdNroConciliacion) as U ');
    q.SQL.Add('From BancoProp ');
    q.SQL.Add('Where IdBanco =:IdB ');
    q.ParamByName('IdB').AsInteger := IdB;
    q.Open;
    if not q.IsEmpty then
      u := q.FieldByName('U').AsInteger + 1
    else
      u := 0;
    q.Close;
  finally
    q.Free;
  end;
  Result := u;
end;

procedure TfrmGestBco.Incrementa_Conciliacion(IdB, UCB: Integer);
var
  q: TMDOQuery;
begin
  try
    q := TMDOQuery.Create(nil);
    q.Database := qBancoProp.Database;
    q.Transaction := qBancoProp.Transaction;
    q.SQL.Add('UpDate Bancos ');
    q.SQL.Add('   Set UltimaConciliacion =:U ');
    q.SQL.Add('Where IdBanco =:B ');
    q.ParamByName('U').AsInteger := UCB;
    q.ParamByName('B').AsInteger := IdB;
    q.ExecSQL;
  finally
    q.Free;
  end;
end;

procedure TfrmGestBco.Conciliar(AOrden: String);
Const
  ConcB = 'Select B.IdBanco, B.IdMov, B.IdEntidad, B.TipoMov,  '+
          '       B.FechaEmision, B. NroCheque, B.FechaVencimiento, '+
          '       B.DetalleMov, B.Monto, B.FechaResumen, '+
          '       B.IdNroConciliacion, T.TipoMovBco as DetTipoMov '+
          'From BancoProp B '+
          'Join TipoMovBco T '+
          '  on T.IdMovBco = B.TipoMov '+
          'Where ((B.FechaResumen <=:FAntes) Or (B.FechaResumen is null)) And '+
          '      (B.FechaEmision <=:FecRes) And '+
          '      (B.IdBanco = :IdBank) And '+
          '      (B.Estado <> 999) ';
  Orden = 'Order By B.FechaEmision ';
begin
  Mod_Con := False;
  Ult_Con := 0;
  Can_Mov := 0;
  btnImpConc.Enabled := False;
  try
    IdBank := Integer(cbBcoConc.Items.Objects[cbBcoConc.ItemIndex]);
  except
    IdBank := 0;
  end;
  if (IdBank > 0)  and (edtFecConc.Date > Ano_2000) then
  begin
    qConcilia.Close;
    qConcilia.SQL.Clear;
    if Trim(AOrden) > Vacio then
      qConcilia.SQL.Text := ConcB + AOrden
    else
      qConcilia.SQL.Text := ConcB + Orden;
    qConcilia.ParamByName('FAntes').AsDate := Ano_2000;
    qConcilia.ParamByName('FecRes').AsDate := edtFecConc.Date;
    qConcilia.ParamByName('IdBank').AsInteger := IdBank;
    qConcilia.Open;
    if not qConcilia.IsEmpty then
    begin
      btnExpConc.Enabled := True;
      btnImpConc.Enabled := True;
      btnSel_All_Conciliacion.Enabled := True;
      btnUnSell_All_Conciliacion.Enabled := True;
    end
    else begin
      ShowMessage('No hay movimientos ha conciliar.-');
    end;
  end;
end;

procedure TfrmGestBco.btnConciliarClick(Sender: TObject);
begin
  Case rgOrdConc.ItemIndex of
    0: Conciliar('Order By B.FechaEmision desc ');
    1: Conciliar('Order By B.FechaEmision ');
    2: Conciliar('Order By B.FechaVencimiento desc ');
    3: Conciliar('Order By B.FechaVencimiento ');
    4: Conciliar('Order By B.Monto desc ');
    5: Conciliar('Order By B.Monto ');
    6: Conciliar('Order By B.NroCheque ');
    7: Conciliar('Order By B.TipoMov ');
    else Conciliar('');
  End;
end;

procedure TfrmGestBco.btnSel_All_ConciliacionClick(Sender: TObject);
var
  q :TMDOQuery;
begin
  EnResumen := 0;
  TotEnRes  := 0;
  if not qConcilia.IsEmpty then
  begin
    try
      q := TMDOQuery.Create(nil);
      q.Database := qConcilia.Database;
      q.Transaction := qConcilia.Transaction;
      q.SQL.Add('Select Count(*) as CantM, ');
      q.SQL.Add('       Sum(B.Monto) as Monto ');
      q.SQL.Add('From BancoProp B ');
      q.SQL.Add('Where ((B.FechaResumen <=:FAntes) Or (B.FechaResumen is null)) And ');
      q.SQL.Add('      (B.FechaEmision <=:FecRes) And ');
      q.SQL.Add('      (B.IdBanco = :IdBank) And ');
      q.SQL.Add('      (B.Estado <> 999) ');
      q.ParamByName('FAntes').AsDate := Ano_2000;
      q.ParamByName('FecRes').AsDate := edtFecConc.Date;
      q.ParamByName('IdBank').AsInteger := IdBank;
      q.Open;
      if not q.IsEmpty then
      begin
        TotEnRes := q.FieldByName('CantM').AsInteger;
        EnResumen := q.FieldByName('Monto').AsCurrency;
      end;
      q.Close;
    finally
      q.Free;
    end;
  end;
  gConciliacion.SelectAll;
  gConciliacion.ColumnByName('DetalleMov').FooterValue := 'Total incluido ';
  gConciliacion.ColumnByName('Monto').FooterValue := Format('%m', [EnResumen]);
  gConciliacion.ColumnByName('NroCheque').FooterValue := Format('%d', [TotEnRes]);
end;

procedure TfrmGestBco.btnUnSell_All_ConciliacionClick(Sender: TObject);
begin
  gConciliacion.UnselectAll;
  EnResumen := 0;
  TotEnRes := 0;
  gConciliacion.ColumnByName('DetalleMov').FooterValue := 'Total incluido ';
  gConciliacion.ColumnByName('Monto').FooterValue := Format('%m', [EnResumen]);
  gConciliacion.ColumnByName('NroCheque').FooterValue := Format('%d', [TotEnRes]);
end;

procedure TfrmGestBco.btnImpConcClick(Sender: TObject);
const
  NoInc = 'Select B.TipoMov, B.FechaEmision, B.NroCheque, '+
          '       B.FechaVencimiento, B.DetalleMov, '+
          '       B.Monto, B.FechaResumen, '+
          '       T.TipoMovBco as DetTipoMov '+
          'From BancoProp B '+
          'Join TipoMovBco T '+
          '  on T.IdMovBco = B.TipoMov '+
          'Where (B.IdBanco = :IdBanK) And '+
          '      (B.FechaEmision <= :FecRes) And (B.Estado <> 999) '+
          '      ((B.FechaResumen <= :FAntes) or (B.FechaResumen is null)) '+
          'Order By B.TipoMov, B.FechaEmision ';

  TotNI = 'Select B.TipoMov, Sum(B.Monto) as TotMto, '+
          '       T.TipoMovBco as DetTipoMov, T.Suma_Resta '+
          'From BancoProp B '+
          'Join TipoMovBco T '+
          '  on T.IdMovBco = B.TipoMov '+
          'Where (B.IdBanco = :IdBanK) And '+
          '      (B.FechaEmision <= :FecRes) And (B.Estado <> 999) And '+
          '      ((B.FechaResumen <= :FAntes) or (B.FechaResumen is null)) '+
          'Group By B.TipoMov, T.TipoMovBco, T.Suma_Resta ';

  RConc = 'Select Sum(Debe) as TotalDebe, '+
          '       Sum(Haber) as TotalHaber '+
          'From BancoProp '+
          'Where (IdBanco = :IdBank) And '+
          '      (FechaEmision <= :FecRes) and (Estado <> 999) '+
          '      ((FechaResumen <= :FAntes) Or (FechaResumen is null)) ';

  Saldo = 'Select Sum(Debe - Haber) as Total '+
          'From BancoProp '+
          'Where (IdBanco = :IdBank) And '+
          '      (FechaEmision <= :FecRes) and '+
          '      ((FechaResumen <= :FAntes) Or (FechaResumen is null)) And '+
          '      (Estado <> 999) ';

var
  i, q: TMDOQuery;
  j, k: Integer;
  SSgCon,
  SSgLib,
  Difer: Currency;

begin
  k := 0;
  EnResumen := 0;
  TotEnRes := 0;
  if not Mod_Con then
  begin
    Can_Mov := 0;
    Ult_Con := Ultima_Conciliacion(IdBank);
  end;

  if (Ult_Con > 0) and (edtFecConc.Date > Ano_2000) then
  begin
    Can_Mov := 0;
    ActPro := qBancoPropIDMOV.AsInteger;
    ActTer := qBancoTerIDMOV.AsInteger;
    K := gConciliacion.SelectedList.Count-1;

    if (K > 0) then
    begin
      try
        if not qBancoProp.Transaction.InTransaction then
          qBancoProp.Transaction.StartTransaction;
        for j := 0 to k do
        begin
          gConciliacion.DataSource.DataSet.GotoBookmark(gConciliacion.SelectedList.items[j]);
          qBancoProp.Close;
          qBancoProp.ParamByName('IdMov').AsInteger := qConciliaIdMov.AsInteger;
          qBancoProp.Open;
          if not qBancoProp.IsEmpty then
          begin
            qBancoProp.Edit;
            qBancoPropFechaResumen.AsDateTime := edtFecConc.Date;
            qBancoPropIDNROCONCILIACION.AsInteger := Ult_Con;
            qBancoProp.Post;
            Inc(Can_Mov);
          end;
        end;
        qBancoProp.Transaction.Commit;
      except
        on E:Exception do
        begin
          qBancoProp.Transaction.Rollback;
          raise EUsuario.Create(E.Message);
        end;
      end;
      gConciliacion.SelectedList.Clear;
    end;

    lblTituloConc.Caption := Format('Conciliacin Bancaria N %d al %s del Banco %s ',
                             [Ult_Con, DateToStr(edtFecConc.Date), cbBcoConc.Text]);
    lblSaldoBco.Caption := Format('Saldo segun extracto bancario %m', [SdoSBco]);

    qIncluidos.Close;
    qIncluidos.ParamByName('IdBank').AsInteger := IdBank;
    qIncluidos.ParamByName('FecRes').AsDate := edtFecConc.Date;
    qIncluidos.ParamByName('IdNro').AsInteger := Ult_Con;
    qIncluidos.Open;

    qNoIncluidos.Close;
    qNoIncluidos.ParamByName('IdBank').AsInteger := IdBank;
    qNoIncluidos.ParamByName('FecRes').AsDate := edtFecConc.Date;
    qNoIncluidos.ParamByName('FAntes').AsDate := Ano_2000;
    qNoIncluidos.Open;

    qTotNoInc.Close;
    qTotNoInc.ParamByName('IdBank').AsInteger := IdBank;
    qTotNoInc.ParamByName('FecRes').AsDate := edtFecConc.Date;
    qTotNoInc.ParamByName('FAntes').AsDate := Ano_2000;
    qTotNoInc.Open;

    SSgCon := SdoSBco;
    while not qTotNoInc.Eof do
    begin
      if qTotNoIncSuma_Resta.AsInteger > 0 then
        SSgCon := SSgCon + Abs(qTotNoIncTotMto.AsCurrency)
      else
        SSgCon := SSgCon - Abs(qTotNoIncTotMto.AsCurrency);
      qTotNoInc.Next;
    end;

    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trGestion;
      q.Close;
      q.SQL.Text := Saldo;
      q.ParamByName('IdBank').AsInteger := IdBank;
      q.ParamByName('FecRes').AsDate := edtFecConc.Date;
      q.ParamByName('FAntes').AsDate := Ano_2000;
      q.Open;
      SSgLib := q.FieldByName('Total').AsCurrency;
      q.Close;
    finally
      q.Free;
    end;

    qMovProp.Close;
    qMovProp.ParamByName('IdCta').AsInteger := IdBank;
    qMovProp.ParamByName('Desde').AsDate := Ano_2000;
    qMovProp.ParamByName('Hasta').AsDate := edtFecConc.Date;
    qMovProp.ParamByName('CualV').AsInteger := 0;
    qMovProp.Open;

    if not qMovProp.IsEmpty then
    begin
      qMovProp.Last;
      SSgLib := qMovPropSALDO.AsCurrency;
    end;

    Difer := -SSgLib + SSgCon;
    lblSSgCon.Caption := Format('%m ',[SSgCon]);
    lblSSgLib.Caption := Format('%m ',[SSgLib]);
    lblDifer.Caption  := Format('%m ',[Difer]);
    rpConciliacion.Print;

    if (k > 0) then
    begin
      try
        if not qBancoProp.Transaction.InTransaction then
          qBancoProp.Transaction.StartTransaction;
        if not Mod_Con then
        begin
          try
            i := TMDOQuery.Create(nil);
            i.Database := qBancoProp.Database;
            i.Transaction := qBancoProp.Transaction;
            i.SQL.Add('Insert InTo ');
            i.SQL.Add('Bancos_Conc(IDCONCILIACION, IDBANCO, FECHA_CONC, ');
            i.SQL.Add('     CANT_MOV, SSBANCO, DIF_CONC, OBSERVACION)');
            i.SQL.Add('Values(:IDCONCILIACION, :IDBANCO, :FECHA_CONC, ');
            i.SQL.Add('     :CANT_MOV, :SSBANCO, :DIF_CONC, :OBSERVACION)');
            i.ParamByName('IDCONCILIACION').AsInteger := Ult_Con;
            i.ParamByName('IDBANCO').AsInteger := IdBank;
            i.ParamByName('FECHA_CONC').AsDate := edtFecConc.Date;
            i.ParamByName('CANT_MOV').AsInteger := Can_Mov;
            i.ParamByName('SSBANCO').AsCurrency := SdoSBco;
            i.ParamByName('DIF_CONC').AsCurrency := Difer ;
            i.ParamByName('OBSERVACION').AsString := Vacio;
            i.ExecSQL;
          finally
            i.Free;
          end;
          Incrementa_Conciliacion(IdBank, Ult_Con);
        end
        else begin
          try
            i := TMDOQuery.Create(nil);
            i.Database := qBancoProp.Database;
            i.Transaction := qBancoProp.Transaction;
            i.SQL.Add('UpDate Bancos_Conc ');
            i.SQL.Add('Set FECHA_CONC = :FECHA_CONC, ');
            i.SQL.Add('    CANT_MOV = :CANT_MOV, ');
            i.SQL.Add('    SSBANCO = :SSBANCO, ');
            i.SQL.Add('    DIF_CONC = :DIF_CONC, ');
            i.SQL.Add('    OBSERVACION = :OBSERVACION ');
            i.SQL.Add('Where (IDCONCILIACION = :IDCONCILIACION) And ');
            i.SQL.Add('      (IDBANCO = :IDBANCO) ');
            i.ParamByName('IDCONCILIACION').AsInteger := Ult_Con;
            i.ParamByName('IDBANCO').AsInteger := IdBank;
            i.ParamByName('FECHA_CONC').AsDate := edtFecConc.Date;
            i.ParamByName('CANT_MOV').AsInteger := Can_Mov;
            i.ParamByName('SSBANCO').AsCurrency := SdoSBco;
            i.ParamByName('DIF_CONC').AsCurrency := Difer ;
            i.ParamByName('OBSERVACION').AsString := ' ';
            i.ExecSQL;
          finally
            i.Free;
          end;
        end;
        qBancoProp.Transaction.Commit;
      except
        on E:Exception do
        begin
          qBancoProp.Transaction.Rollback;
          raise EUsuario.Create(E.Message);
        end;
      end;
      qConcilia.Close;
      qConcR.Close;
      qConcR.Open;

      qBancoProp.Close;
      qBancoProp.ParamByName('IdMov').AsInteger := ActPro;
      qBancoProp.Open;

      qBancoTer.Close;
      qBancoTer.ParamByName('IdMov').AsInteger := ActTer;
      qBancoTer.Open;
    end;
  end;
end;

procedure TfrmGestBco.btnExpConcClick(Sender: TObject);
begin
  dmGestion.IyC_Exp.DataSet := qConcilia;
  dmGestion.IyC_Exp.Select;
end;

procedure TfrmGestBco.Mov_En_Cartera(Orden: String);
Const
  MovT = 'Select IdMov, NombreBanco, NroCuenta, NroCheque, IdTitular, '+
         '       Titular, IdEndoso, Endoso, IdFactura, IdSucursal, '+
         '       IdPuntoVenta, IdOrdPago, NroFactura, FechaVencimiento, '+
         '       FechaEntrega, IdEntrega, Entrega, Monto, Situacion '+
         'From BancoTer '+
         'Where <CondT>'+
         'Order By <Orden> ';

  TotT = 'Select Sum(Monto) As TotTer '+
         'From BancoTer '+
         'Where <CondT>';
var
  CondT: String;
  q : TMDOQuery;

begin
  TotalTerceros := 0;
  CondT := '(FechaVencimiento between :Desde and :Hasta) ';
  if edtDesdeTer.Date <= edtHastaTer.Date then
  begin
    Sit_BT := Integer(cbMovTer.Items.Objects[cbMovTer.ItemIndex]);
    if Sit_BT >= 0 then
       CondT := CondT + ' And (Situacion = '+IntToStr(Sit_BT)+')';
    try
      Screen.Cursor := crSQLWait;
      qMovTer.Close;
      qMovTer.SQL.Clear;
      qMovTer.SQL.Text := MovT;
      qMovTer.SQL.Text := StringReplace(qMovTer.SQL.Text, '<CondT>', CondT, [rfReplaceAll]);
      qMovTer.SQL.Text := StringReplace(qMovTer.SQL.Text, '<Orden>', Orden, [rfReplaceAll]);
      qMovTer.ParamByName('Desde').AsDate := edtDesdeTer.Date;
      qMovTer.ParamByName('Hasta').AsDate := edtHastaTer.Date;
      qMovTer.Open;
      if not qMovTer.IsEmpty then
      begin
        try
          q := TMDOQuery.Create(nil);
          q.Database := dmGestion.dbGestion;
          q.Transaction := dmGestion.trGestion;
          q.SQL.Text := StringReplace(TotT, '<CondT>', CondT, [rfReplaceAll]);
          q.ParamByName('Desde').AsDate := edtDesdeTer.Date;
          q.ParamByName('Hasta').AsDate := edtHastaTer.Date;
          q.Open;
          TotalTerceros := q.FieldByName('TotTer').AsCurrency;
          q.Close;
        finally
          q.Free;
        end;
        btnExpTer.Enabled := True;
      end;
    finally
      Screen.Cursor := crDefault;
    end;
  end;
  gMovTer.ColumnByName('Monto').FooterValue := Format('%m', [TotalTerceros]);
  gMovTer.Refresh;
end;

procedure TfrmGestBco.btnMovTerClick(Sender: TObject);
begin
  Mov_En_Cartera('FechaVencimiento');
end;

procedure TfrmGestBco.btnExpTerClick(Sender: TObject);
begin
  dmGestion.IyC_Exp.DataSet := qMovTer;
  dmGestion.IyC_Exp.Select;
end;

procedure TfrmGestBco.edtSalConcEnter(Sender: TObject);
begin
  edtSalConc.SelectAll;
end;

procedure TfrmGestBco.edtSalConcExit(Sender: TObject);
begin
  try
    SdoSBco := edtSalConc.Value;
  except
    SdoSBco := 0;
  end;
end;

procedure TfrmGestBco.edtSalConcKeyPress(Sender: TObject; var Key: Char);
begin
  if Key in [',', '.'] then
    Key := DecimalSeparator;
end;

procedure TfrmGestBco.btnExpMovProClick(Sender: TObject);
begin
  dmGestion.IyC_Exp.DataSet := qMovProp;
  dmGestion.IyC_Exp.Select;
end;

procedure TfrmGestBco.btnExportarTBClick(Sender: TObject);
begin
  if not qTransRel.IsEmpty then
  begin
    dmGestion.IyC_Exp.DataSet := qTransRel;
    dmGestion.IyC_Exp.Select;
  end;
end;

procedure TfrmGestBco.cbSituacionChange(Sender: TObject);
var
  q: TMDOQuery;
  c: Integer;
begin
  c := 0;
  if (qBancoTer.State in dsEditModes) and
     (StrToInt(cbSituacion.LookupValue) = btDepositado) then
  begin
    edtFecDepTer.Date := qBancoTerFechaVencimiento.AsDateTime;
    try
      q := TMDOQuery.Create(nil);
      q.Database := qBancoProp.Database;
      q.Transaction := qBancoProp.Transaction;
      q.SQL.Add('Select Count(*) as C ');
      q.SQL.Add('From BANCOPROP ');
      q.SQL.Add('Where DetalleMov =:Det And ');
      q.SQL.Add('      Monto =:Mon ');
      q.ParamByName('Det').AsString := qBancoTerNombreBanco.AsString + ' - ' + qBancoTerNroCuenta.AsString;
      q.ParamByName('Mon').AsCurrency := qBancoTerMonto.AsCurrency;
      q.Open;
      c := q.FieldByName('C').AsInteger;
      q.Close;
    finally
      q.Free;
    end;
    if c > 0 then
    begin
      if (Application.MessageBox('Ya existe un depsito con las mismas caracteristicas del que va ha realizar Continua? ',
                                 'Depsito de Valores en Cartera', MB_ICONQUESTION+MB_YESNO) = ID_No) then
       Exit;
    end;
    gbDepositoTer.Visible := True;
    cbBcoTDep.SetFocus;
  end;
end;

procedure TfrmGestBco.btnGrabarDepClick(Sender: TObject);
begin
  try
    try
      IdBank := Integer(cbBcoTDep.Items.Objects[cbBcoTDep.ItemIndex]);
    except
      IdBank := 0;
    end;
    if (IdBank > 0) then
    begin
      ActTer := qBancoTerIDMOV.AsInteger;
      AltaPro:= True;
      try
        if not qBancoProp.Transaction.InTransaction then
          qBancoProp.Transaction.StartTransaction;
        qBancoProp.Insert;
        qBancoPropIDBANCO.AsInteger := IdBank;
        qBancoPropTipoMov.AsInteger := bpDeposito;
        qBancoPropMonto.AsCurrency := qBancoTerMonto.AsCurrency;
        qBancoPropDetalleMov.AsString := qBancoTerNombreBanco.AsString + ' - ' +
                                         qBancoTerNroCuenta.AsString;
        qBancoPropFechaEmision.AsDateTime := edtFecDepTer.Date;
        qBancoPropFechaVencimiento.AsDateTime := edtFecDepTer.Date;
        qBancoPropIDNROCONCILIACION.AsInteger := 0;
        qBancoProp.Post;
        qBancoProp.Transaction.Commit;
      except
        on E:Exception do
        begin
          qBancoProp.Transaction.Rollback;
          raise EUsuario.Create(E.Message);
        end;
      end;
      ShowMessage('Ok. Depsito Bancos.- ');

      gbDepositoTer.Visible := False;
      qBancoTer.Close;
      qBancoTer.ParamByName('IdMov').AsInteger := ActTer;
      qBancoTer.Open;
      try
        if not qBancoTer.Transaction.InTransaction then
          qBancoTer.Transaction.StartTransaction;
        qBancoTer.Edit;
        qBancoTerFechaEntrega.AsDateTime := edtFecDepTer.Date;
        qBancoTerSITUACION.AsInteger := btDepositado;
        qBancoTer.Post;
        qBancoTer.Transaction.Commit;
      except
        on E:Exception do
        begin
          qBancoTer.Transaction.Rollback;
          raise EUsuario.Create(E.Message);
        end;
      end;
      ShowMessage('Ok. En cartera.');
      qBancoProp.Close;
      qBancoProp.ParamByName('IdMov').AsInteger := BancoPropLast;
      qBancoProp.Open;
      qBancoTer.Close;
      qBancoTer.ParamByName('IdMov').AsInteger := ActTer;
      qBancoTer.Open;
    end;
  finally
    gbDepositoTer.Visible := False;
  end;
end;

procedure TfrmGestBco.btnCancelarDepClick(Sender: TObject);
begin
  qBancoTer.Cancel;
  qBancoProp.Cancel;
  gbDepositoTer.Visible := False;
end;

procedure TfrmGestBco.edtMontoAcuerdoCCKeyPress(Sender: TObject; var Key: Char);
begin
  if Key in [',', '.'] then
    Key := DecimalSeparator;
end;

procedure TfrmGestBco.edtImporteKeyPress(Sender: TObject; var Key: Char);
begin
  if Key in [',', '.'] then
    Key := DecimalSeparator;
end;

procedure TfrmGestBco.edtMtoChqTerKeyPress(Sender: TObject; var Key: Char);
begin
  if Key in [',', '.'] then
    Key := DecimalSeparator;
end;

procedure TfrmGestBco.cbBcoDepTKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  {$INCLUDE IyC_NextEdit.Inc}
end;

procedure TfrmGestBco.edtFecConcEnter(Sender: TObject);
begin
  edtFecConc.SelectAll;
end;

procedure TfrmGestBco.edtFecDepTerKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  {$INCLUDE IyC_NextEdit.Inc}
end;

procedure TfrmGestBco.edtCmpDepTerKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  {$INCLUDE IyC_NextEdit.Inc}
end;

procedure TfrmGestBco.pcGestBcoClose(Sender: TObject; var AllowClose: Boolean);
begin
  Close;
end;

procedure TfrmGestBco.dsqBancoPropDataChange(Sender: TObject; Field: TField);
begin
  if qBancoPropFechaResumen.AsDateTime <= Ano_2000 then
  begin
    lblConciliado.Caption := '';
    lblConciliado.Visible := False;
  end
  else begin
    if qBancoPropESTADO.AsInteger = 1 then
    begin
      lblConciliado.Caption := 'ANULADO';
      lblConciliado.Visible := True;
    end
    else begin
      if qBancoPropESTADO.AsInteger = 999 then
      begin
        lblConciliado.Caption := 'BORRADO';
        lblConciliado.Visible := True;
      end
      else begin
        lblConciliado.Caption := 'CONCILIADO';
        lblConciliado.Visible := True;
      end;
    end;
  end;
end;

procedure TfrmGestBco.gMovPropDblClick(Sender: TObject);
begin
  if qMovPropIdMov.AsInteger > 0 then
  begin
    qBancoProp.Close;
    qBancoProp.ParamByName('IdMov').AsInteger := qMovPropIdMov.AsInteger;
    qBancoProp.Open;
  end;
end;

procedure TfrmGestBco.SaldosBcosClick(Sender: TObject);
begin
  dmGestion.IyC_Exp.DataSet := qTotalPorBancoPorMes;
  dmGestion.IyC_Exp.Select;
end;

procedure TfrmGestBco.MovimientosPropiosClick(Sender: TObject);
begin
  dmGestion.IyC_Exp.DataSet := qVencimientos;
  dmGestion.IyC_Exp.Select;
end;

procedure TfrmGestBco.ChequesEnCarteraClick(Sender: TObject);
begin
  dmGestion.IyC_Exp.DataSet := qEnCartera;
  dmGestion.IyC_Exp.Select;
end;

procedure TfrmGestBco.gMovTerTitleButtonClick(Sender: TObject; AFieldName: String);
begin
  Mov_En_Cartera(AFieldName);
end;

procedure TfrmGestBco.gVencimientosTitleButtonClick(Sender: TObject; AFieldName: String);
begin
  Venc_Propios(AFieldName, IdBank);
end;

procedure TfrmGestBco.gEnCarteraTitleButtonClick(Sender: TObject; AFieldName: String);
begin
  Venc_Terceros(AFieldName);
end;

procedure TfrmGestBco.ImpSaldosClick(Sender: TObject);
begin
  lblSBTitulo.Caption := OwnerName+' Saldos bancarios hasta el '+ DateToStr(edtVtoHasta.Date);
  rpTotByBcoByMes.Print;
end;

procedure TfrmGestBco.ImpVencPropClick(Sender: TObject);
begin
  lblVBTitulo.Caption := OwnerName+' Vencimientos bancarios del '+
                         DateToStr(edtVtoDesde.Date)+' al '+ DateToStr(edtVtoHasta.Date);
  rpVencimientos.Print;
end;

procedure TfrmGestBco.ImpSaldoChq3Click(Sender: TObject);
begin
  lblBTTitulo.Caption := OwnerName+' Valores en Cartera con vencimiento del '+
                         DateToStr(edtVtoDesde.Date)+' al '+ DateToStr(edtVtoHasta.Date);
  rpEnCartera.Print;
end;

procedure TfrmGestBco.qBancoPropIDENTIDADChange(Sender: TField);
begin
  if GetDatosEnt(Sender.AsInteger, IdBranch, 2, Datos_Ent) then
    qBancoPropDetalleMov.AsString := Datos_Ent.Nombre
end;

procedure TfrmGestBco.qBancoPropNewRecord(DataSet: TDataSet);
begin
  qBancoPropIDMOV.AsInteger := NUEVO_REGISTRO;
  qBancoPropIdBanco.AsInteger := 0;
  qBancoPropIdOrdPago.AsInteger := 0;
  qBancoPropFECHAEMISION.AsDateTime := Date;
  qBancoPropUsuario.AsInteger := Usuario;
  qBancoPropDebe.AsCurrency := 0;
  qBancoPropHaber.AsCurrency := 0;
  qBancoPropMonto.AsCurrency := 0;
  qBancoPropIDENTIDAD.AsInteger := 0;
  qBancoPropESTADO.AsInteger := 0;
  qBancoPropIDFACTURA.AsInteger := 0;
  qBancoPropIDSUCURSAL.AsInteger := IdBranch;
  qBancoPropIDNROCONCILIACION.AsInteger := 0;
end;

procedure TfrmGestBco.qBancoPropIDMOVGetText(Sender: TField; var Text: String; DisplayText: Boolean);
begin
  if Sender.AsInteger = NUEVO_REGISTRO then
    Text := 'Nuevo'
  else
    Text := Sender.AsString;
end;

procedure TfrmGestBco.qBancoPropBeforePost(DataSet: TDataSet);
var
  q: TMDOQuery;
begin
  if AltaPro then
  begin
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := qBancoProp.Transaction;
      q.SQL.Add('Select Max(IdMov) as Ultimo ');
      q.SQL.Add('From BancoProp ');
      q.Open;
      qBancoPropIDMOV.AsInteger := q.FieldByName('Ultimo').AsInteger + 1;
      q.Close;
    finally
      q.Free;
    end;
  end;
end;

procedure TfrmGestBco.qBancoTerNewRecord(DataSet: TDataSet);
begin
  qBancoTerSituacion.AsInteger := btEnCartera;
  qBancoTerIDMOV.AsInteger := NUEVO_REGISTRO;
  qBancoTerIDSUCURSAL.AsInteger := IdBranch;
  qBancoTerIDFACTURA.AsInteger := 0;
  qBancoTerIDPUNTOVENTA.AsInteger := 0;
  qBancoTerIDORDPAGO.AsInteger := 0;
  qBancoTerIDTITULAR.AsInteger := 0;
  qBancoTerIDENTREGA.AsInteger := 0;
  qBancoTerIDENDOSO.AsInteger := 0;
  qBancoTerIDEMPRESA.AsInteger := 0;
  qBancoTerMONTO.AsCurrency := 0;
end;

procedure TfrmGestBco.qBancoTerIDENTREGAChange(Sender: TField);
begin
  if GetDatosEnt(Sender.AsInteger, IdBranch, 2, Datos_Ent) then
    qBancoTerEntrega.AsString := Datos_Ent.Nombre;
end;

procedure TfrmGestBco.qBancoTerIDMOVGetText(Sender: TField; var Text: string; DisplayText: Boolean);
begin
  if Sender.AsInteger = NUEVO_REGISTRO then
    Text := 'Nuevo'
  else
    Text := Sender.AsString;
end;

procedure TfrmGestBco.qBancoTerIDENDOSOChange(Sender: TField);
begin
  if GetDatosEnt(Sender.AsInteger, IdBranch, 1, Datos_Ent) then
    qBancoTerEndoso.AsString := Datos_Ent.Nombre;
end;

procedure TfrmGestBco.qBancoTerIDTITULARChange(Sender: TField);
begin
  if GetDatosEnt(Sender.AsInteger, IdBranch, 1, Datos_Ent) then
    qBancoTerTITULAR.AsString := Datos_Ent.Nombre;
end;

procedure TfrmGestBco.qBancoTerBeforeDelete(DataSet: TDataSet);
begin
  if not Check_Seg(Nivel_Adm, 'Cheques 3', AutorDto) then
    raise EUsuario.Create('No esta habilitado para esta funcin');
end;

procedure TfrmGestBco.dsqBancoTerDataChange(Sender: TObject; Field: TField);
begin
  if (qBancoTerSituacion.AsInteger = btEntregado) then
  begin
    if Trim(qBancoTerNROCOMPOP.AsString) > Vacio then
      lblSituacionChTer.Caption := 'Entregado OP '+qBancoTerNROCOMPOP.AsString
    else
      lblSituacionChTer.Caption := 'Entregado ';
    lblSituacionChTer.Visible := True;
  end
  else begin
    if (qBancoTerSituacion.AsInteger = btDepositado) then
    begin
      lblSituacionChTer.Caption := 'Depositado ';
      lblSituacionChTer.Visible := True;
    end
    else begin
      lblSituacionChTer.Caption := '';
      lblSituacionChTer.Visible := False;
    end;
  end;
end;

procedure TfrmGestBco.btnFirstProClick(Sender: TObject);
begin
  qBancoProp.Close;
  qBancoProp.ParamByName('IdMov').AsInteger := BancoPropFirst;
  qBancoProp.Open;
end;

procedure TfrmGestBco.btnPriorProClick(Sender: TObject);
begin
  ActPro := BancoPropPrior(qBancoPropIDMOV.AsInteger);
  qBancoProp.Close;
  qBancoProp.ParamByName('IdMov').AsInteger := ActPro;
  qBancoProp.Open;
end;

procedure TfrmGestBco.btnNextProClick(Sender: TObject);
begin
  ActPro := BancoPropNext(qBancoPropIDMOV.AsInteger);
  qBancoProp.Close;
  qBancoProp.ParamByName('IdMov').AsInteger := ActPro;
  qBancoProp.Open;
end;

procedure TfrmGestBco.btnLastProClick(Sender: TObject);
begin
  qBancoProp.Close;
  qBancoProp.ParamByName('IdMov').AsInteger := BancoPropLast;
  try
    qBancoProp.Open;
  Except
    on E:Exception do
      raise EUSuario.Create(E.Message);
  end;
end;

procedure TfrmGestBco.btnInsertProClick(Sender: TObject);
begin
  if qBancoProp.State in dsEditModes then
    qBancoProp.Post;
  AltaPro := True;
  cbBancoProp.SetFocus;
  qBancoProp.Insert;
end;

procedure TfrmGestBco.btnModProClick(Sender: TObject);
begin
  AltaPro := False;
  cbBancoProp.SetFocus;
  qBancoProp.Edit;
end;

procedure TfrmGestBco.btnSaveProClick(Sender: TObject);
begin
  ActTer := qBancoTerIDMOV.AsInteger;
  ActPro := qBancoPropIDMOV.AsInteger;
  try
    if not qBancoProp.Transaction.InTransaction then
      qBancoProp.Transaction.StartTransaction;
    if qBancoProp.State in dsEditModes then
      qBancoProp.Post;
    qBancoProp.Transaction.Commit;
  except
    on E:Exception do
    begin
      qBancoProp.Transaction.Rollback;
      raise EUsuario.Create(E.Message);
    end;
  end;
  ShowMessage('Ok. Bancos.- ');

  if ActPro = NUEVO_REGISTRO then
  begin
    qBancoProp.Close;
    qBancoProp.ParamByName('IdMov').AsInteger := BancoPropLast;
    qBancoProp.Open;
  end
  else begin
    qBancoProp.Close;
    qBancoProp.ParamByName('IdMov').AsInteger := ActPro;
    qBancoProp.Open;
  end;
  qBancoTer.Close;
  qBancoTer.ParamByName('IdMov').AsInteger := ActPro;
  qBancoTer.Open;
  AltaPro := False;
end;

procedure TfrmGestBco.btnCancelProClick(Sender: TObject);
begin
  if qBancoProp.State in dsEditModes then
    qBancoProp.Cancel;
end;

procedure TfrmGestBco.btnBuscarProClick(Sender: TObject);
var
  Encontrado: TSearchMovBco;
begin
  ActPro := qBancoPropIDMOV.AsInteger;
  if BuscarMovBanco(bbBancoProp, 'Busqueda de Movimientos propios', Encontrado) then
  begin
    if Encontrado.Mov > NoEncontrado then
    begin
      qBancoProp.Close;
      qBancoProp.ParamByName('IdMov').AsInteger := Encontrado.Mov;
      qBancoProp.Open;
    end
    else begin
      qBancoProp.Close;
      qBancoProp.ParamByName('IdMov').AsInteger := ActPro;
      qBancoProp.Open;
    end
  end;
end;

procedure TfrmGestBco.btnDelTranClick(Sender: TObject);
begin
  //
end;

procedure TfrmGestBco.btnAnularProClick(Sender: TObject);
begin
  AltaPro := False;
  ActPro := qBancoPropIdMov.AsInteger;
  if not qBancoPropFECHARESUMEN.IsNull then
    raise EUsuario.Create('El Movimiento esta conciliado');
  if Application.MessageBox('Anula el Movimiento?', 'Bancos', MB_ICONQUESTION+MB_YESNO) = ID_YES then
    Grabar_Cheque_Anulado(qBancoPropIdMov.AsInteger, 1);
  qBancoProp.Close;
  qBancoProp.ParamByName('IdMov').AsInteger := BancoPropPrior(ActPro);
  qBancoProp.Open;
end;

procedure TfrmGestBco.btnImpProClick(Sender: TObject);
Var
  Parte1, Parte2: St80;
begin
  if GetDatosChequesP(qBancoPropIDMOV.AsInteger, DatosChqP) then
  begin
    if DatosChqP.MPIm then
    begin
      with dmSaveFile do
      begin
        if ChqModel.Active then
          ChqModel.EmptyDataSet
        else
          ChqModel.CreateDataSet;
        N_A_L('', DatosChqP.Mont, 80, '*', Parte1, Parte2);
        ChqModel.Append;
        ChqModelChNroChq.AsString :=  IntToStr(DatosChqP.NChq);
        ChqModelChMonto.AsCurrency := DatosChqP.Mont;
        ChqModelChDiaEmi.AsInteger := DayOf(DatosChqP.Emis);
        ChqModelChMesEmi.AsString :=  LongMonthNames[MonthOf(DatosChqP.Emis)];
        ChqModelChAnoEmi.AsInteger := YearOf(DatosChqP.Emis);
        ChqModelChDiaVto.AsInteger := DayOf(DatosChqP.Venc);
        ChqModelChMesVto.AsString :=  LongMonthNames[MonthOf(DatosChqP.Venc)];
        ChqModelChAnoVto.AsInteger := YearOf(DatosChqP.Venc);
        ChqModelChTitular.AsString := DatosChqP.DMov;
        ChqModelChPesos1.AsString := Parte1;
        ChqModelChPesos2.AsString := Parte2;
        ChqModelChFirma.AsString := Vacio;
        ChqModelChCruzado.AsBoolean := False;
        ChqModel.Post;
        lstModelChq.DeviceType := 'Screen';
        if Application.MessageBox('Prepare impresora y formulario de cheques. ',
           PChar('Cheque N '+ChqModelChNroChq.AsString) ,MB_ICONQUESTION+MB_YESNO) = ID_YES then
          lstModelChq.Print;
      end;
    end;
  end;
end;

procedure TfrmGestBco.btnEliminarProClick(Sender: TObject);
begin
  if not Check_Seg(Nivel_Mod, 'BcoProp', AutorDto) then
    raise EUsuario.Create('No esta habilitado para esta funcin');
  if Application.MessageBox('Elimina definitivamente el Movimiento?',
     'Bancos', MB_ICONQUESTION+MB_YESNO) = ID_YES then
  begin
    ActPro := qBancoPropIDMOV.AsInteger;
    ActTer := qBancoTerIDMOV.AsInteger;
    try
      if not qBancoProp.Transaction.InTransaction then
        qBancoProp.Transaction.StartTransaction;
      qBancoProp.Edit;
      qBancoPropESTADO.AsInteger := 999;
      qBancoProp.Post;
      qBancoProp.Transaction.Commit;
    except
      on E:Exception do
      begin
        qBancoProp.Transaction.Rollback;
        raise EUsuario.Create(E.Message);
      end;
    end;
    ShowMessage('Eliminacin movimiento. OK ');
    qBancoProp.Close;
    qBancoProp.ParamByName('IdMov').AsInteger := BancoPropPrior(ActPro);
    qBancoProp.Open;

    qBancoTer.Close;
    qBancoTer.ParamByName('IdMov').AsInteger := ActTer;
    qBancoTer.Open;
  end;
end;

procedure TfrmGestBco.btnEliminarTerClick(Sender: TObject);
begin
  if Application.MessageBox('Elimina definitivamente el Movimiento?',
     'Cartera', MB_ICONQUESTION+MB_YESNO) = ID_YES then
  begin
    ActPro := qBancoPropIDMOV.AsInteger;
    ActTer := qBancoTerIDMOV.AsInteger;
    try
      if not qBancoTer.Transaction.InTransaction then
        qBancoTer.Transaction.StartTransaction;
      qBancoTer.Edit;
      qBancoTerSITUACION.AsInteger := 999;
      qBancoTer.Post;
      qBancoTer.Transaction.Commit;
    except
      on E:Exception do
      begin
        qBancoTer.Transaction.Rollback;
        raise EUsuario.Create(E.Message);
      end;
    end;
    ShowMessage('Eliminacin movimiento. OK ');
    qBancoProp.Close;
    qBancoProp.ParamByName('IdMov').AsInteger := ActPro;
    qBancoProp.Open;

    qBancoTer.Close;
    qBancoTer.ParamByName('IdMov').AsInteger := BancoTerPrior(ActPro);
    qBancoTer.Open;
  end;
end;

procedure TfrmGestBco.btnPriorTerClick(Sender: TObject);
begin
  ActTer := BancoTerPrior(qBancoTerIDMOV.AsInteger);
  qBancoTer.Close;
  qBancoTer.ParamByName('IdMov').AsInteger := ActTer;
  qBancoTer.Open;
end;

procedure TfrmGestBco.btnRefrescarTBClick(Sender: TObject);
begin
  qTransRel.Close;
  qTransRel.Open;
end;

procedure TfrmGestBco.btnNextTerClick(Sender: TObject);
begin
  ActTer := BancoTerNext(qBancoTerIDMOV.AsInteger);
  qBancoTer.Close;
  qBancoTer.ParamByName('IdMov').AsInteger := ActTer;
  qBancoTer.Open;
end;

procedure TfrmGestBco.btnLastTerClick(Sender: TObject);
begin
  qBancoTer.Close;
  qBancoTer.ParamByName('IdMov').AsInteger := BancoTerLast;
  qBancoTer.Open;
end;

procedure TfrmGestBco.btnInsertTerClick(Sender: TObject);
begin
  if qBancoTer.State in dsEditModes then
    qBancoTer.Post;
  AltaTer := True;
  edtNomBcoTer.SetFocus;
  qBancoTer.Insert;
end;

procedure TfrmGestBco.btnSaveTerClick(Sender: TObject);
begin
  ActPro := qBancoPropIDMOV.AsInteger;
  ActTer := qBancoTerIDMOV.AsInteger;
  try
    if not qBancoTer.Transaction.InTransaction then
      qBancoTer.Transaction.StartTransaction;
    if qBancoTer.State in dsEditModes then
      qBancoTer.Post;
    qBancoTer.Transaction.Commit;
  except
    qBancoTer.Transaction.Rollback;
  end;
  ShowMessage('Ok. En cartera.');

  if ActTer = NUEVO_REGISTRO then
  begin
    qBancoTer.Close;
    qBancoTer.ParamByName('IdMov').AsInteger := BancoTerLast;
    qBancoTer.Open;
  end
  else begin
    qBancoTer.Close;
    qBancoTer.ParamByName('IdMov').AsInteger := ActTer;
    qBancoTer.Open;
  end;
  AltaTer := False;
  qBancoProp.Close;
  qBancoProp.ParamByName('IdMov').AsInteger := ActPro;
  qBancoProp.Open;
end;

procedure TfrmGestBco.btnEditTerClick(Sender: TObject);
begin
  qBancoTer.Edit;
  AltaTer := False;
  edtNomBcoTer.SetFocus;
end;

procedure TfrmGestBco.btnCancelTerClick(Sender: TObject);
begin
  AltaTer := False;
  if qBancoTer.State in dsEditModes then
    qBancoTer.Cancel;
end;

procedure TfrmGestBco.btnBuscarTerClick(Sender: TObject);
var
  Encontrado: TSearchMovBco;
begin
  ActTer := qBancoTerIDMOV.AsInteger;
  if BuscarMovBanco(bbBancoTer, 'Busqueda de Movimientos de Terceros', Encontrado) then
  begin
    if Encontrado.Mov > NoEncontrado then
    begin
      qBancoTer.Close;
      qBancoTer.ParamByName('IdMov').AsInteger := Encontrado.Mov;
      qBancoTer.Open;
    end
    else begin
      qBancoTer.Close;
      qBancoTer.ParamByName('IdMov').AsInteger := ActTer;
      qBancoTer.Open;
    end
  end;
end;

procedure TfrmGestBco.btnAnularTerClick(Sender: TObject);
var
  mensaje: String;
begin
  AltaTer := False;
  ActTer := qBancoTerIdMov.AsInteger;
  mensaje := Vacio;
  case qBancoTerSITUACION.AsInteger of
    btEntregado : mensaje := 'El Movimiento esta Entregado. ';
    btDepositado: mensaje := 'El Movimiento esta Depositado.';
    btCobrado: mensaje := 'El Movimiento ya ha sido Cobrado.';
  end;
  if (not qBancoTerSITUACION.AsInteger in [btEntregado, btDepositado, btCobrado]) then
    raise EUsuario.Create(mensaje);

  if Application.MessageBox('Anula el Movimiento?', 'Cartera', MB_ICONQUESTION+MB_YESNO) = ID_YES then
    Grabar_Cheque_Anulado(qBancoTerIdMov.AsInteger, 2);
  qBancoTer.Close;
  qBancoTer.ParamByName('IdMov').AsInteger := BancoTerPrior(ActTer);
  qBancoTer.Open;
end;

procedure TfrmGestBco.btnFirstTerClick(Sender: TObject);
begin
  qBancoTer.Close;
  qBancoTer.ParamByName('IdMov').AsInteger := BancoTerFirst;
  qBancoTer.Open;
end;

procedure TfrmGestBco.btnModRepChkClick(Sender: TObject);
begin
  try
    if (not dmGestion.BancosREPORTE.IsNull) then
    begin
      dmGestion.Bancos.Edit;
      dmGestion.BancosMODNAME.AsString := dmGestion.BancosIDBANCO.AsString;
      dmGestion.Bancos.Post;
      dmSaveFile.lstModelChq.Template.FileName := dmGestion.BancosMODNAME.AsString;
      dmSaveFile.lstModelChq.Template.DatabaseSettings.Name := dmGestion.BancosMODNAME.AsString;
      dmSaveFile.lstModelChq.Template.LoadFromDatabase;
    end;
    dmSaveFile.dsgModelChq.ShowModal;
    dmSaveFile.lstModelChq.Template.FileName := dmGestion.BancosMODNAME.AsString;
    dmSaveFile.lstModelChq.Template.DatabaseSettings.Name := dmGestion.BancosMODNAME.AsString;
    dmSaveFile.lstModelChq.Template.SaveToDatabase;
  except
    on E:Exception do
      raise EUsuario.Create('Error grabando modelo de cheque: '+E.Message);
  end;
end;

//********************************** TRANSFERENCIAS BANCARIAS ******************
procedure TfrmGestBco.SaveTranB;
Const
  InChq = 'Insert InTo '+
          'BancoProp(IdMov, IdBanco, TipoMov, NroCheque, FechaEmision, '+
          '          FechaVencimiento, IdOrdPago, IdEntidad, DetalleMov, '+
          '          Monto, Usuario, IdFactura, IdSucursal, Estado, '+
          '          IdNroConciliacion, IdEmpresa) '+
          'Values(:IdMov, :IdBanco, :TipoMov, :NroCheque, :FechaEmision, '+
          '       :FechaVencimiento, :IdOrdPago, :IdEntidad, :DetalleMov, '+
          '       :Monto, :Usuario, :IdFactura, :IdSucursal, :Estado, '+
          '       :IdNroConciliacion, :IdEmpresa) ';
var
  IdOrgBP, IdDesBP, IdUltTB: Integer;
  q, s: TMDOQuery;
  u, l, t: Integer;
begin
  IdOrgBP := 0;
  IdDesBP := 0;
  IdUltTB := 0;
  if Add_Trans then
  begin
    ActPro := qBancoPropIDMOV.AsInteger;
    ActTer := qBancoTerIDMOV.AsInteger;

    if TBank.State in dsEditModes then
      TBank.Post;
    if ItemsT_B.State in dsEditModes then
      ItemsT_B.Post;
    try
      if not dmGestion.trProc.InTransaction then
        dmGestion.trProc.StartTransaction;
      //Extraccion
      try
        s := TMDOQuery.Create(nil);
        s.Database := dmGestion.dbGestion;
        s.Transaction := dmGestion.trProc;
        s.SQL.Add('Select Max(IdMov) as Ultimo ');
        s.SQL.Add('From BancoProp ');
        s.Open;
        IdOrgBP := s.FieldByName('Ultimo').AsInteger + 1;
        s.Close;
      finally
        s.Free;
      end;

      try
        q := TMDOQuery.Create(nil);
        q.Database := dmGestion.dbGestion;
        q.Transaction := dmGestion.trProc;
        q.SQL.Text := InChq;
        q.Close;
        q.ParamByName('IdMov').AsInteger := IdOrgBP;
        q.ParamByName('IdBanco').AsInteger := TBankIdCtaOrg.AsInteger;
        q.ParamByName('TipoMov').AsInteger := bpExtraccion;
        q.ParamByName('NroCheque').AsInteger := 0;
        q.ParamByName('FechaEmision').AsDate := TBankFechaT.AsDateTime;
        q.ParamByName('FechaVencimiento').AsDate := TBankFechaT.AsDateTime;
        q.ParamByName('IdOrdPago').AsInteger := DatosPago.IdOrdPago;
        q.ParamByName('IdEntidad').AsInteger := 0;
        q.ParamByName('DetalleMov').AsString := 'Transf.A/'+ cbCtaDes.Text;
        q.ParamByName('Monto').AsCurrency := TBankMontoT.AsCurrency;
        q.ParamByName('Usuario').AsInteger := Usuario;
        q.ParamByName('IdFactura').AsInteger := 0;
        q.ParamByName('IdSucursal').AsInteger := IdBranch;
        q.ParamByName('Estado').AsInteger := 0;
        q.ParamByName('IdNroConciliacion').AsInteger := 0;
        q.ParamByName('IdEmpresa').AsInteger := 0;
        q.ExecSQL;
      finally
        q.Free;
      end;

      //Deposito
      try
        s := TMDOQuery.Create(nil);
        s.Database := dmGestion.dbGestion;
        s.Transaction := dmGestion.trProc;
        s.SQL.Add('Select Max(IdMov) as Ultimo ');
        s.SQL.Add('From BancoProp ');
        s.Open;
        IdDesBP := s.FieldByName('Ultimo').AsInteger + 1;
        s.Close;
      finally
        s.Free;
      end;

      try
        q := TMDOQuery.Create(nil);
        q.Database := dmGestion.dbGestion;
        q.Transaction := dmGestion.trProc;
        q.SQL.Text := InChq;
        q.Close;
        q.ParamByName('IdMov').AsInteger := IdDesBP;
        q.ParamByName('IdBanco').AsInteger := TBankIdCtaDes.AsInteger;
        q.ParamByName('TipoMov').AsInteger := bpDeposito;
        q.ParamByName('NroCheque').AsInteger := 0;
        q.ParamByName('FechaEmision').AsDate := TBankFechaT.AsDateTime;
        q.ParamByName('FechaVencimiento').AsDate := TBankFechaT.AsDateTime;
        q.ParamByName('IdOrdPago').AsInteger := DatosPago.IdOrdPago;
        q.ParamByName('IdEntidad').AsInteger := 0;
        q.ParamByName('DetalleMov').AsString := 'Transf.D/'+ cbCtaDes.Text;
        q.ParamByName('Monto').AsCurrency := TBankMontoT.AsCurrency;
        q.ParamByName('Usuario').AsInteger := Usuario;
        q.ParamByName('IdFactura').AsInteger := 0;
        q.ParamByName('IdSucursal').AsInteger := IdBranch;
        q.ParamByName('Estado').AsInteger := 0;
        q.ParamByName('IdNroConciliacion').AsInteger := 0;
        q.ParamByName('IdEmpresa').AsInteger := 0;
        q.ExecSQL;
      finally
        q.Free;
      end;

      try
        s := TMDOQuery.Create(nil);
        s.Database := dmGestion.dbGestion;
        s.Transaction := dmGestion.trProc;
        s.SQL.Add('Select Max(IdTBank) as Ultimo ');
        s.SQL.Add('From TRANSBANK ');
        s.Open;
        IdUltTB := s.FieldByName('Ultimo').AsInteger + 1;
        s.Close;
      finally
        s.Free;
      end;

      try
        q := TMDOQuery.Create(nil);
        q.Database := dmGestion.dbGestion;
        q.Transaction := dmGestion.trProc;
        q.SQL.Add('INSERT INTO TRANSBANK ');
        q.SQL.Add('  (IDTBANK, IDCTAORG, IDMOVORG, IDCTADES, IDMOVDES, ');
        q.SQL.Add('   MONTOT, FECHAT, USUARIO, ESTADO, CANTMOV) ');
        q.SQL.Add('VALUES ');
        q.SQL.Add('  (:IDTBANK, :IDCTAORG, :IDMOVORG, :IDCTADES, :IDMOVDES, ');
        q.SQL.Add('   :MONTOT, :FECHAT, :USUARIO, :ESTADO, :CANTMOV) ');
        q.ParamByName('IDTBANK').AsInteger :=  IdUltTB;
        q.ParamByName('IDCTAORG').AsInteger := TBankIdCtaOrg.AsInteger;
        q.ParamByName('IDMOVORG').AsInteger := IdOrgBP;
        q.ParamByName('IDCTADES').AsInteger := TBankIdCtaDes.AsInteger;
        q.ParamByName('IDMOVDES').AsInteger := IdDesBP;
        q.ParamByName('MONTOT').AsCurrency := TBankMontoT.AsCurrency;
        q.ParamByName('FECHAT').AsDate := TBankFechaT.AsDateTime;
        q.ParamByName('USUARIO').AsInteger := Usuario;
        q.ParamByName('ESTADO').AsInteger := 0;
        q.ParamByName('CANTMOV').AsInteger := TBankCantMov.AsInteger;
        q.ExecSQL;
      finally
        q.Free;
      end;

      ItemsT_B.First;
      while not ItemsT_B.Eof do
      begin
        try
          q := TMDOQuery.Create(nil);
          q.Database := dmGestion.dbGestion;
          q.Transaction := dmGestion.trProc;
          q.SQL.Add('INSERT INTO ');
          q.SQL.Add('TBITEMS (IDTBANK, IDITEMTB, FECHA, DETALLE, MONTO) ');
          q.SQL.Add('VALUES (:IDTBANK, :IDITEMTB, :FECHA, :DETALLE, :MONTO) ');
          q.ParamByName('IDTBANK').AsInteger := IdUltTB;
          q.ParamByName('IDITEMTB').AsInteger := ItemsT_BIdItem.AsInteger;
          q.ParamByName('FECHA').AsDate := ItemsT_BFechaT.AsDateTime;
          q.ParamByName('DETALLE').AsString := ItemsT_BDetalle.AsString;
          q.ParamByName('MONTO').AsCurrency := ItemsT_BMonto.AsCurrency;
          q.ExecSQL;
          q.Close;
        finally
          q.Free;
        end;
        ItemsT_B.Next;
      end;
      dmGestion.trProc.Commit;
    except
      on E:Exception do
      begin
        dmGestion.trProc.Rollback;
        raise EUsuario.Create('Error grabando tranferencia bancaria: '+E.Message);
      end;
    end;
    Add_Trans := False;
    qBancoProp.Close;
    qBancoProp.ParamByName('IdMov').AsInteger := BancoPropPrior(ActPro);
    qBancoProp.Open;

    qBancoTer.Close;
    qBancoTer.ParamByName('IdMov').AsInteger := BancoTerPrior(ActPro);
    qBancoTer.Open;

    qConcR.Close;
    qConcR.Open;

    qTransRel.Close;
    qTransRel.Open;
  end;
end;

procedure TfrmGestBco.LoadTranB;
var
  IdOrgBP,
  IdDesBP, j: Integer;
  q: TMDOQuery;
begin
  try
    Load_Trans := True;
    if TBank.Active then
      TBank.EmptyDataSet
    else
      TBank.CreateDataSet;
    if ItemsT_B.Active then
      ItemsT_B.EmptyDataSet
    else
      ItemsT_B.CreateDataSet;
    with dmSaveFile do
    begin
      if not TransBank.Active then
        TransBank.Open;
      Add_Trans := False;
      // Cargar Extraccion
      TBank.Append;
      TBankIdTransBank.AsInteger := qTransRelIdTBank.AsInteger;
      TBankIdCtaOrg.AsInteger := qTransRelIdCtaOrg.AsInteger;
      TBankFechaT.AsDateTime := qTransRelFechaT.AsDateTime;
      TBankMontoT.AsCurrency := qTransRelMontoT.AsCurrency;
      // Cargar Debito
      TBankIdCtaDes.AsInteger := qTransRelIdCtaDes.AsInteger;
      // Leer Detalles
      if qTransRelCantMov.AsInteger > 0 then
      begin
        j := 0;
        try
          q := TMDOQuery.Create(nil);
          q.Database := dmGestion.dbGestion;
          q.Transaction := dmSaveFile.trSaveComp;
          q.SQL.Add('Select * ');
          q.SQL.Add('From TBItems ');
          q.SQL.Add('Where IdTBank =:IdTB ');
          q.ParamByName('IdTB').AsInteger := qTransRelIdTBank.AsInteger;
          q.Open;
          if not q.IsEmpty then
          begin
            q.First;
            while not q.Eof do
            begin
              ItemsT_B.Append;
              ItemsT_BIdTransBank.AsInteger := q.FieldByName('IdTBank').AsInteger;
              ItemsT_BIdItem.AsInteger := q.FieldByName('IdItemTB').AsInteger;
              ItemsT_BFechaT.AsDateTime := q.FieldByName('Fecha').AsDateTime;
              ItemsT_BDetalle.AsString := q.FieldByName('Detalle').AsString;
              ItemsT_BMonto.AsCurrency := q.FieldByName('Monto').AsCurrency;
              ItemsT_B.Post;
              Inc(j);
              q.Next;
            end;
            q.Close;
          end;
        finally
          q.Free;
        end;
      end;
      TotalTransB := TBankMontoT.AsCurrency;
      TBankCantMov.AsInteger := j;
      TBank.Post;
      gMovTran.ColumnByName('Detalle').FooterValue := 'Total';
      gMovTran.ColumnByName('Monto').FooterValue := Format('%m', [TotalTransB]);
    end;
  finally
    Load_Trans := False;
  end;
end;

procedure TfrmGestBco.UpdateTotalsTransB;
begin
  if not Load_Trans then
  begin
    try
      ItemsT_B.First;
      TotalTransB := 0;
      TotalItems := 0;
      while not ItemsT_B.Eof do
      begin
        TotalTransB := TotalTransB + ItemsT_BMonto.AsCurrency;
        Inc(TotalItems);
        ItemsT_B.Next;
      end;
      if not (TBank.State in dsEditModes) then
        TBank.Edit;
      TBankCantMov.AsInteger := TotalItems;
    finally
      ItemsT_B.Last;
      gMovTran.ColumnByName('Detalle').FooterValue := 'Total';
      gMovTran.ColumnByName('Monto').FooterValue := Format('%m', [TotalTransB]);
    end;
  end;
end;

procedure TfrmGestBco.gMovTranUpdateFooter(Sender: TObject);
begin
  gMovTran.ColumnByName('Detalle').FooterValue := 'Total';
  gMovTran.ColumnByName('Monto').FooterValue := Format('%m', [TotalTransB]);
end;

procedure TfrmGestBco.btnNewTranClick(Sender: TObject);
begin
  if TBank.Active then
    TBank.EmptyDataSet
  else
    TBank.CreateDataSet;
  if ItemsT_B.Active then
    ItemsT_B.EmptyDataSet
  else
    ItemsT_B.CreateDataSet;
  TBank.Insert;
  cbCtaOrg.SetFocus;
  Add_Trans := True;
  btnSaveTran.Enabled := True;
end;

procedure TfrmGestBco.btnCancelTranClick(Sender: TObject);
begin
  if (TBank.Active) and
     (Add_Trans) and
     (TBank.State in dsEditModes) then
  begin
    TBank.EmptyDataSet;
    ItemsT_B.EmptyDataSet;
  end;
end;

procedure TfrmGestBco.btnSaveTranClick(Sender: TObject);
begin
  SaveTranB;
end;

procedure TfrmGestBco.btnImpTransClick(Sender: TObject);
begin
  lblTituloTB.Caption := OwnerName + ' Transferencias entre Cuentas';
  rpTransBank.Print;
end;

procedure TfrmGestBco.cbCtaOrgKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  {$INCLUDE IyC_NextEdit.Inc}
end;

procedure TfrmGestBco.edtMtoTranKeyPress(Sender: TObject; var Key: Char);
begin
  if Key in [',', '.'] then
    Key := DecimalSeparator;
end;

procedure TfrmGestBco.gLibBcoCalcCellColors(Sender: TObject; Field: TField;
    State: TGridDrawState; Highlight: Boolean; AFont: TFont; ABrush: TBrush);
begin
  if cdsLibBcoSUMA_O_RESTA.AsInteger > 0 then
  begin
    if not Highlight then
      AFont.Color := clGreen;
  end
  else begin
    if not Highlight then
      AFont.Color := clRed;
  end;
end;

procedure TfrmGestBco.gLibBcoDblClick(Sender: TObject);
begin
  if cdsLibBcoIdMov.AsInteger > 0 then
  begin
    Get_ModBco(cdsLibBcoIdMov.AsInteger)
  end;
end;

procedure TfrmGestBco.gMovTranEnter(Sender: TObject);
begin
  if TBank.State in [dsEdit, dsInsert] then
    TBank.Post;
  TBank.Edit;
end;

procedure TfrmGestBco.gMovTranKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Shift = [] then
  begin
    Case Key of
      VK_RIGHT,
      VK_RETURN,
      VK_TAB : Atras := False;
      VK_LEFT: Atras := True;
      VK_ESCAPE: btnSaveTran.SetFocus;
      else inherited KeyDown(Key, Shift);
    end;
  end;
end;

procedure TfrmGestBco.gMovTranKeyPress(Sender: TObject; var Key: Char);
begin
  if (gMovTran.SelectedField.DataType in [ftFloat, ftCurrency])and
     (Key in [',', '.']) then
    Key := DecimalSeparator;
end;

procedure TfrmGestBco.TBankAfterPost(DataSet: TDataSet);
begin
  qTransRel.Open;
end;

procedure TfrmGestBco.TBankNewRecord(DataSet: TDataSet);
begin
  TBankMontoT.AsCurrency := 0;
  TBankCantMov.AsInteger := 0;
  TBankFechaT.AsDateTime := Date;
end;

procedure TfrmGestBco.ItemsT_BAfterPost(DataSet: TDataSet);
begin
  UpdateTotalsTransB
end;

procedure TfrmGestBco.ItemsT_BNewRecord(DataSet: TDataSet);
begin
  if VarIsNull(ItemsT_BCantIt.Value) then
    ItemsT_BIdItem.AsInteger := 1
  else
    ItemsT_BIdItem.AsInteger := ItemsT_BCantIt.Value + 1;
  ItemsT_BMonto.AsCurrency := 0;
end;

procedure TfrmGestBco.gTransRelDblClick(Sender: TObject);
begin
  LoadTranB;
end;

(*
Select B.IdBanco, B.IdMov, B.IdEntidad, B.TipoMov,
       B.FechaEmision, B.NroCheque, B.FechaVencimiento,
       B.DetalleMov, B.Monto, T.TipoMovBco as DetTipoMov,
       E.Banco as NomBanco, E.NroCta as NumCuenta
From BancoProp B
Left Outer Join TipoMovBco T
  on T.IdMovBco = B.TipoMov
Join Bancos E
  on E.IdBanco = B.IdBanco
Where (B.FechaResumen < '01/01/2000') And (B.TipoMov = 1) And
      (B.FechaVencimiento between '11/01/2008' and '11/30/2008')
Order By B.FechaVencimiento

*)

end.
