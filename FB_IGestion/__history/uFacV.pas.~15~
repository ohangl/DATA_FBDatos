unit uFacV;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs, Math,
  Db, ExtCtrls, StdCtrls, Mask, DBCtrls, wwdblook, Wwdbigrd, Wwdbgrid, ShellApi,
  Buttons, uTools, Wwdbdlg, wwdbedit, Wwdotdot, Wwdbcomb, wwdbdatetimepicker,
  Wwintl, Variants, Menus, XPMenu, Provider, DBClient, Grids, ActnList, RzButton,
  RzPanel, MDOCustomDataSet, MDOQuery, RzCmboBx, RzDBCmbo, RzRadChk, RzLabel,
  RzStatus, RzCommon, RzDBStat, RzTabs;

type
  TfrmFacV = class(TForm)
    xpmFacVen: TXPMenu;

    wwIyC: TwwIntl;
    gbHeader: TRzGroupBox;
    alFacVen: TActionList;
    aCierreZ: TAction;
    aNotaDeCreditos: TAction;
    aSearchCli: TAction;
    aComprobantes_Emitidos: TAction;
    aCierreX: TAction;
    aCancelarAll: TAction;
    aAltaCli: TAction;
    aPtoVtas: TAction;
    aFondos: TAction;
    aFinanciaciones: TAction;
    aServerFiscal: TAction;
    aConsPrec: TAction;
    aSenas: TAction;
    aSucursales: TAction;
    aConsignaciones: TAction;
    aRemitos: TAction;
    aPresupuestos: TAction;
    aNotaDeDebitos: TAction;

    pnlTipoComp: TRzPanel;
    lblEntidad: TLabel;
    edtCliente: TwwDBEdit;
    lblNomCli: TDBText;
    lblEmpleado: TLabel;
    lblDatosCli: TLabel;
    edtEmpleado: TwwDBEdit;
    bvlEmpleado: TBevel;
    lblNombreEmpleado: TDBText;
    lblComprobante: TLabel;
    edtComprobante: TwwDBEdit;
    lblCompRef: TLabel;
    edtCompRef: TwwDBEdit;
    lblFecha: TLabel;
    edtFechaHoy: TwwDBDateTimePicker;
    gbFootComp: TRzGroupBox;
    gbItems: TRzGroupBox;
    gFacV: TwwDBGrid;
    lblTipoCF: TRzLabel;
    lblDomEnt: TLabel;
    edtDomEnt: TwwDBEdit;
    lblNCtas: TLabel;
    edtNCtas: TwwDBEdit;
    lblTarjeta: TLabel;
    cbTarjetas: TwwDBLookupCombo;
    lblSubDep: TLabel;
    cbSubDep: TwwDBComboBox;
    sbFacV: TRzStatusBar;
    btnSalir: TRzBitBtn;
    sbFVen1: TRzStatusPane;
    clkFacVen: TRzClockStatus;
    sbFVenCantArt: TRzDBStatusPane;
    lblEntCont: TLabel;
    edtEntCont: TwwDBEdit;
    FacVContado: TCurrencyField;
    pcTotFacV: TRzPageControl;
    tsTotales: TRzTabSheet;
    tsOperDia: TRzTabSheet;
    gbDiscriminacion: TRzGroupBox;
    lblMtoNC: TDBText;
    lblMtoIva1: TDBText;
    lblNoComp: TLabel;
    lblIvaAlc1: TLabel;
    blDisc1: TBevel;
    blDisc2: TBevel;
    lblSubTotal: TLabel;
    lblMtoNeto: TDBText;
    lblIvaAlc2: TLabel;
    lblMtoIva2: TDBText;
    gbAvisos: TRzGroupBox;
    lblAvisoFac: TRzLabel;
    gbTotales: TRzGroupBox;
    lblTotalF: TDBText;
    lblTotal: TLabel;
    bvlTot: TBevel;
    lblModoFacturacionNC: TRzLabel;
    gbVuelto: TRzGroupBox;
    lblTotalOp: TLabel;
    lblPagado: TLabel;
    lblVuelto: TLabel;
    lblTotAnt: TLabel;
    lblPagoAnt: TLabel;
    lblVueltoAnt: TLabel;
    bvlVto1: TBevel;
    bvlVto2: TBevel;
    gbNotasCreditos: TRzGroupBox;
    lblNCCliente: TLabel;
    lblCompOr_NC: TLabel;
    lblNCNomCli: TLabel;
    pnlNCFoot: TRzPanel;
    btnNCCerrar: TRzBitBtn;
    edtNCCliente: TwwDBEdit;
    btnNCSinComp: TRzBitBtn;
    gFacVenEnc: TwwDBGrid;
    edtNCNroComp: TwwDBEdit;
    gCompRealizados: TwwDBGrid;

    mmVentas: TMainMenu;
    ControladorFiscal: TMenuItem;
    CierrediarioZ: TMenuItem;
    CierreparcialX: TMenuItem;
    CancelarTodo: TMenuItem;
    Comprobantes: TMenuItem;
    NotasCreditos: TMenuItem;
    FacturaManual: TMenuItem;
    SenasDeClientes: TMenuItem;
    Consignaciones: TMenuItem;
    RemitosDeSalida: TMenuItem;
    PresupuestosP: TMenuItem;
    NotaDeDebitos: TMenuItem;
    Clientes: TMenuItem;
    Busqueda: TMenuItem;
    Alta: TMenuItem;
    Precios: TMenuItem;
    BuscarPrecios: TMenuItem;
    CalculoFinanciaciones: TMenuItem;
    Sistema: TMenuItem;
    ComprobantesEmitidos: TMenuItem;
    PuntodeVentas: TMenuItem;
    CajaDiaria: TMenuItem;
    Servidor_Fiscal: TMenuItem;
    Sucursales: TMenuItem;
    Salir: TMenuItem;
    tsOfertas: TRzTabSheet;
    gOfertas: TwwDBGrid;

    FacturasManuales: TMenuItem;
    aFacMan: TAction;
    aFacturaVtaManual: TAction;

    aNCreditoManual: TAction;
    NotasdeCreditosManuales: TMenuItem;

    aNDebitoManual: TAction;
    NotasdeDebitosManuales: TMenuItem;

    aRemitoManual: TAction;
    RemitosManuales: TMenuItem;

    aPresupuestoManual: TAction;
    PresupuestosManuales: TMenuItem;

    aGetOff: TAction;
    LeerOfertasSuc: TMenuItem;

    dsFacV: TDataSource;
    FacV: TClientDataSet;
    FacVIdFactura: TIntegerField;
    FacVTipoFactura: TSmallintField;
    FacVFechaF: TDateField;
    FacVFechaV: TDateField;
    FacVNroFactura: TStringField;
    FacVCliente: TIntegerField;
    FacVRetiro: TIntegerField;
    FacVTipoIva: TSmallintField;
    FacVCantArtic: TSmallintField;
    FacVNeto: TCurrencyField;
    FacVIvaAlicuota1: TCurrencyField;
    FacVIvaAlicuota2: TCurrencyField;
    FacVBonificacion: TCurrencyField;
    FacVExento: TCurrencyField;
    FacVTotal: TCurrencyField;
    FacVNombreCliente: TStringField;
    FacVPuntoVta: TSmallintField;
    FacVNoComputables: TCurrencyField;
    FacVEmpleado: TIntegerField;
    FacVNombreEmpleado: TStringField;
    FacVCompRef: TStringField;
    FacVDireccion: TStringField;
    FacVTipoDoc: TSmallintField;
    FacVNroDocumento: TStringField;
    FacVTipoIvaStr: TStringField;
    FacVLocalidad: TStringField;
    FacVTelefono: TStringField;
    FacVProvincia: TStringField;
    FacVCodPostal: TStringField;
    FacVTipoFacStr: TStringField;
    FacVTipoDocStr: TStringField;
    FacVNombreRetiro: TStringField;
    FacVTipoCompCli: TSmallintField;
    FacVIdCompRef: TIntegerField;
    FacVIdRemito: TIntegerField;
    FacVEntregaCdo: TCurrencyField;
    FacVCantCuotas: TSmallintField;
    FacVIdSucursal: TIntegerField;
    FacVIdTarjeta: TIntegerField;
    FacVIdSubDep: TIntegerField;
    FacVDomEnt: TStringField;
    FacVTipoCompRef: TSmallintField;
    FacVIdLista: TIntegerField;

    dsItemsFV: TDataSource;
    ItemsFV: TClientDataSet;
    ItemsFVIdFactura: TIntegerField;
    ItemsFVIdItem: TAutoIncField;
    ItemsFVIdArticulo: TIntegerField;
    ItemsFVMarca: TStringField;
    ItemsFVDetalle: TStringField;
    ItemsFVPrcExento: TFloatField;
    ItemsFVColor: TStringField;
    ItemsFVDescProd: TStringField;
    ItemsFVMtoImpInt: TCurrencyField;
    ItemsFVCodProd: TStringField;
    ItemsFVTieneTalle: TSmallIntField;
    ItemsFVIdPuntoVenta: TIntegerField;
    ItemsFVCantidad: TFloatField;
    ItemsFVPrcBonificacion: TFloatField;
    ItemsFVPrecioNeto: TCurrencyField;
    ItemsFVPrecioFinal: TCurrencyField;
    ItemsFVPrecioTotal: TCurrencyField;
    ItemsFVPrecioOriginal: TCurrencyField;
    ItemsFVExento: TCurrencyField;
    ItemsFVImpInt: TCurrencyField;
    ItemsFVIvaIn: TCurrencyField;
    ItemsFVAlcIva: TIntegerField;
    ItemsFVDescuento: TCurrencyField;
    ItemsFVEnRemito: TSmallIntField;
    ItemsFVPrecioCosto: TCurrencyField;
    ItemsFVGanancia: TFloatField;
    ItemsFVAlcIB: TIntegerField;
    ItemsFVIngBto: TCurrencyField;
    ItemsFVAlicuotaIva: TCurrencyField;
    ItemsFVCoefIntImp: TFloatField;
    ItemsFVServicio: TSmallIntField;
    ItemsFVAlicuotaIB: TFloatField;
    ItemsFVDetalle1: TStringField;
    ItemsFVDetalle2: TStringField;
    ItemsFVDetalle3: TStringField;
    ItemsFVDetalle4: TStringField;
    ItemsFVCantCuotas: TSmallintField;
    ItemsFVValorCta: TCurrencyField;
    ItemsFVMaxDcto: TFloatField;
    ItemsFVPrecioLista: TCurrencyField;
    ItemsFVTalle: TIntegerField;
    ItemsFVSubDet: TStringField;
    ItemsFVIdSubDep: TIntegerField;
    ItemsFVEsKit: TBooleanField;
    ItemsFVCoefEntCon: TFloatField;
    ItemsFVEntContado: TCurrencyField;
    ItemsFVPrecioOriginalFin: TCurrencyField;
    ItemsFVEnOferta: TBooleanField;
    ItemsFVMostDomi: TSmallintField;
    ItemsFVIdAutorDto: TIntegerField;
    ItemsFVIdSucSalida: TIntegerField;

    dsqComp_Ref: TDataSource;
    qComp_Ref: TMDOQuery;
    qComp_RefIDFACTURA: TIntegerField;
    qComp_RefIDSUCURSAL: TIntegerField;
    qComp_RefIDPUNTOVENTA: TIntegerField;
    qComp_RefCLIENTE: TIntegerField;
    qComp_RefNROFACTURA: TMDOStringField;
    qComp_RefTIPOFACTURA: TSmallintField;
    qComp_RefFECHAF: TDateField;
    qComp_RefNROCTAS: TIntegerField;
    qComp_RefEMPLEADO: TIntegerField;
    qComp_RefCONTADO: TMDOBCDField;
    qComp_RefTARJETA: TMDOBCDField;
    qComp_RefCTACTE: TMDOBCDField;
    qComp_RefTICKETS: TMDOBCDField;
    qComp_RefCHEQUE: TMDOBCDField;
    qComp_RefCOBSENAS: TMDOBCDField;
    qComp_RefOTROSPAGOS: TMDOBCDField;
    qComp_RefTOTAL: TMDOBCDField;
    qComp_RefIDTARJETA: TIntegerField;
    qComp_RefIDSUBDEP: TIntegerField;
    qComp_RefDESCCORTA: TMDOStringField;
    qComp_RefCANTARTIC: TSmallintField;

    qItemsFac: TMDOQuery;
    qItemsFacIDARTICULO: TIntegerField;
    qItemsFacCANTIDAD: TMDOBCDField;
    qItemsFacPRECIONETO: TMDOBCDField;
    qItemsFacPRECIOFINAL: TMDOBCDField;
    qItemsFacPRECIOTOTAL: TMDOBCDField;
    qItemsFacSUBDET: TMDOStringField;
    qItemsFacTALLE: TIntegerField;
    qItemsFacIMPINT: TMDOBCDField;
    qItemsFacIVAIN: TMDOBCDField;
    qItemsFacNROCTAS: TIntegerField;
    qItemsFacPRECIOCOSTO: TMDOBCDField;
    qItemsFacVALORLISTA: TMDOBCDField;
    qItemsFacPRCBONIFICACION: TMDOBCDField;
    qItemsFacDESCUENTO: TMDOBCDField;

    Card: TClientDataSet;
    CardIdCard: TIntegerField;
    CardDetTar: TStringField;
    CardTipoEn: TSmallintField;

    dsCompReal: TDataSource;
    dspqCompReal: TDataSetProvider;
    qCompRealizados: TMDOQuery;
    CompRealizados: TClientDataSet;
    CompRealizadosIDFACTURA: TIntegerField;
    CompRealizadosIDSUCURSAL: TIntegerField;
    CompRealizadosIDPUNTOVENTA: TIntegerField;
    CompRealizadosNROFACTURA: TStringField;
    CompRealizadosNROCTAS: TIntegerField;
    CompRealizadosCONTADO: TBCDField;
    CompRealizadosTARJETA: TBCDField;
    CompRealizadosTICKETS: TBCDField;
    CompRealizadosCHEQUE: TBCDField;
    CompRealizadosCOBSENAS: TBCDField;
    CompRealizadosOTROSPAGOS: TBCDField;
    CompRealizadosTOTAL: TBCDField;
    CompRealizadosDESCCORTA: TStringField;
    CompRealizadosNOMBRE: TStringField;
    CompRealizadosNOMVEND: TStringField;
    CompRealizadosTotCon: TAggregateField;
    CompRealizadosTotTkt: TAggregateField;
    CompRealizadosTotTar: TAggregateField;
    CompRealizadosTotChq: TAggregateField;
    CompRealizadosTotOtP: TAggregateField;
    CompRealizadosTotSen: TAggregateField;
    CompRealizadosTotVen: TAggregateField;

    dsqOfertas: TDataSource;
    qOfertas: TMDOQuery;
    qOfertasIDARTICULO: TIntegerField;
    qOfertasCANTCTAS: TIntegerField;
    qOfertasFECHAALTA: TDateField;
    qOfertasFECHAFIN: TDateField;
    qOfertasPRECIO: TMDOBCDField;
    qOfertasVALORCTAS: TMDOBCDField;
    qOfertasMARCA: TMDOStringField;
    qOfertasDETALLE: TMDOStringField;
    qOfertasCODBARRA: TMDOStringField;
    qOfertasIDSUCURSAL: TIntegerField;
    qOfertasCANTAUT: TIntegerField;
    qOfertasCANTVEN: TIntegerField;

    aABMCli: TAction;
    ABMClientes: TMenuItem;
    ItemsFVEstiloFac: TSmallintField;
    pnlNCExplicacion: TRzPanel;
    lblNCExplicacion: TLabel;
    iFiscalServer: TImage;
    cbSucSal: TwwDBLookupCombo;

    procedure edtEntContKeyPress(Sender: TObject; var Key: Char);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);

    procedure edtClienteEnter(Sender: TObject);
    procedure edtClienteKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);

    procedure edtFechaHoyEnter(Sender: TObject);
    procedure edtFechaHoyExit(Sender: TObject);
    procedure edtFechaHoyKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);

    procedure edtComprobanteEnter(Sender: TObject);
    procedure edtComprobanteExit(Sender: TObject);
    procedure edtComprobanteKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);

    procedure edtCompRefExit(Sender: TObject);

    procedure edtEmpleadoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure edtEmpleadoEnter(Sender: TObject);

    procedure gFacVKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure gFacVKeyPress(Sender: TObject; var Key: Char);
    procedure gFacVEnter(Sender: TObject);
    procedure gFacVColEnter(Sender: TObject);
    procedure gFacVColExit(Sender: TObject);
    procedure gFacVCalcCellColors(Sender: TObject; Field: TField; State: TGridDrawState; Highlight: Boolean; AFont: TFont; ABrush: TBrush);
    procedure gFacVenEncDblClick(Sender: TObject);
    procedure gFacVenEncKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure gFacVUpdateFooter(Sender: TObject);

    procedure FacVNewRecord(DataSet: TDataSet);
    procedure FacVClienteChange(Sender: TField);
    procedure FacVRetiroValidate(Sender: TField);
    procedure FacVTipoFacturaValidate(Sender: TField);

    procedure ItemsFVAfterDelete(DataSet: TDataSet);
    procedure ItemsFVAfterPost(DataSet: TDataSet);
    procedure ItemsFVNewRecord(DataSet: TDataSet);
    procedure ItemsFVBeforeDelete(DataSet: TDataSet);
    procedure ItemsFVBeforeInsert(DataSet: TDataSet);
    procedure ItemsFVBeforeEdit(DataSet: TDataSet);
    procedure ItemsFVIdArticuloValidate(Sender: TField);
    procedure ItemsFVIdArticuloSetText(Sender: TField; const Text: String);
    procedure ItemsFVCantidadValidate(Sender: TField);
    procedure ItemsFVCantidadChange(Sender: TField);
    procedure ItemsFVPrecioFinalChange(Sender: TField);
    procedure ItemsFVPrecioTotalValidate(Sender: TField);
    procedure ItemsFVPrecioTotalChange(Sender: TField);
    procedure gbNotasCreditosEnter(Sender: TObject);
    procedure edtNCClienteEnter(Sender: TObject);
    procedure edtNCClienteExit(Sender: TObject);
    procedure edtNCClienteKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btnNCCerrarClick(Sender: TObject);

    procedure gbVueltoMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);

    procedure aCierreZExecute(Sender: TObject);
    procedure aCierreXExecute(Sender: TObject);
    procedure aCancelarAllExecute(Sender: TObject);
    procedure aNotaDeCreditosExecute(Sender: TObject);
    procedure aSearchCliExecute(Sender: TObject);
    procedure aAltaCliExecute(Sender: TObject);
    procedure aComprobantes_EmitidosExecute(Sender: TObject);
    procedure aPtoVtasExecute(Sender: TObject);
    procedure aFondosExecute(Sender: TObject);
    procedure SalirClick(Sender: TObject);
    procedure ItemsFVIdArticuloGetText(Sender: TField; var Text: String; DisplayText: Boolean);
    procedure aFinanciacionesExecute(Sender: TObject);
    procedure btnNCSinCompClick(Sender: TObject);
    procedure aServerFiscalExecute(Sender: TObject);
    procedure ItemsFVTalleGetText(Sender: TField; var Text: String; DisplayText: Boolean);
    procedure ItemsFVTalleSetText(Sender: TField; const Text: String);
    procedure ItemsFVTalleValidate(Sender: TField);
    procedure ItemsFVIdArticuloChange(Sender: TField);
    procedure ItemsFVPrcBonificacionValidate(Sender: TField);
    procedure aConsPrecExecute(Sender: TObject);
    procedure aSucursalesExecute(Sender: TObject);
    procedure aSenasExecute(Sender: TObject);
    procedure aConsignacionesExecute(Sender: TObject);
    procedure cbSubDepEnter(Sender: TObject);
    procedure cbSubDepChange(Sender: TObject);
    procedure edtNCNroCompEnter(Sender: TObject);
    procedure edtNCNroCompExit(Sender: TObject);
    procedure edtNCNroCompKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure cbSubDepExit(Sender: TObject);
    procedure edtEmpleadoExit(Sender: TObject);
    procedure FacVEmpleadoValidate(Sender: TField);
    procedure aRemitosExecute(Sender: TObject);
    procedure ItemsFVDescuentoValidate(Sender: TField);
    procedure cbTarjetasEnter(Sender: TObject);
    procedure FacVCantCuotasValidate(Sender: TField);
    procedure aPresupuestosExecute(Sender: TObject);
    procedure aNotaDeDebitosExecute(Sender: TObject);
    procedure gCompRealizadosDblClick(Sender: TObject);
    procedure gCompRealizadosUpdateFooter(Sender: TObject);
    procedure FacVAfterInsert(DataSet: TDataSet);
    procedure aFacturaVtaManualExecute(Sender: TObject);
    procedure aNCreditoManualExecute(Sender: TObject);
    procedure aNDebitoManualExecute(Sender: TObject);
    procedure aRemitoManualExecute(Sender: TObject);
    procedure aPresupuestoManualExecute(Sender: TObject);
    procedure aFacManExecute(Sender: TObject);
    procedure gOfertasUpdateFooter(Sender: TObject);
    procedure pcTotFacVClick(Sender: TObject);
    procedure aGetOffExecute(Sender: TObject);
    procedure edtNCtasEnter(Sender: TObject);
    procedure edtEntContEnter(Sender: TObject);
    procedure edtDomEntEnter(Sender: TObject);
    procedure qOfertasIDSUCURSALGetText(Sender: TField; var Text: string; DisplayText: Boolean);
    procedure aABMCliExecute(Sender: TObject);
    procedure ItemsFVMostDomiValidate(Sender: TField);
    procedure ItemsFVPrecioListaChange(Sender: TField);
    procedure ItemsFVPrecioListaValidate(Sender: TField);
    procedure ItemsFVDescuentoChange(Sender: TField);
  private
    { Private declarations }
    Factura_Vta, DeletingItems, GrabarComprobante,
    ImprimioEncabezado, EligioNC, HayCajon,
    ProductosConTalles, Ingresando_Cliente,
    ActualizandoTotal, ActualizandoCantidad,
    ActualizandoContado, ActualizandoFinal,
    ActualizandoDescuento, Emitiendo_Z,
    Pedir_SubDet, Z_Automatico, DandoPrecio,
    FNotaDeCredito, ConDescStk, Cotizacion,
    RemitoEntrega, NotaDebito, Comprobante_Manual,
    ChequeandoPLista, Hay_Domicilio: Boolean;

    Cantidad_Productos, Cantidad_Ofertas: Integer;
    Coeficiente: Double;
    Talle: St04;
    Def_Caption: String;
    Sen_SaF_NCxC, Total_Fac, Total_Lst, Total_Cta,
    Total_Dto, TCon, TTar, TTkt, TSen, TChq, TOtp, TVen: Currency;

    Comp_Ref: TComp_Referencia;

    procedure LoadMenuAccesLevel;
    procedure EnableTasks(Level: Integer);
    procedure DatosArticuloBuscado(Sender: TField; Text: String; Var Art: TDatos_Art);
    procedure Set_Params_FV;
    procedure Calc_Descuento;
    procedure ModificaFinal(PrecioFinal: Double);
    procedure ModificaTotal;
    procedure SetDatosFacCli;
    //-----------------------------------------
    procedure UpdateTotalsFacV;
    //----------------------------------------
    procedure Vaciar_Tablas;
    procedure Ver_Ofertas;
    //----------------------------------------
    function Get_Senas_SaF_NCC(C, S: Integer): Currency;
    procedure Put_Msg(M: String);
    procedure Cargar_Registro_DeDatos(T: SmallInt);
    procedure Cerrar_Comprobante;
    procedure ImprimirFactura_Impresora;
    procedure Imprimir_Remito;
    procedure ImprimirFactura_Controlador;
    procedure GrabarComprobanteCancelado(var Factura: TFactura; var ItemsFactura: TBody_Fiscal);
    procedure Cargar_Comprobante_De_Referencia(CR: TComp_Referencia);
    procedure Comprobantes_Manuales(TC: SmallInt);
    procedure Elegir_Comprobante_De_Referencia;
  public
    { Public declarations }
    //----------------------------------
  end;

var
  frmFacV: TfrmFacV;

implementation

uses udmGestion, uEntidades, uDlgExt, uDemora, udmSaveFile, uConfiguracion,
     uFiscal, uClaveMod, uCalcPrecios, uBuscaEmp, uFondos, uSelecUsuario,
     uServerFiscal, uFormasDePago, uViewFacV, uFormasDePagoNC, uListaSelectTalles,
     uABMArticulos, uNewPrec, uGestSucursales, uSenas, uVtaConsignacion,
     uSelectDestinoSaF,  uSearchProd;

{$R *.DFM}

Const
  Busca_NC = 'Select F.IdFactura, F.IdSucursal, F.IdPuntoVenta, F.Cliente, '+
             '       F.CantArtic, F.NroFactura, F.TipoFactura, F.FechaF, '+
             '       F.NroCtas, F.Empleado, F.Contado, F.Tarjeta, F.CtaCte, '+
             '       F.Tickets, F.Cheque, F.CobSenas, F.OtrosPagos, F.Total, '+
             '       F.IdTarjeta, F.IdSubDep, T.DescCorta '+
             'From FacVen F '+
             'Join TiposComp T '+
             '  on T.IdComprobante = F.TipoFactura '+
             'Where (F.TipoFactura in (1,2,5,6,7)) And '+
             '      (F.State = 0) And '+
             '      (F.IdSucursal = :Sucur) <Cond> '+
             'Order By F.FechaF desc ';

procedure TfrmFacV.LoadMenuAccesLevel;
var
  i, j: Integer;
  Texto: String;
begin
  with dmGestion do
  begin
    FVAccesos.Open;
    if FVAccesos.IsEmpty then
    begin
      for i := 0 to mmVentas.Items.Count - 1 do
      begin
        Texto := mmVentas.Items[i].Caption;
        if Texto <> '-' then
        begin
          Delete(Texto, Pos('&', Texto), 1);
          FVAccesos.Insert;
          FVAccesosMenuText.AsString := Texto;
          FVAccesosTag.AsInteger := 0;
          FVAccesosNivel.AsInteger := 0; //Nivel Cero = Menu principal
          FVAccesosAcceso.AsInteger := AccesoLibre;
          FVAccesosAccesoStr.AsString := Cero;
          FVAccesos.Post;
          for j := 0 to mmVentas.Items[i].Count - 1 do
          begin
            Texto := mmVentas.Items[i].Items[j].Caption;
            if Texto <> '-' then
            begin
              Delete(Texto, Pos('&', Texto), 1);
              FVAccesos.Insert;
              FVAccesosMenuText.AsString := Texto;
              FVAccesosTag.AsInteger := 0;
              FVAccesosNivel.AsInteger := 1; //Nivel Uno = Sub Menu principal
              FVAccesosAcceso.AsInteger := AccesoLibre;
              FVAccesosAccesoStr.AsString := AccesoLibreStr;
              FVAccesos.Post;
            end;
          end;
        end;
      end;

      for i := 0 to alFacVen.ActionCount - 1 do
      begin
        if alFacVen.Actions[i] is TAction then
        begin
          Texto := TAction(alFacVen.Actions[i]).Caption;
          if Texto <> '-' then
          begin
            Delete(Texto, Pos('&', Texto), 1);
            if not FVAccesos.Locate(FVAccesosMenuText.FieldName, Texto, []) then
            begin
              FVAccesos.Insert;
              FVAccesosMenuText.AsString := Texto;
              FVAccesosTag.AsInteger := 0;
              FVAccesosNivel.AsInteger := 0; //Nivel Cero = Menu principal
              FVAccesosAcceso.AsInteger := AccesoLibre;
              FVAccesosAccesoStr.AsString := AccesoLibreStr;
              FVAccesos.Post;
            end;
          end;
        end;
      end;
    end;
  end;
end;

procedure TfrmFacV.EnableTasks(Level: Integer);
var
  i, j: Integer;
  Texto: String;
begin
  if Level > AccesoLibre then
    Exit;

  dmGestion.FVAccesos.Open;
  dmGestion.FVAccesos.First;
  if dmGestion.FVAccesos.IsEmpty then
    Exit;
  For i := 0 to alFacVen.ActionCount - 1 do
  begin
    if alFacVen.Actions[i] is TAction then
    begin
      Texto := Trim(TAction(alFacVen.Actions[i]).Caption);
      Delete(Texto, Pos('&', Texto), 1);
      if dmGestion.FVAccesos.Locate(dmGestion.FVAccesosMenuText.FieldName, Texto, []) then
        TAction(alFacVen.Actions[i]).Tag := dmGestion.FVAccesosAcceso.AsInteger;
    end;
  end;

  For i := 0 to alFacVen.ActionCount - 1 do
  begin
    if alFacVen.Actions[i] is TAction then
      TAction(alFacVen.Actions[i]).Enabled := TAction(alFacVen.Actions[i]).Tag >= Level;
  end;

  For i := 0 to mmVentas.Items.Count - 1 do
  begin
    For j := 0 to mmVentas.Items[i].Count - 1 do
    begin
      Texto := mmVentas.Items[i].Items[j].Caption;
      Delete(Texto, Pos('&', Texto), 1);
      if dmGestion.FVAccesos.Locate(dmGestion.FVAccesosMenuText.FieldName, Texto, []) then
      begin
        if (dmGestion.FVAccesosAcceso.Value = AccesoLibre) or
           (dmGestion.FVAccesosAcceso.Value >= Level) then
          mmVentas.Items[i].Items[j].Enabled := True
        else
          mmVentas.Items[i].Items[j].Enabled := False;
      end
      else
        mmVentas.Items[i].Items[j].Enabled := True;
    end;
  end;
  dmGestion.FVAccesos.Close;
end;

procedure TfrmFacV.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
begin
  if (not Emitiendo_Z) and
     (Application.MessageBox('¿Cerrar facturación?', 'Salida',
           MB_ICONQUESTION + MB_YESNO + MB_DEFBUTTON2) = ID_NO) then
    CanClose := False;
end;

procedure TfrmFacV.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  try
    if ControladorOK then
    begin
      if ComprobanteAbierto then
      begin
        Factura.NroFactura := FacVNroFactura.AsString;
        Factura.FechaF := FacVFechaF.AsDateTime;
        Factura.CantArtic := 0;
        Factura.Entidad := FacVCliente.AsInteger;
        Factura.TipoIva := FacVTipoIva.AsInteger;
        Factura.TipoFactura := FacVTipoFactura.AsInteger;
        GrabarComprobanteCancelado(Factura, ItemsFiscal);
        frmFiscal.CancelarFactura(FNotaDeCredito);
      end;
      frmFiscal.Finalizar;
      ControladorOK := False;
    end;
    Vaciar_Tablas;
  finally
    dmGestion.SubDep.Filtered := False;
    Application.OnException := nil;
    Action := caFree;
  end;
end;

procedure TfrmFacV.DatosArticuloBuscado(Sender: TField; Text: String; Var Art: TDatos_Art);
var
  V, Err: Integer;
  Searched: String;
  ElTalle: Integer;
begin
  ElTalle := SIN_DETALLE_TALLE;
  Searched := Text;
  if Trim(Searched) > Vacio then
  begin
    if Length(Searched) = 12 then
    begin
      try
        ElTalle := StrToInt(Copy(Searched, 9, 3));
      except
        ElTalle := SIN_DETALLE_TALLE;
      end;
      Searched := Copy(Searched, 1, 7);
    end;

    if GetDatosArt(0, Searched, Datos_Art) then
    begin
      if Datos_Art.Activo = Verdadero then
      begin
        Art := Datos_Art;
        if ElTalle > SIN_DETALLE_TALLE then
          ItemsFVTalle.AsInteger := ElTalle;
        Sender.AsInteger := Datos_Art.IdArticulo;
      end
      else
        raise EUsuario.Create('Producto DESACTIVADO no se puede Facturar.-');
    end
    else begin
      Val(Searched, V, Err);
      if Err = 0 then
      begin
        if GetDatosArt(V, Vacio, Datos_Art) then
        begin
          if Datos_Art.Activo = Verdadero then
          begin
            Art := Datos_Art;
            if ElTalle > SIN_DETALLE_TALLE then
              ItemsFVTalle.AsInteger := ElTalle;
            Sender.AsInteger := Datos_Art.IdArticulo;
          end
          else
            raise EUsuario.Create('Producto DESACTIVADO no se puede Facturar.-');
        end
        else begin
          Elegido := Search_Prod(Searched, Tarea);
          if Elegido.IdArticulo > NoEncontrado then
          begin
            if GetDatosArt(Elegido.IdArticulo, Vacio, Datos_Art) then
            begin
              if Datos_Art.Activo = Verdadero then
              begin
                Art := Datos_Art;
                Sender.AsInteger := Datos_Art.IdArticulo;
              end
              else
                raise EUsuario.Create('Producto DESACTIVADO no se puede Facturar.-');
            end;
          end
          else
            raise EUsuario.Create('No se encontró el producto');
        end;
      end
      else begin
        Elegido := Search_Prod(Searched, Tarea);
        if Elegido.IdArticulo > NoEncontrado then
        begin
          if GetDatosArt(Elegido.IdArticulo, Vacio, Datos_Art) then
          begin
            if Datos_Art.Activo = Verdadero then
            begin
              Art := Datos_Art;
              Sender.AsInteger := Elegido.IdArticulo;
            end
            else
              raise EUsuario.Create('Producto DESACTIVADO no se puede Facturar.-');
          end
        end
        else
          raise Exception.Create('No se encontró el producto');
      end;
    end;
  end
  else begin
    Elegido := Search_Prod(Searched, Tarea);
    if Elegido.IdArticulo > NoEncontrado then
    begin
      if GetDatosArt(Elegido.IdArticulo, Vacio, Datos_Art) then
      begin
        if Datos_Art.Activo = Verdadero then
        begin
          Art := Datos_Art;
          Sender.AsInteger := Elegido.IdArticulo;
        end
        else
          raise EUsuario.Create('Producto DESACTIVADO no se puede Facturar.-');
      end
    end
    else
      raise Exception.Create('No se encontró el producto');
  end;
end;

procedure TfrmFacV.Set_Params_FV;
begin
  edtCompRef.Enabled := False;
  lblCompRef.Enabled := False;
  Def_Caption := Vacio;
  ProductosConTalles := False;
  ControladorOK := False;
  IF_Modelo := 0;
  ImprimirEnLinea := False;
  Ingresando_Cliente := False;
  Tipo_Factura := False;
  Tipo_Estacion := False;
  Cantidad_Productos := 0;
  ImprimirEnControlador := False;
  Z_Automatico := False;
  HayCajon := False;
  lblModoFacturacionNC.Caption := '-';
  lblDatosCli.Caption := '';
  Pedir_SubDet := False;
  Nombre_Impersonal := ' ';
  Cantidad_Ofertas := 0;
  gbVuelto.Caption := 'Ult.Op 0000-0000000';
  lblTotalOp.Caption := '';
  lblPagado.Caption := '';
  lblVuelto.Caption := '';
  lblTipoCF.Visible := False;

  with dmGestion do
  begin
    qTerminales.Close;
    qTerminales.Transaction := trProc;
    qTerminales.ParamByName('IdSucursal').AsInteger := IdBranch;
    qTerminales.ParamByName('IdPuntoVenta').AsInteger := IdSalesPoint;
    qTerminales.Open;
    if not Empresas.Active then
      Empresas.Open;
    if not Sucursales.Active then
      Sucursales.Open;
    if not Dptos.Active then
      Dptos.Open;
    if not MotivosAJ.Active then
      MotivosAJ.Open;
    if not qTarjetas.Active then
      qTarjetas.Open;

    lblSubDep.Visible := False;
    cbSubDep.Visible := False;
    if ConSubDep then
    begin
      SubDep.Filter := 'IdSucursal = '+IntToStr(IdBranch);
      SubDep.Filtered := True;
      if not SubDep.IsEmpty then
      begin
        SubDep.First;
        cbSubDep.Items.AddObject('<Sucursal>', TObject(0));
        While not SubDep.Eof do
        begin
          cbSubDep.Items.AddObject(SubDepDetSubDep.AsString, TObject(SubDepIdSubDep.AsInteger));
          SubDep.Next;
        end;
        lblSubDep.Visible := True;
        cbSubDep.Visible := True;
      end;
      lblCompRef.Enabled := True;
      edtCompRef.Enabled := True;
    end;

    if Card.Active then
      Card.EmptyDataSet
    else
      Card.CreateDataSet;
    Card.Append;
    CardIdCard.AsInteger := 0;
    CardDetTar.AsString :=  '<Operación sin Tarjeta>';
    Card.Post;
    qTarjetas.First;
    While not qTarjetas.Eof do
    begin
      Card.Append;
      CardIdCard.AsInteger := qTarjetasIdTarjeta.AsInteger;
      CardDetTar.AsString  := qTarjetasTarjeta.AsString;
      CardTipoEn.AsInteger := qTarjetasTIPOENT.AsInteger;
      Card.Post;
      qTarjetas.Next;
    end;
    sbFVen1.Caption := Format('S: %d/P: %d/U: %s - %s /C: %d ',
                              [IdBranch, IdSalesPoint, NombreUsuario,
                               DetalleTarea, Id_Cia]);

    //--------------------- Inicializaciones
    ImprimirEnControlador := (qTerminalesImprimeEnControlador.AsInteger = Verdadero);
    ImprimirEnLinea := (qTerminalesImprimeEnLinea.AsInteger = Verdadero);
    Tipo_Estacion := (qTerminalesTipoControlador.AsInteger = ControladorTipoEstacion);
    Tipo_Factura := ((qTerminalesTipoControlador.AsInteger >= ControladorTipoFactura) and
                    (qTerminalesTipoControlador.AsInteger <> ControladorTktFact_NC)) or
                    (not ImprimirEnControlador);
    ServidorFiscal := (qTerminalesSERVIDORFISCAL.AsInteger = Verdadero);
    Tipo_FacNC := (qTerminalesTipoControlador.AsInteger = ControladorTktFact_NC);
    IF_Modelo := qTerminalesModeloControlador.AsInteger;
    Z_Automatico := (qTerminalesCierreAutomatico.AsInteger = Verdadero);
    Pedir_SubDet := (qTerminalesPedirSubDet.AsInteger = Verdadero);
    iFiscalServer.Visible := ServidorFiscal;

    if ImprimirEnControlador then  //  Leyendo tipo de dispositivo de Impresion
      IF_Modelo := qTerminalesModeloControlador.AsInteger
    else
      IF_Modelo := Con_Impresora;

    if GetDatosEnt(Impersonal, IdBranch, 1, Datos_Ent) then
      Nombre_Impersonal := Datos_Ent.Nombre;

    // Seteos de Flags segun Configuracion Punto
    ItemsFVPrcBonificacion.Visible := True;
    ItemsFVDescuento.Visible := True;

    gFacV.TitleFont.Name := 'Tahoma';
    gFacV.TitleFont.Size := 8;
    gFacV.TitleFont.Style := [fsBold];
    gFacV.Font.Name := 'Tahoma';
    gFacV.ControlType.Clear;
    gFacV.Selected.Clear;
    gFacV.TitleLines := 2;
    gFacV.Font.Size := 7;

    if Control_Talles then
    begin
      gFacV.Selected.Add('IdArticulo'#9'6'#9'Código'#9'F'#9'Producto/Servicio');
      gFacV.Selected.Add('Talle'#9'2'#9'T/M'#9'F'#9'Producto/Servicio');
    end
    else
      gFacV.Selected.Add('IdArticulo'#9'6'#9'Código'#9'F'#9'Producto/Servicio');

    if Pedir_SubDet then
    begin
      gFacV.Selected.Add('DescProd'#9'30'#9'Descripción F2+'#9'F'#9'Producto/Servicio');
      gFacV.Selected.Add('SubDet'#9'10'#9'SubDetalle'#9'F'#9'Producto/Servicio');
      gFacV.Selected.Add('Cantidad'#9'7'#9'Cantidad'#9'F'#9'Producto/Servicio');
    end
    else begin
      gFacV.Selected.Add('DescProd'#9'40'#9'Descripción F2+'#9'T'#9'Producto/Servicio');
      gFacV.Selected.Add('Cantidad'#9'7'#9'Cantidad'#9'F'#9'Producto/Servicio');
    end;
    gFacV.Selected.Add('PrecioLista'#9'10'#9'Lista'#9'F'#9'Precios');
    gFacV.Selected.Add('EntContado'#9'8'#9'Anticipo'#9'T'#9'Precios');
    lblEntCont.Visible := True;
    edtEntCont.Visible := True;

    gFacV.Selected.Add('ValorCta'#9'8'#9'Cuota'#9'T'#9'Precios');
    gFacV.Selected.Add('PrecioFinal'#9'8'#9'Final'#9'F'#9'Precios');
    gFacV.Selected.Add('PrecioTotal'#9'10'#9'Total'#9'T'#9'Precios');
    gFacV.Selected.Add('Descuento'#9'8'#9'$'#9'F'#9'Descuentos');
    gFacV.Selected.Add('PrcBonificacion'#9'8'#9'%'#9'F'#9'Descuentos');

    if EmitirRtoDomicilio then
      gFacV.Selected.Add('MostDomi'#9'6'#9'0 Retira~1 Enviar'#9'F');

    if Hacer_Trans_EnFact then
    begin
      gFacV.Selected.Add('IdSucSalida'#9'7'#9'Sucursal~de Salida'#9'F');
      gFacV.ControlType.Add('IdSucSalida;CustomEdit;cbSucSal;T');
    end;

    gFacV.ColumnByName('DescProd').ReadOnly := True;
    gFacV.ColumnByName('EntContado').ReadOnly := True;
    gFacV.ColumnByName('ValorCta').ReadOnly := True;
    gFacV.ColumnByName('PrecioTotal').ReadOnly := True;
    gFacV.RefreshDisplay;

    FNotaDeCredito := False;
    RemitoEntrega := False;
    Factura_Vta := True;
    Cotizacion := False;
    Comprobante_Manual := False;
    NotaDebito := False;
    if ImprimirEnControlador then //-------------- Inicializa Controlador
    begin
      ControladorFiscal.Enabled := True;
      if not Assigned(frmFiscal) then
        frmFiscal := TfrmFiscal.Create(nil);

      // ------------ Caption Form
      Def_Caption := OwnerName + ' - Facturación con Impresor Fiscal';
      //------------ Z Automatico
      HayCajon := (qTerminalesCajonDinero.AsInteger = Verdadero);

      edtComprobante.ReadOnly := True;
      edtComprobante.TabStop := False;
      edtFechaHoy.ReadOnly := True;
      edtFechaHoy.TabStop := False;
      lblTipoCF.Visible := True;

      if Tipo_Factura then
      begin
        lblTipoCF.Caption:= 'F';
        HayCajon := False;
      end
      else
        lblTipoCF.Caption:= 'TF';
      ImprimioEncabezado := False;

      // Controlador Remoto
      if ServidorFiscal then
      begin
        ControladorFiscal.Enabled := False;
        Def_Caption := OwnerName + ' - Facturación a Servidor Fiscal';
        HayCajon := False;
        ImprimirEnLinea := False;
      end;
      Emitiendo_Z := False;
    end
    else begin // Facturacion a impresora comun
      ControladorFiscal.Enabled := False;
      aFacMan.Visible := False;
      Def_Caption := OwnerName + ' - Facturación manual';
      Tipo_Factura := True;
      lblTipoCF.Visible := True;
      lblTipoCF.Caption := 'TC';
      ImprimirEnLinea := False;
      ControladorLocal := False;
      edtComprobante.ReadOnly := False;
      edtComprobante.TabStop := True;
      lblFecha.Enabled := True;
      edtFechaHoy.ReadOnly := False;
      edtFechaHoy.TabStop := True;
      edtFechaHoy.Enabled := True;
    end;
  end;
  
  if Hacer_Trans_EnFact then
    Def_Caption := Def_Caption + ' RT';

  //------------ Inicializacion de Formatos en Tablas
  case Decimales of  //-------------- Centavos Precios
    0: ItemsFVCantidad.DisplayFormat := '0';
    1: ItemsFVCantidad.DisplayFormat := '0.0';
    2: ItemsFVCantidad.DisplayFormat := '0.00';
    3: ItemsFVCantidad.DisplayFormat := '0.000';
    4: ItemsFVCantidad.DisplayFormat := '0.0000';
    else ItemsFVCantidad.DisplayFormat := '0';
  end;

  ItemsFVCantidad.EditFormat := ItemsFVCantidad.DisplayFormat;
  case CentavosP of  //-------------- Centavos Precios
    2: ItemsFVPrecioTotal.DisplayFormat := '0.00';
    3: ItemsFVPrecioTotal.DisplayFormat := '0.000';
    4: ItemsFVPrecioTotal.DisplayFormat := '0.0000';
    else ItemsFVPrecioTotal.DisplayFormat := '0.00';
  end;
  ItemsFVPrecioTotal.EditFormat :=ItemsFVPrecioTotal.DisplayFormat;
  ItemsFVMtoImpInt.DisplayFormat := ItemsFVPrecioTotal.DisplayFormat;
  ItemsFVPrcBonificacion.DisplayFormat := '0.00%';
  ItemsFVPrcBonificacion.EditFormat := '0.00';

  FacVTotal.DisplayFormat := ItemsFVPrecioTotal.DisplayFormat;
  FacVTotal.EditFormat := FacVTotal.DisplayFormat;

  ItemsFVPrecioFinal.DisplayFormat := ItemsFVPrecioTotal.DisplayFormat;
  ItemsFVPrecioFinal.EditFormat := ItemsFVPrecioTotal.DisplayFormat;
  ItemsFVDescuento.DisplayFormat := ItemsFVPrecioTotal.DisplayFormat;
  ItemsFVDescuento.EditFormat := ItemsFVPrecioTotal.DisplayFormat;
  ItemsFVValorCta.DisplayFormat := ItemsFVPrecioTotal.DisplayFormat;

  Caption := Def_Caption;
  Vaciar_Tablas;
  FacV.Insert;
  FacVCliente.AsInteger := Impersonal;
end;

procedure TfrmFacV.FormCreate(Sender: TObject);
begin
  Set_Params_FV;
  Vaciar_Tablas;
  FacV.Insert;
  FacVCliente.AsInteger := Impersonal;
end;

procedure TfrmFacV.FormShow(Sender: TObject);
begin
  LoadMenuAccesLevel;
  EnableTasks(Tarea);
  if Visible then
  begin
    edtCliente.SetFocus;
    edtCliente.SelectAll;
  end;
end;

procedure TfrmFacV.ModificaFinal(PrecioFinal: Double);
var
  P: TPrecios;
begin
  if (ItemsFVIdArticulo.AsInteger > 0) and
     (ItemsFVPrecioTotal.AsCurrency <> 0) and
     (not ActualizandoCantidad) and
     (not ActualizandoFinal) and
     ((not FNotaDeCredito) or (not EligioNC)) and
     (not ActualizandoTotal) and
     (not DandoPrecio) and
     (not ActualizandoDescuento) and
     (not ActualizandoContado) then
  begin
    try
      ActualizandoFinal := True;
      if (RoundTo(PrecioFinal, -2) >=
         (RoundTo(ItemsFVPrecioOriginalFin.AsCurrency, -2))) then
      begin
        if GetPrecio(ItemsFVIdArticulo.AsInteger, FacVIdTarjeta.AsInteger,
                     FacVCantCuotas.AsInteger, PrecioFinal, ItemsFVPrcBonificacion.AsFloat,
                     Coeficiente, FacVEntregaCdo.AsCurrency, ItemsFVCantidad.AsFloat, P) >= 0 then
        begin
          ItemsFVIvaIn.AsCurrency := P.Iva1;
          ItemsFVImpInt.AsCurrency := P.ImpInt;
          ItemsFVExento.AsCurrency := P.Exento;
          ItemsFVPrecioNeto.AsCurrency := P.Neto;
          ItemsFVCantidad.AsCurrency := P.Cantid;
          ItemsFVPrecioNeto.AsCurrency := P.Neto;
          ItemsFVPrecioFinal.AsCurrency := P.PFinal;
          ItemsFVPrecioTotal.AsCurrency := P.Total;
          ItemsFVPrecioOriginal.AsCurrency := P.PLista;
          ItemsFVPrecioLista.AsCurrency := P.PLista;
          ItemsFVDescuento.AsCurrency := P.Descto;
          ItemsFVAlcIva.AsInteger := P.IdAlcIva;
          ItemsFVAlicuotaIva.AsFloat := P.AlicuotaIva;
          ItemsFVAlcIB.AsInteger := P.IdAlcIB;
          ItemsFVAlicuotaIB.AsFloat := P.AlicuotaIB;
          ItemsFVIngBto.AsCurrency := P.IngBto;
          ItemsFVValorCta.AsCurrency := P.ValorCuota;
        end
        else begin
          ItemsFVPrecioFinal.AsCurrency := ItemsFVPrecioOriginalFin.AsCurrency;
        end;
      end;
    finally
      ActualizandoFinal := False;
    end;
    gFacV.RefreshDisplay;
  end;
end;

procedure TfrmFacV.ModificaTotal;
var
  P: TPrecios;
begin
  if (ItemsFVIdArticulo.AsInteger > 0) and
     (ItemsFVPrecioTotal.AsCurrency <> 0) and
     (not ActualizandoCantidad) and
     (not ActualizandoFinal) and
     (not FNotaDeCredito) and
     (not ActualizandoTotal) and
     (not DandoPrecio) and
     (not ActualizandoDescuento) and
     (not ActualizandoContado) then
  begin
    ActualizandoTotal := True;
    try
      Case ItemsFVEstiloFac.AsInteger of
        PedirTodo,
        PedirTotal: begin
          P := Precio(ItemsFVPrecioTotal.AsCurrency, ItemsFVPrecioFinal.AsCurrency,
                      ItemsFVCantidad.AsFloat, ItemsFVPrcBonificacion.AsFloat,
                      ItemsFVIdArticulo.AsInteger, 3, FacVCantCuotas.AsInteger);
        end;
        PedirCant : begin
          P := Precio(ItemsFVPrecioTotal.AsCurrency, ItemsFVPrecioFinal.AsCurrency,
                      ItemsFVCantidad.AsFloat, ItemsFVPrcBonificacion.AsFloat,
                      ItemsFVIdArticulo.AsInteger, 1, FacVCantCuotas.AsInteger);
        end;
      end;
      ItemsFVPrecioNeto.AsCurrency := P.Neto;
      ItemsFVIvaIn.AsCurrency := P.Iva1;
      ItemsFVImpInt.AsCurrency := P.ImpInt;
      ItemsFVExento.AsCurrency := P.Exento;
      ItemsFVPrecioNeto.AsCurrency := P.Neto;
      ItemsFVCantidad.AsCurrency := P.Cantid;
      ItemsFVPrecioFinal.AsCurrency := P.PFinal;
      ItemsFVDescuento.AsCurrency := P.Descto;
      ItemsFVAlcIva.AsInteger := P.IdAlcIva;
      ItemsFVAlicuotaIva.AsFloat := P.AlicuotaIva;
      ItemsFVAlcIB.AsInteger := P.IdAlcIB;
      ItemsFVAlicuotaIB.AsFloat := P.AlicuotaIB;
      ItemsFVIngBto.AsCurrency := P.IngBto;
      ItemsFVValorCta.AsCurrency := P.ValorCuota;
    finally
      ActualizandoTotal := False;
    end;
  end;
end;

procedure TfrmFacV.pcTotFacVClick(Sender: TObject);
begin
  case pcTotFacV.ActivePageIndex of
    0: gbFootComp.Caption := 'Totales Comprobantes';
    1: gbFootComp.Caption := 'Comprobantes realizados';
    2: gbFootComp.Caption := 'Ofertas vigentes';
  end;
end;

procedure TfrmFacV.SetDatosFacCli;

  procedure HabilitarA(T: Boolean);
  begin
    gbDiscriminacion.Visible := T;
    lblIvaAlc1.Caption := Format('Iva %7.2f',[GetAlcIva(1)])+ '%';
    lblIvaAlc2.Caption := Format('Iva %7.2f',[GetAlcIva(2)])+ '%';
  end;

  procedure HabilitarB_Ticket;
  begin
    HabilitarA(False);
  end;

  procedure SetFac;
  begin
    if RemitoEntrega then
    begin
      FacVTipoFactura.AsInteger := RemitoX;
      pnlTipoComp.Caption := 'R';
      HabilitarA(False);
    end
    else begin
      if Cotizacion then
      begin
        FacVTipoFactura.AsInteger := Presupuesto;
        pnlTipoComp.Caption := 'P';
        HabilitarA(False);
      end
      else begin
        case FacVTipoIva.AsInteger of
          RI, RNI, NC: begin
            if FNotaDeCredito then
              FacVTipoFactura.AsInteger := CreA
            else
              if NotaDebito then
                FacVTipoFactura.AsInteger := DebA
              else
                FacVTipoFactura.AsInteger := FacA;
            pnlTipoComp.Caption := 'A';
            HabilitarA(True);
          end;

          Ex, RMT, BU, NR: begin
            if FNotaDeCredito then
              FacVTipoFactura.AsInteger := CreB
            else
              if NotaDebito then
                FacVTipoFactura.AsInteger := DebB
              else
                FacVTipoFactura.AsInteger := FacB;
            pnlTipoComp.Caption := 'B';
          end;

          CFi: begin
            if FacVTipoDoc.AsInteger = Ninguno then
            begin
              if Tipo_Factura then
              begin
                if FNotaDeCredito then
                  FacVTipoFactura.AsInteger := CreB
                else
                  if NotaDebito then
                    FacVTipoFactura.AsInteger := DebB
                  else
                    FacVTipoFactura.AsInteger := FacB;
                pnlTipoComp.Caption := 'B';
              end
              else begin
                if Tipo_Estacion then
                begin
                  if FNotaDeCredito then
                  begin
                    FacVTipoFactura.AsInteger := CreB;
                    pnlTipoComp.Caption := 'B';
                  end
                  else begin
                    if NotaDebito then
                    begin
                      FacVTipoFactura.AsInteger := DebB;
                      pnlTipoComp.Caption := 'B';
                    end
                    else begin
                      FacVTipoFactura.AsInteger := Tkt;
                      pnlTipoComp.Caption := 'T';
                    end
                  end;
                end
                else begin
                  if FNotaDeCredito then
                  begin
                    FacVTipoFactura.AsInteger := CreB;
                    pnlTipoComp.Caption := 'B';
                  end
                  else begin
                    if NotaDebito then
                    begin
                      FacVTipoFactura.AsInteger := DebB;
                      pnlTipoComp.Caption := 'B';
                    end
                    else begin
                      FacVTipoFactura.AsInteger := Tkt;
                      pnlTipoComp.Caption := 'T';
                    end
                  end;
                end;
              end;
            end
            else begin
              if FNotaDeCredito then
                FacVTipoFactura.AsInteger := CreB
              else
                if NotaDebito then
                  FacVTipoFactura.AsInteger := DebB
                else
                  FacVTipoFactura.AsInteger := FacB;
              pnlTipoComp.Caption := 'B';
            end;
            HabilitarB_Ticket;
          end;
        end;
      end;
    end;
  end;

begin
  SetFac;
  FacVTipoFacStr.AsString := GetText_Comprobante(FacVTipoFactura.AsInteger, 1);
  Application.ProcessMessages;
end;

procedure TfrmFacV.UpdateTotalsFacV;
var
  TempTotal, TempNeto, TempExento,
  TempNoComput, TempIvaAlic1, TempIvaAlic2,
  TempDescuentos, TempLista, TempCuota, EntCont: Currency;
  CoefEntCon: Double;
  PrevRecord: TBookmark;
  TotalItems: Integer;
  P: TPrecios;
begin
  if (not ActualizandoContado) then
  begin
    PrevRecord := ItemsFV.GetBookmark;
    try
      ActualizandoContado := True;
      Total_Fac := 0;
      Total_Lst := 0;
      Total_Cta := 0;
      ItemsFV.DisableControls;
      TempTotal := 0;
      TempNeto := 0;
      TempExento := 0;
      TempNocomput := 0;
      TempIvaAlic1 := 0;
      TempIvaAlic2 := 0;
      TempDescuentos := 0;
      TempLista := 0;
      TempCuota := 0;
      TotalItems := 0;
      CoefEntCon := 0;

      ItemsFV.First;
      while not ItemsFV.Eof do
      begin
        TempLista := TempLista + (ItemsFVPrecioLista.AsCurrency * ItemsFVCantidad.AsFloat);
        ItemsFV.Next;
      end;

      if (FacVEntregaCdo.AsCurrency > 0) and
         (TempLista > 0)and
         (FacVTipoFactura.AsInteger in [FacA, FacB, Tkt]) then
      begin
        ItemsFV.First;
        while not ItemsFV.Eof do
        begin
          CoefEntCon := 0;
          EntCont := 0;
          CoefEntCon := ((((ItemsFVPrecioLista.AsCurrency * ItemsFVCantidad.AsFloat) *
                        100)/TempLista) / 100);
          EntCont := (FacVEntregaCdo.AsCurrency * CoefEntCon);
          if GetPrecio(ItemsFVIdArticulo.AsInteger, FacVIdTarjeta.AsInteger,
                       FacVCantCuotas.AsInteger, ItemsFVPrecioLista.AsCurrency,
                       ItemsFVPrcBonificacion.AsFloat, Coeficiente, EntCont,
                       ItemsFVCantidad.Value, P) > 0 then
          begin
            ItemsFV.Edit;
            ItemsFVCoefEntCon.AsFloat := CoefEntCon;
            ItemsFVEntContado.AsCurrency := EntCont;
            ItemsFVEnOferta.AsBoolean := P.EnOferta;
            ItemsFVPrecioNeto.AsCurrency := P.Neto;
            ItemsFVImpInt.AsCurrency := P.ImpInt;
            ItemsFVExento.AsCurrency := P.Exento;
            ItemsFVAlicuotaIva.AsFloat := P.AlicuotaIva;
            ItemsFVPrecioFinal.AsCurrency := P.PFinal;
            ItemsFVPrecioTotal.AsCurrency := P.Total;
            ItemsFVDescuento.AsCurrency := P.Descto;
            ItemsFVIvaIn.AsCurrency := P.Iva1;
            ItemsFVAlicuotaIB.AsFloat := P.AlicuotaIB;
            ItemsFVIngBto.AsCurrency := P.IngBto;
            ItemsFVCoefIntImp.AsFloat := P.CoefImpInt;
            ItemsFVCantCuotas.AsInteger := FacVCantCuotas.AsInteger;
            ItemsFVValorCta.AsCurrency := P.ValorCuota;
            ItemsFV.Post;
          end;
          ItemsFV.Next;
        end;
      end;
      ItemsFV.First;
      while not ItemsFV.Eof do
      begin
        TempTotal := TempTotal + ItemsFVPrecioTotal.AsCurrency;
        TempNeto := TempNeto + ItemsFVPrecioNeto.AsCurrency;
        TempExento := TempExento + ItemsFVExento.AsCurrency;
        TempNoComput := TempNoComput + ItemsFVImpInt.AsCurrency;
        TempDescuentos := TempDescuentos + ItemsFVDescuento.AsCurrency;
        TempCuota := TempCuota + ItemsFVValorCta.AsCurrency;
        if ItemsFVAlcIva.AsInteger = 1 then
          TempIvaAlic1 := TempIvaAlic1 + ItemsFVIvaIn.Value
        else
          TempIvaAlic2 := TempIvaAlic2 + ItemsFVIvaIn.Value;
        Inc(TotalItems);
        ItemsFV.Next;
      end;

      FacV.Edit;
      FacVTotal.AsCurrency := TempTotal;
      FacVNeto.AsCurrency := TempNeto;
      FacVExento.AsCurrency := TempExento;
      FacVNoComputables.AsCurrency := TempNoComput;
      FacVIvaAlicuota1.AsCurrency := TempIvaAlic1;
      FacVIvaAlicuota2.AsCurrency := TempIvaAlic2;
      FacVBonificacion.AsCurrency := TempDescuentos;
      FacVCantArtic.AsCurrency := TotalItems;
    finally
      Total_Fac := FacVTotal.AsCurrency;
      Total_Dto := FacVBonificacion.AsCurrency;
      Total_Lst := TempLista;
      Total_Cta := TempCuota;
      ItemsFV.EnableControls;
      gFacV.ColumnByName('PrecioLista').FooterValue := Format('%9.2f',[Total_Lst]);
      gFacV.ColumnByName('ValorCta').FooterValue := Format('%9.2f',[Total_Cta]);
      gFacV.ColumnByName('PrecioTotal').FooterValue := Format('%9.2f',[Total_Fac]);
      gFacV.ColumnByName('PrcBonificacion').FooterValue := Format('%9.2f',[Total_Dto]);
      if PrevRecord <> nil then
      begin
        ItemsFV.GotoBookmark(PrevRecord);
        ItemsFV.FreeBookmark(PrevRecord);
      end;
      ActualizandoContado := False;
    end;

    // Chequeo del Impersonal < $1000
    if (FacVTipoIva.Value = CFi) and
       (not Ingresando_Cliente) and
       (FacVCliente.AsInteger = Impersonal) and
       (FacVTipoDoc.AsInteger = Ninguno) and
       (not FNotaDeCredito) and
       (Total_Fac > LimVtaCFi) then
    begin
      raise EUsuario.Create(Format('No se puede vender mas de %m a Consumidor Final, '+
                                   'sin identificar. Agreger Nombre, Dirección, Tipo '+
                                   'y Número de documento. Cancele el comprobante actual. ',[LimVtaCFi]));
    end;
    // Chequeo del CF < $5000
    if (not FNotaDeCredito) and
       (Total_Fac >= LimVtaCFd) and
       (ImprimirEnControlador) and
       (Not ((Tipo_Factura) or (Tipo_Estacion))) then
    begin
      raise EUsuario.Create(Format('No se puede vender mas de %m , en este Modelo de Controlador Fiscal  ',[LimVtaCFd]));
    end;
  end;
end;

procedure TfrmFacV.Ver_Ofertas;
const
   Off = 'Select O.IDSUCURSAL, O.IDARTICULO, O.CANTCTAS, O.FECHAALTA,  '+
         '       O.FECHAFIN, O.PRECIO, O.VALORCTAS, O.CANTAUT, O.CANTVEN, '+
         '       A.MARCA, A.DETALLE, A.CODBARRA '+
         'From ARTOFERTAS O '+
         'Join ARTICULOS A '+
         '  on A.IdArticulo = O.IdArticulo '+
         'Where (A.Activo = 1) And '+
         '      (O.IdSucursal in (0,1)) or (O.IdSucursal = :IdSuc) And '+
         '      ((O.CANTAUT >= O.CANTVEN) or (O.CANTAUT = 0)) '+
         'Order By A.Marca, A.Detalle ';
var
  q: TMDOQuery;
begin
  Cantidad_Ofertas := 0;
  qOfertas.Close;
  qOfertas.SQL.Text := Off;
  qOfertas.ParamByName('IdSuc').AsInteger := IdBranch;
  qOfertas.Open;
  if qOfertas.IsEmpty then
    tsOfertas.TabVisible := False
  else begin
    tsOfertas.TabVisible := True;
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trGestion;
      q.SQL.Add('Select Count(IdArticulo) as C ');
      q.SQL.Add('From ArtOfertas ');
      q.SQL.Add('Where (IdSucursal in (0,1)) or (IdSucursal = :S) ');
      q.ParamByName('S').AsInteger := IdBranch;
      q.Open;
      if not q.IsEmpty then
        Cantidad_Ofertas := q.FieldByName('C').AsInteger
      else
        Cantidad_Ofertas := 0;
      q.Close;
    finally
      q.Free;
    end;
    gOfertas.ColumnByName('Detalle').FooterValue := 'Cantidad Ofertas ';
    gOfertas.ColumnByName('Precio').FooterValue := Format('%d',[Cantidad_Ofertas]);
  end;
end;

procedure TfrmFacV.Vaciar_Tablas;
begin
  try
    try
      Check_Oferta;
      Ver_Ofertas;

      Total_Fac := 0;
      Total_Dto := 0;
      Total_Lst := 0;
      Total_Cta := 0;

      EligioNC := False;
      Comprobante_Manual := False;
      NotaDebito := False;
      FNotaDeCredito := False;
      RemitoEntrega := False;
      Cotizacion := False;
      Factura_Vta := True;
      ActualizandoContado := False;
      Ingresando_Cliente := False;
      ConDescStk := True;
      ItemsFVIdArticulo.ValidChars := CodChars;
      gbHeader.Enabled  := True;
      ComprobanteAbierto := False;

      qComp_Ref.Close;
      if not dmGestion.trGestion.InTransaction then
        dmGestion.trGestion.StartTransaction;
      if FacV.Active then
        FacV.EmptyDataSet
      else
        FacV.CreateDataSet;
      if ItemsFV.Active then
      begin
        if ItemsFV.State in [dsEdit, dsInsert] then
          ItemsFV.Cancel;
        ItemsFV.EmptyDataSet
      end
      else
        ItemsFV.CreateDataSet;

      gbDiscriminacion.Visible := False;
      lblIvaAlc1.Caption := Format('Iva %4.2f',[GetAlcIva(1)])+ '%';
      lblIvaAlc2.Caption := Format('Iva %4.2f',[GetAlcIva(2)])+ '%';

      if ImprimirEnControlador then
      begin
        edtComprobante.ReadOnly := True;
        edtComprobante.TabStop := False;
        edtFechaHoy.ReadOnly := True;
        edtFechaHoy.TabStop := False;
        edtFechaHoy.Enabled := False;
        lblFecha.Enabled := False;
      end
      else begin
        edtComprobante.ReadOnly := False;
        edtComprobante.TabStop := True;
        edtFechaHoy.ReadOnly := False;
        edtFechaHoy.TabStop := True;
        edtFechaHoy.Enabled := True;
        lblFecha.Enabled := True;
      end;

      lblDomEnt.Enabled := True;
      edtDomEnt.Enabled := True;
      lblNCtas.Visible := True;
      edtNCtas.Visible := True;
      edtNCtas.TabStop := True;
      lblTarjeta.Visible := True;
      cbTarjetas.Visible := True;
      lblEntCont.Visible := True;
      edtEntCont.Visible := True;
      edtCompRef.Enabled := False;
      lblCompRef.Enabled := False;
      edtCompRef.Enabled := False;
      lblCompRef.Enabled := False;
      pnlTipoComp.Caption:= '';

      aNotaDeCreditos.Enabled := True;
      Put_Msg('No Olvide actualizar Precios.');
      CompRealizados.Close;
      CompRealizados.Params.ParamByName('HoyDia').AsDate := Date;
      CompRealizados.Params.ParamByName('IdBranch').AsInteger := IdBranch;
      CompRealizados.Open;
      if CompRealizados.IsEmpty then
      begin
        TCon := 0;
        TTkt := 0;
        TTar := 0;
        TSen := 0;
        TChq := 0;
        TOtP := 0;
        TVen := 0;
      end
      else begin
        TCon := CompRealizadosTotCon.Value;
        TTkt := CompRealizadosTotTkt.Value;
        TTar := CompRealizadosTotTar.Value;
        TSen := CompRealizadosTotSen.Value;
        TChq := CompRealizadosTotChq.Value;
        TOtP := CompRealizadosTotOtP.Value;
        TVen := CompRealizadosTotVen.Value;
      end;
    finally
      gCompRealizados.ColumnByName('Contado').FooterValue := Format('%8.2f',[TCon]);
      gCompRealizados.ColumnByName('Tickets').FooterValue := Format('%8.2f',[TTkt]);
      gCompRealizados.ColumnByName('Tarjeta').FooterValue := Format('%8.2f',[TTar]);
      gCompRealizados.ColumnByName('CobSenas').FooterValue := Format('%8.2f',[TSen]);
      gCompRealizados.ColumnByName('Cheque').FooterValue := Format('%8.2f',[TChq]);
      gCompRealizados.ColumnByName('OtrosPagos').FooterValue := Format('%8.2f',[TOtP]);
      gCompRealizados.ColumnByName('Total').FooterValue := Format('%8.2f',[TVen]);
    end;
  except
    on E:Exception do
      raise EUsuario.Create(E.Message);
  end;
end;

procedure TfrmFacV.gCompRealizadosUpdateFooter(Sender: TObject);
begin
  gCompRealizados.ColumnByName('Contado').FooterValue := Format('%8.2f',[TCon]);
  gCompRealizados.ColumnByName('Tickets').FooterValue := Format('%8.2f',[TTkt]);
  gCompRealizados.ColumnByName('Tarjeta').FooterValue := Format('%8.2f',[TTar]);
  gCompRealizados.ColumnByName('CobSenas').FooterValue := Format('%8.2f',[TSen]);
  gCompRealizados.ColumnByName('Cheque').FooterValue := Format('%8.2f',[TChq]);
  gCompRealizados.ColumnByName('OtrosPagos').FooterValue := Format('%8.2f',[TOtP]);
  gCompRealizados.ColumnByName('Total').FooterValue := Format('%8.2f',[TVen]);
end;

procedure TfrmFacV.gCompRealizadosDblClick(Sender: TObject);
begin
  Get_FacV(CompRealizadosIdFactura.AsInteger,
           CompRealizadosIdSucursal.AsInteger,
           CompRealizadosIDPUNTOVENTA.AsInteger);
end;

procedure TfrmFacV.Put_Msg(M: String);
begin
  if (Trim(M) = Vacio) or
     (FacVTipoFactura.AsInteger in [Presupuesto, DebA, DebB, RemitoX]) then
    lblAvisoFac.Visible := False
  else begin
    lblAvisoFac.Visible := True;
    lblAvisoFac.Caption := M;
  end;
end;

procedure TfrmFacV.qOfertasIDSUCURSALGetText(Sender: TField; var Text: string; DisplayText: Boolean);
begin
  if qOfertasIDSUCURSAL.AsInteger = 0 then
    Text := 'T'
  else
    Text := qOfertasIDSUCURSAL.AsString;
end;

procedure TfrmFacV.Cargar_Registro_DeDatos(T: SmallInt);
var
  Actual: Integer;
  TotalR: Currency;
begin
  FillChar(ItemsFiscal, SizeOf(TBody_Fiscal), 0);
  FillChar(Factura, SizeOf(TFactura), 0);

  with Factura do
  begin
    TipoOp := Venta;
    TipoFactura := T;
    TipoFacStr := Vacio;
    NroFactura := '0000-0000000';
    IdStOrigen := 0;
    IdStDestino:= IdBranch;
    FechaF := FacVFechaF.Value;
    FechaI := FacVFechaV.Value;
    PuntoVta := FacVPuntoVta.Value;
    IdPuntoVenta := IdSalesPoint;
    Sector := SectorSistema;
    Factura.IdSucursal := IdBranch;
    IdEmpresa := Id_Cia;
    TipoCompCli := 0;
    CompRef := FacVNroFactura.AsString;
    IdCompRef := FacVIdFactura.AsInteger;
    IdRemito := 0;
    Entidad := FacVCliente.AsInteger;
    NombreEnt := FacVNombreCliente.Value;
    TipoIva := FacVTipoIva.Value;
    TipoIvaStr := FacVTipoIvaStr.AsString;
    TipoDoc := FacVTipoDoc.Value;
    TipoDocStr := FacVTipoDocStr.AsString;
    NroDocumento := FacVNroDocumento.AsString;
    Direccion := FacVDireccion.AsString;
    Localidad := FacVLocalidad.AsString;
    Provincia := FacVProvincia.AsString;
    CodPostal := FacVCodPostal.AsString;
    Telefono  := FacVTelefono.AsString;
    CantArtic := 0;
    Descuento := 0;
    Neto := 0;
    Exento := 0;
    NoComputables := 0;
    AlicuotaIva1 := GetAlcIva(1);
    IvaAlicuota1 := FacVIvaAlicuota1.AsCurrency;
    AlicuotaIva2 := GetAlcIva(2);
    IvaAlicuota2 := FacVIvaAlicuota2.AsCurrency;
    Total := 0;
    Contado := 0;
    BonosTkt := 0;
    Tarjeta := 0;
    IdTarjeta := 0;
    CantCuotas := 0;
    CtaCte := 0;
    ChequeTer := 0;
    CobSenas := 0;
    SdoAFavor:= 0;
    Empleado := FacVEmpleado.AsInteger;
    NombreEmpleado := FacVNombreEmpleado.AsString;
    IdSubDep := FacVIdSubDep.AsInteger;
    DomicilioE := FacVDomEnt.AsString;
    EntregarA := FacVNombreCliente.AsString;
    Imprimir_Totales := True;
  end;

  ItemsFV.First;
  Actual := 1;
  TotalR := 0;
  Case T of
    RemitoTraspaso: begin
      while not ItemsFV.Eof do
      begin
        if (ItemsFVIdSucSalida.AsInteger <> IdBranch) And
           (ItemsFVServicio.AsInteger = Falso) then
        begin
          ItemsFiscal[Actual].IdProducto := ItemsFVIdArticulo.AsInteger;
          ItemsFiscal[Actual].Talle := ItemsFVTalle.AsInteger;
          ItemsFiscal[Actual].CodProd := ItemsFVIdArticulo.AsString;
          ItemsFiscal[Actual].CodySal := ItemsFVIdArticulo.AsString +' '+Get_DetSuc(ItemsFVIdSucSalida.AsInteger, 2);
          ItemsFiscal[Actual].Marca := ItemsFVMarca.AsString;
          ItemsFiscal[Actual].Detalle := ItemsFVDetalle.AsString;
          ItemsFiscal[Actual].DescProd := ItemsFiscal[Actual].Marca +' '+ ItemsFiscal[Actual].Detalle;
          ItemsFiscal[Actual].SubDet := ItemsFVSubDet.AsString;
          ItemsFiscal[Actual].Color := ItemsFVColor.AsString;
          ItemsFiscal[Actual].IdPuntoVenta := IdSalesPoint;
          ItemsFiscal[Actual].IdSucursal := IdBranch;
          ItemsFiscal[Actual].Cantidad := ItemsFVCantidad.AsFloat;
          ItemsFiscal[Actual].Bonificacion := 0;
          ItemsFiscal[Actual].Descuento := 0;
          ItemsFiscal[Actual].PrecioNetoT := ItemsFVPrecioNeto.AsCurrency;
          ItemsFiscal[Actual].PrecioNetoU := ItemsFVPrecioNeto.AsCurrency/ItemsFVCantidad.AsFloat;
          ItemsFiscal[Actual].PrecioFinal := Redondeo(ItemsFVPrecioFinal.AsCurrency, CentavosP);
          ItemsFiscal[Actual].PrecioTotal := ItemsFVPrecioTotal.AsCurrency;
          ItemsFiscal[Actual].Exento := 0;
          ItemsFiscal[Actual].NoComputable := 0;
          ItemsFiscal[Actual].MtoIva := 0;
          ItemsFiscal[Actual].IdAlcIva := 0;
          ItemsFiscal[Actual].AlicuotaIva := 0;
          ItemsFiscal[Actual].TIvaEnt := 0;
          ItemsFiscal[Actual].Servicio := False;
          ItemsFiscal[Actual].CoefImpInt := 0;
          ItemsFiscal[Actual].PrecioCosto := 0;
          ItemsFiscal[Actual].PrecioLista := 0;
          ItemsFiscal[Actual].EnOferta := False;
          ItemsFiscal[Actual].ConDescStk := ConDescStk;
          ItemsFiscal[Actual].MosDom := ItemsFVMostDomi.AsInteger;
          ItemsFiscal[Actual].IdSucSalida  := ItemsFVIdSucSalida.AsInteger;
          ItemsFiscal[Actual].IdSucDestino := IdBranch;
          ItemsFiscal[Actual].IdAutorDto := 0;
          ItemsFiscal[Actual].IdAlcIB := 0;
          ItemsFiscal[Actual].AlicuotaIB := 0;
          ItemsFiscal[Actual].IngBto := 0;
          if Length(Trim(ItemsFVDetalle1.AsString + ItemsFVDetalle2.AsString)) > 0 then
          begin
            ItemsFiscal[Actual].DetalleExtendido := True;
            ItemsFiscal[Actual].DetalleExt[1] := ItemsFVDetalle1.AsString;
            ItemsFiscal[Actual].DetalleExt[2] := ItemsFVDetalle2.AsString;
            ItemsFiscal[Actual].DetalleExt[3] := ItemsFVDetalle3.AsString;
            ItemsFiscal[Actual].DetalleExt[4] := ItemsFVDetalle4.AsString;
          end
          else begin
            ItemsFiscal[Actual].DetalleExtendido := False;
            ItemsFiscal[Actual].DetalleExt[1] := Cero;
            ItemsFiscal[Actual].DetalleExt[2] := Cero;
            ItemsFiscal[Actual].DetalleExt[3] := Cero;
            ItemsFiscal[Actual].DetalleExt[4] := Cero;
          end;
          Inc(Actual);
          TotalR := TotalR + ItemsFVPrecioTotal.AsCurrency;
        end;
        ItemsFV.Next;
      end;
    end;

    RemitoR: begin
      while not ItemsFV.Eof do
      begin
        if (ItemsFVMostDomi.AsInteger = 1) And
           (ItemsFVServicio.AsInteger = Falso) then
        begin
          ItemsFiscal[Actual].IdProducto := ItemsFVIdArticulo.AsInteger;
          ItemsFiscal[Actual].Talle := ItemsFVTalle.AsInteger;
          ItemsFiscal[Actual].CodProd := ItemsFVIdArticulo.AsString;
          ItemsFiscal[Actual].CodySal := ItemsFVIdArticulo.AsString +' '+Get_DetSuc(ItemsFVIdSucSalida.AsInteger, 2);
          ItemsFiscal[Actual].Marca := ItemsFVMarca.AsString;
          ItemsFiscal[Actual].Detalle := ItemsFVDetalle.AsString;
          ItemsFiscal[Actual].DescProd := ItemsFiscal[Actual].Marca +' '+ ItemsFiscal[Actual].Detalle;
          ItemsFiscal[Actual].SubDet := ItemsFVSubDet.AsString;
          ItemsFiscal[Actual].Color := ItemsFVColor.AsString;
          ItemsFiscal[Actual].IdPuntoVenta := IdSalesPoint;
          ItemsFiscal[Actual].IdSucursal := IdBranch;
          ItemsFiscal[Actual].Cantidad := ItemsFVCantidad.AsFloat;
          ItemsFiscal[Actual].Bonificacion := 0;
          ItemsFiscal[Actual].Descuento := 0;
          ItemsFiscal[Actual].PrecioNetoT := 0;
          ItemsFiscal[Actual].PrecioNetoU := 0;
          ItemsFiscal[Actual].PrecioFinal := Redondeo(ItemsFVPrecioFinal.AsCurrency, CentavosP);
          ItemsFiscal[Actual].PrecioTotal := ItemsFVPrecioTotal.AsCurrency;
          ItemsFiscal[Actual].Exento := 0;
          ItemsFiscal[Actual].NoComputable := 0;
          ItemsFiscal[Actual].MtoIva := 0;
          ItemsFiscal[Actual].IdAlcIva := 0;
          ItemsFiscal[Actual].AlicuotaIva := 0;
          ItemsFiscal[Actual].TIvaEnt := 0;
          ItemsFiscal[Actual].Servicio := False;
          ItemsFiscal[Actual].CoefImpInt := 0;
          ItemsFiscal[Actual].PrecioCosto := 0;
          ItemsFiscal[Actual].PrecioLista := 0;
          ItemsFiscal[Actual].EnOferta := False;
          ItemsFiscal[Actual].ConDescStk := False;
          ItemsFiscal[Actual].MosDom := 1;
          ItemsFiscal[Actual].IdSucSalida := IdBranch;
          ItemsFiscal[Actual].IdAutorDto := 0;
          ItemsFiscal[Actual].IdAlcIB := 0;
          ItemsFiscal[Actual].AlicuotaIB := 0;
          ItemsFiscal[Actual].IngBto := 0;
          if Length(Trim(ItemsFVDetalle1.AsString + ItemsFVDetalle2.AsString)) > 0 then
          begin
            ItemsFiscal[Actual].DetalleExtendido := True;
            ItemsFiscal[Actual].DetalleExt[1] := ItemsFVDetalle1.AsString;
            ItemsFiscal[Actual].DetalleExt[2] := ItemsFVDetalle2.AsString;
            ItemsFiscal[Actual].DetalleExt[3] := ItemsFVDetalle3.AsString;
            ItemsFiscal[Actual].DetalleExt[4] := ItemsFVDetalle4.AsString;
          end
          else begin
            ItemsFiscal[Actual].DetalleExtendido := False;
            ItemsFiscal[Actual].DetalleExt[1] := Cero;
            ItemsFiscal[Actual].DetalleExt[2] := Cero;
            ItemsFiscal[Actual].DetalleExt[3] := Cero;
            ItemsFiscal[Actual].DetalleExt[4] := Cero;
          end;
          Inc(Actual);
          TotalR := TotalR + ItemsFVPrecioTotal.AsCurrency;
        end;
        ItemsFV.Next;
      end;
    end;
  end;
end;

procedure TfrmFacV.Cerrar_Comprobante;
var
  i: Integer;
  ComoPago: TAccionPago;
  Cobrado: Currency;
  SaF_Ok: Boolean;
  q: TMDOQuery;

  procedure Cargar_Registro_DeDatos;
  var
    Actual: Integer;
  begin
    with Factura do
    begin
      TipoOp := Venta;
      TipoFactura := FacVTipoFactura.AsInteger;
      TipoFacStr := FacVTipoFacStr.AsString;
      FechaF := FacVFechaF.Value;
      FechaI := FacVFechaV.Value;
      PuntoVta := FacVPuntoVta.Value;
      IdPuntoVenta := IdSalesPoint;
      Sector := SectorSistema;
      Factura.IdSucursal := IdBranch;
      IdEmpresa := Id_Cia;
      NroFactura := FacVNroFactura.Value;
      TipoCompCli := FacVTipoCompCli.Value;
      CompRef := FacVCompRef.Value;
      IdCompRef := FacVIdCompRef.Value;
      IdRemito := FacVIdRemito.AsInteger;
      Entidad := FacVCliente.AsInteger;
      NombreEnt := FacVNombreCliente.Value;
      TipoIva := FacVTipoIva.Value;
      TipoIvaStr := FacVTipoIvaStr.AsString;
      TipoDoc := FacVTipoDoc.Value;
      TipoDocStr := FacVTipoDocStr.AsString;
      NroDocumento := FacVNroDocumento.AsString;
      Direccion := FacVDireccion.AsString;
      Localidad := FacVLocalidad.AsString;
      Provincia := FacVProvincia.AsString;
      CodPostal := FacVCodPostal.AsString;
      Telefono  := FacVTelefono.AsString;
      CantArtic := FacVCantArtic.AsInteger;
      Descuento := FacVBonificacion.AsCurrency;
      Neto := FacVNeto.AsCurrency;
      Exento := FacVExento.AsCurrency;
      NoComputables := FacVNoComputables.AsCurrency;
      AlicuotaIva1 := GetAlcIva(1);
      IvaAlicuota1 := FacVIvaAlicuota1.AsCurrency;
      AlicuotaIva2 := GetAlcIva(2);
      IvaAlicuota2 := FacVIvaAlicuota2.AsCurrency;
      Total := FacVTotal.AsCurrency;
      Contado := DatosPago.PagosContado;
      BonosTkt := DatosPago.PagosBonosTk;
      Tarjeta := DatosPago.PagosTarjeta.TotalTarjeta;
      IdTarjeta := FacVIdTarjeta.AsInteger;
      CantCuotas := DatosPago.CantidadCuotas;
      CtaCte := DatosPago.PagosCtaCte.TotalCtaCte;
      ChequeTer := DatosPago.PagosCheques.TotalValores;
      CobSenas := DatosPago.PagosSena;
      SdoAFavor:= DatosPago.SdoAFavor;
      Empleado := FacVEmpleado.AsInteger;
      NombreEmpleado := FacVNombreEmpleado.AsString;
      IdSubDep := FacVIdSubDep.AsInteger;
      DomicilioE := FacVDomEnt.AsString;
      EntregarA := FacVNombreCliente.AsString;
      Imprimir_Totales := True;
    end;

    ItemsFV.First;
    FillChar(ItemsFiscal, SizeOf(TBody_Fiscal), 0);
    Actual := 1;
    Hay_Domicilio := False;
    while not ItemsFV.Eof do
    begin
      ItemsFiscal[Actual].IdProducto := ItemsFVIdArticulo.AsInteger;
      ItemsFiscal[Actual].Talle := ItemsFVTalle.AsInteger;
      ItemsFiscal[Actual].CodProd := ItemsFVIdArticulo.AsString;
      ItemsFiscal[Actual].CodySal := ItemsFVIdArticulo.AsString +' '+Get_DetSuc(ItemsFVIdSucSalida.AsInteger, 2);
      ItemsFiscal[Actual].Marca := ItemsFVMarca.AsString;
      ItemsFiscal[Actual].Detalle := ItemsFVDetalle.AsString;
      ItemsFiscal[Actual].DescProd := ItemsFiscal[Actual].Marca +' '+ ItemsFiscal[Actual].Detalle;
      ItemsFiscal[Actual].SubDet := ItemsFVSubDet.AsString;
      ItemsFiscal[Actual].Color := ItemsFVColor.AsString;
      ItemsFiscal[Actual].IdPuntoVenta := IdSalesPoint;
      ItemsFiscal[Actual].IdSucursal := IdBranch;
      ItemsFiscal[Actual].Cantidad := ItemsFVCantidad.AsFloat;
      ItemsFiscal[Actual].Bonificacion := ItemsFVPrcBonificacion.AsFloat;
      ItemsFiscal[Actual].Descuento := Redondeo(ItemsFVDescuento.AsCurrency, CentavosP);
      ItemsFiscal[Actual].PrecioNetoT := ItemsFVPrecioNeto.AsCurrency;
      ItemsFiscal[Actual].PrecioNetoU := ItemsFVPrecioNeto.AsCurrency/ItemsFVCantidad.AsFloat;
      ItemsFiscal[Actual].PrecioFinal := Redondeo(ItemsFVPrecioFinal.AsCurrency, CentavosP);
      ItemsFiscal[Actual].PrecioTotal := ItemsFVPrecioTotal.AsCurrency;
      ItemsFiscal[Actual].Exento := ItemsFVExento.AsCurrency;
      ItemsFiscal[Actual].NoComputable := ItemsFVImpInt.AsCurrency;
      ItemsFiscal[Actual].MtoIva := ItemsFVIvaIn.AsCurrency;
      ItemsFiscal[Actual].IdAlcIva := ItemsFVAlcIva.AsInteger;
      ItemsFiscal[Actual].AlicuotaIva := ItemsFVAlicuotaIva.AsFloat;
      ItemsFiscal[Actual].TIvaEnt := FacVTipoIva.AsInteger;
      ItemsFiscal[Actual].Servicio := ItemsFVServicio.AsInteger = Verdadero;
      ItemsFiscal[Actual].CoefImpInt := ItemsFVCoefIntImp.Value;
      ItemsFiscal[Actual].PrecioCosto := ItemsFVPrecioCosto.AsCurrency;
      ItemsFiscal[Actual].PrecioLista := ItemsFVPrecioLista.AsCurrency;
      ItemsFiscal[Actual].EnOferta := ItemsFVEnOferta.AsBoolean;
      ItemsFiscal[Actual].ConDescStk := ConDescStk;
      if (ItemsFVMostDomi.AsInteger = Verdadero) then
       Hay_Domicilio := True;
      ItemsFiscal[Actual].MosDom := ItemsFVMostDomi.AsInteger;
      ItemsFiscal[Actual].IdSucSalida := ItemsFVIdSucSalida.AsInteger;
      ItemsFiscal[Actual].IdAutorDto := ItemsFVIdAutorDto.AsInteger;
      if (ItemsFVIngBto.AsCurrency = 0) then
      begin
        ItemsFiscal[Actual].IdAlcIB := ItemsFVAlcIB.AsInteger;
        ItemsFiscal[Actual].AlicuotaIB := GetAlcIBt(ItemsFVAlcIB.AsInteger) -
                                          ((GetAlcIBt(ItemsFVAlcIB.AsInteger)*
                                          ItemsFVPrcExento.AsFloat)/100);
        ItemsFiscal[Actual].IngBto := ((ItemsFVPrecioNeto.AsCurrency+
                                        ItemsFVImpInt.AsCurrency) *
                                        ItemsFiscal[Actual].AlicuotaIB) / 100;
      end
      else begin
        ItemsFiscal[Actual].IdAlcIB := ItemsFVAlcIB.AsInteger;
        ItemsFiscal[Actual].AlicuotaIB := ItemsFVAlicuotaIB.AsFloat;
        ItemsFiscal[Actual].IngBto := ItemsFVIngBto.AsCurrency;
      end;

      if Length(Trim(ItemsFVDetalle1.AsString + ItemsFVDetalle2.AsString)) > 0 then
      begin
        ItemsFiscal[Actual].DetalleExtendido := True;
        ItemsFiscal[Actual].DetalleExt[1] := ItemsFVDetalle1.AsString;
        ItemsFiscal[Actual].DetalleExt[2] := ItemsFVDetalle2.AsString;
        ItemsFiscal[Actual].DetalleExt[3] := ItemsFVDetalle3.AsString;
        ItemsFiscal[Actual].DetalleExt[4] := ItemsFVDetalle4.AsString;
      end
      else begin
        ItemsFiscal[Actual].DetalleExtendido := False;
        ItemsFiscal[Actual].DetalleExt[1] := Cero;
        ItemsFiscal[Actual].DetalleExt[2] := Cero;
        ItemsFiscal[Actual].DetalleExt[3] := Cero;
        ItemsFiscal[Actual].DetalleExt[4] := Cero;
      end;
      Inc(Actual);
      ItemsFV.Next;
    end;
  end;

begin
  FillChar(DatosPago, SizeOf(DatosPago), 0);
  FillChar(Factura, SizeOf(Factura), 0);
  FillChar(ItemsFiscal, SizeOf(ItemsFiscal), 0);

  ComprobanteOK := False;
  GrabarComprobante := False;
  if FacV.State in dsEditModes then
    FacV.Post;
  if (ItemsFV.State in dsEditModes) and
     (ItemsFVIdArticulo.AsInteger > 0) then
    ItemsFV.Post
  else
    ItemsFV.Cancel;
  DatosPago.IdEntidad := FacVCliente.AsInteger;
  DatosPago.NomEntidad := FacVNombreCliente.AsString;
  DatosPago.IdPuntoVenta := IdSalesPoint;
  DatosPago.IdSucursal := IdBranch;
  DatosPago.FechaOp := FacVFechaF.AsDateTime;
  DatosPago.NroComprobante := FacVNroFactura.AsString;
  DatosPago.TipoComprobante := FacVTipoFactura.AsInteger;
  DatosPago.IdCompRef := FacVIdCompRef.AsInteger;
  DatosPago.CompReferencia := FacVCompRef.AsString;
  DatosPago.Coeficiente := Coeficiente;
  DatosPago.IdTarjeta := FacVIdTarjeta.AsInteger;
  DatosPago.CantidadCuotas := FacVCantCuotas.AsInteger;
  DatosPago.IdVendedor := FacVEmpleado.AsInteger;

  Cargar_Registro_DeDatos;

  // ---------- Presupuestos
  if Cotizacion then
  begin
    if Application.MessageBox('¿Imprimir el presupuesto?.', 'Cotizaciones', MB_ICONQUESTION + MB_YESNO) = IdYes then
    begin
      if (ImprimirEnControlador) and
         (Tipo_Factura or Tipo_Estacion) and
         (ControladorLocal) and
         (not Comprobante_Manual) then
        GrabarComprobante := frmFiscal.ImprimirCotizacionF(Factura, ItemsFiscal)
      else
        GrabarComprobante := Print_Form(Factura, ItemsFiscal);

      if GrabarComprobante then
        if dmSaveFile.GrabarComprobanteVenta(DatosPago, Factura, ItemsFiscal) then
           ShowMessage('El comprobante fue correctamente grabado');
    end
    else begin
      LockWindowUpdate(Handle);
      try
        Vaciar_Tablas;
      finally
        LockWindowUpdate(0);
      end;
      FacV.Insert;
      FacVRetiro.AsInteger := Impersonal;
      Exit;
    end;
  end;

  //--------- Remitos con o sin descuento de Stock
  if RemitoEntrega then
  begin
    Case Application.MessageBox('¿Imprimir el remito con precios?.', 'Remitos X', MB_ICONQUESTION + MB_YESNOCANCEL) of
      IdYes: Factura.Situacion := Verdadero;
      IdNo : Factura.Situacion := Falso;
      IdCancel: begin
        LockWindowUpdate(Handle);
        try
          Vaciar_Tablas;
        finally
          LockWindowUpdate(0);
        end;
        FacV.Insert;
        FacVRetiro.AsInteger := Impersonal;
        Exit;
      end;
    end;

    if Application.MessageBox('¿Imprimir el remito?', 'Remitos X', MB_ICONQUESTION + MB_YESNO) = IdYes then
    begin
      if (ImprimirEnControlador) And
         (Tipo_Factura or Tipo_Estacion) and
         (ControladorLocal) and
         (not Comprobante_Manual) then
        GrabarComprobante := frmFiscal.ImprimirRemitoF(Factura, ItemsFiscal)
      else
        GrabarComprobante := Print_Form(Factura, ItemsFiscal);
    end;
    if GrabarComprobante then
      if dmSaveFile.GrabarComprobanteVenta(DatosPago, Factura, ItemsFiscal) then
         ShowMessage('El comprobante fue correctamente grabado');
  end;

  //------ Notas de Creditos --
  if FNotaDeCredito then
  begin
    if EligioNC then // Con comprobante de referencia
    begin
      ComprobanteOk := False;
      DatosPago.IdComprobante := Comp_Ref.IdFactura;
      DatosPago.IdSucursal := Comp_Ref.IdSucursal;
      DatosPago.IdTarjeta := FacVIdTarjeta.AsInteger;
      DatosPago.CantidadCuotas := FacVCantCuotas.AsInteger;
      DatosPago.TotalPagos := FacVTotal.AsCurrency;
      DatosPago.PagosContado := Comp_Ref.Contado;
      DatosPago.PagosBonosTk := Comp_Ref.Tickets;
      DatosPago.PagosTarjeta.TotalTarjeta := Comp_Ref.Tarjeta;
      DatosPago.PagosCheques.TotalValores := Comp_Ref.Cheque;
      DatosPago.PagosSena := Comp_Ref.CobSenas + Comp_Ref.OtrosPagos;
      DatosPago.TipoComRef := FacVTipoCompRef.AsInteger;

      if DoPagoNC(DatosPago) then
      begin
        if (ImprimirEnControlador) and
           ((Tipo_Factura) or (Tipo_Estacion) or (Tipo_FacNC)) and
           (ControladorLocal) and
           (not Comprobante_Manual) then
        begin
          if ImprimirEnLinea then
            frmFiscal.Cerrar_Comprobante(DatosPago, Factura, Text_PieComprobante)
          else
            ImprimirFactura_Controlador;
        end
        else begin
          if (Application.MessageBox(PChar('¿Graba el Comprobante Nº ' + FacVNroFactura.AsString +' como comprobante manual?'),
                                     'Nota de Crédito manual', MB_ICONQUESTION + MB_YESNO) = IdYes) then
            ComprobanteOk := Print_Form(Factura, ItemsFiscal);
        end;

        if ComprobanteOk then
        begin // Grabar Comprobante
          if dmSaveFile.GrabarComprobanteVenta(DatosPago, Factura, ItemsFiscal) then
          begin
            SaF_Ok := False;
            ShowMessage('El comprobante fue correctamente grabado');
            Case DatosPago.OpcionNC of
              0: begin
                   if (DatosPago.SdoAFavor > 0) and (SdoAFav in DatosPago.PagosRealizados) then
                   begin
                     DatosPago.IdEntidad := Destino_SAF(Factura.Entidad, 'Generar Saldo a Favor');
                     DatosPago.TipoComprobante := SaldoAFavor;
                     DatosPago.NroComprobante := GetNumeroComprobante(IdBranch, PtoVta, 0, ReciboX);
                     Factura.Entidad := DatosPago.IdEntidad;
                     Factura.NroFactura := DatosPago.NroComprobante;
                     Factura.TipoFactura := SaldoAFavor;
                     if (Application.MessageBox(PChar('Prepare impresora para emitir el Recibo del Saldo a Favor del Cliente'), 'SaF', MB_ICONQUESTION+MB_YESNO+MB_DEFBUTTON1) = IdYes) then
                     begin
                       if (ImprimirEnControlador) and
                          (Tipo_Factura or Tipo_Estacion) and
                          (ControladorLocal) and
                          (not Tipo_FacNC) and
                          (not Comprobante_Manual) then
                          SaF_Ok := frmFiscal.ImprimirReciboF(DatosPago, ItemsFiscal,
                                                 'Saldo A Favor por Nota de Credito ',
                                                 'para usar en operaciones futuras ')
                        else
                          SaF_Ok := Print_Form(Factura, ItemsFiscal);
                     end;

                     if SaF_Ok then
                     begin //Gravar Saldo A Favor por lo cobrado en la nota de Credito
                       try
                         if dmSaveFile.Grabar_Senas(DatosPago, SaldoAFavor) then
                           ShowMessage('El Saldo A Favor fue correctamente grabado');
                       except
                         on E:Exception do
                         begin
                           raise EUsuario.Create('Error grabando el SaF del Comprobante Nº '+
                                                  DatosPago.NroComprobante+E.Message);
                         end;
                       end;
                     end
                     else begin
                       ShowMessage('NO se gravo, NI se genero el comprobante del Saldo A Favor.-');
                     end;
                   end;
                 end;
              1: begin

              end;
              2: begin // Saldo a Favor Por Devolución
                   if (DatosPago.SdoAFavor > 0) and
                      (NotaCre in DatosPago.PagosRealizados) then
                   begin
                     DatosPago.IdEntidad := Destino_SAF(Factura.Entidad, 'NC x C: Entidad a Asignar el SaF ');
                     if DatosPago.IdEntidad <> Factura.Entidad then
                     begin
                       DatosPago.TipoComprobante:= SaldoAFavor;
                       DatosPago.NroComprobante := GetNumeroComprobante(IdBranch, PtoVta, 0, ReciboX);
                       Factura.Entidad := DatosPago.IdEntidad;
                       Factura.NroFactura := DatosPago.NroComprobante;
                       Factura.TipoFactura := SaldoAFavor;
                       if (Application.MessageBox(PChar('Prepare impresora para emitir el Recibo del Saldo a Favor del Cliente'), 'SaF', MB_ICONQUESTION+MB_YESNO+MB_DEFBUTTON1) = IdYes) then
                       begin
                         if (ImprimirEnControlador) and
                            (Tipo_Factura or Tipo_Estacion) and
                            (ControladorLocal) and
                            (not Tipo_FacNC) and
                            (not Comprobante_Manual) then
                            SaF_Ok := frmFiscal.ImprimirReciboF(DatosPago, ItemsFiscal,
                                                   'Saldo A Favor por Nota de Credito ',
                                                   'para usar en operaciones futuras ')
                          else
                            SaF_Ok := Print_Form(Factura, ItemsFiscal);
                       end;

                       if SaF_Ok then
                       begin //Grabar Saldo A Favor por lo cobrado en la nota de Credito
                         try
                           if dmSaveFile.Grabar_Senas(DatosPago, SaldoAFavor) then
                             ShowMessage('El Saldo A Favor fue correctamente grabado');
                         except
                           on E:Exception do
                           begin
                             raise EUsuario.Create('Error grabando el SaF del Comp Nº '+
                                                    DatosPago.NroComprobante+' Error: '+
                                                    E.Message);
                           end;
                         end;
                       end
                       else begin
                         ShowMessage('NO se gravo, NI Se genero el comprobante del Saldo A Favor.-');
                       end;
                     end
                     else begin
                       ShowMessage('No se emite, recibo del Saldo A Favor, ya que es el mismo Titular de la NC x C.-');
                     end;
                   end;
                 end;
            end;
          end;
        end;
      end;

      if not ComprobanteOK then
      begin // No Grabar Comprobante
        if (Application.MessageBox(PChar('¿Graba el Comprobante Nº ' + FacVNroFactura.AsString +' como anulado?'), 'NC Anulado', MB_ICONQUESTION + MB_YESNO) = IdYes) then
        begin
          if (ImprimirEnControlador) and
             (ImprimirEnLinea) and
             (Tipo_Factura or Tipo_Estacion) and
             (not Tipo_FacNC) and
             (not Comprobante_Manual) then
          begin
            frmFiscal.CancelarFactura(FNotaDeCredito);
          end;
          GrabarComprobanteCancelado(Factura, ItemsFiscal);
        end;
      end;
    end
    else begin // Sin comprobante de referencia
      GrabarComprobante := False;
      DatosPago.TotalPagos := FacVTotal.AsCurrency;
      ComoPago := DoPago(DatosPago, ImprimirEnLinea);
      DatosPago.OpcionNC := 1;
      case ComoPago of
        apContinuar: begin
          FacV.Edit;
          Exit;
        end;
        apPago: begin
          GrabarComprobante := True;
          if DatosPago.RestaPagar < 0 then
            DatosPago.RestaPagar := -1 * DatosPago.RestaPagar;
        end;
        apCancelo: GrabarComprobante := False;
      end;
      if GrabarComprobante then
      begin
        with DatosPago do
        begin
          gbVuelto.Caption := 'Ult.Op '+ FacVNroFactura.AsString;
          Cobrado := SdoAFavor + PagosSena + PagosContado + PagosBonosTk +
                     PagosTarjeta.TotalTarjeta + PagosCtaCte.TotalCtaCte+
                     PagosCheques.TotalValores + RestaPagar;
          lblTotalOp.Caption := Format('%9.2m', [TotalPagos]);
          lblPagado.Caption  := Format('%9.2m', [Cobrado]);
          lblVuelto.Caption  := Format('%9.2m', [RestaPagar]);
          Application.ProcessMessages;
        end;

        if ImprimirEnControlador then
        begin
          if Comprobante_Manual then
          begin
            ComprobanteOK := True;
            if not ServidorFiscal then
            begin
              repeat
                if (Application.MessageBox(PChar('¿Imprimir Nota de Crédito Nº ' + FacVNroFactura.AsString +' ?'), 'Comprobante', MB_ICONQUESTION + MB_YESNO) = IdYes) then
                  ImprimirFactura_Impresora
                else
                  Break;
              until False;
            end
          end
          else begin
            if ControladorLocal then
            begin
              if ImprimirEnLinea then
              begin
                frmFiscal.Cerrar_Comprobante(DatosPago, Factura, Text_PieComprobante);
                if HayCajon then
                  frmFiscal.AbrirCajon;
              end
              else
                ImprimirFactura_Controlador;
            end
            else begin
              ComprobanteOK := False;
            end;
          end;
        end
        else begin
          ComprobanteOK := True;
          if not ServidorFiscal then
          begin
            repeat
              if (Application.MessageBox(PChar('¿Imprimir Nota de Crédito Nº ' + FacVNroFactura.AsString +' ?'), 'Comprobante', MB_ICONQUESTION + MB_YESNO) = IdYes) then
                ImprimirFactura_Impresora
              else Break;
            until False;
          end
        end;

        // Grabar Comprobante
        if ComprobanteOk then
        begin
          if dmSaveFile.GrabarComprobanteVenta(DatosPago, Factura, ItemsFiscal) then
            ShowMessage('La Nota de Crédito fue correctamente grabada');
        end
        else begin
          if (Application.MessageBox(PChar('Error al leer resultado de impresión de la Nota de Crédito Nº '+FacVNroFactura.AsString+'. Verifiquelo. ¿Lo graba?'),
              'Error de Impresión', MB_ICONQUESTION + MB_YESNO) = IdYes) then
          begin
            if dmSaveFile.GrabarComprobanteVenta(DatosPago, Factura, ItemsFiscal) then
              ShowMessage('La Nota de Crédito fue correctamente grabada.! ');
          end
          else
            ShowMessage('La Nota de Crédito '+Factura.TipoFacStr+' Nº '+Factura.NroFactura+' No se grabo.-');
        end;
      end;

      if not GrabarComprobante then // No Grabar Comprobante
      begin
        if ComoPago = apAnulo then
        begin
          GrabarComprobanteCancelado(Factura, ItemsFiscal);
          if (ImprimirEnControlador) and
             (ImprimirEnLinea) then
            frmFiscal.CancelarFactura(FNotaDeCredito);
        end
        else begin
          if ComoPago = apCancelo then
          begin
            if (not ServidorFiscal) and
               (ImprimirEnControlador) and
               (ImprimirEnLinea) then
            begin
              GrabarComprobanteCancelado(Factura, ItemsFiscal);
              frmFiscal.CancelarFactura(FNotaDeCredito);
            end;
          end;
        end;
      end;
    end;
  end;

  //--------- Facturas, Tiquets y Notas de Debitos
  if Factura_Vta or NotaDebito then
  begin
    GrabarComprobante := False;
    DatosPago.TotalPagos := FacVTotal.AsCurrency;
    try
      ComoPago := DoPago(DatosPago, ImprimirEnLinea);
    except
      on E:Exception do
        raise EUsuario.Create(E.Message);
    end;

    case ComoPago of
      apContinuar: begin
        FacV.Edit;
        Exit;
      end;
      apPago: begin
        GrabarComprobante := True;
        if DatosPago.RestaPagar < 0 then // Si hay resto, le cambio el signo para darlo como vuelto
          DatosPago.RestaPagar := -1 * DatosPago.RestaPagar;
      end;
      apCancelo: begin
        GrabarComprobante := False;
      end;
    end;

    if GrabarComprobante then
    begin
      with DatosPago do
      begin
        gbVuelto.Caption := 'Ult.Op '+ FacVNroFactura.AsString;
        Cobrado := SdoAFavor+PagosSena+PagosContado+PagosBonosTk+
                   PagosTarjeta.TotalTarjeta+PagosCtaCte.TotalCtaCte+
                   PagosCheques.TotalValores+RestaPagar;
        lblTotalOp.Caption := Format('%9.2m', [TotalPagos]);
        lblPagado.Caption  := Format('%9.2m', [Cobrado]);
        lblVuelto.Caption  := Format('%9.2m', [RestaPagar]);
        Application.ProcessMessages;
      end;

      if ImprimirEnControlador then
      begin
        if Comprobante_Manual then
        begin
          ComprobanteOK := True;
          if not ServidorFiscal then
          begin
            repeat
              if (Application.MessageBox(PChar('¿Imprimir Factura Nº ' + FacVNroFactura.AsString +' ?'), 'Comprobante', MB_ICONQUESTION + MB_YESNO) = IdYes) then
                ImprimirFactura_Impresora
              else
                Break;
            until False;
          end
        end
        else begin
          if ControladorLocal then
          begin
            if ImprimirEnLinea then
            begin
              frmFiscal.Cerrar_Comprobante(DatosPago, Factura, Text_PieComprobante);
              if HayCajon then
                frmFiscal.AbrirCajon;
            end
            else
              ImprimirFactura_Controlador;
          end
          else begin
            ComprobanteOK := False;
          end;
        end;
      end
      else begin
        ComprobanteOK := True;
        if not ServidorFiscal then
        begin
          repeat
            if (Application.MessageBox(PChar('¿Imprimir Factura Nº ' + FacVNroFactura.AsString +' ?'), 'Comprobante', MB_ICONQUESTION + MB_YESNO) = IdYes) then
              ImprimirFactura_Impresora
            else Break;
          until False;
        end
      end;

      // Grabar Comprobante
      if ComprobanteOk then
      begin
        if dmSaveFile.GrabarComprobanteVenta(DatosPago, Factura, ItemsFiscal) then
          ShowMessage('La venta fue correctamente grabada');
      end
      else begin
        if (Application.MessageBox(PChar('Error al leer resultado de impresión del comprobante Nº '+FacVNroFactura.AsString+'. Verifiquelo. ¿Lo graba?'),
            'Error de Impresión', MB_ICONQUESTION + MB_YESNO) = IdYes) then
        begin
          if dmSaveFile.GrabarComprobanteVenta(DatosPago, Factura, ItemsFiscal) then
            ShowMessage('El comprobante fue correctamente grabado.! ');
        end
        else
          ShowMessage('El comprobante '+Factura.TipoFacStr+' Nº '+Factura.NroFactura+' No se grabo.-');
      end;

      //-------------------- No Fiscales -------------------------------------
      // Pago con tarjetas imprimir el comprobante No Fiscal
      if Tarjeta in DatosPago.PagosRealizados then
      begin
        if (ImprimirEnControlador) and
           (ControladorLocal) and
           (ComprobanteOK) and
           (not Comprobante_Manual) then
        begin
          if (Not Tipo_Factura) then
          begin
            if (Application.MessageBox('¿Imprimir Voucher de Tarjeta?', 'Tarjetas', MB_ICONQUESTION + MB_YESNO) = IdYes) then
            begin
              for i := 1 to DatosPago.PagosTarjeta.CantTarjetas do
              begin
                with DatosPago.PagosTarjeta.Movimientos[i] do
                  frmFiscal.ImprimirVoucher(Factura.NombreEnt, NomTarjeta, 1, NumTarjeta, Vencimiento, 1,
                            CantidadCuotas, CodigoComercio, Factura.PuntoVta, StrToInt(Lote), Cupon, 1, 1,
                            StrToInt(Autorizacion), TotalTarj, MontoCuota, StrToInt(Copy(DatosPago.NroComprobante, 6, 8)), 1);
              end;
            end;
          end;
        end
      end;

      if (Factura_Vta) And
         (Hacer_Trans_EnFact) then
      begin
        //
      end;

      if (Factura_Vta) And
         (EmitirRtoDomicilio) then
      begin
        //
      end;
    end;

    if not GrabarComprobante then // No Grabar Comprobante
    begin
      if ComoPago = apAnulo then
      begin
        if (ImprimirEnControlador) and
           (not ServidorFiscal) and
           (ControladorLocal) then
        begin
          frmFiscal.CancelarFactura(FNotaDeCredito)
        end;
        GrabarComprobanteCancelado(Factura, ItemsFiscal);
      end;
    end;
  end;

  try
    LockWindowUpdate(Handle);
    Vaciar_Tablas;
  finally
    LockWindowUpdate(0);
  end;
  FacV.Insert;
  FacVRetiro.AsInteger := Impersonal;
end;

procedure TfrmFacV.ImprimirFactura_Impresora;
begin
  ComprobanteOK := Print_Form(Factura, ItemsFiscal);
end;

procedure TfrmFacV.Imprimir_Remito;
begin
  ComprobanteOK := Print_Form(Factura, ItemsFiscal);
end;

procedure TfrmFacV.ImprimirFactura_Controlador;
var
  i: Integer;
begin
  with frmFiscal do
  begin
    if not ControladorOK then
      InicializarControlador;
    if HayCajon then
      AbrirCajon;
    ImprimirEncabezado(Factura);
    for i:= 1 to Factura.CantArtic do
     begin
       if Factura.IvaAlicuota1 >0  then begin
       ItemsFiscal[i].AlicuotaIva := Factura.AlicuotaIva1;
          end
      else  ItemsFiscal[i].AlicuotaIva := Factura.AlicuotaIva2;
      
       ImprimirLineaControlador(ItemsFiscal[i], FNotaDeCredito);
     end;
    Cerrar_Comprobante(DatosPago, Factura, Text_PieComprobante);
  end;
end;

procedure TfrmFacV.GrabarComprobanteCancelado(var Factura: TFactura; var ItemsFactura: TBody_Fiscal);
begin
  FillChar(ItemsFactura, SizeOf(TBody_Fiscal), 0);
  FillChar(DatosPago, SizeOf(DatosPago) ,0);
  Case Factura.TipoFactura of
    FacA,CreA: Factura.TipoFactura := CanceladoA;
    FacB,CreB: Factura.TipoFactura := CanceladoB;
          Tkt: Factura.TipoFactura := CanceladoT;
  end;
  Factura.Total := 0;
  Factura.Neto := 0;
  Factura.Exento := 0;
  Factura.NoComputables := 0;
  Factura.IvaAlicuota1 := 0;
  Factura.Contado := 0;
  Factura.BonosTkt := 0;
  Factura.Tarjeta := 0;
  Factura.CtaCte := 0;
  ComprobanteOK := False;
  if dmSaveFile.GrabarComprobanteVenta(DatosPago, Factura, ItemsFactura) then
    ShowMessage('El comprobante cancelado fue correctamente grabado.-');
end;

procedure TfrmFacV.Cargar_Comprobante_De_Referencia(CR: TComp_Referencia);
var
  Comprobante: St13;
begin
  FacV.Edit;
  FacVRetiro.AsInteger := CR.NCCliente;
  EligioNC := True;
  if RemitoEntrega then
  begin
    FNotaDeCredito := False;
    ConDescStk := True;
  end
  else begin
    FNotaDeCredito := True;
    ConDescStk := True;
  end;

  if not Tipo_Factura then
  begin
    edtComprobante.TabStop := True;
    edtComprobante.ReadOnly := False;
  end;

  SetDatosFacCli;
  Comprobante := Inc_NComp(GetNumeroComprobante(IdBranch, PtoVta,
                           FacVTipoIva.AsInteger, FacVTipoFactura.AsInteger));
  edtComprobante.Text := Comprobante;
  FacVNroFactura.AsString := Comprobante;
  FacVCompRef.AsString := CR.NroFactura;
  FacVIdCompRef.AsInteger := CR.IdFactura;
  FacVIdTarjeta.AsInteger := CR.IdTarjeta;
  FacVEmpleado.AsInteger := CR.Empleado;
  FacVCantCuotas.AsInteger := CR.NroCtas;
  FacVIdSubDep.AsInteger := CR.IdSubDep;
  FacVTipoCompRef.AsInteger := CR.TipoFactura;

  qItemsFac.Close;
  qItemsFac.ParamByName('NroFac').AsInteger := CR.IdFactura;
  qItemsFac.ParamByName('NroSuc').AsInteger := CR.IdSucursal;
  qItemsFac.Open;
  if not qItemsFac.IsEmpty then
  begin
    ItemsFV.First;
    try
      ItemsFV.DisableControls;
      DandoPrecio := True;
      while not qItemsFac.Eof do
      begin
        ItemsFV.Insert;
        if GetDatosArt(qItemsFacIdArticulo.AsInteger, Vacio, Datos_Art) then
        begin
          ItemsFVIdArticulo.AsInteger  := Datos_Art.IdArticulo;
          ItemsFVCodProd.AsString := Datos_Art.CodBarra;
          ItemsFVDescProd.AsString := Datos_Art.DetProd;
          ItemsFVMarca.AsString := Datos_Art.Marca;
          ItemsFVDetalle.AsString := Datos_Art.Detalle;
          ItemsFVColor.AsString := Datos_Art.Color;
          ItemsFVTieneTalle.AsInteger := Datos_Art.TieneTalle;
          ItemsFVAlcIva.AsInteger := Datos_Art.IdAlcI;
          ItemsFVAlcIB.AsInteger := Datos_Art.IdAlcB;
          ItemsFVServicio.AsInteger := Datos_Art.Servicio;
        end;
        ItemsFVCantidad.AsFloat := qItemsFacCantidad.AsFloat;
        ItemsFVPrecioNeto.AsCurrency := qItemsFacPrecioNeto.AsCurrency;
        ItemsFVPrecioFinal.AsCurrency := qItemsFacPrecioFinal.AsCurrency;
        ItemsFVPrecioTotal.AsCurrency := qItemsFacPrecioTotal.AsCurrency;
        ItemsFVSubDet.AsString := qItemsFacSubDet.AsString;
        ItemsFVTalle.AsInteger := qItemsFacTalle.AsInteger;
        ItemsFVImpInt.AsCurrency := qItemsFacImpInt.AsCurrency;
        ItemsFVIvaIn.AsCurrency := qItemsFacIvaIn.AsCurrency;
        ItemsFVCantCuotas.AsInteger := qItemsFacNroCtas.AsInteger;
        ItemsFVPrcBonificacion.AsFloat := qItemsFacPrcBonificacion.AsFloat;
        ItemsFVDescuento.AsCurrency := qItemsFacDescuento.AsCurrency;
        if qItemsFacNroCtas.AsInteger > 0 then
          ItemsFVValorCta.AsCurrency := qItemsFacPrecioTotal.AsCurrency /
                                        qItemsFacNroCtas.AsInteger
        else
          ItemsFVValorCta.AsCurrency := 0;
        ItemsFVPrecioCosto.AsCurrency := qItemsFacPrecioCosto.AsCurrency;
        ItemsFVPrecioLista.AsCurrency := qItemsFacValorLista.AsCurrency;
        ItemsFVMaxDcto.AsFloat := 0;
        ItemsFV.Post;
        qItemsFac.Next;
      end;
    finally
      DandoPrecio := False;
      ItemsFV.EnableControls;
    end;
  end
  else begin
    raise EUsuario.Create('Comprobante de referencia no valido.-');
    FacV.Cancel;
  end;

  //----
  try
    Ingresando_Cliente := True;
    FacV.Edit;
    FacVRetiro.AsInteger := Comp_Ref.NCCliente;
  finally
    Ingresando_Cliente := False;
  end;
end;

procedure TfrmFacV.gFacVKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  FillChar(Elegido, SizeOf(Elegido), NoEncontrado);
  if Shift = [] then
  begin
    case Key of
      VK_RIGHT,
      VK_RETURN,
      VK_TAB   : Atras := False;
      VK_LEFT  : Atras := True;
      VK_F2    : begin // Agregar detalles extendidos
        if (Tipo_Factura) or
           (Comprobante_Manual) or
           ((gFacV.SelectedField.FieldName = ItemsFVCantidad.FieldName) or
           (gFacV.SelectedField.FieldName = ItemsFVSubDet.FieldName)) then
        begin
          frmDlgExt := TfrmDlgExt.Create(Self);
          frmDlgExt.Tipo_Fac := 1;
          frmDlgExt.ShowModal;
        end;
      end;
      VK_F3    : if gFacV.SelectedField.FieldName = ItemsFVIdArticulo.FieldName then
                   Elegido := Search_Prod(Cero, Tarea);
      VK_F5    : Calculadora(Handle);
      VK_ESCAPE: begin
        Put_Msg('No olvide chequear Señas o SAF del Cliente.');
        Cerrar_Comprobante; // Terminar Comprobante
      end;
      else
        inherited KeyDown(Key, Shift);
    end;
    if Elegido.IdArticulo <> NoEncontrado then
    begin
      ItemsFV.Edit;
      ItemsFVIdArticulo.AsInteger := Elegido.IdArticulo;
    end;
  end;
end;

procedure TfrmFacV.edtClienteKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
var
  NuevoCli: Integer;
begin
  case Key of
    VK_F1: begin
      NuevoCli := AltaCliente(1);
      if NuevoCli <> NoEncontrado then
      begin
        FacV.Edit;
        FacVRetiro.AsInteger := NuevoCli;
      end;
    end;
    VK_F3: begin
      if Busca_Cli(IdEntidad, IdSucEnt) then
      begin
        FacV.Edit;
        FacVRetiro.AsInteger := IdEntidad;
      end;
    end;
    VK_ESCAPE: Close
    else begin
      {$INCLUDE IyC_NextEdit.Inc}
    end
  end;
end;

procedure TfrmFacV.FacVNewRecord(DataSet: TDataSet);
begin
  FacVIdSucursal.AsInteger := IdBranch;
  FacVIdLista.AsInteger := 0;
  FacVFechaF.AsDateTime := Date;
  FacVRetiro.AsInteger := Impersonal;
  FacVIdTarjeta.AsInteger := 0;
  FacVNombreRetiro.AsString := Cero;
  FacVEmpleado.AsInteger := 0;
  FacVCantCuotas.AsInteger := 0;
  FacVEntregaCdo.AsCurrency := 0;
  FacVIdSubDep.AsInteger := 0;
  FacVDomEnt.AsString := Cero;
  FacVContado.AsCurrency := 0;
end;

procedure TfrmFacV.ItemsFVAfterDelete(DataSet: TDataSet);
begin
  if DataSet.IsEmpty then
  begin
    if (ImprimirEnControlador) and
       (ImprimirEnLinea) and
       (ControladorLocal) then
    begin
      FillChar(Factura, SizeOf(TFactura), 0);
      FillChar(ItemFiscal, SizeOf(TItemFiscal), 0);
      Factura.NroFactura := FacVNroFactura.AsString;
      Factura.FechaF := FacVFechaF.AsDateTime;
      Factura.CantArtic := 0;
      Factura.Entidad := FacVCliente.AsInteger;
      GrabarComprobanteCancelado(Factura, ItemsFiscal);
      frmFiscal.CancelarFactura(FNotaDeCredito);
    end;
    Vaciar_Tablas;
    FacV.Insert;
    FacVRetiro.AsInteger := Impersonal;
  end
  else begin
    UpdateTotalsFacV;
    ItemsFV.Append;
  end;
end;

procedure TfrmFacV.ItemsFVAfterPost(DataSet: TDataSet);

  procedure CargarRegistroFiscal;
  begin
    FillChar(ItemFiscal, SizeOf(TItemFiscal), 0);
    with ItemFiscal do
    begin
      IdProducto := ItemsFVIdArticulo.AsInteger;
      Talle := ItemsFVTalle.AsInteger;
      Marca := ItemsFVMarca.AsString;
      Detalle := ItemsFVDetalle.AsString;
      CodProd := ItemsFVCodProd.AsString;
      Color := ItemsFVColor.AsString;
      SubDet := ItemsFVSubDet.AsString;
      Cantidad := ItemsFVCantidad.AsFloat;
      PrecioTotal := ItemsFVPrecioTotal.AsCurrency;
      PrecioFinal := ItemsFVPrecioFinal.AsCurrency;
      PrecioNetoT := ItemsFVPrecioNeto.AsCurrency;
      PrecioNetoU := ItemsFVPrecioNeto.AsCurrency/ItemsFVCantidad.AsFloat;
      NoComputable := ItemsFVImpInt.AsCurrency;
      Bonificacion := ItemsFVPrcBonificacion.AsFloat;
      Descuento := ItemsFVDescuento.AsCurrency;
      Exento := ItemsFVPrcExento.AsFloat;
      Servicio := ItemsFVServicio.AsInteger = Verdadero;
      IdAlcIva := ItemsFVAlcIva.AsInteger;
      AlicuotaIva := ItemsFVAlicuotaIva.Value;
      TIvaEnt := FacVTipoIva.AsInteger;
      CoefImpInt := ItemsFVCoefIntImp.Value;
      IdAutorDto := ItemsFVIdAutorDto.AsInteger;

      if Length(ItemsFVDetalle1.AsString + ItemsFVDetalle2.AsString) > 0 then
      begin
        DetalleExtendido := True;
        DetalleExt[1]:= ItemsFVDetalle1.AsString;
        DetalleExt[2]:= ItemsFVDetalle2.AsString;
        DetalleExt[3]:= ItemsFVDetalle3.AsString;
        DetalleExt[4]:= ItemsFVDetalle4.AsString;
      end
      else begin
        DetalleExtendido := False;
        DetalleExt[1]:= Cero;
        DetalleExt[2]:= Cero;
        DetalleExt[3]:= Cero;
        DetalleExt[4]:= Cero;
      end;
    end;
  end;

begin
  UpdateTotalsFacV;
  if (ItemsFVPrecioTotal.AsCurrency > 0) and
     (ItemsFVIdArticulo.AsInteger > 0) then
  begin
    if ImprimirEnLinea then
    begin
      CargarRegistroFiscal;
      frmFiscal.ImprimirLineaControlador(ItemFiscal, FNotaDeCredito);
    end;
  end;
end;

procedure TfrmFacV.ItemsFVNewRecord(DataSet: TDataSet);
begin
  ItemsFVIdFactura.AsInteger := FacVIdFactura.AsInteger;
  ItemsFVCantidad.AsFloat := 1;
  ItemsFVPrcBonificacion.AsFloat := 0;
  ItemsFVDescuento.AsCurrency := 0;
  ItemsFVEnRemito.AsInteger := Falso;
  ItemsFVTieneTalle.AsInteger := Falso;
  ItemsFVCantCuotas.AsInteger := 0;
  ItemsFVValorCta.AsCurrency := 0;
  ItemsFVTalle.AsInteger := SIN_DETALLE_TALLE;
  ItemsFVIdSubDep.AsInteger := FacVIdSubDep.AsInteger;
  ItemsFVMostDomi.AsInteger := 0;
  ItemsFVIdAutorDto.AsInteger := 0;
  ItemsFVIdSucSalida.AsInteger := IdBranch;
  ItemsFVEntContado.AsCurrency := 0;
  ItemsFVMaxDcto.AsFloat := 0;
  ActualizandoTotal := False;
  ActualizandoCantidad := False;
  ActualizandoFinal := False;
  Talle := Cero;
  Put_Msg(Vacio);
end;

procedure TfrmFacV.gFacVEnter(Sender: TObject);
begin
  Put_Msg(Vacio);
  gFacV.SelectedField := ItemsFVIdArticulo;
  if ImprimirEnControlador then
  begin
    if not ControladorOK then
    begin
      if ControladorLocal = True then  // Controlador Local
      begin
        if ImprimirEnLinea then
          ControladorOK := frmFiscal.InicializarControlador;
      end;
    end;
  end;

  Put_Msg(gFacV.Hint);
  if FacV.State in dsEditModes then
    FacV.Post;
  FacV.Edit;
  if (not ImprimioEncabezado) then
  begin
    gbHeader.Enabled := False;
    aNotaDeCreditos.Enabled := False;
    if (ControladorOK) and
       (ImprimirEnLinea) and
       (ControladorLocal) then
    begin
      Factura.TipoFactura := FacVTipoFactura.AsInteger;
      Factura.TipoCompCli := FacVTipoCompCli.Value;
      Factura.NroFactura := FacVNroFactura.AsString;
      Factura.CompRef := FacVCompRef.AsString;
      Factura.NombreEnt := FacVNombreCliente.AsString;
      Factura.Direccion := FacVDireccion.AsString;
      Factura.NroDocumento := FacVNroDocumento.AsString;
      Factura.TipoIva := FacVTipoIva.AsInteger;
      Factura.TipoDoc := FacVTipoDoc.AsInteger;
      Factura.IdCompRef := FacVIdCompRef.AsInteger;
      Factura.IdRemito := FacVIdRemito.AsInteger;
      frmFiscal.ImprimirEncabezado(Factura);
      ImprimioEncabezado := True;
      ComprobanteAbierto := True;
    end;
  end;
end;

procedure TfrmFacV.ItemsFVPrecioTotalChange(Sender: TField);
begin
  ModificaTotal;
end;

procedure TfrmFacV.gFacVColEnter(Sender: TObject);
begin
  if (gFacV.SelectedField.FieldName = 'DescProd') then
  begin
    if Atras then
      gFacV.SelectedIndex := gFacV.SelectedIndex - 1
    else
      gFacV.SelectedIndex := gFacV.SelectedIndex + 1;
  end;

  if (gFacV.SelectedField.FieldName = 'Talle') then
  begin
    if Atras then
      gFacV.SelectedIndex := gFacV.SelectedIndex - 1
    else
      gFacV.SelectedIndex := gFacV.SelectedIndex + 1;
  end;

  if (gFacV.SelectedField.FieldName = 'EntContado') then
  begin
    if Atras then
      gFacV.SelectedIndex := gFacV.SelectedIndex - 1
    else
      gFacV.SelectedIndex := gFacV.SelectedIndex + 1;
  end;

  if (gFacV.SelectedField.FieldName = 'ValorCta') then
  begin
    if Atras then
      gFacV.SelectedIndex := gFacV.SelectedIndex - 1
    else
      gFacV.SelectedIndex := gFacV.SelectedIndex + 1;
  end;
  if (gFacV.SelectedField.FieldName = 'PrecioTotal') and
     (gFacV.ColumnByName('PrecioTotal').ReadOnly = True) then
  begin
    if Atras then
      gFacV.SelectedIndex := gFacV.SelectedIndex - 1
    else
      gFacV.SelectedIndex := gFacV.SelectedIndex + 1;
  end;
  (*
  if (gFacV.SelectedField.FieldName = 'PrecioFinal') and
     (gFacV.ColumnByName('PrecioFinal').ReadOnly = True) then
  begin
    if Atras then
      gFacV.SelectedIndex := gFacV.SelectedIndex - 1
    else
      gFacV.SelectedIndex := gFacV.SelectedIndex + 1;
  end;
  *)
  if (gFacV.SelectedField.FieldName = 'MostDomi') then
  begin
    Put_Msg('0 = Retira Cliente en mostrador. 1 = Enviar a Domicilio');
  end;
end;

procedure TfrmFacV.edtEmpleadoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Case Key of
    VK_F3: begin
      frmBuscaEmp := TfrmBuscaEmp.Create(Self);
      if (frmBuscaEmp.ShowModal = mrOk) and
         (frmBuscaEmp.Elegido <> NoEncontrado) then
      begin
        FacV.Edit;
        FacVEmpleado.AsInteger := frmBuscaEmp.Elegido;
      end;
    end;
    VK_ESCAPE: edtCliente.SetFocus;
    else
      {$INCLUDE IyC_NextEdit.Inc}
  end;
end;

procedure TfrmFacV.FacVClienteChange(Sender: TField);
begin
  edtCliente.SelectAll;
end;

procedure TfrmFacV.edtClienteEnter(Sender: TObject);
begin
  edtCliente.SelectAll;
  Put_Msg(edtCliente.Hint);
  pcTotFacV.ActivePageIndex := 0;
end;

procedure TfrmFacV.gFacVColExit(Sender: TObject);
var
  Text: String;
begin
  if gFacV.Columns[gFacV.SelectedIndex].FieldName = 'IdArticulo' then
  begin
    if (Trim(ItemsFVIdArticulo.AsString) = Vacio) or
       (ItemsFVIdArticulo.IsNull) then
    begin
      Text := ItemsFVIdArticulo.AsString;
      Elegido := Search_Prod(Text, Tarea);
      if Elegido.IdArticulo > NoEncontrado then
      begin
        ItemsFV.Edit;
        ItemsFVIdArticulo.AsInteger := Elegido.IdArticulo;
      end;
      Abort;
    end
    else begin
      if Control_Talles then
      begin
        if (ItemsFVTieneTalle.AsInteger = Verdadero) and
           (ItemsFVIdArticulo.AsInteger > 0) and
           ((ItemsFVTalle.IsNull) or (ItemsFVTalle.AsInteger = SIN_DETALLE_TALLE)) then
        begin
          ItemsFV.Edit;
          ItemsFVTalle.AsInteger := GetTalles(ItemsFVIdArticulo.AsInteger);
        end;
      end;
    end;
  end;
  gFacV.RefreshDisplay;
end;

procedure TfrmFacV.ItemsFVBeforeDelete(DataSet: TDataSet);
begin
  if FNotaDeCredito then
    ShowMessage('Solo se permiten Notas de Créditos parciales por cambio de producto.-');
  if (Application.MessageBox('¿Elimina el producto facturado?', 'Borrar', MB_ICONQUESTION + MB_YESNO + MB_DEFBUTTON2) = ID_NO) then
    Abort;
  if (ImprimirEnControlador) and
     (ImprimirEnLinea) and
     (ControladorLocal) then
  begin
    if (DataSet.RecordCount <> DataSet.RecNo) then
      raise EUsuario.Create('Solo se puede borrar el último producto vendido');
    FillChar(ItemFiscal, SizeOf(TItemFiscal), 0);
    ItemFiscal.Detalle := ItemsFVDetalle.AsString;
    ItemFiscal.PrecioTotal := Redondeo(ItemsFVPrecioFinal.AsCurrency, CentavosP) * ItemsFVCantidad.AsFloat;
    frmFiscal.ImprimirLineaBorrada(ItemFiscal);
  end;
end;

procedure TfrmFacV.edtComprobanteExit(Sender: TObject);
var
  Part1, Part2: Integer;
begin
  try
    Part1 := 0;
    Part2 := 0;
    try
      Part1:= StrToInt(Trim(Copy(edtComprobante.Text,1,Pos('-',edtComprobante.Text)-1)));
    except
      on E: EConvertError do
      begin
        edtComprobante.SetFocus;
        edtComprobante.SelStart := 0;
        edtComprobante.SelLength := 3;
        raise EUsuario.Create('Error en el Pto. de Venta del comprobante');
      end;
    end;

    try
      Part2 := StrToInt(Trim(Copy(edtComprobante.Text,Pos('-',edtComprobante.Text)+1,Length(edtComprobante.Text))));
    except
      on E: EConvertError do
      begin
        edtComprobante.SetFocus;
        edtComprobante.SelStart := 5;
        edtComprobante.SelLength := 8;
        raise EUsuario.Create('Error en el Nº de comprobante');
      end;
    end;
  finally
    FacVNroFactura.AsString := Format('%.4d-%.8d',[Part1,Part2]);
    FacVPuntoVta.AsInteger := Part1;
  end;
end;

procedure TfrmFacV.gFacVKeyPress(Sender: TObject; var Key: Char);
begin
  if (gFacV.SelectedField.DataType in [ftFloat, ftCurrency]) and
     (Key in [',', '.']) then
    Key := DecimalSeparator;
end;

procedure TfrmFacV.edtFechaHoyExit(Sender: TObject);
begin
  try
    StrToDate(edtFechaHoy.Text);
  except
    on E: EConvertError do
    begin
      edtFechaHoy.SetFocus;
      raise EUsuario.Create('Fecha del comprobante inválida');
    end;
  end;
end;

procedure TfrmFacV.ItemsFVIdArticuloSetText(Sender: TField; const Text: String);
begin
  if not DandoPrecio then
  begin
    try
      DatosArticuloBuscado(Sender, Text, Datos_Art);
    except
      on E:Exception do
      begin
        raise EUsuario.Create(E.Message);
      end;
    end;
  end;
end;

procedure TfrmFacV.ItemsFVIdArticuloValidate(Sender: TField);
var
  StkAct: Double;
  P: TPrecios;
begin
  StkAct := 0;
  if not DandoPrecio then
  begin
    try
      DandoPrecio := True;
      try
        if (Sender.AsInteger > 0) and
           (not Sender.IsNull) then
        begin
          DatosArticuloBuscado(Sender, Sender.AsString, Datos_Art);
          ItemsFVTieneTalle.AsInteger := Datos_Art.TieneTalle;
          if GetPrecio(ItemsFVIdArticulo.AsInteger, FacVIdTarjeta.AsInteger,
                       FacVCantCuotas.AsInteger, Datos_Art.Precio,
                       ItemsFVPrcBonificacion.AsFloat, GetCoefTar(FacVIdTarjeta.AsInteger,
                       FacVIdSucursal.AsInteger, FacVCantCuotas.AsInteger),
                       FacVEntregaCdo.AsCurrency, ItemsFVCantidad.Value, P) <= 0 then
          begin
            ItemsFV.Cancel;
            ItemsFV.Append;
            gFacV.SetFocus;
            raise EUsuario.Create('Producto sin precio final. No se puede facturar.-');
          end;

          ItemsFVCodProd.AsString := Datos_Art.CodBarra;
          ItemsFVDescProd.AsString := Datos_Art.DetProd;
          ItemsFVMarca.AsString := Datos_Art.Marca;
          ItemsFVDetalle.AsString := Datos_Art.Detalle;
          ItemsFVColor.AsString := Datos_Art.Color;
          ItemsFVTieneTalle.AsInteger := Datos_Art.TieneTalle;
          ItemsFVEstiloFac.AsInteger := Datos_Art.EstiloFac;
          ItemsFVAlcIva.AsInteger := Datos_Art.IdAlcI;
          ItemsFVAlcIB.AsInteger := Datos_Art.IdAlcB;
          ItemsFVServicio.AsInteger := Datos_Art.Servicio;
          ItemsFVEnOferta.AsBoolean := P.EnOferta;
          ItemsFVPrcExento.AsCurrency := Datos_Art.Exento;
          ItemsFVMtoImpInt.AsCurrency := Datos_Art.ImpInt;
          ItemsFVPrecioOriginal.AsCurrency := Datos_Art.Precio;
          ItemsFVPrecioCosto.AsCurrency := Datos_Art.Costo;
          ItemsFVPrecioNeto.AsCurrency := Redondeo(P.Neto, CentavosP);
          ItemsFVImpInt.AsCurrency := P.ImpInt;
          ItemsFVExento.AsCurrency := P.Exento;
          ItemsFVAlicuotaIva.AsFloat := P.AlicuotaIva;
          ItemsFVPrecioFinal.AsCurrency := P.PFinal;
          ItemsFVPrecioTotal.AsCurrency := P.Total;
          ItemsFVDescuento.AsCurrency := P.Descto;
          ItemsFVIvaIn.AsCurrency := P.Iva1;
          ItemsFVAlicuotaIB.AsFloat := P.AlicuotaIB;
          ItemsFVIngBto.AsCurrency := P.IngBto;
          ItemsFVCoefIntImp.AsFloat := P.CoefImpInt;
          ItemsFVCantCuotas.AsInteger := FacVCantCuotas.AsInteger;
          ItemsFVValorCta.AsCurrency := P.ValorCuota;
          ItemsFVPrecioLista.AsCurrency := P.PLista;
          ItemsFVEntContado.AsCurrency := P.EntContado;
          ItemsFVMaxDcto.AsFloat := MaxDctoPermitido(ItemsFVIdArticulo.AsInteger,
                                                     FacVIdTarjeta.AsInteger,
                                                     FacVCantCuotas.AsInteger,
                                                     FacVIdSucursal.AsInteger);
          if ItemsFVTieneTalle.AsInteger = Verdadero then
          begin
            StkAct := Get_Stock(Sender.AsInteger, IdBranch, 0, False);
            sbFacV.SimpleCaption := Format('Stk = %d ',[StkAct]);
            if StkAct <= 0 then
              ShowMessage('el producto no tiene Stock, verifiquelo. ');
            gFacV.Refresh;
          end;

          Case Datos_Art.EstiloFac of
            PedirTodo: begin   // Editar todos los Datos
              gFacV.ColumnByName('Cantidad').ReadOnly := False;
              gFacV.ColumnByName('PrecioTotal').ReadOnly := True;
            end;
            PedirCant: begin  // Pedir solo Cantidad
              gFacV.ColumnByName('PrecioTotal').ReadOnly := True;
              //gFacV.ColumnByName('PrecioFinal').ReadOnly := True;
            end;
            PedirTotal: begin // Pedir solo Total
              gFacV.ColumnByName('PrecioTotal').ReadOnly := True;  // desabilitar p' que funcione pedir total
              //gFacV.ColumnByName('PrecioFinal').ReadOnly := True;
              gFacV.ColumnByName('Cantidad').ReadOnly := True;
            end;
          end;
        end;
      finally
        DandoPrecio := False;
      end;
    except
      on E:Exception do
      begin
        raise EUsuario.Create('Error validando producto: '+E.Message);
      end;
    end;
  end;
  gFacV.RefreshDisplay;
end;

procedure TfrmFacV.ItemsFVMostDomiValidate(Sender: TField);
begin
  if not (ItemsFVMostDomi.AsInteger in [Falso, Verdadero]) then
  begin
    raise EUsuario.Create('0 = Retira Cliente en mostrador. 1 = Enviar a Domicilio');
  end
  else begin
    If (ItemsFVServicio.AsInteger = Verdadero) and
       (ItemsFVMostDomi.AsInteger = Verdadero) then
      ShowMessage('Esta enviando un producto "servicio" a domicilio. ')
    else
     Put_Msg('0 = Retira Cliente en mostrador. 1 = Enviar a Domicilio. Cobrar flete ');
  end;
end;

function TfrmFacV.Get_Senas_SaF_NCC(C, S: Integer): Currency;
(*
Select F.IdFactura, F.IdSucursal, F.IdPuntoVenta, F.Cliente,
      F.NroFactura, F.TipoFactura, F.FechaF, F.Total, F.Impresa,
      T.DescCorta as TipoFac
From FacVen F
Left Outer Join TiposComp T
  on T.IdComprobante = F.TipoFactura
Where F.TipoFactura in (42, 100)  And
      F.Cliente=:Cliente And
      F.Impresa = 1 And
      F.IdSucursal =:Sucur
Order By F.FechaF desc
*)

Const
  Pend = 'Select Sum(F.TOTAL) as Saldo '+
         'From FacVen F '+
         'Where (F.State = 0) and '+
         '      (((F.TIPOFACTURA in (42, 100)) And (F.IMPRESA = 1)) or '+
         '       ((F.TIPOFACTURA in (3,8)) And (F.SITUACION = 2) and '+
         '       (F.Impresa = 0))) and '+
         '      (F.CLIENTE = :C) and (F.IdSucursal =:S)';
var
  q: TMDOQuery;
begin
  Result := 0;
  try
    q := TMDOQuery.Create(nil);
    q.Database := dmGestion.dbGestion;
    q.Transaction := dmGestion.trProc;
    q.SQL.Text := Pend;
    q.ParamByName('C').AsInteger := C;
    q.ParamByName('S').AsInteger := S;
    q.Open;
    Result := q.FieldByName('Saldo').AsCurrency;
    q.Close;
  finally
    q.Free;
  end;
end;

procedure TfrmFacV.FacVRetiroValidate(Sender: TField);
var
  Comprobante: St13;
begin
  try
    if not Ingresando_Cliente then
    begin
      Sen_SaF_NCxC := 0;
      Ingresando_Cliente := True;
      if Sender.AsInteger <> Impersonal then
      begin
        if GetDatosEnt(Sender.AsInteger, IdBranch, 1, Datos_Ent) then
        begin
          FacVCliente.AsInteger := Sender.AsInteger;
          FacVNombreRetiro.AsString := Cero;
        end
        else begin
          edtCliente.SetFocus;
          raise EUsuario.Create('Código de Cliente invalido');
        end;

        if (Trim(Datos_Ent.Direccion) = Vacio) or
           (Datos_Ent.TipoIva = 0) or
           (Datos_Ent.TipoDoc = 0) or
           (Trim(Datos_Ent.Documento) = Vacio) then
          ShowMessage('Falta o No es valido alguno de los datos requeridos en el Cliente.-');

        Sen_SaF_NCxC := Get_Senas_SaF_NCC(Sender.AsInteger, IdBranch);
        if Sen_SaF_NCxC <> 0 then
          Put_Msg(Format('El Cliente posee Señas, SaF, NCxC por %m', [Sen_SaF_NCxC]))
        else
          Put_Msg(Vacio);

        FacVNombreCliente.AsString := Datos_Ent.Nombre;
        FacVLocalidad.AsString := Datos_Ent.Localidad;
        FacVProvincia.AsString := Datos_Ent.Provincia;
        FacVTelefono.AsString  := Datos_Ent.Telefono;
        FacVCodPostal.AsString := Datos_Ent.CodPostal;
        FacVDireccion.AsString := Copy(Datos_Ent.Direccion, 1, 20)+' '+Copy(Datos_Ent.Localidad, 1, 10)+' '+Copy(Datos_Ent.Telefono, 1, 20);
        FacVTipoIva.AsInteger := Datos_Ent.TipoIva;
        FacVTipoDoc.AsInteger := Datos_Ent.TipoDoc;
        FacVTipoCompCli.AsInteger := En_Slip;
        FacVDomEnt.AsString := Datos_Ent.Direccion+' '+Datos_Ent.Localidad+' '+Datos_Ent.Telefono;
        if FacVTipoDoc.AsInteger = CUIT then
          FacVNroDocumento.AsString := StringReplace(Datos_Ent.Documento, '-', '', [rfReplaceAll])
        else
          FacVNroDocumento.AsString := StringReplace(Datos_Ent.Documento, '.', '', [rfReplaceAll]);
        FacVTipoIvaStr.AsString := Datos_Ent.DetIva;

        if FacVNombreRetiro.AsString > Cero  then
          lblDatosCli.Caption := 'Retira: ' + FacVNombreRetiro.AsString
        else
          lblDatosCli.Caption := ' - '+ Datos_Ent.DetIva +' - '+ Datos_Ent.DetDoc+': '+ Datos_Ent.Documento;
        //
        SetDatosFacCli;
        Comprobante := Inc_NComp(GetNumeroComprobante(IdBranch, PtoVta, Datos_Ent.TipoIva, FacVTipoFactura.AsInteger));
        edtComprobante.Text  := Comprobante;
        FacVNroFactura.AsString := Comprobante;
        //
        Application.ProcessMessages;
      end
      else begin
        if (RemitoEntrega) then
        begin
          if Sender.AsInteger = Impersonal then
          begin
            edtCliente.SetFocus;
            raise EUsuario.Create('No se puede emitir Remitos Impersonales.-');
          end;
        end
        else begin
          FacVCliente.AsInteger := Impersonal;
          FacVNombreCliente.AsString := Nombre_Impersonal;
          FacVTipoIva.AsInteger := CFi;
          FacVTipoDoc.AsInteger := Ninguno;
          FacVNroDocumento.AsString := Cero;
          FacVTipoCompCli.AsInteger := En_Ticket;
          SetDatosFacCli;
          Comprobante := Inc_NComp(GetNumeroComprobante(IdBranch, PtoVta, FacVTipoIva.AsInteger, FacVTipoFactura.AsInteger));
          edtComprobante.Text := Comprobante;
          FacVNroFactura.AsString := Comprobante;
          lblDatosCli.Caption := ' - a Consumidor Final ';
        end;
      end;
    end;
  finally
    gbHeader.Refresh;
    Ingresando_Cliente := False;
  end;
end;

procedure TfrmFacV.gbVueltoMouseDown(Sender: TObject; Button: TMouseButton; Shift: TShiftState; X, Y: Integer);
begin
  if (Button = mbLeft) and
     (ssCtrl in Shift) and
     (HayCajon) and
     (ImprimirEnControlador) then
  begin
    if Application.MessageBox('¿Abrir Cajón de dinero?', 'Caja', MB_ICONQUESTION + MB_YESNO) = IDYES then
      frmFiscal.AbrirCajon;
  end;
end;

procedure TfrmFacV.ItemsFVPrecioFinalChange(Sender: TField);
begin
  try
    if (not ItemsFVIdArticulo.IsNull) and
       (not Sender.IsNull) then
      ModificaFinal(ItemsFVPrecioFinal.AsCurrency);
  except
    ShowMessage('Error en Cambio de Precio final');
  end;
end;

procedure TfrmFacV.ItemsFVPrecioListaChange(Sender: TField);
begin
  if not ChequeandoPLista then
  begin
    try
      ChequeandoPLista := True;
      if ItemsFVPrecioLista.AsCurrency < ItemsFVPrecioOriginal.AsCurrency then
        ItemsFVPrecioLista.AsCurrency := ItemsFVPrecioOriginal.AsCurrency;
      gFacV.RefreshDisplay;
    finally
      ChequeandoPLista := False;
    end;
  end;
end;

procedure TfrmFacV.ItemsFVPrecioListaValidate(Sender: TField);
begin
  try
    if (not ItemsFVIdArticulo.IsNull) and
       (not Sender.IsNull) then
      ModificaFinal(ItemsFVPrecioLista.AsCurrency);
  except
    ShowMessage('Error en Cambio de Precio de Lista.-');
  end;
end;

procedure TfrmFacV.ItemsFVCantidadChange(Sender: TField);
var
  P: TPrecios;
begin
  if (ItemsFVIdArticulo.AsInteger > 0) and
     ((ItemsFVCantidad.AsFloat > 0) or (ItemsFVCantidad.AsFloat <= MaxCntIt)) then
  begin
    try
      if (not ActualizandoCantidad) and
         (not ActualizandoFinal) and
         (not FNotaDeCredito) and
         (not ActualizandoTotal) and
         (not DandoPrecio) and
         (not ActualizandoDescuento) and
         (not ActualizandoContado) then
      begin
        ActualizandoCantidad := True;

        if GetPrecio(ItemsFVIdArticulo.AsInteger, FacVIdTarjeta.AsInteger,
                     FacVCantCuotas.AsInteger, ItemsFVPrecioLista.AsCurrency,
                     ItemsFVPrcBonificacion.AsFloat, Coeficiente,
                     FacVEntregaCdo.AsCurrency, ItemsFVCantidad.AsFloat, P) >= 0 then
        begin
          ItemsFVPrecioFinal.Value := P.PFinal;
          ItemsFVPrecioTotal.Value := P.Total;
          ItemsFVPrecioNeto.Value := P.Neto;
          ItemsFVPrecioOriginal.Value := P.PLista;
          ItemsFVIvaIn.Value := P.Iva1;
          ItemsFVImpInt.Value := P.ImpInt;
          ItemsFVExento.Value := P.Exento;
          ItemsFVAlcIB.Value := P.IdAlcIB;
          ItemsFVAlcIva.Value := P.IdAlcIva;
          ItemsFVAlicuotaIB.Value := P.AlicuotaIB;
          ItemsFVIngBto.Value := P.IngBto;
          ItemsFVAlicuotaIva.Value := P.AlicuotaIva;
          ItemsFVCoefIntImp.Value := P.CoefImpInt;
          ItemsFVValorCta.Value := P.ValorCuota;
          gFacV.RefreshDisplay;
        end;
      end;
    finally
      ActualizandoCantidad := False;
    end;
  end;
end;

procedure TfrmFacV.ItemsFVCantidadValidate(Sender: TField);
begin
  if ((ItemsFVCantidad.IsNull) or
     (ItemsFVCantidad.AsFloat <= 0) or
     (ItemsFVCantidad.AsFloat > MaxCntIt)) then
    raise EUsuario.Create('Cantidad mal ingresada.-');

  if ImprimirEnControlador then
  begin
    if (Sender.Value > MaxCntIt) or
       (Sender.Value < 0) or
       (Sender.IsNull) then
      raise EUsuario.Create('¡ Cantidad ingresada no valida para Imprimir en Controlador Fiscal... !');
  end;
end;

procedure TfrmFacV.gFacVCalcCellColors(Sender: TObject; Field: TField; State: TGridDrawState;
          Highlight: Boolean; AFont: TFont; ABrush: TBrush);
begin
  if Highlight then
  begin
    if State = [gdSelected, gdFocused] then
    begin
      if ItemsFVEnOferta.AsBoolean then
      begin
        //ABrush.Color:= clMaroon;
        AFont.Color := clWhite;
        AFont.Style := [fsItalic];
      end
      else begin
        AFont.Color := clWhite;
        AFont.Style := [fsBold];
      end;
    end
    else begin
      if ItemsFVEnOferta.AsBoolean then
      begin
        ABrush.Color:= clMaroon;
        AFont.Color := clWhite;
        AFont.Style := [fsItalic];
      end
      else begin
        AFont.Color := clBlack;
        AFont.Style := [];
      end;
    end;
  end
  else begin
    if ItemsFVEnOferta.AsBoolean then
    begin
      ABrush.Color := clBlack;
      AFont.Color := clLime;
      AFont.Style := [fsBold, fsUnderline];
    end
  end;
end;

procedure TfrmFacV.ItemsFVPrecioTotalValidate(Sender: TField);
begin
  if ImprimirEnControlador then
  begin
    if (not ItemsFVIdArticulo.IsNull) and
       (not Tipo_Factura) and
       (not Tipo_Estacion) and
       ((Sender.Value > 999999.9999) or (Sender.Value < 0)) And
       (not Comprobante_Manual) And
       (not Cotizacion) then
     begin
       raise EUsuario.Create('¡ Precio Total ingresado no valido para Facturar en controlador... !');
     end;
  end;
end;

procedure TfrmFacV.edtComprobanteKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_ESCAPE then
    edtCliente.SetFocus
  else begin
    {$INCLUDE IyC_NextEdit.Inc}
  end
end;

procedure TfrmFacV.edtDomEntEnter(Sender: TObject);
begin
  edtDomEnt.SelectAll;
  Put_Msg(edtDomEnt.Hint);
end;

procedure TfrmFacV.edtEntContEnter(Sender: TObject);
begin
  edtEntCont.SelectAll;
  Put_Msg(edtEntCont.Hint);
end;

procedure TfrmFacV.edtEntContKeyPress(Sender: TObject; var Key: Char);
begin
  if Key in [',', '.'] then
    Key := DecimalSeparator;
end;

procedure TfrmFacV.edtFechaHoyKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_ESCAPE then
    edtCliente.SetFocus
  else begin
    {$INCLUDE IyC_NextEdit.Inc}
  end
end;

procedure TfrmFacV.edtComprobanteEnter(Sender: TObject);
begin
  edtComprobante.SelectAll;
  Put_Msg(edtComprobante.Hint);
end;

procedure TfrmFacV.edtFechaHoyEnter(Sender: TObject);
begin
  edtFechaHoy.SelectAll;
  Put_Msg(edtFechaHoy.Hint);
end;

procedure TfrmFacV.edtEmpleadoEnter(Sender: TObject);
begin
  edtEmpleado.SelectAll;
  Put_Msg(edtEmpleado.Hint);
end;

procedure TfrmFacV.ItemsFVBeforeInsert(DataSet: TDataSet);
begin
  sbFacV.SimpleCaption := ' ';
  if FacVCantArtic.AsInteger >= Cantidad_Productos then
    raise EUsuario.Create('Formulario lleno. No se pueden agregar mas items.');
end;

procedure TfrmFacV.ItemsFVBeforeEdit(DataSet: TDataSet);
begin
  if (ImprimirEnControlador) and
     (ImprimirEnLinea) and
     (ControladorLocal) then
  begin
    if ItemsFVIdArticulo.AsInteger > 0 then
      raise EUsuario.Create('No puede modificar un producto ya facturado');
  end;
end;

procedure TfrmFacV.FacVTipoFacturaValidate(Sender: TField);
var
  q: TMDOQuery;
begin
  if not ImprimirEnControlador then
  begin
    try
      q := TMDOQuery.Create(nil);
      q.Database := dmGestion.dbGestion;
      q.Transaction := dmGestion.trProc;
      q.SQL.Add('Select Cantidad_Items ');
      q.SQL.Add('From DefComp ');
      q.SQL.Add('Where TipoComp = :T ');
      q.ParamByName('T').AsInteger := FacVTipoFactura.AsInteger;
      q.Open;
      if not q.IsEmpty then
        Cantidad_Productos := q.FieldByName('Cantidad_Items').AsInteger
      else
        Cantidad_Productos := MaxBody;
      q.Close;
    finally
      q.Free;
    end;

    if FNotaDeCredito then
      lblModoFacturacionNC.Caption := 'Nota de'+#13#10+'Crédito'
    else
      lblModoFacturacionNC.Caption := 'Facturación';
    if NotaDebito then
      lblModoFacturacionNC.Caption := 'Nota de'+#13#10+'Débito';
    if Cotizacion then
      lblModoFacturacionNC.Caption := 'Presupuesto';
    if RemitoEntrega then
      lblModoFacturacionNC.Caption := 'Remito'+#13#10+'de Salida';
  end
  else begin
    Cantidad_Productos := MaxBody;
    if ControladorOK then
      ImprimioEncabezado := False;
    if ControladorLocal then
    begin
      if ImprimirEnLinea then
        lblModoFacturacionNC.Caption := 'Facturación'+#13#10+'en Linea '
      else
        lblModoFacturacionNC.Caption := 'Facturación'+#13#10+'al Cierre';
      if Cotizacion then
        lblModoFacturacionNC.Caption := 'Presupuesto';
      if RemitoEntrega then
        lblModoFacturacionNC.Caption := 'Remito'+#13#10+'de Salida';
      if NotaDebito then
        lblModoFacturacionNC.Caption := 'Nota de'+#13#10+'Débito';
      if FNotaDeCredito then
      begin
        if (Tipo_Factura) or (Tipo_Estacion) or
           (not ImprimirEnControlador) then
          lblModoFacturacionNC.Caption := 'Nota de'+#13#10+'Crédito'
        else
          lblModoFacturacionNC.Caption := 'Devolución';
      end;
    end
    else begin
      if ServidorFiscal then
        lblModoFacturacionNC.Caption := 'Facturación a'+#13#10+'Servidor Fiscal'
      else
        lblModoFacturacionNC.Caption := ' ERROR!!! ';
    end
  end;
  if Comprobante_Manual then
    lblModoFacturacionNC.Caption := lblModoFacturacionNC.Caption + ' Manual';
end;

procedure TfrmFacV.edtNCClienteEnter(Sender: TObject);
begin
  edtNCCliente.SelectAll;
  Put_Msg(edtNCCliente.Hint);
end;

procedure TfrmFacV.edtNCClienteKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  case Key of
      VK_F3: begin
        if Busca_Cli(IdEntidad, IdSucEnt) then
          edtNCCliente.Text := IntToStr(IdEntidad);
      end;
      VK_ESCAPE: begin
        gbNotasCreditos.Visible := False;
        Put_Msg(Vacio);
        FNotaDeCredito := False;
        if qComp_Ref.Active then
          qComp_Ref.Close;
        gbHeader.Enabled := True;
        aNotaDeCreditos.Enabled := True;
        edtCliente.SetFocus;
      end
    else begin
      {$INCLUDE IyC_NextEdit.Inc}
    end
  end;
end;

procedure TfrmFacV.btnNCCerrarClick(Sender: TObject);
begin
  gbNotasCreditos.Visible := False;
  Put_Msg(Vacio);
  if qComp_Ref.Active then
    qComp_Ref.Close;
  gbHeader.Enabled := True;
  aNotaDeCreditos.Enabled := True;
  Vaciar_Tablas;
  FacV.Insert;
  FacVRetiro.AsInteger := Impersonal;
end;

procedure TfrmFacV.edtNCClienteExit(Sender: TObject);
var
  ClienteNC: Integer;
begin
  ClienteNC := 0;
  if Trim(edtNCCliente.Text) > Cero then
  begin
    try
      ClienteNC := StrToInt(Trim(edtNCCliente.Text));
    except
      lblNCNomCli.Caption := '  ';
      edtNCCliente.SetFocus;
      ClienteNC := 0;
      raise EUsuario.Create('Nº de cliente erroneo');
    end;
    try
      qComp_Ref.Close;
      if GetDatosEnt(ClienteNC, IdBranch, 1, Datos_Ent) then
      begin
        lblNCNomCli.Caption := Datos_Ent.Nombre+' '+Datos_Ent.DetDoc+' '+Datos_Ent.Documento;
        qComp_Ref.SQL.Text := StringReplace(Busca_NC, '<Cond>', ' And (F.Cliente = '+IntToStr(ClienteNC)+')', [rfReplaceAll]);
        qComp_Ref.ParamByName('Sucur').AsInteger := IdBranch;
        qComp_Ref.Open;
        if qComp_Ref.IsEmpty then
        begin
          edtNCCliente.Text := '0';
          edtNCCliente.SetFocus;
          ShowMessage('El Cliente '+ Datos_Ent.Nombre +' no registra movimientos')
        end
        else begin
          gFacVenEnc.SetFocus;
        end;
      end;
    except
      on E:Exception do
      begin
        edtNCCliente.Text := '0';
        lblNCNomCli.Caption := ' Nº de Cliente no encontrado ';
        edtNCCliente.SetFocus;
        raise EUsuario.Create(E.Message);
      end;
    end;
  end
  else begin
    if not btnNCCerrar.Focused then
      edtNCCliente.SetFocus;
  end;
end;

procedure TfrmFacV.edtNCNroCompEnter(Sender: TObject);
begin
  edtNCNroComp.SelectAll;
  Put_Msg(edtNCNroComp.Hint);
end;

procedure TfrmFacV.edtNCNroCompExit(Sender: TObject);
Var
  Part1, Part2: Integer;
begin
  if Trim(edtNCNroComp.Text) > Vacio then
  begin
    try
      Part1 := 0;
      Part2 := 0;
      try
        Part1:= StrToInt(Trim(Copy(edtNCNroComp.Text,1,Pos('-',edtNCNroComp.Text)-1)));
      except
        on E: EConvertError do
        begin
          edtNCNroComp.SetFocus;
          edtNCNroComp.SelStart := 0;
          edtNCNroComp.SelLength := 3;
          raise EUsuario.Create('Error en el Pto. de Venta del comprobante');
        end;
      end;
      try
        Part2:= StrToInt(Trim(Copy(edtNCNroComp.Text,Pos('-',edtNCNroComp.Text)+1,Length(edtNCNroComp.Text))));
      except
        on E: EConvertError do
        begin
          edtNCNroComp.SetFocus;
          edtNCNroComp.SelStart := 5;
          edtNCNroComp.SelLength := 8;
          raise EUsuario.Create('Error en el Nº de comprobante');
        end;
      end;
    finally
      edtNCNroComp.Text := Format('%.4d-%.8d', [Part1,Part2]);
      try
        qComp_Ref.Close;
        lblNCNomCli.Caption := 'por comprobante';
        qComp_Ref.SQL.Text := StringReplace(Busca_NC, '<Cond>', ' And (F.NroFactura = '+QuotedStr(edtNCNroComp.Text)+')', [rfReplaceAll]);
        qComp_Ref.ParamByName('Sucur').AsInteger := IdBranch;
        qComp_Ref.Open;
        if qComp_Ref.IsEmpty then
        begin
          lblNCNomCli.Caption := '';
          edtNCCliente.SetFocus;
          ShowMessage('El comprobante Nº '+ edtNCNroComp.Text +' no fue encontrado. Verifique.- ')
        end
        else begin
          if GetDatosEnt(qComp_RefCLIENTE.AsInteger, IdBranch, 1, Datos_Ent) then
            lblNCNomCli.Caption := Datos_Ent.Nombre+' '+Datos_Ent.DetDoc+' '+Datos_Ent.Documento;
          gFacVenEnc.SetFocus;
        end;
      except
        edtNCCliente.SetFocus;
        raise;
      end;
    end;
  end;
end;

procedure TfrmFacV.edtNCNroCompKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_ESCAPE then
  begin
    gbNotasCreditos.Visible := False;
    Put_Msg(Vacio);
    FNotaDeCredito := False;
    RemitoEntrega := False;
    if qComp_Ref.Active then
      qComp_Ref.Close;
    gbHeader.Enabled := True;
    aNotaDeCreditos.Enabled := True;
    edtCliente.SetFocus;
  end
  else begin
    {$INCLUDE IyC_NextEdit.Inc}
  end
end;

procedure TfrmFacV.edtNCtasEnter(Sender: TObject);
begin
  edtNCtas.SelectAll;
  Put_Msg(edtNCtas.Hint);
end;

procedure TfrmFacV.edtCompRefExit(Sender: TObject);
Var
  Part1, Part2: Integer;
begin
  try
    Part1 := 0;
    Part2 := 0;
    try
      Part1 := StrToInt(Trim(Copy(edtCompRef.Text,1,Pos('-',edtCompRef.Text)-1)));
    except
      on E: EConvertError do
      begin
        edtCompRef.SetFocus;
        edtCompRef.SelStart := 0;
        edtCompRef.SelLength := 3;
        raise EUsuario.Create('Error en el Pto. de Venta del comprobante');
      end;
    end;
    try
      Part2 := StrToInt(Trim(Copy(edtCompRef.Text,Pos('-',edtCompRef.Text)+1,Length(edtCompRef.Text))));
    except
      on E: EConvertError do
      begin
        edtCompRef.SetFocus;
        edtCompRef.SelStart := 5;
        edtCompRef.SelLength := 8;
        raise EUsuario.Create('Error en el Nº de comprobante');
      end;
    end;
  finally
    FacVCompRef.Value:= Format('%.4d-%.8d',[Part1,Part2]);
  end;
end;

procedure TfrmFacV.gbNotasCreditosEnter(Sender: TObject);
begin
  Put_Msg('Elija un comprobante');
  lblNCNomCli.Caption := Vacio;
  lblNCExplicacion.Visible := FNotaDeCredito;
  EligioNC := False;
end;

procedure TfrmFacV.gFacVenEncDblClick(Sender: TObject);
begin
  FillChar(Comp_Ref, SizeOf(TComp_Referencia), 0);
  if not qComp_Ref.IsEmpty then
  begin
    gbNotasCreditos.Visible := False;
    Put_Msg(Vacio);
    Comp_Ref.NCCliente := qComp_RefCliente.AsInteger;
    Comp_Ref.IdFactura := qComp_RefIdFactura.AsInteger;
    Comp_Ref.IdSucursal := qComp_RefIdSucursal.AsInteger;
    Comp_Ref.NroFactura := qComp_RefNroFactura.AsString;
    Comp_Ref.TipoFactura := qComp_RefTipoFactura.AsInteger;
    Comp_Ref.IdPuntoVenta := qComp_RefIdPuntoVenta.AsInteger;
    Comp_Ref.FechaF := qComp_RefFechaF.AsDateTime;
    Comp_Ref.NroCtas := qComp_RefNroCtas.AsInteger;
    Comp_Ref.Empleado := qComp_RefEmpleado.AsInteger;
    Comp_Ref.Contado := qComp_RefContado.AsCurrency;
    Comp_Ref.Tarjeta := qComp_RefTarjeta.AsCurrency;
    Comp_Ref.CtaCte := qComp_RefCtaCte.AsCurrency;
    Comp_Ref.Tickets := qComp_RefTickets.AsCurrency;
    Comp_Ref.Cheque := qComp_RefCHEQUE.AsCurrency;
    Comp_Ref.CobSenas := qComp_RefCOBSENAS.AsCurrency;
    Comp_Ref.OtrosPagos := qComp_RefOtrosPagos.AsCurrency;
    Comp_Ref.Total := qComp_RefTotal.AsCurrency;
    Comp_Ref.IdTarjeta := qComp_RefIdTarjeta.AsInteger;
    Comp_Ref.IdSubDep := qComp_RefIdSubDep.AsInteger;
    Cargar_Comprobante_De_Referencia(Comp_Ref);
    qComp_Ref.Close;
    gbHeader.Enabled := True;
    edtCliente.SetFocus;
  end
  else begin
    edtNCCliente.SetFocus;
  end;
end;

procedure TfrmFacV.gFacVenEncKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  FillChar(Comp_Ref, SizeOf(TComp_Referencia), 0);
  if Shift = [] then
  begin
    if Key = VK_ESCAPE then
    begin
      if qComp_Ref.Active then
        qComp_Ref.Close;
      gbNotasCreditos.Visible := False;
      Put_Msg(Vacio);
    end;

    if (Key = VK_RETURN) and
       (not qComp_Ref.IsEmpty) then
    begin
      gbNotasCreditos.Visible := False;
      Comp_Ref.NCCliente := qComp_RefCliente.AsInteger;
      Comp_Ref.IdFactura := qComp_RefIdFactura.AsInteger;
      Comp_Ref.IdSucursal := qComp_RefIdSucursal.AsInteger;
      Comp_Ref.IdPuntoVenta := qComp_RefIdPuntoVenta.AsInteger;
      Comp_Ref.NroFactura := qComp_RefNroFactura.AsString;
      Comp_Ref.TipoFactura := qComp_RefTipoFactura.AsInteger;
      Comp_Ref.FechaF := qComp_RefFechaF.AsDateTime;
      Comp_Ref.NroCtas := qComp_RefNroCtas.AsInteger;
      Comp_Ref.Empleado := qComp_RefEmpleado.AsInteger;
      Comp_Ref.Contado := qComp_RefContado.AsCurrency;
      Comp_Ref.Tarjeta := qComp_RefTarjeta.AsCurrency;
      Comp_Ref.CtaCte := qComp_RefCtaCte.AsCurrency;
      Comp_Ref.Tickets := qComp_RefTickets.AsCurrency;
      Comp_Ref.Cheque := qComp_RefCHEQUE.AsCurrency;
      Comp_Ref.OtrosPagos := qComp_RefOtrosPagos.AsCurrency;
      Comp_Ref.Total := qComp_RefTotal.AsCurrency;
      Comp_Ref.IdTarjeta := qComp_RefIdTarjeta.AsInteger;
      Comp_Ref.IdSubDep := qComp_RefIdSubDep.AsInteger;
      Cargar_Comprobante_De_Referencia(Comp_Ref);
      qComp_Ref.Close;
      gbHeader.Enabled := True;
      edtCliente.SetFocus;
    end;
  end;
end;

procedure TfrmFacV.Elegir_Comprobante_De_Referencia;
begin
  gbNotasCreditos.Visible := True;
  edtNCCliente.Text := '0';
  lblNCNomCli.Caption := ' ';
  lblCompRef.Enabled := True;
  edtCompRef.Enabled := True;
  EligioNC := False;

  if (ImprimirEnControlador) and
     ((Tipo_Factura) or (Tipo_Estacion) or (Tipo_FacNC)) and
     (ControladorLocal) then
  begin
    edtFechaHoy.Enabled := False;
    edtFechaHoy.ReadOnly := True;
    edtFechaHoy.TabStop := False;
    lblFecha.Enabled := False;
  end
  else begin
    edtFechaHoy.Enabled := True;
    edtFechaHoy.ReadOnly := False;
    edtFechaHoy.TabStop := True;
    lblFecha.Enabled := True;
  end;

  if RemitoEntrega then
  begin
    lblNCtas.Visible := False;
    edtNCtas.Visible := False;
    lblTarjeta.Visible := False;
    cbTarjetas.Visible := False;
    lblEntCont.Visible := False;
    edtEntCont.Visible := False;
  end
  else begin
    lblNCtas.Visible := True;
    edtNCtas.Visible := True;
    edtNCtas.TabStop := False;
  end;

  aNotaDeCreditos.Enabled := False;
  qComp_Ref.Close;
  edtNCCliente.SetFocus;
  gbHeader.Enabled := False;
  edtNCCliente.SetFocus;
end;

procedure TfrmFacV.gFacVUpdateFooter(Sender: TObject);
begin
  gFacV.ColumnByName('PrecioLista').FooterValue := Format('%9.2f',[Total_Lst]);
  gFacV.ColumnByName('ValorCta').FooterValue := Format('%9.2f',[Total_Cta]);
  gFacV.ColumnByName('PrecioTotal').FooterValue := Format('%9.2f',[Total_Fac]);
  gFacV.ColumnByName('PrcBonificacion').FooterValue := Format('%9.2f',[Total_Dto]);
end;

procedure TfrmFacV.gOfertasUpdateFooter(Sender: TObject);
begin
  gOfertas.ColumnByName('Detalle').FooterValue := 'Cantidad Ofertas ';
  gOfertas.ColumnByName('Precio').FooterValue := Format('%d',[Cantidad_Ofertas]);
end;

procedure TfrmFacV.aCierreZExecute(Sender: TObject);
begin
  if ComprobanteAbierto then
    raise EUsuario.Create('Debe cerrar el comprobante primero');

  if Application.MessageBox(' ¡Última operación del día! ', 'Cuidado', MB_ICONEXCLAMATION + MB_YESNO + MB_DEFBUTTON2) = ID_YES then
  begin
    with frmFiscal do
    begin
      if not ControladorOK then
        ControladorOK := InicializarControlador;
      ReporteZ;
    end;
    Emitiendo_Z := True;
    Close;
  end;
end;

procedure TfrmFacV.aCierreXExecute(Sender: TObject);
begin
  if ComprobanteAbierto then
    raise EUsuario.Create('Debe cerrar el comprobante primero');

  if Application.MessageBox('¿Imprimir reporte X?', 'Confirmación', MB_ICONQUESTION + MB_YESNO + MB_DEFBUTTON2) = ID_YES then
  begin
    with frmFiscal do
    begin
      if not ControladorOK then
        ControladorOK := InicializarControlador;
      ReporteX;
      ControladorOK := InicializarControlador;
    end;
    Set_Params_FV;
  end;
end;

procedure TfrmFacV.aCancelarAllExecute(Sender: TObject);
begin
  frmFiscal.CancelarTodo;
end;

procedure TfrmFacV.aNCreditoManualExecute(Sender: TObject);
begin
  Comprobantes_Manuales(3);
  Elegir_Comprobante_De_Referencia;
end;

procedure TfrmFacV.aNDebitoManualExecute(Sender: TObject);
begin
  Comprobantes_Manuales(1);
end;

procedure TfrmFacV.aNotaDeCreditosExecute(Sender: TObject);
begin
  ImprimirEnLinea := False;
  FNotaDeCredito := True;
  Factura_Vta := False;
  RemitoEntrega := False;
  Cotizacion := False;
  NotaDebito := False;
  ConDescStk := True;
  Elegir_Comprobante_De_Referencia;
end;

procedure TfrmFacV.aRemitoManualExecute(Sender: TObject);
begin
  Comprobantes_Manuales(4);
  Elegir_Comprobante_De_Referencia;
end;

procedure TfrmFacV.aRemitosExecute(Sender: TObject);
begin
  if (Tipo_Factura) or
     (not ImprimirEnControlador) then
  begin
    ImprimirEnLinea := False;
    RemitoEntrega := True;
    FNotaDeCredito := False;
    Factura_Vta := False;
    NotaDebito := False;
    Cotizacion := False;
    ConDescStk := True;
    Elegir_Comprobante_De_Referencia;
  end;
end;

procedure TfrmFacV.aSearchCliExecute(Sender: TObject);
begin
  Busca_Cli(IdEntidad, IdSucEnt);
end;

procedure TfrmFacV.aABMCliExecute(Sender: TObject);
begin
  frmEntidades := TfrmEntidades.Create(nil);
  frmEntidades.ShowModal;
end;

procedure TfrmFacV.aAltaCliExecute(Sender: TObject);
begin
  if AltaCliente(1) = NoEncontrado then
  begin
    edtCliente.SetFocus;
    raise EUsuario.Create('Cliente mal ingresado');
  end;
end;

procedure TfrmFacV.aComprobantes_EmitidosExecute(Sender: TObject);
begin
  Get_FacV(NoEncontrado, IdBranch, IdSalesPoint);
end;

procedure TfrmFacV.aPtoVtasExecute(Sender: TObject);
begin
  if ComprobanteAbierto then
    raise EUsuario.Create('Debe cerrar el comprobante primero');
  frmConfiguracion := TfrmConfiguracion.Create(Self);
  frmConfiguracion.ShowModal;
  Set_Params_FV;
end;

procedure TfrmFacV.aFondosExecute(Sender: TObject);
begin
  frmFondos := TfrmFondos.Create(Self);
  frmFondos.ShowModal;
  Set_Params_FV;
end;

procedure TfrmFacV.aGetOffExecute(Sender: TObject);
begin
  try
    Screen.Cursor := crSQLWait;
    UpDater_POff(IdBranch);
    Ver_Ofertas;
  finally
    Set_Params_FV;
    Screen.Cursor := crDefault;
  end;
end;

procedure TfrmFacV.SalirClick(Sender: TObject);
begin
  Close;
end;

procedure TfrmFacV.ItemsFVIdArticuloGetText(Sender: TField; var Text: String; DisplayText: Boolean);
begin
  if GetDatosArt(Sender.AsInteger, Vacio, Datos_Art) then
    Text := Datos_Art.CodBarra
  else
    Text := Sender.AsString;
end;

procedure TfrmFacV.aFacManExecute(Sender: TObject);
begin
  if (ImprimirEnControlador = False) then
    Exit;
end;

procedure TfrmFacV.aFacturaVtaManualExecute(Sender: TObject);
begin
  Comprobantes_Manuales(0);
end;

procedure TfrmFacV.aFinanciacionesExecute(Sender: TObject);
begin
  frmCalcPrecios := TfrmCalcPrecios.Create(Self);
  frmCalcPrecios.ShowModal;
end;

procedure TfrmFacV.btnNCSinCompClick(Sender: TObject);
begin
  gbNotasCreditos.Visible := False;
  Put_Msg(Vacio);
  EligioNC := False;
  gbHeader.Enabled := True;
  aNotaDeCreditos.Enabled := True;
  FacV.Edit;
  SetDatosFacCli;
  edtComprobante.Text := Inc_NComp(GetNumeroComprobante(IdBranch, PtoVta, FacVTipoIva.AsInteger, FacVTipoFactura.AsInteger));
  edtComprobante.TabStop := True;
  edtComprobante.ReadOnly := False;
  FacVNroFactura.AsString := edtComprobante.Text;
  FacVCompRef.AsString := '0000-00000000';
  FacVIdCompRef.AsInteger := 0;
  edtCliente.SetFocus;
end;

procedure TfrmFacV.aServerFiscalExecute(Sender: TObject);
begin
  frmServidorFiscal := TfrmServidorFiscal.Create(Self);
  frmServidorFiscal.ShowModal;
end;

procedure TfrmFacV.ItemsFVTalleGetText(Sender: TField; var Text: String; DisplayText: Boolean);
begin
  if Control_Talles then
  begin
    try
      Text := GetTextTalle(Sender.AsInteger);
    except
      Text := Sender.AsString;
    end;
  end;
end;

procedure TfrmFacV.ItemsFVTalleSetText(Sender: TField; const Text: String);
begin
  if Control_Talles then
  begin
    try
      Sender.Value := SetTextTalle(Text);
    except
      on E: Exception do
        Application.MessageBox(PChar(E.Message), 'Error cargando talles', MB_ICONERROR);
    end;
  end;
end;

procedure TfrmFacV.ItemsFVTalleValidate(Sender: TField);
var
  StkAct: Double;
begin
  if Control_Talles then
  begin
    StkAct := 0;
    if ItemsFVTieneTalle.AsInteger = Verdadero then
    begin
      StkAct := Get_Stock(ItemsFVIdArticulo.AsInteger, IdBranch, Sender.AsInteger, True);
      sbFacV.SimpleCaption := Format('Stk Medida = %f ',[StkAct]);
      if StkAct <= 0 then
        ShowMessage('el Talle del producto no tiene Stock, verifiquelo. ');
      gFacV.Refresh;
    end;
  end;
end;

procedure TfrmFacV.ItemsFVIdArticuloChange(Sender: TField);
begin
  ItemsFVPrcBonificacion.AsFloat := 0;
  ItemsFVIdAutorDto.AsInteger := 0;
  ItemsFVDescuento.AsCurrency := 0;
end;

procedure TfrmFacV.Calc_Descuento;
var
  P: TPrecios;
begin
  AutorDto := 0;
  if (ItemsFVIdArticulo.AsInteger > 0) and
     (ItemsFVPrcBonificacion.AsFloat > 0) and
     (ItemsFVCantidad.AsFloat > 0) and
     (FacVTipoFactura.AsInteger in [Tkt, FacA, FacB, FacC, DebA, DebB, Presupuesto]) then
  begin
    if ItemsFVPrcBonificacion.AsFloat > ItemsFVMaxDcto.AsFloat then
    begin
      if not Check_Seg(Nivel_Dto, 'Autorización Dcto', AutorDto) then
      begin
        ItemsFVPrcBonificacion.AsFloat := 0;
        ItemsFVDescuento.AsCurrency := 0;
        ItemsFVMaxDcto.AsFloat := MaxDctoPermitido(ItemsFVIdArticulo.AsInteger,
                                                   FacVIdTarjeta.AsInteger,
                                                   FacVCantCuotas.AsInteger,
                                                   FacVIdSucursal.AsInteger);
        ItemsFVIdAutorDto.AsInteger := AutorDto;
        gFacV.RefreshDisplay;
        raise EUsuario.Create('El descuento exede el limite permitido');
      end
      else begin
        ItemsFVIdAutorDto.AsInteger := AutorDto;
      end;
    end;
    if (ItemsFVPrecioFinal.AsCurrency >= ItemsFVPrecioOriginal.AsCurrency) then
    begin
      P := Descuento(ItemsFVPrecioTotal.AsCurrency,
                     ItemsFVPrecioFinal.AsCurrency, FacVEntregaCdo.AsCurrency,
                     ItemsFVMtoImpInt.Value, ItemsFVPrcBonificacion.AsFloat,
                     ItemsFVPrcExento.Value, ItemsFVCantidad.Value,
                     ItemsFVAlcIva.Value, ItemsFVAlcIB.Value, FacVCantCuotas.AsInteger);
    end
    else begin
      P := Descuento((ItemsFVPrecioOriginal.AsCurrency*ItemsFVCantidad.AsFloat),
                     ItemsFVPrecioOriginal.AsCurrency, FacVEntregaCdo.AsCurrency,
                     ItemsFVMtoImpInt.Value, ItemsFVPrcBonificacion.AsFloat,
                     ItemsFVPrcExento.Value, ItemsFVCantidad.Value,
                     ItemsFVAlcIva.Value, ItemsFVAlcIB.Value, FacVCantCuotas.AsInteger);
    end;
    ItemsFVPrecioFinal.AsCurrency := P.PFinal;
    ItemsFVPrecioTotal.AsCurrency := P.Total;
    ItemsFVPrecioNeto.AsCurrency := P.Neto;
    ItemsFVDescuento.AsCurrency := P.Descto;
    ItemsFVIvaIn.AsCurrency := P.Iva1;
    ItemsFVImpInt.AsCurrency := P.ImpInt * ItemsFVCantidad.AsFloat;
    ItemsFVExento.AsCurrency := P.Exento;
    ItemsFVAlcIva.AsCurrency := P.IdAlcIva;
    ItemsFVAlicuotaIva.Value := P.AlicuotaIva;
    ItemsFVAlcIB.Value := P.IdAlcIB;
    ItemsFVAlicuotaIB.Value := P.AlicuotaIB;
    ItemsFVIngBto.AsCurrency := P.IngBto;
    ItemsFVCoefIntImp.AsFloat := P.CoefImpInt;
    ItemsFVValorCta.AsCurrency := P.ValorCuota;
    gFacV.RefreshDisplay;
  end;
end;

procedure TfrmFacV.ItemsFVDescuentoChange(Sender: TField);
begin
  if (ItemsFVIdArticulo.AsInteger > 0) and
     (ItemsFVDescuento.AsCurrency > 0) and
     (ItemsFVCantidad.AsFloat <> 0) and
     (not ActualizandoDescuento) and
     (FacVTipoFactura.AsInteger in [TKT, FacA, FacB, FacC, DebA, DebB, Presupuesto]) then
  begin
    try
      ActualizandoDescuento := True;
      if ItemsFVPrecioLista.AsCurrency > ItemsFVPrecioOriginal.AsCurrency then
      begin
        if (ItemsFVPrecioLista.AsCurrency * ItemsFVCantidad.AsFloat) <> 0 then
        begin
          try
            ItemsFVPrcBonificacion.AsFloat := (ItemsFVDescuento.AsCurrency * 100) /
                                              (((ItemsFVPrecioLista.AsCurrency -
                                                 ItemsFVImpInt.AsCurrency) /
                                                 (1+(ItemsFVAlicuotaIva.AsFloat/100)))*
                                               ItemsFVCantidad.AsFloat);
          except
            ItemsFVPrcBonificacion.AsFloat := 0;
          end;
          if (ItemsFVPrcBonificacion.AsFloat <= ItemsFVMaxDcto.AsFloat) And
             (ItemsFVPrcBonificacion.AsFloat > 0) then
          begin
            Calc_Descuento
          end
          else begin
            if (ItemsFVPrcBonificacion.AsFloat > 0) And
               (not Check_Seg(Nivel_Dto, 'Autorización Dcto', AutorDto)) then
            begin
              ItemsFVPrcBonificacion.AsFloat := 0;
              ItemsFVDescuento.AsCurrency := 0;
            end;
          end;
        end
        else begin
          if not Check_Seg(Nivel_Dto, 'Autorización Dcto', AutorDto) then
          begin
            ItemsFVDescuento.AsCurrency := 0;
            ItemsFVPrcBonificacion.AsFloat := 0;
          end;
        end;
      end
      else begin
        if ((ItemsFVPrecioOriginal.AsCurrency * ItemsFVCantidad.AsFloat) <> 0) then
        begin
          try
            ItemsFVPrcBonificacion.AsFloat := (ItemsFVDescuento.AsCurrency * 100) /
                                              (((ItemsFVPrecioOriginal.AsCurrency -
                                                 ItemsFVImpInt.AsCurrency) /
                                                 (1+(ItemsFVAlicuotaIva.AsFloat/100)))*
                                               ItemsFVCantidad.AsFloat);
          except
            ItemsFVPrcBonificacion.AsFloat := 0;
          end;
          (*
          ItemsFVPrcBonificacion.AsFloat := (ItemsFVDescuento.AsCurrency * 100) /
                                            (ItemsFVPrecioOriginal.AsCurrency *
                                             ItemsFVCantidad.AsFloat);
          *)
          if (ItemsFVPrcBonificacion.AsFloat <= ItemsFVMaxDcto.AsFloat) And
             (ItemsFVPrcBonificacion.AsFloat > 0) then
          begin
            Calc_Descuento
          end
          else begin
            if (ItemsFVPrcBonificacion.AsFloat > 0) And
               (not Check_Seg(Nivel_Dto, 'Autorización Dcto', AutorDto)) then
            begin
              ItemsFVDescuento.AsCurrency := 0;
              ItemsFVPrcBonificacion.AsFloat := 0;
            end;
          end;
        end
        else begin
          if not Check_Seg(Nivel_Dto, 'Autorización Dcto', AutorDto) then
          begin
            ItemsFVDescuento.AsCurrency := 0;
            ItemsFVPrcBonificacion.AsFloat := 0;
          end;
        end;
      end;
      gFacV.RefreshDisplay;
    finally
      ActualizandoDescuento := False;
    end;
  end;
end;

procedure TfrmFacV.ItemsFVDescuentoValidate(Sender: TField);
begin
  if (ItemsFVIdArticulo.AsInteger > 0) and
     (ItemsFVCantidad.AsFloat > 0) and
     (ItemsFVDescuento.AsCurrency < 0) then
    raise EUsuario.Create('ERROR. No se puede realizar un descuento negativo.');
end;

procedure TfrmFacV.ItemsFVPrcBonificacionValidate(Sender: TField);
begin
  if (ItemsFVIdArticulo.AsInteger > 0) and
     (ItemsFVPrcBonificacion.AsFloat > 0.0000) and
     (not ActualizandoDescuento) and
     (not ActualizandoCantidad) and
     (not ActualizandoFinal) and
     (not ActualizandoTotal) and
     (not FNotaDeCredito) and
     (not DandoPrecio) and
     (not ActualizandoContado) then
  begin
    try
      ActualizandoDescuento := True;
      if (Sender.AsFloat <= ItemsFVMaxDcto.AsFloat) then
        Calc_Descuento
      else
        raise EUsuario.Create(Format('No esta permitido un descuento mayor a: %7.2f', [ItemsFVMaxDcto.AsFloat])+'%');
    finally
      ActualizandoDescuento := False;
    end;
  end
end;

procedure TfrmFacV.Comprobantes_Manuales(TC: SmallInt);
begin
  FacV.Cancel;
  Vaciar_Tablas;
  ConDescStk := True;
  Comprobante_Manual := True;
  Factura_Vta := False;
  NotaDebito := False;
  Cotizacion := False;
  FNotaDeCredito := False;
  RemitoEntrega := False;
  Case TC of
    0: Factura_Vta := True;
    1: NotaDebito := True;
    2: Cotizacion := True;
    3: FNotaDeCredito := True;
    4: RemitoEntrega := True;
  End;
  edtComprobante.ReadOnly := False;
  edtComprobante.TabStop := True;
  lblFecha.Enabled := True;
  edtFechaHoy.Enabled := True;
  edtFechaHoy.ReadOnly := False;
  edtFechaHoy.TabStop := True;
  if FacV.Active then
    FacV.EmptyDataSet
  else
    FacV.CreateDataSet;
  FacV.Insert;
  if not RemitoEntrega then
    FacVRetiro.AsInteger := Impersonal;
end;

procedure TfrmFacV.aConsPrecExecute(Sender: TObject);
begin
  try
    if ComprobanteAbierto then
      raise EUsuario.Create('Debe cerrar el comprobante primero');

    if not ExisteForm('TfrmABMArticulos') then
      frmABMArticulos := TfrmABMArticulos.Create(Self);
    frmABMArticulos.WindowState := wsNormal;
    frmABMArticulos.Cual_Art := 0;
    frmABMArticulos.ShowModal;
  finally
    FreeAndNil(frmABMArticulos);
  end;
end;

procedure TfrmFacV.aSucursalesExecute(Sender: TObject);
begin
  frmGestSucursales := TfrmGestSucursales.Create(Self);
  frmGestSucursales.ShowModal;
  Set_Params_FV;
end;

procedure TfrmFacV.aSenasExecute(Sender: TObject);
begin
  frmSenas := TfrmSenas.Create(Self);
  frmSenas.ShowModal;
end;

procedure TfrmFacV.aConsignacionesExecute(Sender: TObject);
begin
  Consignacion;
end;

procedure TfrmFacV.cbSubDepEnter(Sender: TObject);
begin
  cbSubDep.DropDown;
end;

procedure TfrmFacV.cbSubDepChange(Sender: TObject);
begin
  if ConSubDep then
  begin
    if not (FacV.State in [dsEdit, dsInsert]) then
      FacV.Edit;
    try
      FacVIdSubDep.AsInteger := Integer(cbSubDep.Items.Objects[cbSubDep.ItemIndex])
    except
      FacVIdSubDep.AsInteger := 0;
    end;
  end;
end;

procedure TfrmFacV.cbSubDepExit(Sender: TObject);
begin
  if ConSubDep then
  begin
    FacVIdSubDep.AsInteger := Integer(cbSubDep.Items.Objects[cbSubDep.ItemIndex])
  end;
end;

procedure TfrmFacV.edtEmpleadoExit(Sender: TObject);
begin
  if FacVEmpleado.AsInteger = 0 then
  begin
    edtEmpleado.SetFocus;
    raise EUsuario.Create('debe ingresar un código de vendedor.-');
  end;
end;

procedure TfrmFacV.FacVEmpleadoValidate(Sender: TField);

  procedure Go_Home;
  begin
    FacVNombreEmpleado.Clear;
    if Focused then
      edtEmpleado.SetFocus;
    raise EUsuario.Create('Usuario no asignado o desactivado. ');
  end;

begin
  if (FacVEmpleado.AsInteger > 0) And
     (not RemitoEntrega) And
     (not FNotaDeCredito) then
  begin
    if GetDatosEmp(FacVEmpleado.AsInteger, Vacio, 3, Datos_Ent) then
    begin
      if not (Datos_Ent.IdSuc = 0) then
      begin
        if not (Datos_Ent.IdSuc = IdBranch) then
        begin
          if IdBranch <> 1 then
            Go_Home
          else begin
            if not Datos_Ent.Activo then
            Go_Home
          end;
        end
        else begin
          if not Datos_Ent.Activo then
            Go_Home
        end;
      end
      else begin
        if not Datos_Ent.Activo then
          Go_Home
      end;
      if Datos_Ent.Activo then
        FacVNombreEmpleado.AsString := Datos_Ent.Nombre
      else
        Go_Home;
    end
  end
  else begin
    if (FacVEmpleado.AsInteger > 0) And
       (FacV.State in dsEditModes) And
       (GetDatosEmp(FacVEmpleado.AsInteger, Vacio, 3, Datos_Ent)) then
     if (Datos_Ent.Activo) then
       FacVNombreEmpleado.AsString := Datos_Ent.Nombre;
  end
end;

procedure TfrmFacV.cbTarjetasEnter(Sender: TObject);
begin
  cbTarjetas.SelectAll;
  Put_Msg(cbTarjetas.Hint);
end;

procedure TfrmFacV.FacVAfterInsert(DataSet: TDataSet);
begin
  if Visible then
  begin
    edtCliente.SetFocus;
    edtCliente.SelectAll;
  end;
end;

procedure TfrmFacV.FacVCantCuotasValidate(Sender: TField);
begin
  if (FacVCantCuotas.AsInteger > 0) and
     (FacVTipoFactura.AsInteger in [FacA, FacB, Tkt, FacC]) then
  begin
    Coeficiente := GetCoefTar(FacVIdTarjeta.AsInteger, FacVIdSucursal.AsInteger, FacVCantCuotas.AsInteger);
    if Coeficiente < 0 then
    begin
      ShowMessage('Plan de financiación no autorizado.');
      Exit;
    end;
  end;
end;

procedure TfrmFacV.aPresupuestoManualExecute(Sender: TObject);
begin
  Comprobantes_Manuales(2);
end;

procedure TfrmFacV.aPresupuestosExecute(Sender: TObject);
begin
  if (Tipo_Factura) or
     (not ImprimirEnControlador) then
  begin
    ImprimirEnLinea := False;
    RemitoEntrega := False;
    FNotaDeCredito := False;
    Factura_Vta := False;
    EligioNC := False;
    NotaDebito := False;
    Cotizacion := True;
    ConDescStk := False;
    edtCompRef.Enabled := False;
    lblCompRef.Enabled := False;
    lblFecha.Enabled := True;
    edtFechaHoy.Enabled := True;
    edtFechaHoy.ReadOnly := False;
    edtFechaHoy.TabStop := True;
    if FacV.Active then
      FacV.EmptyDataSet
    else
      FacV.CreateDataSet;
    FacV.Insert;
    FacVTipoFactura.AsInteger := Presupuesto;
    FacVRetiro.AsInteger := Impersonal;
  end;
end;

procedure TfrmFacV.aNotaDeDebitosExecute(Sender: TObject);
begin
  if (Tipo_Factura) or
     (Tipo_Estacion) or
     (not ImprimirEnControlador) then
  begin
    ImprimirEnLinea := False;
    RemitoEntrega := False;
    FNotaDeCredito := False;
    Factura_Vta := False;
    EligioNC   := False;
    NotaDebito := True;
    Cotizacion := False;
    ConDescStk := True;
    if FacV.Active then
      FacV.EmptyDataSet
    else
      FacV.CreateDataSet;
    FacV.Insert;
    FacVRetiro.AsInteger := Impersonal;
  end;
end;

end.
